<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.0.0"><link rel="apple-touch-icon" sizes="180x180" href="https://myblog-1303447677.file.myqcloud.com/BlogFrame/pig_32px_1271682_easyicon.net.ico"><link rel="icon" type="image/png" sizes="32x32" href="https://myblog-1303447677.file.myqcloud.com/BlogFrame/pig_32px_1271682_easyicon.net.ico"><link rel="icon" type="image/png" sizes="16x16" href="https://myblog-1303447677.file.myqcloud.com/BlogFrame/pig_32px_1271682_easyicon.net.ico"><link rel="mask-icon" href="https://myblog-1303447677.file.myqcloud.com/BlogFrame/pig_32px_1271682_easyicon.net.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"zm6666.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.2/source/js/config.min.js"></script><meta name="description" content="本文采用 CC BY-NC-SA 4.0 协议，转载请注明出处。   与Spring集成 这里用的Spring版本 12345&lt;dependency&gt;    &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;    &lt;artifactId&gt;spring-webmvc&lt;&#x2F;artifactId&gt;"><meta property="og:type" content="article"><meta property="og:title" content="RabbitMQ使用指南3——RMQ与Spring结合"><meta property="og:url" content="https://zm6666.top/RabbitMQ/How-to-use-RabbitMQ-3-UseWithSpring/index.html"><meta property="og:site_name" content="ZM666"><meta property="og:description" content="本文采用 CC BY-NC-SA 4.0 协议，转载请注明出处。   与Spring集成 这里用的Spring版本 12345&lt;dependency&gt;    &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;    &lt;artifactId&gt;spring-webmvc&lt;&#x2F;artifactId&gt;"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-11-23T15:00:21.000Z"><meta property="article:modified_time" content="2022-08-23T17:51:30.385Z"><meta property="article:tag" content="RabbitMQ"><meta property="article:tag" content="Java"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://zm6666.top/RabbitMQ/How-to-use-RabbitMQ-3-UseWithSpring/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zm6666.top/RabbitMQ/How-to-use-RabbitMQ-3-UseWithSpring/","path":"RabbitMQ/How-to-use-RabbitMQ-3-UseWithSpring/","title":"RabbitMQ使用指南3——RMQ与Spring结合"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>RabbitMQ使用指南3——RMQ与Spring结合 | ZM666</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">ZM666</p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8Espring%E9%9B%86%E6%88%90"><span class="nav-number">1.</span> <span class="nav-text">与Spring集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#application-context.xml%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.</span> <span class="nav-text">application-context.xml配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">1.1.1.</span> <span class="nav-text">命名空间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E7%9B%B8%E5%85%B3"><span class="nav-number">1.1.2.</span> <span class="nav-text">连接相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rabbitadmin%E7%AE%A1%E7%90%86%E7%B1%BB"><span class="nav-number">1.1.3.</span> <span class="nav-text">RabbitAdmin管理类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%9F%E5%88%97"><span class="nav-number">1.1.4.</span> <span class="nav-text">队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="nav-number">1.1.5.</span> <span class="nav-text">交换机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">1.1.6.</span> <span class="nav-text">消费者</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="" src="https://myblog-1303447677.file.myqcloud.com/BlogFrame/my-avatar.png"><p class="site-author-name" itemprop="name"></p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/zhaomin6666" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhaomin6666" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:lanmao_1029@163.com" title="E-Mail → mailto:lanmao_1029@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://zm6666.top/RabbitMQ/How-to-use-RabbitMQ-3-UseWithSpring/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://myblog-1303447677.file.myqcloud.com/BlogFrame/my-avatar.png"><meta itemprop="name" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ZM666"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="RabbitMQ使用指南3——RMQ与Spring结合 | ZM666"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> RabbitMQ使用指南3——RMQ与Spring结合</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-11-23 23:00:21" itemprop="dateCreated datePublished" datetime="2020-11-23T23:00:21+08:00">2020-11-23</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-08-24 01:51:30" itemprop="dateModified" datetime="2022-08-24T01:51:30+08:00">2022-08-24</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a> 协议，转载请注明出处。</li></ul><hr><h2 id="与spring集成">与Spring集成</h2><p>这里用的Spring版本</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.11.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure> 这里用的RabbitMQ结合Spring的版本<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><span id="more"></span><p>这里把和springboot的结合放一放，先讲和spring的结合。毕竟使用xml配置和使用注解配置最终在代码上是一致的，即可以用xml配置的，一定可以用代码去实现。而且目前作者工作使用的项目还未使用springboot，所以就先讲讲xml配置了。</p><h3 id="application-context.xml配置">application-context.xml配置</h3><h4 id="命名空间">命名空间</h4><p>要使用xml配置RabbitMQ相关内容，首先要在spring的xml中引入RabbitMQ相关的Schema。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">	   	http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">		http://www.springframework.org/schema/rabbit</span></span></span><br><span class="line"><span class="string"><span class="tag">		http://www.springframework.org/schema/rabbit/spring-rabbit-2.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">		http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">		http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure> 其中可以看到RabbitMQ相关的3个引用，在引用完成之后就可以在xml中配置RabbitMQ相关的内容了。<p></p><h4 id="连接相关">连接相关</h4><p>使用Spring的配置文件配置连接，利用Spring对bean标签解析实例化创建RabbitMQ的连接工厂。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rabbitMQ配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;rabbitConnectionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.amqp.rabbit.connection.CachingConnectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;127.0.0.1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;guest&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;guest&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;channelCacheSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;port&quot;</span> <span class="attr">value</span>=<span class="string">&quot;5672&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure> property标签就是配置工厂类的变量，常用的几个列了一下。如果要手动从连接工厂获取连接可以使用<code>createConnection()</code>方法。<p></p><h4 id="rabbitadmin管理类">RabbitAdmin管理类</h4><p>使用自定义标签配置管理器。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring的rabbitmq admin 管理配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">&quot;rabbitConnectionFactory&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure> 其中RabbitAdmin是RabbitMQ在Spring中的管理类，其中有创建队列、创建交换机、绑定等多种方法。RabbitAdmin实现了InitializingBean接口，在Spring容器初始化完成Bean之后会调用<code>initializeBean(beanName, exposedObject, mbd);</code>（详细见Spring源码中AbstractAutowireCapableBeanFactory的<code>doCreateBean()</code>方法），来调用到RabbitAdmin的<code>afterPropertiesSet()</code>方法。<code>afterPropertiesSet()</code>方法中又会调用本类中的<code>initialize()</code>方法。 其实贴一下<code>initialize()</code>方法源码就一目了然了，这边我把源码大概简化说明一下，源码贴在后面，大家对比一下很容易理解。<p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// 检查applicationcontext，applicationcontext是通过实现ApplicationContextAware接口的方法setApplicationContext获取的。</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 从Spring上下文中获取到所有的Exchange.class、Queue.class、Binding.class，也就是后面我们会配置的xml参数。</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// processDeclarables方法从Spring上下文中获取Declarables类，这个类是个可以容纳Exchange，Queue，Binding的集合。这个类后面会提到。</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 第一个循环：对exchange的遍历，如果找到的交换机不是持久化或是自动删除的，会在日志中log.info记录。</span></span><br><span class="line">	<span class="comment">// 第二个循环：对queue的遍历，如果找到的队列不是持久化或是自动删除的或是排他的（只能自己用），会在日志中log.info记录。</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 使用RabbitTemplate的channel，调用RabbitAdmin类中的declareExchanges、declareQueues、declareBindings对交换机、队列、绑定进行声明。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Declares all the exchanges, queues and bindings in the enclosing application context, if any. It should be safe</span></span><br><span class="line"><span class="comment"> * (but unnecessary) to call this method more than once.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span> <span class="comment">// NOSONAR complexity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">this</span>.applicationContext == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="built_in">this</span>.logger.debug(<span class="string">&quot;no ApplicationContext has been set, cannot auto-declare Exchanges, Queues, and Bindings&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">this</span>.logger.debug(<span class="string">&quot;Initializing declarations&quot;</span>);</span><br><span class="line">	Collection&lt;Exchange&gt; contextExchanges = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Exchange&gt;(<span class="built_in">this</span>.applicationContext.getBeansOfType(Exchange.class).values());</span><br><span class="line">	Collection&lt;Queue&gt; contextQueues = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Queue&gt;(<span class="built_in">this</span>.applicationContext.getBeansOfType(Queue.class).values());</span><br><span class="line">	Collection&lt;Binding&gt; contextBindings = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Binding&gt;(<span class="built_in">this</span>.applicationContext.getBeansOfType(Binding.class).values());</span><br><span class="line">	Collection&lt;DeclarableCustomizer&gt; customizers = <span class="built_in">this</span>.applicationContext.getBeansOfType(DeclarableCustomizer.class).values();</span><br><span class="line">	</span><br><span class="line">	processDeclarables(contextExchanges, contextQueues, contextBindings);</span><br><span class="line">	<span class="keyword">final</span> Collection&lt;Exchange&gt; exchanges = filterDeclarables(contextExchanges, customizers);</span><br><span class="line">	<span class="keyword">final</span> Collection&lt;Queue&gt; queues = filterDeclarables(contextQueues, customizers);</span><br><span class="line">	<span class="keyword">final</span> Collection&lt;Binding&gt; bindings = filterDeclarables(contextBindings, customizers);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (Exchange exchange : exchanges) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((!exchange.isDurable() || exchange.isAutoDelete())  &amp;&amp; <span class="built_in">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.info(<span class="string">&quot;Auto-declaring a non-durable or auto-delete Exchange (&quot;</span> + exchange.getName() + <span class="string">&quot;) durable:&quot;</span> + exchange.isDurable() + <span class="string">&quot;, auto-delete:&quot;</span> + exchange.isAutoDelete() + <span class="string">&quot;. &quot;</span> + <span class="string">&quot;It will be deleted by the broker if it shuts down, and can be redeclared by closing and &quot;</span> + <span class="string">&quot;reopening the connection.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (Queue queue : queues) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((!queue.isDurable() || queue.isAutoDelete() || queue.isExclusive()) &amp;&amp; <span class="built_in">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class="line">			<span class="built_in">this</span>.logger.info(<span class="string">&quot;Auto-declaring a non-durable, auto-delete, or exclusive Queue (&quot;</span> + queue.getName() + <span class="string">&quot;) durable:&quot;</span> + queue.isDurable() + <span class="string">&quot;, auto-delete:&quot;</span> + queue.isAutoDelete() + <span class="string">&quot;, exclusive:&quot;</span> + queue.isExclusive() + <span class="string">&quot;. &quot;</span> + <span class="string">&quot;It will be redeclared if the broker stops and is restarted while the connection factory is &quot;</span> + <span class="string">&quot;alive, but all messages will be lost.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (exchanges.size() == <span class="number">0</span> &amp;&amp; queues.size() == <span class="number">0</span> &amp;&amp; bindings.size() == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">this</span>.logger.debug(<span class="string">&quot;Nothing to declare&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">this</span>.rabbitTemplate.execute(channel -&gt; &#123;</span><br><span class="line">		declareExchanges(channel, exchanges.toArray(<span class="keyword">new</span> <span class="title class_">Exchange</span>[exchanges.size()]));</span><br><span class="line">		declareQueues(channel, queues.toArray(<span class="keyword">new</span> <span class="title class_">Queue</span>[queues.size()]));</span><br><span class="line">		declareBindings(channel, bindings.toArray(<span class="keyword">new</span> <span class="title class_">Binding</span>[bindings.size()]));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">this</span>.logger.debug(<span class="string">&quot;Declarations finished&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processDeclarables</span><span class="params">(Collection&lt;Exchange&gt; contextExchanges, Collection&lt;Queue&gt; contextQueues,</span></span><br><span class="line"><span class="params">		Collection&lt;Binding&gt; contextBindings)</span> &#123;</span><br><span class="line">	Collection&lt;Declarables&gt; declarables = <span class="built_in">this</span>.applicationContext.getBeansOfType(Declarables.class, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">			.values();</span><br><span class="line">	declarables.forEach(d -&gt; &#123;</span><br><span class="line">		d.getDeclarables().forEach(declarable -&gt; &#123;</span><br><span class="line">			<span class="keyword">if</span> (declarable <span class="keyword">instanceof</span> Exchange) &#123;</span><br><span class="line">				contextExchanges.add((Exchange) declarable);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (declarable <span class="keyword">instanceof</span> Queue) &#123;</span><br><span class="line">				contextQueues.add((Queue) declarable);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (declarable <span class="keyword">instanceof</span> Binding) &#123;</span><br><span class="line">				contextBindings.add((Binding) declarable);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h4 id="队列">队列</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义队列 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">&quot;queue1&quot;</span> <span class="attr">durable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">&quot;queue2&quot;</span> <span class="attr">durable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">&quot;queue3&quot;</span> <span class="attr">durable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>在队列声明上，可以设置的常用属性： name：队列名称； durable：持久化（注意，持久化是需要交换机exchange、队列queue、消息message三者都是持久的）； exclusive：仅创建者可以使用的私有队列，断开后自动删除； auto_delete：当所有消费客户端连接断开后，是否自动删除队列； id：允许独立于队列名称使用Spring进行管理。即可以使用ApplicationContext.getBean("id")来获取队列，并且能够使用属性占位符和SpEL表达式。</p><p>在标签queue里面，还可以设置更多详细的属性，具体属性可以看上一篇中的【队列的控制】。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">&quot;queue4&quot;</span> <span class="attr">durable</span>=<span class="string">&quot;false&quot;</span> <span class="attr">id</span>=<span class="string">&quot;q4&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line">    	<span class="comment">&lt;!-- 设置队列内消息过期时间 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-message-ttl&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span>100<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 创建 HA 队列 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-ha-policy&quot;</span> <span class="attr">value</span>=<span class="string">&quot;all&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span><br></pre></td></tr></table></figure> 在SpringFramework版本3.2及以后，对于详细属性可以使用更简便的配置方式：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-message-ttl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.Long&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p></p><h4 id="交换机">交换机</h4><p>交换机的配置使用xxxx-exchange标签进行配置，可以设置的常用属性： name：交换机名称； durable：持久化； auto-delete：自动删除； id：独立于队列名称的id。</p><p>对于Fanout交换机是比较简单的</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 把队列与Fanout交换机绑定一起 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:fanout-exchange</span> <span class="attr">name</span>=<span class="string">&quot;fanout-exchange&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span> <span class="attr">durable</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;queue1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;queue2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;queue3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:fanout-exchange</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- fanout交换机 end--&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>对于Direct/Topic交换机来说，队列需要通过绑定键绑定在交换机上。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- topic交换器 begin--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 定义队列 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 把需要数据的队列通过路由键与topic交换器绑定一起 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">&quot;topic-exchange&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span> <span class="attr">durable</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">binding</span> <span class="attr">pattern</span>=<span class="string">&quot;#&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;all_cars&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">binding</span> <span class="attr">pattern</span>=<span class="string">&quot;*.black&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;all_black_cars&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">binding</span> <span class="attr">pattern</span>=<span class="string">&quot;fast.white&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;fast_black_cars&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">binding</span> <span class="attr">pattern</span>=<span class="string">&quot;fast.*&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;fast_all_cars&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">binding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- topic交换器 end--&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>相信仔细的读者在上面讲管理类的时候会看到一个Declarables类，这个类可以包含实现了Declarable的接口的类的实例，而Queue，Exchange，Binding都是实现了这个接口的类。 对于上面对Queue，Exchange，Binding的xml配置，其实都可以使用@Bean的方式实现。这里就写一个使用@Bean注解和Declarable创建绑定的例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key.queue=red:redqueue,white:whitequeue</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Declarables <span class="title function_">bindings</span><span class="params">(<span class="meta">@Value(&quot;$&#123;key.queue&#125;&quot;)</span> List&lt;String&gt; keysAndQueues)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Declarables</span>(keysAndQueues.stream()</span><br><span class="line">            .map(keysAndQueue -&gt; BindingBuilder.bind(keyAndQueue.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]).to(<span class="string">&quot;myExchange&quot;</span>)</span><br><span class="line">            .with(keyAndQueue.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>]))</span><br><span class="line">            .collect(Collectors.toList()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>对于Headers交换器这里就写一个例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;rabbit:headers-exchange　name=&quot;headers-exchange&quot;&gt;</span><br><span class="line">    &lt;rabbit:bindings&gt;</span><br><span class="line">        &lt;rabbit:binding　queue=&quot;header_png_animal&quot;&gt;</span><br><span class="line">            &lt;rabbit:binding-arguments&gt;</span><br><span class="line">                &lt;entrykey=&quot;filetype&quot;value=&quot;png&quot;/&gt;</span><br><span class="line">                &lt;entrykey=&quot;catagory&quot;value=&quot;animal&quot;/&gt;</span><br><span class="line">                &lt;entrykey=&quot;x-match&quot;value=&quot;all&quot;/&gt;</span><br><span class="line">            &lt;/rabbit:binding-arguments&gt;</span><br><span class="line">        &lt;/rabbit:binding&gt;</span><br><span class="line">    &lt;/rabbit:bindings&gt;</span><br><span class="line">&lt;/rabbit:headers-exchange&gt;</span><br></pre></td></tr></table></figure><p></p><p>从1.6版本开始，ExChanges可以设置internal标志。这样的交换机是不能从客户端接收消息的，只能用于死信交换机、与交换机绑定的交换机。 spring-amqp中的注释如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Is an exchange internal; i.e. can&#x27;t be directly published to by a client, used for exchange-to-exchange binding only.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if internal.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isInternal</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><p>注意点：RabbitMQ broker 不允许使用不匹配的参数来声明队列。默认情况下如果出现异常，RabbitAdmin会立即停止所有声明的处理过程，会导致后面监听容器的声明失败。我们可以通过设置RabbitAdmin的<code>ignore-declaration-exceptions</code>为true来让管理类在遇到错误的时候记录并记录执行下面的声明。 可以看到<code>RabbitAdmin</code>类中的<code>logOrRethrowDeclarationException</code>方法中首先会调用<code>publishDeclarationExceptionEvent</code>发布一个<code>DeclarationExceptionEvent</code>事件，紧接着判断<code>ignoreDeclarationExceptions</code>变量，如果是false直接就抛出异常了。</p><h4 id="消费者">消费者</h4><p>消费者是使用的Spring容器创建，可以使用xml或者@Component注解方式创建。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myConsumer1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.zm.service.fanout.MyConsumer1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConsumer1</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MyConsumer1.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Get message: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>创建监听Listener</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--监听容器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;rabbitConnectionFactory&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置文件，消费者监听对应的队列(fanout类型交换器绑定的队列)  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;myConsumer1&quot;</span> <span class="attr">queues</span>=<span class="string">&quot;q1&quot;</span> <span class="attr">method</span>=<span class="string">&quot;onMessage&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;myConsumer2&quot;</span> <span class="attr">queues</span>=<span class="string">&quot;q2&quot;</span> <span class="attr">method</span>=<span class="string">&quot;onMessage&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;myConsumer3&quot;</span> <span class="attr">queues</span>=<span class="string">&quot;q3&quot;</span> <span class="attr">method</span>=<span class="string">&quot;onMessage&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure> 通过这样简单的配置就可以将消费者绑定到对应的队列上。同时在listener结点上，还可以设置的部分属性有： priority：优先级，设置该listener的消费者的优先级。 method：接收到消息的时候调用的方法，如果不设置，那么消费者类应该去实现MessageListener接口。 response-exchange、response-routing-key：如果消息不设置reply-to，但是设置了这两个属性，那么对于上面调用method方法返回的值，将会被发送到response-exchange设置的交换机。 原文注释： response-exchange: <code>The name of the default response Exchange to send response messages to. This will be applied in case of a request message that does not carry a "replyTo" property. Note: This only applies to a listener method with a return value, for which each result object will be converted into a response message.</code> response-routing-key: <code>The routing key to send along with a response message.</code><p></p><p>那么这些消费者是如何绑定到队列上的呢？在上一篇文章说过，所有的操作其实都是调用基本的操作方法实现的。回忆一下，我们在上一篇文章写到消费者绑定到队列上使用的方法是<code>channel.basicConsume(queueName, false, consumer);</code>，那么我们在spring-rabbit的最终目标就是要找到这一行代码，并且了解它是如何被调用的。</p><p>首先，由于使用了xml的配置方式，那么就从xml配置入手。从<code>spring.handles</code>文件找到解析xml所需的所有类，可以在<code>RabbitNamespaceHandler</code>类中看到<code>listener-container</code>对应的解析类为<code>ListenerContainerParser</code>，见下面代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registerBeanDefinitionParser(<span class="string">&quot;listener-container&quot;</span>, <span class="keyword">new</span> <span class="title class_">ListenerContainerParser</span>());</span><br></pre></td></tr></table></figure><p></p><p>进入<code>ListenerContainerParser</code>类，很明显这个类实现了<code>BeanDefinitionParser</code>接口，Spring会调用这个接口的<code>parse</code>方法。我们找到实现了的<code>parse</code>方法，对于<code>group</code>属性我们先不说，那么在<code>parse</code>方法中会调用到这个<code>listener-container</code>中所有的<code>listener</code>的解析，见下面代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LISTENER_ELEMENT</span> <span class="operator">=</span> <span class="string">&quot;listener&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> BeanDefinition <span class="title function_">parse</span><span class="params">(Element element, ParserContext parserContext)</span> &#123;</span><br><span class="line">	<span class="comment">// 解析group属性</span></span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// 获取所有的listener子元素，执行parseListener方法。</span></span><br><span class="line">    List&lt;Element&gt; childElements = DomUtils.getChildElementsByTagName(element, LISTENER_ELEMENT);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; childElements.size(); i++) &#123;</span><br><span class="line">        parseListener(childElements.get(i), element, parserContext, containerList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>熟悉Spring的应该都知道，在做初始化解析xml的时候，就是去根据xml配置的参数去创建一个个BeanDefinition，即创建一个用来描述一个类的类，然后后面Spring再根据这个BeanDefinition的描述去创建类。所以在对于各个listener的解析来说，就是要创建对应的各个BeanDefinition。根据代码我可以找到最终创建的BeanDefinition变量名称是containerDef，而他初始化的方法是使用的工具类<code>RabbitNamespaceUtils</code>，见下面代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseListener</span><span class="params">(Element listenerEle, Element containerEle, ParserContext parserContext, ManagedList&lt;RuntimeBeanReference&gt; containerList)</span> &#123;</span><br><span class="line">	<span class="comment">// 创建messageListener并设置属性</span></span><br><span class="line">	<span class="type">RootBeanDefinition</span> <span class="variable">listenerDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>();</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// 创建消费者容器并设置属性</span></span><br><span class="line">    <span class="type">BeanDefinition</span> <span class="variable">containerDef</span> <span class="operator">=</span> RabbitNamespaceUtils.parseContainer(containerEle, parserContext);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 向Spring注册BeanDefinition</span></span><br><span class="line">    parserContext.registerBeanComponent(<span class="keyword">new</span> <span class="title class_">BeanComponentDefinition</span>(containerDef, containerBeanName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>进入这个<code>parseContainer</code>方法，可以看到<code>RootBeanDefinition</code>的构造函数中传入的是<code>ListenerContainerFactoryBean.class</code>，后面是将xml配置的参数给BeanDefinition赋值。</p></div><footer class="post-footer"><div><div style="text-align:center;color:#ccc;font-size:14px">-------------　　　　本文结束　<i class="fa fa-flag"></i>　感谢阅读　　　　-------------</div></div><div class="reward-container"><div>请我一杯咖啡吧！</div> <button> 打赏</button><div class="post-reward"><div> <img src="https://myblog-1303447677.file.myqcloud.com/BlogFrame/wechatpay.png" alt=" 微信支付"> <span>微信支付</span></div><div> <img src="https://myblog-1303447677.file.myqcloud.com/BlogFrame/alipay.png" alt=" 支付宝"> <span>支付宝</span></div></div></div><div class="post-tags"><a href="/tags/RabbitMQ/" rel="tag"><i class="fa fa-tag"></i> RabbitMQ</a><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a></div><div class="post-nav"><div class="post-nav-item"><a href="/RabbitMQ/How-to-use-RabbitMQ-1-InstallAndIntroduction-2-NativeUse/" rel="prev" title="RabbitMQ使用指南1,2——简介和安装、原生Java客户端的使用"><i class="fa fa-angle-left"></i> RabbitMQ使用指南1,2——简介和安装、原生Java客户端的使用</a></div><div class="post-nav-item"> <a href="/LeetCode/Leet26_remove-duplicates-from-sorted-array/" rel="next" title="LeetCode 26.Remove Duplicates From Sorted Array">LeetCode 26.Remove Duplicates From Sorted Array<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">zm</span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div><script>var titleTime,OriginTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="来啊快活啊~"+OriginTitle,clearTimeout(titleTime)):(document.title="咚咚咚"+OriginTitle,titleTime=setTimeout(function(){document.title=OriginTitle},2e3))})</script></div></footer><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.2/source/js/comments.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.2/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.2/source/js/motion.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.2/source/js/next-boot.min.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.2/source/js/third-party/math/mathjax.min.js"></script><script src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://zm6666.top/RabbitMQ/How-to-use-RabbitMQ-3-UseWithSpring/"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.2/source/js/third-party/quicklink.min.js"></script><script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"zhaomin6666/BlogUtterances","issue_term":"title","theme":"github-light"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.2/source/js/third-party/comments/utterances.min.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0}})</script></body></html>