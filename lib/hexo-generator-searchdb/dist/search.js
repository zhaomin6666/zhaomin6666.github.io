class LocalSearch{constructor({path:t="",unescape:e=!1,top_n_per_article:r=1}){this.path=t,this.unescape=e,this.top_n_per_article=r,this.isfetched=!1,this.datas=null}getIndexByWord(t,h,s=!1){const i=[],o=new Set;return s||(h=h.toLowerCase()),t.forEach(e=>{this.unescape&&((t=document.createElement("div")).innerText=e,e=t.innerHTML);var t,r=e.length;if(0!==r){let t=0;var n;for(s||(e=e.toLowerCase());-1<(n=h.indexOf(e,t));)i.push({position:n,word:e}),o.add(e),t=n+r}}),i.sort((t,e)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length),[i,o]}mergeIntoSlice(t,e,r){var n;let{position:h,word:s}=r[0];for(var i=[],o=new Set;h+s.length<=e&&0!==r.length;){o.add(s),i.push({position:h,length:s.length});var a=h+s.length;for(r.shift();0!==r.length&&(n=r[0],h=n.position,s=n.word,a>h);)r.shift()}return{hits:i,start:t,end:e,count:o.size}}highlightKeyword(t,e){let r="",n=e.start;for(var{position:h,length:s}of e.hits)r+=t.substring(n,h),n=h+s,r+=`<mark class="search-keyword">${t.substr(h,s)}</mark>`;return r+=t.substring(n,e.end)}getResultItems(g){const u=[];return this.datas.forEach(({title:r,content:n,url:h})=>{var[s,i]=this.getIndexByWord(g,r),[o,a]=this.getIndexByWord(g,n),i=new Set([...i,...a]).size,a=s.length+o.length;if(0!==a){var l=[];0!==s.length&&l.push(this.mergeIntoSlice(0,r.length,s));let t=[];for(;0!==o.length;){var c=o[0]["position"],d=Math.max(0,c-20),c=Math.min(n.length,c+80);t.push(this.mergeIntoSlice(d,c,o))}t.sort((t,e)=>t.count!==e.count?e.count-t.count:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start);s=parseInt(this.top_n_per_article,10);0<=s&&(t=t.slice(0,s));let e="";(h=new URL(h,location.origin)).searchParams.append("highlight",g.join(" ")),e+=0!==l.length?`<li><a href="${h.href}" class="search-result-title">${this.highlightKeyword(r,l[0])}</a>`:`<li><a href="${h.href}" class="search-result-title">${r}</a>`,t.forEach(t=>{e+=`<a href="${h.href}"><p class="search-result">${this.highlightKeyword(n,t)}...</p></a>`}),e+="</li>",u.push({item:e,id:u.length,hitCount:a,includedCount:i})}}),u}fetchData(){const e=!this.path.endsWith("json");fetch(this.path).then(t=>t.text()).then(t=>{this.isfetched=!0,this.datas=e?[...(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("entry")].map(t=>({title:t.querySelector("title").textContent,content:t.querySelector("content").textContent,url:t.querySelector("url").textContent})):JSON.parse(t),this.datas=this.datas.filter(t=>t.title).map(t=>(t.title=t.title.trim(),t.content=t.content?t.content.trim().replace(/<[^>]+>/g,""):"",t.url=decodeURIComponent(t.url).replace(/\/{2,}/g,"/"),t)),window.dispatchEvent(new Event("search:loaded"))})}highlightText(e,t,r){var n=e.nodeValue;let h=t.start;var s,i,o=[];for({position:s,length:i}of t.hits){var a=document.createTextNode(n.substring(h,s)),l=(h=s+i,document.createElement("mark"));l.className=r,l.appendChild(document.createTextNode(n.substr(s,i))),o.push(a,l)}e.nodeValue=n.substring(h,t.end),o.forEach(t=>{e.parentNode.insertBefore(t,e)})}highlightSearchWords(t){var e=new URL(location.href).searchParams.get("highlight");const r=e?e.split(" "):[];if(r.length&&t){for(var n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null),h=[];n.nextNode();)n.currentNode.parentNode.matches("button, select, textarea, .mermaid")||h.push(n.currentNode);h.forEach(t=>{var[e]=this.getIndexByWord(r,t.nodeValue);e.length&&(e=this.mergeIntoSlice(0,t.nodeValue.length,e),this.highlightText(t,e,"search-keyword"))})}}}