!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(mg,pg){"use strict";try{!function(){var c,n=(n=mg)&&"object"==typeof n&&"default"in n?n:{default:n};function s(n){var r=[];let i=0;for(let t=0;t<n.length;t++){let e=n.charCodeAt(t);e<128?r[i++]=e:(e<2048?r[i++]=e>>6|192:(55296==(64512&e)&&t+1<n.length&&56320==(64512&n.charCodeAt(t+1))?(e=65536+((1023&e)<<10)+(1023&n.charCodeAt(++t)),r[i++]=e>>18|240,r[i++]=e>>12&63|128):r[i++]=e>>12|224,r[i++]=e>>6&63|128),r[i++]=63&e|128)}return r}const a={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();var i=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let n=0;n<r.length;n+=3){var a=r[n],o=n+1<r.length,u=o?r[n+1]:0,h=n+2<r.length,l=h?r[n+2]:0;let e=(15&u)<<2|l>>6,t=63&l;h||(t=64,o)||(e=64),s.push(i[a>>2],i[(3&a)<<4|u>>4],i[e],i[t])}return s.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(s(e),t)},decodeString(n,r){if(this.HAS_NATIVE_SUPPORT&&!r)return atob(n);{var i=this.decodeStringToByteArray(n,r),s=[];let e=0,t=0;for(;e<i.length;){var a,o,u=i[e++];u<128?s[t++]=String.fromCharCode(u):191<u&&u<224?(a=i[e++],s[t++]=String.fromCharCode((31&u)<<6|63&a)):239<u&&u<365?(o=((7&u)<<18|(63&i[e++])<<12|(63&i[e++])<<6|63&i[e++])-65536,s[t++]=String.fromCharCode(55296+(o>>10)),s[t++]=String.fromCharCode(56320+(1023&o))):(a=i[e++],o=i[e++],s[t++]=String.fromCharCode((15&u)<<12|(63&a)<<6|63&o))}return s.join("")}},decodeStringToByteArray(t,e){this.init_();var n=e?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let e=0;e<t.length;){var i=n[t.charAt(e++)],s=e<t.length?n[t.charAt(e)]:0,a=++e<t.length?n[t.charAt(e)]:64,o=++e<t.length?n[t.charAt(e)]:64;if(++e,null==i||null==s||null==a||null==o)throw new u;r.push(i<<2|s>>4),64!==a&&(r.push(s<<4&240|a>>2),64!==o)&&r.push(a<<6&192|o)}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),(this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e)>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class u extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}function U(e){return e=s(e),a.encodeByteArray(e,!0).replace(/\./g,"")}const q=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,j=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return a.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}};function G(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function K(){return!function(){var e=null==(e=(()=>{try{return q()||("undefined"!=typeof process&&void 0!==process.env&&(e=process.env.__FIREBASE_DEFAULTS__)?JSON.parse(e):void 0)||j()}catch(e){console.info("Unable to get __FIREBASE_DEFAULTS__ due to: "+e)}var e})())?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class z extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,z.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Q.prototype.create)}}class Q{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,t=t[0]||{},n=this.service+"/"+e,e=(e=this.errors[e])?(r=t,e.replace($,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",e=this.serviceName+`: ${e} (${n}).`;return new z(n,e,t)}}const $=/\{\$([^}]+)}/g;function v(e){return e&&e._delegate?e._delegate:e}class H{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(Or=c=c||{})[Or.DEBUG=0]="DEBUG",Or[Or.VERBOSE=1]="VERBOSE",Or[Or.INFO=2]="INFO",Or[Or.WARN=3]="WARN",Or[Or.ERROR=4]="ERROR",Or[Or.SILENT=5]="SILENT";const W={debug:c.DEBUG,verbose:c.VERBOSE,info:c.INFO,warn:c.WARN,error:c.ERROR,silent:c.SILENT},Y=c.INFO,X={[c.DEBUG]:"log",[c.VERBOSE]:"log",[c.INFO]:"info",[c.WARN]:"warn",[c.ERROR]:"error"},J=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),i=X[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)}};var Z="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},x=Z||self;function ee(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function te(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}Math.random();function ne(e,t,n){return e.call.apply(e.bind,arguments)}function re(t,n,e){var r;if(t)return 2<arguments.length?(r=Array.prototype.slice.call(arguments,2),function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}):function(){return t.apply(n,arguments)};throw Error()}function ie(e,t,n){return(ie=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ne:re).apply(null,arguments)}function se(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function e(e,s){function t(){}t.prototype=s.prototype,e.$=s.prototype,e.prototype=new t,(e.prototype.constructor=e).ac=function(e,t,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return s.prototype[t].apply(e,r)}}function ae(){this.s=this.s,this.o=this.o}ae.prototype.s=!1,ae.prototype.sa=function(){this.s||(this.s=!0,this.N())},ae.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const oe=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(t,n){if("string"==typeof t)return"string"!=typeof n||1!=n.length?-1:t.indexOf(n,0);for(let e=0;e<t.length;e++)if(e in t&&t[e]===n)return e;return-1};function ue(t){var n=t.length;if(0<n){var r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function he(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(ee(n)){var r=t.length||0,i=n.length||0;t.length=r+i;for(let e=0;e<i;e++)t[r+e]=n[e]}else t.push(n)}}function le(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}le.prototype.h=function(){this.defaultPrevented=!0};var ce=function(){if(!x.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{x.addEventListener("test",()=>{},t),x.removeEventListener("test",()=>{},t)}catch(e){}return e}();function de(e){return/^[\s\xa0]*$/.test(e)}function fe(){var e=x.navigator;return e&&e.userAgent||""}function ge(e){return-1!=fe().indexOf(e)}function me(e){return me[" "](e),e}me[" "]=function(){};var pe=ge("Opera"),ye=ge("Trident")||ge("MSIE"),t=ge("Edge"),ve=t||ye,we=ge("Gecko")&&!(-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge"))&&!(ge("Trident")||ge("MSIE"))&&!ge("Edge"),_e=-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge");function be(){var e=x.document;return e?e.documentMode:void 0}var Ie="",Ee=(Ee=fe(),we?/rv:([^\);]+)(\)|;)/.exec(Ee):t?/Edge\/([\d\.]+)/.exec(Ee):ye?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(Ee):_e?/WebKit\/(\S+)/.exec(Ee):pe?/(?:Version)[ \/]?(\S+)/.exec(Ee):void 0),Te=((Ee&&(Ie=Ee?Ee[1]:""),ye&&null!=(Ee=be())&&Ee>parseFloat(Ie))?cg=String(Ee):cg=Ie,x.document&&ye&&(be()||parseInt(cg,10))||void 0);function Se(e,t){if(le.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(we){e:{try{me(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:xe[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&Se.$.h.call(this)}}e(Se,le);var xe={2:"touch",3:"pen",4:"mouse"},Ce=(Se.prototype.h=function(){Se.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1},"closure_listenable_"+(1e6*Math.random()|0)),Ae=0;function De(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.la=i,this.key=++Ae,this.fa=this.ia=!1}function Ne(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function ke(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function Re(e){var t={};for(const n in e)t[n]=e[n];return t}const Me="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Oe(t){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e])t[n]=r[n];for(let e=0;e<Me.length;e++)n=Me[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function Le(e){this.src=e,this.g={},this.h=0}function Fe(e,t){var n,r,i,s=t.type;s in e.g&&(n=e.g[s],(i=0<=(r=oe(n,t)))&&Array.prototype.splice.call(n,r,1),i)&&(Ne(t),0==e.g[s].length)&&(delete e.g[s],e.h--)}function Pe(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.fa&&s.listener==t&&s.capture==!!n&&s.la==r)return i}return-1}Le.prototype.add=function(e,t,n,r,i){var s=e.toString(),a=((e=this.g[s])||(e=this.g[s]=[],this.h++),Pe(e,t,r,i));return-1<a?(t=e[a],n||(t.ia=!1)):((t=new De(t,this.src,s,!!r,i)).ia=n,e.push(t)),t};var Ve="closure_lm_"+(1e6*Math.random()|0),Be={};function Ue(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var a=te(i)?!!i.capture:!!i,o=Ke(e);if(o||(e[Ve]=o=new Le(e)),!(n=o.add(t,n,r,a,s)).proxy)if(r=function(){const n=Ge;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(i=ce?i:a)&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(je(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function qe(e){var t,n,r;"number"!=typeof e&&e&&!e.fa&&((t=e.src)&&t[Ce]?Fe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(je(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Ke(t))?(Fe(n,e),0==n.h&&(n.src=null,t[Ve]=null)):Ne(e)))}function je(e){return e in Be?Be[e]:Be[e]="on"+e}function Ge(e,t){var n,r;return!!e.fa||(t=new Se(t,this),n=e.listener,r=e.la||e.src,e.ia&&qe(e),n.call(r,t))}function Ke(e){return(e=e[Ve])instanceof Le?e:null}var ze="__closure_events_fn_"+(1e9*Math.random()>>>0);function Qe(t){return"function"==typeof t?t:(t[ze]||(t[ze]=function(e){return t.handleEvent(e)}),t[ze])}function i(){ae.call(this),this.i=new Le(this),(this.S=this).J=null}function $e(e,t){var n,r=e.J;if(r)for(n=[];r;r=r.J)n.push(r);if(e=e.S,r=t.type||t,"string"==typeof t?t=new le(t,e):t instanceof le?t.target=t.target||e:(a=t,Oe(t=new le(r,e),a)),a=!0,n)for(var i=n.length-1;0<=i;i--)var s=t.g=n[i],a=He(s,r,!0,t)&&a;if(a=He(s=t.g=e,r,!0,t)&&a,a=He(s,r,!1,t)&&a,n)for(i=0;i<n.length;i++)a=He(s=t.g=n[i],r,!1,t)&&a}function He(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var a,o,u=t[s];u&&!u.fa&&u.capture==n&&(a=u.listener,o=u.la||u.src,u.ia&&Fe(e.i,u),i=!1!==a.call(o,r)&&i)}return i&&!r.defaultPrevented}e(i,ae),i.prototype[Ce]=!0,i.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,s){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);else i=te(i)?!!i.capture:!!i,r=Qe(r),t&&t[Ce]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=Pe(a=t.g[n],r,i,s))&&(Ne(a[r]),Array.prototype.splice.call(a,r,1),0==a.length)&&(delete t.g[n],t.h--)):(t=t&&Ke(t))&&(n=t.g[n.toString()],r=(t=-1)<(t=n?Pe(n,r,i,s):t)?n[t]:null)&&qe(r)}(this,e,t,n,r)},i.prototype.N=function(){if(i.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)Ne(n[r]);delete t.g[e],t.h--}}this.J=null},i.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},i.prototype.P=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var We=x.JSON.stringify,Ye=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Xe,e=>e.reset());class Xe{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let Je,Ze=!1,et=new class{constructor(){this.h=this.g=null}add(e,t){var n=Ye.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},tt=()=>{const e=x.Promise.resolve(void 0);Je=()=>{e.then(nt)}};var nt=()=>{for(var e;e=function(){var e=et;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){x.setTimeout(()=>{throw e},0)}(e)}var t=Ye;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Ze=!1};function rt(e,t){i.call(this),this.h=e||1,this.g=t||x,this.j=ie(this.qb,this),this.l=Date.now()}function it(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function st(e,t,n){if("function"==typeof e)n&&(e=ie(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=ie(e.handleEvent,e)}return 2147483647<Number(t)?-1:x.setTimeout(e,t||0)}e(rt,i),(t=rt.prototype).ga=!1,t.T=null,t.qb=function(){var e;this.ga&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),$e(this,"tick"),this.ga&&(it(this),this.start())))},t.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},t.N=function(){rt.$.N.call(this),it(this),delete this.g};class at extends ae{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=st(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(x.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ot(e){ae.call(this),this.h=e,this.g={}}e(ot,ae);var ut=[];function ht(e,t,n,r){Array.isArray(n)||(n&&(ut[0]=n.toString()),n=ut);for(var i=0;i<n.length;i++){var s=function e(t,n,r,i,s){if(i&&i.once)return function e(t,n,r,i,s){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}return r=Qe(r),t&&t[Ce]?t.P(n,r,te(i)?!!i.capture:!!i,s):Ue(t,n,r,!0,i,s)}(t,n,r,i,s);if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}return r=Qe(r),t&&t[Ce]?t.O(n,r,te(i)?!!i.capture:!!i,s):Ue(t,n,r,!1,i,s)}(t,n[i],r||e.handleEvent,!1,e.h||e);if(!s)break;e.g[s.key]=s}}function lt(e){ke(e.g,function(e,t){this.g.hasOwnProperty(t)&&qe(e)},e),e.g={}}function ct(){this.g=!0}function dt(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var i=r[1];if(Array.isArray(i)&&!(i.length<1)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<i.length;a++)i[a]=""}}}return We(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}ot.prototype.N=function(){ot.$.N.call(this),lt(this)},ot.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ct.prototype.Ea=function(){this.g=!1},ct.prototype.info=function(){};var ft={},gt=null;function mt(){return gt=gt||new i}function pt(e){le.call(this,ft.Ta,e)}function yt(){var e=mt();$e(e,new pt(e))}function vt(e,t){le.call(this,ft.STAT_EVENT,e),this.stat=t}function wt(e){var t=mt();$e(t,new vt(t,e))}function _t(e,t){le.call(this,ft.Ua,e),this.size=t}function bt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return x.setTimeout(function(){e()},t)}ft.Ta="serverreachability",e(pt,le),ft.STAT_EVENT="statevent",e(vt,le),ft.Ua="timingevent",e(_t,le);_e={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},pe={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function It(){}function Et(e){return e.h||(e.h=e.i())}function Tt(){}function St(){le.call(this,"d")}function xt(){le.call(this,"c")}function Ct(){}function At(e,t,n,r){this.l=e,this.j=t,this.m=n,this.W=r||1,this.U=new ot(this),this.P=kt,this.V=new rt(e=ve?125:void 0),this.I=null,this.i=!1,this.s=this.A=this.v=this.L=this.G=this.Y=this.B=null,this.F=[],this.g=null,this.C=0,this.o=this.u=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new Dt}function Dt(){this.i=null,this.g="",this.h=!1}It.prototype.h=null,Z={OPEN:"a",vb:"b",Ra:"c",Hb:"d"},e(St,le),e(xt,le),e(Ct,It),Ct.prototype.g=function(){return new XMLHttpRequest},Ct.prototype.i=function(){return{}};var Nt=new Ct,kt=45e3,Rt={},Mt={};function Ot(e,t,n){e.L=1,e.v=Xt($t(t)),e.s=n,e.S=!0,Lt(e,null)}function Lt(e,t){e.G=Date.now(),Vt(e),e.A=$t(e.v);var a,o,u,h,l,c,n=e.A,r=e.W;Array.isArray(r)||(r=[String(r)]),cn(n.i,"t",r),e.C=0,n=e.l.J,e.h=new Dt,e.g=hr(e.l,n?t:null,!e.s),0<e.O&&(e.M=new at(ie(e.Pa,e,e.g),e.O)),ht(e.U,e.g,"readystatechange",e.nb),t=e.I?Re(e.I):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.A,e.u,e.s,t)):(e.u="GET",e.g.ha(e.A,e.u,null,t)),yt(),a=e.j,o=e.u,u=e.A,h=e.m,l=e.W,c=e.s,a.info(function(){if(a.g)if(c)for(var e="",t=c.split("&"),n=0;n<t.length;n++){var r,i,s=t[n].split("=");1<s.length&&(r=s[0],s=s[1],e=2<=(i=r.split("_")).length&&"type"==i[1]?e+(r+"=")+s+"&":e+(r+"=redacted&"))}else e=null;else e=c;return"XMLHTTP REQ ("+h+") [attempt "+l+"]: "+o+"\n"+u+"\n"+e})}function Ft(e){return e.g&&"GET"==e.u&&2!=e.L&&e.l.Ha}function Pt(e,t,n){let r=!0,i;for(;!e.J&&e.C<n.length;){if((i=(0,o=(s=e).C,-1==(u=(a=n).indexOf("\n",o))?Mt:(o=Number(a.substring(o,u)),isNaN(o)?Rt:(u+=1)+o>a.length?Mt:(a=a.slice(u,u+o),s.C=u+o,a))))==Mt){4==t&&(e.o=4,wt(14),r=!1),dt(e.j,e.m,null,"[Incomplete Response]");break}if(i==Rt){e.o=4,wt(15),dt(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}dt(e.j,e.m,i,null),Gt(e,i)}var s,a,o,u;Ft(e)&&i!=Mt&&i!=Rt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,wt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e)&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),tr(t),t.M=!0,wt(11)):(dt(e.j,e.m,n,"[Invalid Chunked Response]"),jt(e),qt(e))}function Vt(e){e.Y=Date.now()+e.P,Bt(e,e.P)}function Bt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=bt(ie(e.lb,e),t)}function Ut(e){e.B&&(x.clearTimeout(e.B),e.B=null)}function qt(e){0==e.l.H||e.J||ir(e.l,e)}function jt(e){Ut(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,it(e.V),lt(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function Gt(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||yn(n.i,e)))if(!e.K&&yn(n.i,e)&&3==n.H){try{var r=n.Ja.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;rr(n),$n(n)}er(n),wt(18)}}else n.Fa=i[1],0<n.Fa-n.V&&i[2]<37500&&n.G&&0==n.A&&!n.v&&(n.v=bt(ie(n.ib,n),6e3));if(pn(n.i)<=1&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else ar(n,11)}else if(!e.K&&n.g!=e||rr(n),!de(t))for(i=n.Ja.g.parse(t),t=0;t<i.length;t++){var s,a,o,u,h,l,c,d,f,g,m=i[t];n.V=m[0],m=m[1],2==n.H?"c"==m[0]?(n.K=m[1],n.pa=m[2],null!=(s=m[3])&&(n.ra=s,n.l.info("VER="+n.ra)),null!=(a=m[4])&&(n.Ga=a,n.l.info("SVER="+n.Ga)),null!=(h=m[5])&&"number"==typeof h&&0<h&&(r=1.5*h,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n,(l=e.g)&&(!(c=l.g?l.g.getResponseHeader("X-Client-Wire-Protocol"):null)||(o=r.i).g||-1==c.indexOf("spdy")&&-1==c.indexOf("quic")&&-1==c.indexOf("h2")||(o.j=o.l,o.g=new Set,o.h&&(vn(o,o.h),o.h=null)),r.F)&&(u=l.g?l.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.Da=u,p(r.I,r.F,u)),n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms")),g=e,(r=n).wa=ur(r,r.J?r.pa:null,r.Y),g.K?(wn(r.i,g),d=g,(f=r.L)&&d.setTimeout(f),d.B&&(Ut(d),Vt(d)),r.g=g):Zn(r),0<n.j.length&&Wn(n)):"stop"!=m[0]&&"close"!=m[0]||ar(n,7):3==n.H&&("stop"==m[0]||"close"==m[0]?"stop"==m[0]?ar(n,7):Qn(n):"noop"!=m[0]&&n.h&&n.h.Aa(m),n.A=0)}yt()}catch(e){}}function Kt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(ee(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(ee(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n)}else{t=[],n=0;for(const r in e)t[n++]=r}return t}}}(e),r=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(ee(e))for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);else for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],n&&n[s],e)}(t=At.prototype).setTimeout=function(e){this.P=e},t.nb=function(e){e=e.target;var t=this.M;t&&3==Un(e)?t.l():this.Pa(e)},t.Pa=function(e){try{if(e==this.g)e:{var t=Un(this.g),n=this.g.Ia();if(this.g.da(),!(t<3)&&(3!=t||ve||this.g&&(this.h.h||this.g.ja()||qn(this.g)))){this.J||4!=t||7==n||yt(),Ut(this);var r=this.g.da();this.ca=r;t:if(Ft(this)){var i=qn(this.g),s=(e="",i.length),a=4==Un(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){jt(this),qt(this);var o="";break t}this.h.i=new x.TextDecoder}for(n=0;n<s;n++)this.h.h=!0,e+=this.h.i.decode(i[n],{stream:a&&n==s-1});i.splice(0,s),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.ja();if(this.i=200==r,v=this.j,w=this.u,_=this.A,b=this.m,I=this.W,E=t,T=r,v.info(function(){return"XMLHTTP RESP ("+b+") [ attempt "+I+"]: "+w+"\n"+_+"\n"+E+" "+T}),this.i){if(this.aa&&!this.K){t:{if(this.g){var u,h=this.g;if((u=h.g?h.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!de(u)){var l=u;break t}}l=null}if(!(r=l)){this.i=!1,this.o=3,wt(12),jt(this),qt(this);break e}dt(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Gt(this,r)}this.S?(Pt(this,t,o),ve&&this.i&&3==t&&(ht(this.U,this.V,"tick",this.mb),this.V.start())):(dt(this.j,this.m,o,null),Gt(this,o)),4==t&&jt(this),this.i&&!this.J&&(4==t?ir(this.l,this):(this.i=!1,Vt(this)))}else{{var c=this.g;var d,f,g,m={};c=(c.g&&2<=Un(c)&&c.g.getAllResponseHeaders()||"").split("\r\n");for(let e=0;e<c.length;e++)de(c[e])||(d=(f=function(e){for(var t=1,n=(e=e.split(":"),[]);0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(c[e]))[0],"string"==typeof(f=f[1])&&(f=f.trim(),g=m[d]||[],(m[d]=g).push(f)));function p(e){return e.join(", ")}var y=m;for(const S in y)p.call(void 0,y[S],S,y)}400==r&&0<o.indexOf("Unknown SID")?(this.o=3,wt(12)):(this.o=0,wt(13)),jt(this),qt(this)}}}}catch(e){}var v,w,_,b,I,E,T},t.mb=function(){var e,t;this.g&&(e=Un(this.g),t=this.g.ja(),this.C<t.length)&&(Ut(this),Pt(this,e,t),this.i)&&4!=e&&Vt(this)},t.cancel=function(){this.J=!0,jt(this)},t.lb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.L&&(yt(),wt(17)),jt(this),this.o=2,qt(this)):Bt(this,this.Y-n)};var zt=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Qt(e){var t,n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof Qt?(this.h=e.h,Ht(this,e.j),this.s=e.s,this.g=e.g,Wt(this,e.m),this.l=e.l,t=e.i,(n=new on).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Yt(this,n),this.o=e.o):e&&(t=String(e).match(zt))?(this.h=!1,Ht(this,t[1]||"",!0),this.s=Jt(t[2]||""),this.g=Jt(t[3]||"",!0),Wt(this,t[4]),this.l=Jt(t[5]||"",!0),Yt(this,t[6]||"",!0),this.o=Jt(t[7]||"")):(this.h=!1,this.i=new on(null,this.h))}function $t(e){return new Qt(e)}function Ht(e,t,n){e.j=n?Jt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Wt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Yt(e,t,n){var r,i;t instanceof on?(e.i=t,r=e.i,(i=e.h)&&!r.j&&(un(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(hn(this,t),cn(this,n,e))},r)),r.j=i):(n||(t=Zt(t,sn)),e.i=new on(t,e.h))}function p(e,t,n){e.i.set(t,n)}function Xt(e){return p(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Jt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Zt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,en),n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function en(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Qt.prototype.toString=function(){var e=[],t=this.j,n=(t&&e.push(Zt(t,tn,!0),":"),this.g);return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Zt(t,tn,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Zt(n,"/"==n.charAt(0)?rn:nn,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Zt(n,an)),e.join("")};var tn=/[#\/\?@]/g,nn=/[#\?:]/g,rn=/[#\?]/g,sn=/[#\?@]/g,an=/#/g;function on(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function un(e){if(!e.g&&(e.g=new Map,e.h=0,e.i)){var t=e.i;if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,i=t[n].indexOf("="),s=null;0<=i?(r=t[n].substring(0,i),s=t[n].substring(i+1)):r=t[n],i=r,s=s?decodeURIComponent(s.replace(/\+/g," ")):"",e.add(decodeURIComponent(i.replace(/\+/g," ")),s)}}}}function hn(e,t){un(e),t=dn(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function ln(e,t){return un(e),t=dn(e,t),e.g.has(t)}function cn(e,t,n){hn(e,t),0<n.length&&(e.i=null,e.g.set(dn(e,t),ue(n)),e.h+=n.length)}function dn(e,t){return t=String(t),e.j?t.toLowerCase():t}(t=on.prototype).add=function(e,t){un(this),this.i=null,e=dn(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},t.forEach=function(n,r){un(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},t.ta=function(){un(this);var e=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let t=0;t<n.length;t++){var i=e[t];for(let e=0;e<i.length;e++)r.push(n[t])}return r},t.Z=function(t){un(this);let n=[];if("string"==typeof t)ln(this,t)&&(n=n.concat(this.g.get(dn(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},t.set=function(e,t){return un(this),this.i=null,ln(this,e=dn(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},t.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},t.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var e=[],t=Array.from(this.g.keys()),n=0;n<t.length;n++)for(var r=t[n],i=encodeURIComponent(String(r)),s=this.Z(r),r=0;r<s.length;r++){var a=i;""!==s[r]&&(a+="="+encodeURIComponent(String(s[r]))),e.push(a)}return this.i=e.join("&")};var fn=class{constructor(e,t){this.g=e,this.map=t}};function gn(e){this.l=e||10,e=x.PerformanceNavigationTiming?0<(e=x.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(x.g&&x.g.Ka&&x.g.Ka()&&x.g.Ka().dc),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function mn(e){return e.h||e.g&&e.g.size>=e.j}function pn(e){return e.h?1:e.g?e.g.size:0}function yn(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function vn(e,t){e.g?e.g.add(t):e.h=t}function wn(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function _n(t){if(null!=t.h)return t.i.concat(t.h.F);if(null==t.g||0===t.g.size)return ue(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}}gn.prototype.cancel=function(){if(this.i=_n(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var bn,In=class{stringify(e){return x.JSON.stringify(e,void 0)}parse(e){return x.JSON.parse(e,void 0)}};function En(){this.g=new In}function Tn(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}function Sn(e){this.l=e.ec||null,this.j=e.ob||!1}function xn(e,t){i.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=Cn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}e(Sn,It),Sn.prototype.g=function(){return new xn(this.l,this.j)},Sn.prototype.i=(bn={},function(){return bn}),e(xn,i);var Cn=0;function An(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function Dn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,Nn(e)}function Nn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(t=xn.prototype).open=function(e,t){if(this.readyState!=Cn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,Nn(this)},t.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;var t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||x).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},t.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Dn(this)),this.readyState=Cn},t.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,Nn(this)),this.g)&&(this.readyState=3,Nn(this),this.g))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==x.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;An(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},t.Xa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):!this.u&&(t=e.value||new Uint8Array(0),t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t),(e.done?Dn:Nn)(this),3==this.readyState)&&An(this)},t.Za=function(e){this.g&&(this.response=this.responseText=e,Dn(this))},t.Ya=function(e){this.g&&(this.response=e,Dn(this))},t.ka=function(){this.g&&Dn(this)},t.setRequestHeader=function(e,t){this.v.append(e,t)},t.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},t.getAllResponseHeaders=function(){if(!this.h)return"";for(var e=[],t=this.h.entries(),n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(xn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var kn=x.JSON.parse;function r(e){i.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=Rn,this.L=this.M=!1}e(r,i);var Rn="",Mn=/^https?$/i,On=["POST","PUT"];function Ln(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Fn(e),Vn(e)}function Fn(e){e.F||(e.F=!0,$e(e,"complete"),$e(e,"error"))}function Pn(e){if(e.h&&(!e.C[1]||4!=Un(e)||2!=e.da()))if(e.v&&4==Un(e))st(e.La,0,e);else if($e(e,"readystatechange"),4==Un(e)){e.h=!1;try{var t,n,r,i=e.da();switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var s=!0;break;default:s=!1}if((t=s)||((n=0===i)&&(!(r=String(e.I).match(zt)[1]||null)&&x.self&&x.self.location&&(r=x.self.location.protocol.slice(0,-1)),n=!Mn.test(r?r.toLowerCase():"")),t=n),t)$e(e,"complete"),$e(e,"success");else{e.m=6;try{var a=2<Un(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.da()+"]",Fn(e)}}finally{Vn(e)}}}function Vn(e,t){if(e.g){Bn(e);var n=e.g,r=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||$e(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Bn(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(x.clearTimeout(e.A),e.A=null)}function Un(e){return e.g?e.g.readyState:0}function qn(e){try{if(e.g){if("response"in e.g)return e.g.response;switch(e.K){case Rn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}}return null}catch(e){return null}}function jn(e){let n="";return ke(e,function(e,t){n=(n=n+t+":")+e+"\r\n"}),n}function Gn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=jn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):p(e,t,n))}function Kn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function zn(e){this.Ga=0,this.j=[],this.l=new ct,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=Kn("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=Kn("baseRetryDelayMs",5e3,e),this.hb=Kn("retryDelaySeedMs",1e4,e),this.eb=Kn("forwardChannelMaxRetries",2,e),this.xa=Kn("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new gn(e&&e.concurrentRequestLimit),this.Ja=new En,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Qn(e){if(Hn(e),3==e.H){var t=e.W++,n=$t(e.I);if(p(n,"SID",e.K),p(n,"RID",t),p(n,"TYPE","terminate"),Xn(e,n),(t=new At(e,e.l,t)).L=2,t.v=Xt($t(n)),n=!1,x.navigator&&x.navigator.sendBeacon)try{n=x.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&x.Image&&((new Image).src=t.v,n=!0),n||(t.g=hr(t.l,null),t.g.ha(t.v)),t.G=Date.now(),Vt(t)}or(e)}function $n(e){e.g&&(tr(e),e.g.cancel(),e.g=null)}function Hn(e){$n(e),e.u&&(x.clearTimeout(e.u),e.u=null),rr(e),e.i.cancel(),e.m&&("number"==typeof e.m&&x.clearTimeout(e.m),e.m=null)}function Wn(e){var t;mn(e.i)||e.m||(e.m=!0,t=e.Na,Je||tt(),Ze||(Je(),Ze=!0),et.add(t,e),e.C=0)}function Yn(e,t){var n=t?t.m:e.W++,r=$t(e.I);p(r,"SID",e.K),p(r,"RID",n),p(r,"AID",e.V),Xn(e,r),e.o&&e.s&&Gn(r,e.o,e.s),n=new At(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=Jn(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),vn(e.i,n),Ot(n,r,t)}function Xn(e,n){e.na&&ke(e.na,function(e,t){p(n,t,e)}),e.h&&Kt({},function(e,t){p(n,t,e)})}function Jn(r,e,i){i=Math.min(r.j.length,i);var s=r.h?ie(r.h.Va,r.h,r):null;e:{var a=r.j;let n=-1;for(;;){var o=["count="+i];-1==n?0<i?(n=a[0].g,o.push("ofs="+n)):n=0:o.push("ofs="+n);let t=!0;for(let e=0;e<i;e++){var u=a[e].g,h=a[e].map;if((u-=n)<0)n=Math.max(0,a[e].g-100),t=!1;else try{!function(e,r){const i="req"+u+"_"||"";try{Kt(e,function(e,t){let n=e;te(e)&&(n=We(e)),r.push(i+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(i+"type="+encodeURIComponent("_badmap")),e}}(h,o)}catch(r){s&&s(h)}}if(t){s=o.join("&");break e}}}return r=r.j.splice(0,i),e.F=r,s}function Zn(e){var t;e.g||e.u||(e.ba=1,t=e.Ma,Je||tt(),Ze||(Je(),Ze=!0),et.add(t,e),e.A=0)}function er(e){return!(e.g||e.u||3<=e.A)&&(e.ba++,e.u=bt(ie(e.Ma,e),sr(e,e.A)),e.A++,1)}function tr(e){null!=e.B&&(x.clearTimeout(e.B),e.B=null)}function nr(e){e.g=new At(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=$t(e.wa),n=(p(t,"RID","rpc"),p(t,"SID",e.K),p(t,"AID",e.V),p(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&p(t,"TO",e.qa),p(t,"TYPE","xmlhttp"),Xn(e,t),e.o&&e.s&&Gn(t,e.o,e.s),e.L&&e.g.setTimeout(e.L),e.g);e=e.pa,n.L=1,n.v=Xt($t(t)),n.s=null,n.S=!0,Lt(n,e)}function rr(e){null!=e.v&&(x.clearTimeout(e.v),e.v=null)}function ir(e,t){var n,r,i,s=null;if(e.g==t){rr(e),tr(e),e.g=null;var a=2}else{if(!yn(e.i,t))return;s=t.F,wn(e.i,t),a=1}if(0!=e.H)if(t.i)(1==a?(s=t.s?t.s.length:0,t=Date.now()-t.G,n=e.C,$e(a=mt(),new _t(a,s)),Wn):Zn)(e);else if(3==(n=t.o)||0==n&&0<t.ca||(1!=a||(i=t,pn((r=e).i)>=r.i.j-(r.m?1:0))||(r.m?(r.j=i.F.concat(r.j),0):1==r.H||2==r.H||r.C>=(r.cb?0:r.eb)||(r.m=bt(ie(r.Na,r,i),sr(r,r.C)),r.C++,0)))&&(2!=a||!er(e)))switch(s&&0<s.length&&(t=e.i,t.i=t.i.concat(s)),n){case 1:ar(e,5);break;case 4:ar(e,10);break;case 3:ar(e,6);break;default:ar(e,2)}}function sr(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function ar(e,t){if(e.l.info("Error code "+t),2==t){n=null,e.h&&(n=null),r=ie(e.pb,e),n||(n=new Qt("//www.google.com/images/cleardot.gif"),x.location&&"http"==x.location.protocol||Ht(n,"https"),Xt(n));var n=n.toString(),r,i=new ct;if(x.Image){const s=new Image;s.onload=se(Tn,i,s,"TestLoadImage: loaded",!0,r),s.onerror=se(Tn,i,s,"TestLoadImage: error",!1,r),s.onabort=se(Tn,i,s,"TestLoadImage: abort",!1,r),s.ontimeout=se(Tn,i,s,"TestLoadImage: timeout",!1,r),x.setTimeout(function(){s.ontimeout&&s.ontimeout()},1e4),s.src=n}else r(!1)}else wt(2);e.H=0,e.h&&e.h.za(t),or(e),Hn(e)}function or(e){var t;e.H=0,e.ma=[],e.h&&(0==(t=_n(e.i)).length&&0==e.j.length||(he(e.ma,t),he(e.ma,e.j),e.i.i.length=0,ue(e.j),e.j.length=0),e.h.ya())}function ur(e,t,n){var r,i,s=n instanceof Qt?$t(n):new Qt(n);return""!=s.g?(t&&(s.g=t+"."+s.g),Wt(s,s.m)):(s=(r=x.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,i=new Qt(null),s&&Ht(i,s),t&&(i.g=t),r&&Wt(i,r),n&&(i.l=n),s=i),n=e.F,t=e.Da,n&&t&&p(s,n,t),p(s,"VER",e.ra),Xn(e,s),s}function hr(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ha&&!e.va?new r(new Sn({ob:!0})):new r(e.va)).Oa(e.J),t}function lr(){}function cr(){if(ye&&!(10<=Number(Te)))throw Error("Environmental error: no available transport.")}function dr(e,t){i.call(this),this.g=new zn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!de(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!de(t)&&(this.g.F=t,null!==(e=this.h))&&t in e&&t in(e=this.h)&&delete e[t],this.j=new mr(this)}function fr(e){St.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function gr(){xt.call(this),this.status=1}function mr(e){this.g=e}function pr(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function yr(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var i=0;i<16;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;i<16;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1];var i=e.g[2],s=e.g[3],a=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+((a=t+(s^n&(i^s))+r[0]+3614090360&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((s=(t=n+((a=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((i=s+((a=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function h(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}(t=r.prototype).Oa=function(e){this.M=e},t.ha=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=(this.u||Nt).g(),this.C=this.u?Et(this.u):Et(Nt),this.g.onreadystatechange=ie(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void Ln(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),i=x.FormData&&e instanceof x.FormData,0<=oe(On,t)&&!r&&!i&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[s,a]of n)this.g.setRequestHeader(s,a);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{Bn(this),0<this.B&&((this.L=(o=this.g,ye&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=ie(this.ua,this)):this.A=st(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){Ln(this,e)}var o},t.ua=function(){this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,$e(this,"timeout"),this.abort(8))},t.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,$e(this,"complete"),$e(this,"abort"),Vn(this))},t.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Vn(this,!0)),r.$.N.call(this)},t.La=function(){this.s||(this.G||this.v||this.l?Pn(this):this.kb())},t.kb=function(){Pn(this)},t.isActive=function(){return!!this.g},t.da=function(){try{return 2<Un(this)?this.g.status:-1}catch(e){return-1}},t.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},t.Wa=function(e){var t;if(this.g)return t=this.g.responseText,e&&0==t.indexOf(e)&&(t=t.substring(e.length)),kn(t)},t.Ia=function(){return this.m},t.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(t=zn.prototype).ra=8,t.H=1,t.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;var n=new At(this,this.l,t);let e=this.s;if(this.U&&(e?Oe(e=Re(e),this.U):e=this.U),null!==this.o||this.O||(n.I=e,e=null),this.P)e:{for(var r=0,i=0;i<this.j.length;i++){var s=this.j[i];if(void 0===(s="__data__"in s.map&&"string"==typeof(s=s.map.__data__)?s.length:void 0))break;if(4096<(r+=s)){r=i;break e}if(4096===r||i===this.j.length-1){r=i+1;break e}}r=1e3}else r=1e3;r=Jn(this,n,r),p(i=$t(this.I),"RID",t),p(i,"CVER",22),this.F&&p(i,"X-HTTP-Session-Id",this.F),Xn(this,i),e&&(this.O?r="headers="+encodeURIComponent(String(jn(e)))+"&"+r:this.o&&Gn(i,this.o,e)),vn(this.i,n),this.bb&&p(i,"TYPE","init"),this.P?(p(i,"$req",r),p(i,"SID","null"),n.aa=!0,Ot(n,i,null)):Ot(n,i,r),this.H=2}}else 3==this.H&&(t?Yn(this,t):0==this.j.length||mn(this.i)||Yn(this))},t.Ma=function(){var e;this.u=null,nr(this),this.ca&&!(this.M||null==this.g||this.S<=0)&&(e=2*this.S,this.l.info("BP detection timer enabled: "+e),this.B=bt(ie(this.jb,this),e))},t.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,wt(10),$n(this),nr(this))},t.ib=function(){null!=this.v&&(this.v=null,$n(this),er(this),wt(19))},t.pb=function(e){e?(this.l.info("Successfully pinged google.com"),wt(2)):(this.l.info("Failed to ping google.com"),wt(1))},t.isActive=function(){return!!this.h&&this.h.isActive(this)},(t=lr.prototype).Ba=function(){},t.Aa=function(){},t.za=function(){},t.ya=function(){},t.isActive=function(){return!0},t.Va=function(){},cr.prototype.g=function(e,t){return new dr(e,t)},e(dr,i),dr.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;wt(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=ur(e,null,e.Y),Wn(e)},dr.prototype.close=function(){Qn(this.g)},dr.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=We(e),e=t),n.j.push(new fn(n.fb++,e)),3==n.H&&Wn(n)},dr.prototype.N=function(){this.g.h=null,delete this.j,Qn(this.g),delete this.g,dr.$.N.call(this)},e(fr,St),e(gr,xt),e(mr,lr),mr.prototype.Ba=function(){$e(this.g,"a")},mr.prototype.Aa=function(e){$e(this.g,new fr(e))},mr.prototype.za=function(e){$e(this.g,new gr)},mr.prototype.ya=function(){$e(this.g,"b")},e(pr,function(){this.blockSize=-1}),pr.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},pr.prototype.j=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.m,i=this.h,s=0;s<t;){if(0==i)for(;s<=n;)yr(this,e,s),s+=this.blockSize;if("string"==typeof e){for(;s<t;)if(r[i++]=e.charCodeAt(s++),i==this.blockSize){yr(this,r),i=0;break}}else for(;s<t;)if(r[i++]=e[s++],i==this.blockSize){yr(this,r),i=0;break}}this.h=i,this.i+=t},pr.prototype.l=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;for(var n=8*this.i,t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var vr={};function wr(e){return-128<=e&&e<128?(t=e,n=function(e){return new h([0|e],e<0?-1:0)},r=vr,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new h([0|e],e<0?-1:0);var t,n,r}function _r(e){if(isNaN(e)||!isFinite(e))return Ir;if(e<0)return Cr(_r(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=br;return new h(t,0)}var br=4294967296,Ir=wr(0),Er=wr(1),Tr=wr(16777216);function Sr(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function xr(e){return-1==e.h}function Cr(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new h(n,~e.h).add(Er)}function Ar(e,t){return e.add(Cr(t))}function Dr(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function Nr(e,t){this.g=e,this.h=t}function kr(e,t){if(Sr(t))throw Error("division by zero");if(Sr(e))return new Nr(Ir,Ir);if(xr(e))return t=kr(Cr(e),t),new Nr(Cr(t.g),Cr(t.h));if(xr(t))return t=kr(e,Cr(t)),new Nr(Cr(t.g),t.h);if(30<e.g.length){if(xr(e)||xr(t))throw Error("slowDivide_ only works with positive integers.");for(var n=Er,r=t;r.X(e)<=0;)n=Rr(n),r=Rr(r);for(var i=Mr(n,1),s=Mr(r,1),r=Mr(r,2),n=Mr(n,2);!Sr(r);){var a=s.add(r);a.X(e)<=0&&(i=i.add(n),s=a),r=Mr(r,1),n=Mr(n,1)}return t=Ar(e,i.R(t)),new Nr(i,t)}for(i=Ir;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),a=(s=_r(n)).R(t);xr(a)||0<a.X(e);)a=(s=_r(n-=r)).R(t);Sr(s)&&(s=Er),i=i.add(s),e=Ar(e,a)}return new Nr(i,e)}function Rr(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.D(r)<<1|e.D(r-1)>>>31;return new h(n,e.h)}function Mr(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,i=[],s=0;s<r;s++)i[s]=0<t?e.D(s+n)>>>t|e.D(s+n+1)<<32-t:e.D(s+n);return new h(i,e.h)}(t=h.prototype).ea=function(){if(xr(this))return-Cr(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.D(n);e+=(0<=r?r:br+r)*t,t*=br}return e},t.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(Sr(this))return"0";if(xr(this))return"-"+Cr(this).toString(e);for(var t=_r(Math.pow(e,6)),n=this,r="";;){var i=kr(n,t).g,s=((0<(n=Ar(n,i.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(Sr(n=i))return s+r;for(;s.length<6;)s="0"+s;r=s+r}},t.D=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},t.X=function(e){return xr(e=Ar(this,e))?-1:Sr(e)?0:1},t.abs=function(){return xr(this)?Cr(this):this},t.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,i=0;i<=t;i++){var s=r+(65535&this.D(i))+(65535&e.D(i)),a=(s>>>16)+(this.D(i)>>>16)+(e.D(i)>>>16),r=a>>>16;n[i]=(a&=65535)<<16|(s&=65535)}return new h(n,-2147483648&n[n.length-1]?-1:0)},t.R=function(e){if(Sr(this)||Sr(e))return Ir;if(xr(this))return xr(e)?Cr(this).R(Cr(e)):Cr(Cr(this).R(e));if(xr(e))return Cr(this.R(Cr(e)));if(this.X(Tr)<0&&e.X(Tr)<0)return _r(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<e.g.length;i++){var s=this.D(r)>>>16,a=65535&this.D(r),o=e.D(i)>>>16,u=65535&e.D(i);n[2*r+2*i]+=a*u,Dr(n,2*r+2*i),n[2*r+2*i+1]+=s*u,Dr(n,2*r+2*i+1),n[2*r+2*i+1]+=a*o,Dr(n,2*r+2*i+1),n[2*r+2*i+2]+=s*o,Dr(n,2*r+2*i+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new h(n,0)},t.gb=function(e){return kr(this,e).h},t.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)&e.D(r);return new h(n,this.h&e.h)},t.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)|e.D(r);return new h(n,this.h|e.h)},t.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)^e.D(r);return new h(n,this.h^e.h)},cr.prototype.createWebChannel=cr.prototype.g,dr.prototype.send=dr.prototype.u,dr.prototype.open=dr.prototype.m,_e.NO_ERROR=0,_e.TIMEOUT=8,_e.HTTP_ERROR=6,pe.COMPLETE="complete",(Tt.EventType=Z).OPEN="a",Z.CLOSE="b",Z.ERROR="c",Z.MESSAGE="d",i.prototype.listen=i.prototype.O,r.prototype.listenOnce=r.prototype.P,r.prototype.getLastError=r.prototype.Sa,r.prototype.getLastErrorCode=r.prototype.Ia,r.prototype.getStatus=r.prototype.da,r.prototype.getResponseJson=r.prototype.Wa,r.prototype.getResponseText=r.prototype.ja,r.prototype.send=r.prototype.ha,r.prototype.setWithCredentials=r.prototype.Oa,pr.prototype.digest=pr.prototype.l,pr.prototype.update=pr.prototype.j,h.prototype.multiply=h.prototype.R,h.prototype.modulo=h.prototype.gb,h.prototype.compare=h.prototype.X,h.prototype.toNumber=h.prototype.ea,h.prototype.getBits=h.prototype.D,h.fromNumber=_r,h.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return Cr(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=_r(Math.pow(n,8)),i=Ir,s=0;s<t.length;s+=8)var a=Math.min(8,t.length-s),o=parseInt(t.substring(s,s+a),n),i=(a<8?(a=_r(Math.pow(n,a)),i.R(a)):i=i.R(r)).add(_r(o));return i};var g,Or,Lr=mt,Fr=_e,Pr=pe,Vr=ft,Br=Tt,Ur=r,qr=pr,jr=h,Ee="@firebase/firestore";class o{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}o.UNAUTHENTICATED=new o(null),o.GOOGLE_CREDENTIALS=new o("google-credentials-uid"),o.FIRST_PARTY=new o("first-party-uid"),o.MOCK_USER=new o("mock-user");let Gr="10.4.0";const Kr=new class{constructor(e){this.name=e,this._logLevel=Y,this._logHandler=J,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in c))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?W[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,c.DEBUG,...e),this._logHandler(this,c.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,c.VERBOSE,...e),this._logHandler(this,c.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,c.INFO,...e),this._logHandler(this,c.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,c.WARN,...e),this._logHandler(this,c.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,c.ERROR,...e),this._logHandler(this,c.ERROR,...e)}}("@firebase/firestore");function zr(){return Kr.logLevel}function m(e,...t){Kr.logLevel<=c.DEBUG&&(t=t.map($r),Kr.debug(`Firestore (${Gr}): `+e,...t))}function d(e,...t){Kr.logLevel<=c.ERROR&&(t=t.map($r),Kr.error(`Firestore (${Gr}): `+e,...t))}function Qr(e,...t){Kr.logLevel<=c.WARN&&(t=t.map($r),Kr.warn(`Firestore (${Gr}): `+e,...t))}function $r(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function b(e="Unexpected state"){e=`FIRESTORE (${Gr}) INTERNAL ASSERTION FAILED: `+e;throw d(e),new Error(e)}function y(e){e||b()}const w={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class _ extends z{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: `+this.message}}class Hr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Wr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization","Bearer "+e)}}class Yr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(o.UNAUTHENTICATED))}shutdown(){}}class Xr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Jr{constructor(e){this.t=e,this.currentUser=o.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const i=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let s=new Hr;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Hr,t.enqueueRetryable(()=>i(this.currentUser))};const a=()=>{const e=s;t.enqueueRetryable(async()=>{await e.promise,await i(this.currentUser)})},o=e=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Hr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(y("string"==typeof e.accessToken),new Wr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return y(null===e||"string"==typeof e),new o(e)}}class Zr{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=o.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);var e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class ei{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new Zr(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(o.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class ti{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class ni{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,n){const r=e=>{null!=e.error&&m("FirebaseAppCheckTokenProvider","Error getting App Check token; using placeholder token instead. Error: "+e.error.message);var t=e.token!==this.R;return this.R=e.token,m("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()},i=(this.o=e=>{t.enqueueRetryable(()=>r(e))},e=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)});this.A.onInit(e=>i(e)),setTimeout(()=>{var e;this.appCheck||((e=this.A.getImmediate({optional:!0}))?i(e):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(y("string"==typeof e.token),this.R=e.token,new ti(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class ri{static V(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var i=function(){var e="undefined"!=typeof self&&(self.crypto||self.msCrypto),t=new Uint8Array(40);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(t);else for(let e=0;e<40;e++)t[e]=Math.floor(256*Math.random());return t}();for(let e=0;e<i.length;++e)r.length<20&&i[e]<n&&(r+=t.charAt(i[e]%t.length))}return r}}function I(e,t){return e<t?-1:t<e?1:0}function ii(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function si(e){return e+"\0"}class l{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new _(w.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new _(w.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new _(w.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new _(w.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return l.fromMillis(Date.now())}static fromDate(e){return l.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),e=Math.floor(1e6*(e-1e3*t));return new l(t,e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?I(this.nanoseconds,e.nanoseconds):I(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class E{constructor(e){this.timestamp=e}static fromTimestamp(e){return new E(e)}static min(){return new E(new l(0,0))}static max(){return new E(new l(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ai{constructor(e,t,n){void 0===t?t=0:t>e.length&&b(),void 0===n?n=e.length-t:n>e.length-t&&b(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===ai.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof ai?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(n){for(let e=this.offset,t=this.limit();e<t;e++)n(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,n){const r=Math.min(t.length,n.length);for(let e=0;e<r;e++){const r=t.get(e),i=n.get(e);if(r<i)return-1;if(r>i)return 1}return t.length<n.length?-1:t.length>n.length?1:0}}class T extends ai{construct(e,t,n){return new T(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){var t=[];for(const n of e){if(0<=n.indexOf("//"))throw new _(w.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new T(t)}static emptyPath(){return new T([])}}const oi=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class f extends ai{construct(e,t,n){return new f(e,t,n)}static isValidIdentifier(e){return oi.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),f.isValidIdentifier(e)?e:"`"+e+"`")).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new f(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var i=()=>{if(0===n.length)throw new _(w.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new _(w.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new _(w.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new _(w.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new f(t)}static emptyPath(){return new f([])}}class S{constructor(e){this.path=e}static fromPath(e){return new S(T.fromString(e))}static fromName(e){return new S(T.fromString(e).popFirst(5))}static empty(){return new S(T.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===T.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return T.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new S(new T(e.slice()))}}class ui{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function hi(e){return e.fields.find(e=>2===e.kind)}function li(e){return e.fields.filter(e=>2!==e.kind)}ui.UNKNOWN_ID=-1;class ci{constructor(e,t){this.fieldPath=e,this.kind=t}}class di{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new di(0,mi.min())}}function fi(e,t){var n=e.toTimestamp().seconds,e=e.toTimestamp().nanoseconds+1,e=E.fromTimestamp(1e9===e?new l(n+1,0):new l(n,e));return new mi(e,S.empty(),t)}function gi(e){return new mi(e.readTime,e.key,-1)}class mi{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new mi(E.min(),S.empty(),-1)}static max(){return new mi(E.max(),S.empty(),-1)}}function pi(e,t){var n=e.readTime.compareTo(t.readTime);return 0!==n||0!==(n=S.comparator(e.documentKey,t.documentKey))?n:I(e.largestBatchId,t.largestBatchId)}const yi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class vi{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function wi(e){if(e.code!==w.FAILED_PRECONDITION||e.message!==yi)throw e;m("LocalStore","Unexpectedly lost primary lease")}class C{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,i){return this.callbackAttached&&b(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new C((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(i,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof C?t:C.resolve(t)}catch(e){return C.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):C.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):C.reject(t)}static resolve(n){return new C((e,t)=>{e(n)})}static reject(n){return new C((e,t)=>{t(n)})}static waitFor(e){return new C((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=C.resolve(!1);for(const n of e)t=t.next(e=>e?C.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new C((t,n)=>{const r=o.length,i=new Array(r);let s=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{i[a]=e,++s===r&&t(i)},e=>n(e))}})}static doWhile(r,i){return new C((e,t)=>{const n=()=>{!0===r()?i().next(()=>{n()},t):e()};n()})}}class _i{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.m=new Hr,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{e.error?this.m.reject(new Ei(t,e.error)):this.m.resolve()},this.transaction.onerror=e=>{e=Ai(e.target.error);this.m.reject(new Ei(t,e))}}static open(e,t,n,r){try{return new _i(t,e.transaction(r,n))}catch(e){throw new Ei(t,e)}}get g(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(m("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}p(){var e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){e=this.transaction.objectStore(e);return new Si(e)}}class bi{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===bi.D(G())&&d("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return m("SimpleDb","Removing database:",e),xi(window.indexedDB.deleteDatabase(e)).toPromise()}static C(){var e,t,n;return!(!function(){try{return"object"==typeof indexedDB}catch(e){}}()||!bi.v()&&(e=G(),t=0<(t=bi.D(e))&&t<10,n=0<(n=bi.F(e))&&n<4.5,0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||t||n))}static v(){var e;return"undefined"!=typeof process&&"YES"===(null==(e=process.env)?void 0:e.M)}static O(e,t){return e.store(t)}static D(e){e=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),e=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(e)}static F(e){e=e.match(/Android ([\d.]+)/i),e=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(e)}async N(i){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{e=e.target.result;t(e)},r.onblocked=()=>{n(new Ei(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{e=e.target.error;"VersionError"===e.name?n(new _(w.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===e.name?n(new _(w.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+e)):n(new Ei(i,e))},r.onupgradeneeded=e=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.S.B(t,r.transaction,e.oldVersion,this.version).next(()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(t){this.L=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var i="readonly"===t;let s=0;for(;;){++s;try{this.db=await this.N(e);const t=_i.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.p(),e)).catch(e=>(t.abort(e),C.reject(e))).toPromise();return s.catch(()=>{}),await t.g,s}catch(e){const t=e,n="FirebaseError"!==t.name&&s<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Ii{constructor(e){this.q=e,this.K=!1,this.$=null}get isDone(){return this.K}get U(){return this.$}set cursor(e){this.q=e}done(){this.K=!0}W(e){this.$=e}delete(){return xi(this.q.delete())}}class Ei extends _{constructor(e,t){super(w.UNAVAILABLE,`IndexedDB transaction '${e}' failed: `+t),this.name="IndexedDbTransactionError"}}function Ti(e){return"IndexedDbTransactionError"===e.name}class Si{constructor(e){this.store=e}put(e,t){return xi(void 0!==t?(m("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)))}add(e){return m("SimpleDb","ADD",this.store.name,e,e),xi(this.store.add(e))}get(t){return xi(this.store.get(t)).next(e=>(m("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return m("SimpleDb","DELETE",this.store.name,e),xi(this.store.delete(e))}count(){return m("SimpleDb","COUNT",this.store.name),xi(this.store.count())}G(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.j(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new C((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}H(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new C((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}J(e,t){m("SimpleDb","DELETE ALL",this.store.name);e=this.options(e,t),e.Y=!1,t=this.cursor(e);return this.j(t,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);e=this.cursor(n);return this.j(e,t)}X(r){const e=this.cursor({});return new C((n,t)=>{e.onerror=e=>{e=Ai(e.target.error);t(e)},e.onsuccess=e=>{const t=e.target.result;t?r(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}j(e,i){const s=[];return new C((r,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{e=e.target.result;if(e){const t=new Ii(e),n=i(e.primaryKey,e.value,t);if(n instanceof C){const e=n.catch(e=>(t.done(),C.reject(e)));s.push(e)}t.isDone?r():null===t.U?e.continue():e.continue(t.U)}else r()}}).next(()=>C.waitFor(s))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";var n;return e.reverse&&(t="prev"),e.index?(n=this.store.index(e.index),e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)):this.store.openCursor(e.range,t)}}function xi(e){return new C((t,n)=>{e.onsuccess=e=>{e=e.target.result;t(e)},e.onerror=e=>{e=Ai(e.target.error);n(e)}})}let Ci=!1;function Ai(e){const t=bi.D(G());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new _("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ci||(Ci=!0,setTimeout(()=>{throw e},0)),e}}return e}class Di{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){m("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{m("IndexBackiller","Documents written: "+await this.ee.ne())}catch(e){Ti(e)?m("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await wi(e)}await this.te(6e4)})}}class Ni{constructor(e,t){this.localStore=e,this.persistence=t}async ne(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.re(e,t))}re(e,t){const n=new Set;let r=t,i=!0;return C.doWhile(()=>!0===i&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(i=!1):(m("IndexBackiller","Processing collection: "+t),this.ie(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}ie(r,i,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,i).next(n=>this.localStore.localDocuments.getNextDocuments(r,i,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.se(n,e)).next(e=>(m("IndexBackiller","Updating offset: "+e),this.localStore.indexManager.updateCollectionGroup(r,i,e))).next(()=>t.size)}))}se(e,t){let n=e;return t.changes.forEach((e,t)=>{t=gi(t);0<pi(t,n)&&(n=t)}),new mi(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ki{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this._e&&this._e(e),e}}function Ri(e){return null==e}function Mi(e){return 0===e&&1/e==-1/0}function Oi(e){return"number"==typeof e&&Number.isInteger(e)&&!Mi(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Li(t){let i="";for(let e=0;e<t.length;e++)0<i.length&&(i=Fi(i)),i=function(t){let n=i;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(t.get(e));return Fi(i)}function Fi(e){return e+""}function Pi(n){const r=n.length;if(y(2<=r),2===r)return y(""===n.charAt(0)&&""===n.charAt(1)),T.emptyPath();var i=r-2,s=[];let a="";for(let t=0;t<r;){const r=n.indexOf("",t);switch((r<0||r>i)&&b(),n.charAt(r+1)){case"":var o=n.substring(t,r);let e;0===a.length?e=o:(a+=o,e=a,a=""),s.push(e);break;case"":a=a+n.substring(t,r)+"\0";break;case"":a+=n.substring(t,r+1);break;default:b()}t=r+2}return new T(s)}ki.ae=-1;const Vi=["userId","batchId"];function Bi(e,t){return[e,Li(t)]}function Ui(e,t,n){return[e,Li(t),n]}const qi={},ji=["prefixPath","collectionGroup","readTime","documentId"],Gi=["prefixPath","collectionGroup","documentId"],Ki=["collectionGroup","readTime","prefixPath","documentId"],zi=["canonicalId","targetId"],Qi=["targetId","path"],$i=["path","targetId"],Hi=["collectionId","parent"],Wi=["indexId","uid"],Yi=["uid","sequenceNumber"],Xi=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Ji=["indexId","uid","orderedDocumentKey"],Zi=["userId","collectionPath","documentId"],es=["userId","collectionPath","largestBatchId"],ts=["userId","collectionGroup","largestBatchId"],ns=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],rs=[...ns,"documentOverlays"],is=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ss=is,as=[...ss,"indexConfiguration","indexState","indexEntries"];class os extends vi{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function us(e,t){return bi.O(e.ue,t)}function hs(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function ls(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function cs(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class A{constructor(e,t){this.comparator=e,this.root=t||fs.EMPTY}insert(e,t){return new A(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,fs.BLACK,null,null))}remove(e){return new A(this.comparator,this.root.remove(e,this.comparator).copy(null,null,fs.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(e+":"+t),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new ds(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new ds(this.root,e,this.comparator,!1)}getReverseIterator(){return new ds(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new ds(this.root,e,this.comparator,!0)}}class ds{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){var e;return 0===this.nodeStack.length?null:{key:(e=this.nodeStack[this.nodeStack.length-1]).key,value:e.value}}}class fs{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:fs.RED,this.left=null!=r?r:fs.EMPTY,this.right=null!=i?i:fs.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new fs(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){var r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return fs.EMPTY;let e=this;return(e=(e=e.left.isRed()||e.left.left.isRed()?e:e.moveRedLeft()).copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r=(r=r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()?r:r.moveRedLeft()).copy(null,null,null,r.left.remove(e,t),null);else{if(0===t(e,(r=(r=r.left.isRed()?r.rotateRight():r).right.isEmpty()||r.right.isRed()||r.right.left.isRed()?r:r.moveRedRight()).key)){if(r.right.isEmpty())return fs.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e=(e=(e=e.right.isRed()&&!e.left.isRed()?e.rotateLeft():e).left.isRed()&&e.left.left.isRed()?e.rotateRight():e).left.isRed()&&e.right.isRed()?e.colorFlip():e}moveRedLeft(){let e=this.colorFlip();return e=e.right.left.isRed()?(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip():e}moveRedRight(){let e=this.colorFlip();return e=e.left.left.isRed()?(e=e.rotateRight()).colorFlip():e}rotateLeft(){var e=this.copy(null,null,fs.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,fs.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw b();if(this.right.isRed())throw b();var e=this.left.check();if(e!==this.right.check())throw b();return e+(this.isRed()?0:1)}}fs.EMPTY=null,fs.RED=!0,fs.BLACK=!1,fs.EMPTY=new class{constructor(){this.size=0}get key(){throw b()}get value(){throw b()}get color(){throw b()}get left(){throw b()}get right(){throw b()}copy(e,t,n,r,i){return this}insert(e,t,n){return new fs(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class D{constructor(e){this.comparator=e,this.data=new A(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){for(var n=this.data.getIteratorFrom(e[0]);n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){for(var n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){e=this.data.getIteratorFrom(e);return e.hasNext()?e.getNext().key:null}getIterator(){return new gs(this.data.getIterator())}getIteratorFrom(e){return new gs(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof D))return!1;if(this.size!==e.size)return!1;for(var t=this.data.getIterator(),n=e.data.getIterator();t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){var t=new D(this.comparator);return t.data=e,t}}class gs{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function ms(e){return e.hasNext()?e.getNext():void 0}class ps{constructor(e){(this.fields=e).sort(f.comparator)}static empty(){return new ps([])}unionWith(e){let t=new D(f.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new ps(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return ii(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class ys extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class vs{constructor(e){this.binaryString=e}static fromBase64String(e){e=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new ys("Invalid base64 string: "+e):e}}(e);return new vs(e)}static fromUint8Array(e){e=function(t){let n="";for(let e=0;e<t.length;++e)n+=String.fromCharCode(t[e]);return n}(e);return new vs(e)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){var t=this.binaryString,n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return I(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}vs.EMPTY_BYTE_STRING=new vs("");const ws=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function _s(t){if(y(!!t),"string"!=typeof t)return{seconds:N(t.seconds),nanos:N(t.nanos)};{let e=0;var n=ws.exec(t),n=(y(!!n),n[1]&&(n=(n[1]+"000000000").substr(0,9),e=Number(n)),new Date(t));return{seconds:Math.floor(n.getTime()/1e3),nanos:e}}}function N(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function bs(e){return"string"==typeof e?vs.fromBase64String(e):vs.fromUint8Array(e)}function Is(e){return"server_timestamp"===(null==(e=((null==(e=null==e?void 0:e.mapValue)?void 0:e.fields)||{}).__type__)?void 0:e.stringValue)}function Es(e){e=e.mapValue.fields.__previous_value__;return Is(e)?Es(e):e}function Ts(e){e=_s(e.mapValue.fields.__local_write_time__.timestampValue);return new l(e.seconds,e.nanos)}class Ss{constructor(e,t,n,r,i,s,a,o,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=u}}class xs{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new xs("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof xs&&e.projectId===this.projectId&&e.database===this.database}}const Cs={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},As={nullValue:"NULL_VALUE"};function Ds(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Is(e)?4:js(e)?9007199254740991:10:b()}function Ns(e,t){if(e===t)return!0;var n,r,i,s=Ds(e);if(s!==Ds(t))return!1;switch(s){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Ts(e).isEqual(Ts(t));case 3:return r=t,"string"==typeof e.timestampValue&&"string"==typeof r.timestampValue&&e.timestampValue.length===r.timestampValue.length?e.timestampValue===r.timestampValue:(i=_s(e.timestampValue),r=_s(r.timestampValue),i.seconds===r.seconds&&i.nanos===r.nanos);case 5:return e.stringValue===t.stringValue;case 6:return n=t,bs(e.bytesValue).isEqual(bs(n.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return i=t,N((n=e).geoPointValue.latitude)===N(i.geoPointValue.latitude)&&N(n.geoPointValue.longitude)===N(i.geoPointValue.longitude);case 2:return r=t,"integerValue"in(n=e)&&"integerValue"in r?N(n.integerValue)===N(r.integerValue):"doubleValue"in n&&"doubleValue"in r&&((n=N(n.doubleValue))===(r=N(r.doubleValue))?Mi(n)===Mi(r):isNaN(n)&&isNaN(r));case 9:return ii(e.arrayValue.values||[],t.arrayValue.values||[],Ns);case 10:var a=e,o=a.mapValue.fields||{},u=t.mapValue.fields||{};if(hs(o)!==hs(u))return!1;for(const a in o)if(o.hasOwnProperty(a)&&(void 0===u[a]||!Ns(o[a],u[a])))return!1;return!0;default:return b()}}function ks(e,t){return void 0!==(e.values||[]).find(e=>Ns(e,t))}function Rs(e,t){if(e===t)return 0;var n,r,i=Ds(e),s=Ds(t);if(i!==s)return I(i,s);switch(i){case 0:case 9007199254740991:return 0;case 1:return I(e.booleanValue,t.booleanValue);case 2:return r=t,(a=N((n=e).integerValue||n.doubleValue))<(g=N(r.integerValue||r.doubleValue))?-1:g<a?1:a===g?0:isNaN(a)?isNaN(g)?0:-1:1;case 3:return Ms(e.timestampValue,t.timestampValue);case 4:return Ms(Ts(e),Ts(t));case 5:return I(e.stringValue,t.stringValue);case 6:var a=e.bytesValue,o=t.bytesValue;return a=bs(a),o=bs(o),a.compareTo(o);case 7:var o=e.referenceValue,u=t.referenceValue,h=o.split("/"),l=u.split("/");for(let e=0;e<h.length&&e<l.length;e++){const u=I(h[e],l[e]);if(0!==u)return u}return I(h.length,l.length);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(g=I(N(n.latitude),N(r.latitude)))?g:I(N(n.longitude),N(r.longitude));case 9:var u=e.arrayValue,c=t.arrayValue,d=u.values||[],f=c.values||[];for(let e=0;e<d.length&&e<f.length;++e){const c=Rs(d[e],f[e]);if(c)return c}return I(d.length,f.length);case 10:var g=e.mapValue,m=t.mapValue;if(g===Cs.mapValue&&m===Cs.mapValue)return 0;if(g===Cs.mapValue)return 1;if(m===Cs.mapValue)return-1;var p=g.fields||{},y=Object.keys(p),v=m.fields||{},w=Object.keys(v);y.sort(),w.sort();for(let e=0;e<y.length&&e<w.length;++e){const m=I(y[e],w[e]);if(0!==m)return m;var _=Rs(p[y[e]],v[w[e]]);if(0!==_)return _}return I(y.length,w.length);default:throw b()}}function Ms(e,t){var n;return"string"==typeof e&&"string"==typeof t&&e.length===t.length?I(e,t):(e=_s(e),t=_s(t),0!==(n=I(e.seconds,t.seconds))?n:I(e.nanos,t.nanos))}function Os(e){return function n(r){{if("nullValue"in r)return"null";if("booleanValue"in r)return""+r.booleanValue;if("integerValue"in r)return""+r.integerValue;if("doubleValue"in r)return""+r.doubleValue;if("timestampValue"in r)return`time(${(t=_s(r.timestampValue)).seconds},${t.nanos})`;if("stringValue"in r)return r.stringValue;if("bytesValue"in r)return bs(r.bytesValue).toBase64();if("referenceValue"in r)return t=r.referenceValue,S.fromName(t).toString();if("geoPointValue"in r)return`geo(${(e=r.geoPointValue).latitude},${e.longitude})`;if("arrayValue"in r){let e="[",t=!0;for(const s of r.arrayValue.values||[])t?t=!1:e+=",",e+=n(s);return e+"]"}if("mapValue"in r){var i=r.mapValue;let e="{",t=!0;for(const a of Object.keys(i.fields||{}).sort())t?t=!1:e+=",",e+=a+":"+n(i.fields[a]);return e+"}"}return b()}var e,t}(e)}function Ls(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/`+t.path.canonicalString()}}function Fs(e){return e&&"integerValue"in e}function Ps(e){return!!e&&"arrayValue"in e}function Vs(e){return e&&"nullValue"in e}function Bs(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Us(e){return e&&"mapValue"in e}function qs(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const r={mapValue:{fields:{}}};return ls(t.mapValue.fields,(e,t)=>r.mapValue.fields[e]=qs(t)),r}if(t.arrayValue){var n={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)n.arrayValue.values[e]=qs(t.arrayValue.values[e]);return n}return Object.assign({},t)}function js(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Gs(e,t){var n=Rs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Ks(e,t){var n=Rs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class zs{constructor(e){this.value=e}static empty(){return new zs({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let t=this.value;for(let e=0;e<n.length-1;++e)if(!Us(t=(t.mapValue.fields||{})[n.get(e)]))return null;return(t=(t.mapValue.fields||{})[n.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=qs(t)}setAll(e){let n=f.emptyPath(),r={},i=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,i),r={},i=[],n=t.popLast()}e?r[t.lastSegment()]=qs(e):i.push(t.lastSegment())});e=this.getFieldsMap(n);this.applyChanges(e,r,i)}delete(e){var t=this.field(e.popLast());Us(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Ns(this.value,e.value)}getFieldsMap(n){let r=this.value;r.mapValue.fields||(r.mapValue={fields:{}});for(let t=0;t<n.length;++t){let e=r.mapValue.fields[n.get(t)];Us(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},r.mapValue.fields[n.get(t)]=e),r=e}return r.mapValue.fields}applyChanges(n,e,t){ls(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new zs(qs(this.value))}}class k{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new k(e,0,E.min(),E.min(),E.min(),zs.empty(),0)}static newFoundDocument(e,t,n,r){return new k(e,1,t,E.min(),n,r,0)}static newNoDocument(e,t){return new k(e,2,t,E.min(),E.min(),zs.empty(),0)}static newUnknownDocument(e,t){return new k(e,3,t,E.min(),E.min(),zs.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(E.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=zs.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=zs.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=E.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof k&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new k(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Qs{constructor(e,t){this.position=e,this.inclusive=t}}function $s(t,n,r){let i=0;for(let e=0;e<t.position.length;e++){var s=n[e],a=t.position[e];if(i=s.field.isKeyField()?S.comparator(S.fromName(a.referenceValue),r.key):Rs(a,r.data.field(s.field)),"desc"===s.dir&&(i*=-1),0!==i)break}return i}function Hs(t,n){if(null===t)return null===n;if(null===n)return!1;if(t.inclusive!==n.inclusive||t.position.length!==n.position.length)return!1;for(let e=0;e<t.position.length;e++)if(!Ns(t.position[e],n.position[e]))return!1;return!0}class Ws{constructor(e,t="asc"){this.field=e,this.dir=t}}class Ys{}class R extends Ys{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new ra(e,t,n):"array-contains"===t?new oa(e,n):"in"===t?new ua(e,n):"not-in"===t?new ha(e,n):"array-contains-any"===t?new la(e,n):new R(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?ia:sa)(e,n)}matches(e){e=e.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(Rs(e,this.value)):null!==e&&Ds(this.value)===Ds(e)&&this.matchesComparison(Rs(e,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return b()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class M extends Ys{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new M(e,t)}matches(t){return Xs(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null===this.ce&&(this.ce=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ce}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){var e=this.le(e=>e.isInequality());return null!==e?e.field:null}le(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function Xs(e){return"and"===e.op}function Js(e){return"or"===e.op}function Zs(e){return ea(e)&&Xs(e)}function ea(e){for(const t of e.filters)if(t instanceof M)return!1;return!0}function ta(e,t){t=e.filters.concat(t);return M.create(t,e.op)}function na(e){return e instanceof R?`${(t=e).field.canonicalString()} ${t.op} `+Os(t.value):e instanceof M?e.op.toString()+" {"+e.getFilters().map(na).join(" ,")+"}":"Filter";var t}class ra extends R{constructor(e,t,n){super(e,t,n),this.key=S.fromName(n.referenceValue)}matches(e){e=S.comparator(e.key,this.key);return this.matchesComparison(e)}}class ia extends R{constructor(e,t){super(e,"in",t),this.keys=aa(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class sa extends R{constructor(e,t){super(e,"not-in",t),this.keys=aa(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function aa(e,t){return((null==(t=t.arrayValue)?void 0:t.values)||[]).map(e=>S.fromName(e.referenceValue))}class oa extends R{constructor(e,t){super(e,"array-contains",t)}matches(e){e=e.data.field(this.field);return Ps(e)&&ks(e.arrayValue,this.value)}}class ua extends R{constructor(e,t){super(e,"in",t)}matches(e){e=e.data.field(this.field);return null!==e&&ks(this.value.arrayValue,e)}}class ha extends R{constructor(e,t){super(e,"not-in",t)}matches(e){return!ks(this.value.arrayValue,{nullValue:"NULL_VALUE"})&&null!==(e=e.data.field(this.field))&&!ks(this.value.arrayValue,e)}}class la extends R{constructor(e,t){super(e,"array-contains-any",t)}matches(e){e=e.data.field(this.field);return!(!Ps(e)||!e.arrayValue.values)&&e.arrayValue.values.some(e=>ks(this.value.arrayValue,e))}}class ca{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.he=null}}function da(e,t=null,n=[],r=[],i=null,s=null,a=null){return new ca(e,t,n,r,i,s,a)}function fa(t){if(null===t.he){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e=(e=(e+="|f:")+t.filters.map(e=>function t(e){var n;return e instanceof R?e.field.canonicalString()+e.op.toString()+Os(e.value):Zs(e)?e.filters.map(e=>t(e)).join(","):(n=e.filters.map(e=>t(e)).join(","),e.op+`(${n})`)}(e)).join(",")+"|ob:")+t.orderBy.map(e=>{return(e=e).field.canonicalString()+e.dir}).join(","),Ri(t.limit)||(e=(e+="|l:")+t.limit),t.startAt&&(e=(e=(e+="|lb:")+(t.startAt.inclusive?"b:":"a:"))+t.startAt.position.map(e=>Os(e)).join(",")),t.endAt&&(e=(e=(e+="|ub:")+(t.endAt.inclusive?"a:":"b:"))+t.endAt.position.map(e=>Os(e)).join(",")),t.he=e}return t.he}function ga(t,n){if(t.limit!==n.limit)return!1;if(t.orderBy.length!==n.orderBy.length)return!1;for(let e=0;e<t.orderBy.length;e++)if(r=t.orderBy[e],i=n.orderBy[e],r.dir!==i.dir||!r.field.isEqual(i.field))return!1;var r,i;if(t.filters.length!==n.filters.length)return!1;for(let e=0;e<t.filters.length;e++)if(!function r(e,t){return e instanceof R?(n=e,(s=t)instanceof R&&n.op===s.op&&n.field.isEqual(s.field)&&Ns(n.value,s.value)):e instanceof M?(i=t)instanceof M&&e.op===i.op&&e.filters.length===i.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,i.filters[n]),!0):void b();var i,n,s}(t.filters[e],n.filters[e]))return!1;return t.collectionGroup===n.collectionGroup&&!!t.path.isEqual(n.path)&&!!Hs(t.startAt,n.startAt)&&Hs(t.endAt,n.endAt)}function ma(e){return S.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function pa(e,t){return e.filters.filter(e=>e instanceof R&&e.field.isEqual(t))}function ya(t,n,r){let i=As,s=!0;for(const r of pa(t,n)){let e=As,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?As:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Ls(xs.empty(),S.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:b();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=As}Gs({value:i,inclusive:s},{value:e,inclusive:t})<0&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];Gs({value:i,inclusive:s},{value:t,inclusive:r.inclusive})<0&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}function va(t,n,r){let i=Cs,s=!0;for(const r of pa(t,n)){let e=Cs,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Ls(xs.empty(),S.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?Cs:b(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=Cs}0<Ks({value:i,inclusive:s},{value:e,inclusive:t})&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<Ks({value:i,inclusive:s},{value:t,inclusive:r.inclusive})&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}class wa{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.Pe=null,this.Ie=null,this.de=null,this.startAt,this.endAt}}function _a(e,t,n,r,i,s,a,o){return new wa(e,t,n,r,i,s,a,o)}function ba(e){return new wa(e)}function Ia(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Ea(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function Ta(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function Sa(e){return null!==e.collectionGroup}function xa(t){var n=t;if(null===n.Pe){n.Pe=[];const t=Ta(n),e=Ea(n);if(null!==t&&null===e)t.isKeyField()||n.Pe.push(new Ws(t)),n.Pe.push(new Ws(f.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n.Pe.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.Pe.push(new Ws(f.keyField(),t))}}}return n.Pe}function Ca(e){var t=e;return t.Ie||(t.Ie=function(e,t){if("F"===e.limitType)return da(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);t=t.map(e=>{var t="desc"===e.dir?"asc":"desc";return new Ws(e.field,t)});var n=e.endAt?new Qs(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Qs(e.startAt.position,e.startAt.inclusive):null;return da(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}(t,xa(e))),t.Ie}function Aa(e,t){t.getFirstInequalityField(),Ta(e);t=e.filters.concat([t]);return new wa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)}function Da(e,t,n){return new wa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Na(e,t){return ga(Ca(e),Ca(t))&&e.limitType===t.limitType}function ka(e){return fa(Ca(e))+"|lt:"+e.limitType}function Ra(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>na(e)).join(", ")}]`),Ri(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>{return`${(e=e).field.canonicalString()} (${e.dir})`}).join(", ")}]`),e.startAt&&(t=(t=(t+=", startAt: ")+(e.startAt.inclusive?"b:":"a:"))+e.startAt.position.map(e=>Os(e)).join(",")),`Target(${t=e.endAt?(t=(t+=", endAt: ")+(e.endAt.inclusive?"a:":"b:"))+e.endAt.position.map(e=>Os(e)).join(","):t})`}(Ca(e))}; limitType=${e.limitType})`}function Ma(n,e){return e.isFoundDocument()&&(i=n,a=(s=e).key.path,null!==i.collectionGroup?s.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(a):S.isDocumentKey(i.path)?i.path.isEqual(a):i.path.isImmediateParentOf(a))&&function(e){for(const t of xa(n))if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(i=e,!(e=n).startAt||(r=$s(t=e.startAt,n=xa(e),i),t.inclusive?r<=0:r<0))&&(!e.endAt||(r=$s(t=e.endAt,e=xa(e),i),t.inclusive?0<=r:0<r));var t,r,i,s,a}function Oa(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function La(i){return(e,t)=>{let n=!1;for(const r of xa(i)){const i=function(e,t,n){var r,i=e.field.isKeyField()?S.comparator(t.key,n.key):(r=e.field,n=n,t=t.data.field(r),n=n.data.field(r),null!==t&&null!==n?Rs(t,n):b());switch(e.dir){case"asc":return i;case"desc":return-1*i;default:return b()}}(r,e,t);if(0!==i)return i;n=n||r.field.isKeyField()}return 0}}class Fa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(t,n){var e=this.mapKeyFn(t),r=this.inner[e];if(void 0===r)this.inner[e]=[[t,n]];else{for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return void(r[e]=[t,n]);r.push([t,n])}this.innerSize++}delete(t){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r)for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return 1===r.length?delete this.inner[n]:r.splice(e,1),this.innerSize--,!0;return!1}forEach(r){ls(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return cs(this.inner)}size(){return this.innerSize}}const Pa=new A(S.comparator),Va=new A(S.comparator);function Ba(...e){let t=Va;for(const n of e)t=t.insert(n.key,n);return t}function Ua(e){let n=Va;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function qa(){return new Fa(e=>e.toString(),(e,t)=>e.isEqual(t))}const ja=new A(S.comparator),Ga=new D(S.comparator);function O(...e){let t=Ga;for(const n of e)t=t.add(n);return t}const Ka=new D(I);function za(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Mi(t)?"-0":t}}function Qa(e){return{integerValue:""+e}}function $a(e,t){return Oi(t)?Qa(t):za(e,t)}class Ha{constructor(){this._=void 0}}function Wa(e,t){return e instanceof to?Fs(e=t)||e&&"doubleValue"in e?t:{integerValue:0}:null}class Ya extends Ha{}class Xa extends Ha{constructor(e){super(),this.elements=e}}function Ja(e,t){var n=ro(t);for(const t of e.elements)n.some(e=>Ns(e,t))||n.push(t);return{arrayValue:{values:n}}}class Za extends Ha{constructor(e){super(),this.elements=e}}function eo(e,t){let n=ro(t);for(const t of e.elements)n=n.filter(e=>!Ns(e,t));return{arrayValue:{values:n}}}class to extends Ha{constructor(e,t){super(),this.serializer=e,this.Te=t}}function no(e){return N(e.integerValue||e.doubleValue)}function ro(e){return Ps(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class io{constructor(e,t){this.field=e,this.transform=t}}class so{constructor(e,t){this.version=e,this.transformResults=t}}class L{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new L}static exists(e){return new L(void 0,e)}static updateTime(e){return new L(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function ao(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class oo{}function uo(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new yo(e.key,L.none()):new co(e.key,e.data,L.none());{var r,i=e.data,s=zs.empty();let t=new D(f.comparator);for(r of n.fields)if(!t.has(r)){let e=i.field(r);null===e&&1<r.length&&(r=r.popLast(),e=i.field(r)),null===e?s.delete(r):s.set(r,e),t=t.add(r)}return new fo(e.key,s,new ps(t.toArray()),L.none())}}function ho(e,t,n,r){return e instanceof co?(s=t,a=n,o=r,ao((i=e).precondition,s)?(u=i.value.clone(),i=po(i.fieldTransforms,o,s),u.setAll(i),s.convertToFoundDocument(s.version,u).setHasLocalMutations(),null):a):e instanceof fo?(o=t,i=n,s=r,ao((u=e).precondition,o)?(s=po(u.fieldTransforms,s,o),(a=o.data).setAll(go(u)),a.setAll(s),o.convertToFoundDocument(o.version,a).setHasLocalMutations(),null===i?null:i.unionWith(u.fieldMask.fields).unionWith(u.fieldTransforms.map(e=>e.field))):i):ao(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n;var i,s,a,o,u}function lo(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&ii(n,r,(e,t)=>{return t=t,(e=e).field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Xa&&t instanceof Xa||e instanceof Za&&t instanceof Za?ii(e.elements,t.elements,Ns):e instanceof to&&t instanceof to?Ns(e.Te,t.Te):e instanceof Ya&&t instanceof Ya)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask));var n,r}class co extends oo{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class fo extends oo{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function go(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function mo(t,n,r){var i=new Map;y(t.length===r.length);for(let e=0;e<r.length;e++){var s=t[e],a=s.transform,o=n.data.field(s.field);i.set(s.field,(s=a,a=o,o=r[e],s instanceof Xa?Ja(s,a):s instanceof Za?eo(s,a):o))}return i}function po(e,t,n){var r,i,s,a,o=new Map;for(const u of e){const e=u.transform,h=n.data.field(u.field);o.set(u.field,(r=e,i=h,s=t,0,r instanceof Ya?(a=void 0,a={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:s.seconds,nanos:s.nanoseconds}}}},(s=i&&Is(i)?Es(i):i)&&(a.fields.__previous_value__=s),{mapValue:a}):r instanceof Xa?Ja(r,i):r instanceof Za?eo(r,i):(a=no(s=Wa(r,i))+no(r.Te),Fs(s)&&Fs(r.Te)?Qa(a):za(r.serializer,a))))}return o}class yo extends oo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class vo extends oo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class wo{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){var n,r,i,s,a,o,u=e.mutationResults;for(let e=0;e<this.mutations.length;e++){var h=this.mutations[e];h.key.isEqual(t.key)&&(h=h,n=t,r=u[e],o=a=s=i=void 0,h instanceof co?(s=n,a=r,o=(i=h).value.clone(),i=mo(i.fieldTransforms,s,a.transformResults),o.setAll(i),s.convertToFoundDocument(a.version,o).setHasCommittedMutations()):h instanceof fo?(i=n,s=r,ao((a=h).precondition,i)?(o=mo(a.fieldTransforms,i,s.transformResults),(h=i.data).setAll(go(a)),h.setAll(o),i.convertToFoundDocument(s.version,h).setHasCommittedMutations()):i.convertToUnknownDocument(s.version)):n.convertToNoDocument(r.version).setHasCommittedMutations())}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=ho(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=ho(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(r,i){const s=qa();return this.mutations.forEach(e=>{var t=r.get(e.key),n=t.overlayedDocument,t=this.applyToLocalView(n,t.mutatedFields),t=uo(n,i.has(e.key)?null:t);null!==t&&s.set(e.key,t),n.isValidDocument()||n.convertToNoDocument(E.min())}),s}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),O())}isEqual(e){return this.batchId===e.batchId&&ii(this.mutations,e.mutations,(e,t)=>lo(e,t))&&ii(this.baseMutations,e.baseMutations,(e,t)=>lo(e,t))}}class _o{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){y(e.mutations.length===n.length);let r=ja;var i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new _o(e,t,n,r)}}class bo{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class Io{constructor(e,t){this.count=e,this.unchangedNames=t}}function Eo(e){switch(e){default:return b(),0;case w.CANCELLED:case w.UNKNOWN:case w.DEADLINE_EXCEEDED:case w.RESOURCE_EXHAUSTED:case w.INTERNAL:case w.UNAVAILABLE:case w.UNAUTHENTICATED:return;case w.INVALID_ARGUMENT:case w.NOT_FOUND:case w.ALREADY_EXISTS:case w.PERMISSION_DENIED:case w.FAILED_PRECONDITION:case w.ABORTED:case w.OUT_OF_RANGE:case w.UNIMPLEMENTED:case w.DATA_LOSS:return 1}}function To(e){if(void 0===e)return d("GRPC error has no .code"),w.UNKNOWN;switch(e){case g.OK:return w.OK;case g.CANCELLED:return w.CANCELLED;case g.UNKNOWN:return w.UNKNOWN;case g.DEADLINE_EXCEEDED:return w.DEADLINE_EXCEEDED;case g.RESOURCE_EXHAUSTED:return w.RESOURCE_EXHAUSTED;case g.INTERNAL:return w.INTERNAL;case g.UNAVAILABLE:return w.UNAVAILABLE;case g.UNAUTHENTICATED:return w.UNAUTHENTICATED;case g.INVALID_ARGUMENT:return w.INVALID_ARGUMENT;case g.NOT_FOUND:return w.NOT_FOUND;case g.ALREADY_EXISTS:return w.ALREADY_EXISTS;case g.PERMISSION_DENIED:return w.PERMISSION_DENIED;case g.FAILED_PRECONDITION:return w.FAILED_PRECONDITION;case g.ABORTED:return w.ABORTED;case g.OUT_OF_RANGE:return w.OUT_OF_RANGE;case g.UNIMPLEMENTED:return w.UNIMPLEMENTED;case g.DATA_LOSS:return w.DATA_LOSS;default:return b()}}function So(){return new TextEncoder}pe=g={OK:0,0:"OK",CANCELLED:1,1:"CANCELLED",UNKNOWN:2,2:"UNKNOWN",INVALID_ARGUMENT:3,3:"INVALID_ARGUMENT",DEADLINE_EXCEEDED:4,4:"DEADLINE_EXCEEDED",NOT_FOUND:5,5:"NOT_FOUND",ALREADY_EXISTS:6,6:"ALREADY_EXISTS",PERMISSION_DENIED:7,7:"PERMISSION_DENIED",UNAUTHENTICATED:16,16:"UNAUTHENTICATED",RESOURCE_EXHAUSTED:8,8:"RESOURCE_EXHAUSTED",FAILED_PRECONDITION:9,9:"FAILED_PRECONDITION",ABORTED:10,10:"ABORTED",OUT_OF_RANGE:11,11:"OUT_OF_RANGE",UNIMPLEMENTED:12,12:"UNIMPLEMENTED",INTERNAL:13,13:"INTERNAL",UNAVAILABLE:14,14:"UNAVAILABLE",DATA_LOSS:15,15:"DATA_LOSS"};const xo=new jr([4294967295,4294967295],0);function Co(e){var e=So().encode(e),t=new qr;return t.update(e),new Uint8Array(t.digest())}function Ao(e){var e=new DataView(e.buffer),t=e.getUint32(0,!0),n=e.getUint32(4,!0),r=e.getUint32(8,!0),e=e.getUint32(12,!0);return[new jr([t,n],0),new jr([r,e],0)]}class Do{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new No("Invalid padding: "+t);if(n<0)throw new No("Invalid hash count: "+n);if(0<e.length&&0===this.hashCount)throw new No("Invalid hash count: "+n);if(0===e.length&&0!==t)throw new No("Invalid padding when bitmap length is 0: "+t);this.Ae=8*e.length-t,this.Re=jr.fromNumber(this.Ae)}Ve(e,t,n){let r=e.add(t.multiply(jr.fromNumber(n)));return(r=1===r.compare(xo)?new jr([r.getBits(0),r.getBits(1)],0):r).modulo(this.Re).toNumber()}me(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ae)return!1;const t=Co(e),[n,r]=Ao(t);for(let e=0;e<this.hashCount;e++){const t=this.Ve(n,r,e);if(!this.me(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new Do(i,r,t);return n.forEach(e=>s.insert(e)),s}insert(e){if(0!==this.Ae){var[t,n]=Ao(Co(e));for(let e=0;e<this.hashCount;e++){var r=this.Ve(t,n,e);this.fe(r)}}}fe(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class No extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class ko{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){var r=new Map;return r.set(e,Ro.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new ko(E.min(),r,new A(I),Pa,O())}}class Ro{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Ro(n,t,O(),O(),O())}}class Mo{constructor(e,t,n,r){this.ge=e,this.removedTargetIds=t,this.key=n,this.pe=r}}class Oo{constructor(e,t){this.targetId=e,this.ye=t}}class Lo{constructor(e,t,n=vs.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Fo{constructor(){this.we=0,this.Se=Bo(),this.be=vs.EMPTY_BYTE_STRING,this.De=!1,this.Ce=!0}get current(){return this.De}get resumeToken(){return this.be}get ve(){return 0!==this.we}get Fe(){return this.Ce}Me(e){0<e.approximateByteSize()&&(this.Ce=!0,this.be=e)}xe(){let n=O(),r=O(),i=O();return this.Se.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:i=i.add(e);break;default:b()}}),new Ro(this.be,this.De,n,r,i)}Oe(){this.Ce=!1,this.Se=Bo()}Ne(e,t){this.Ce=!0,this.Se=this.Se.insert(e,t)}Be(e){this.Ce=!0,this.Se=this.Se.remove(e)}Le(){this.we+=1}ke(){--this.we}qe(){this.Ce=!0,this.De=!0}}class Po{constructor(e){this.Qe=e,this.Ke=new Map,this.$e=Pa,this.Ue=Vo(),this.We=new A(I)}Ge(e){for(const t of e.ge)e.pe&&e.pe.isFoundDocument()?this.ze(t,e.pe):this.je(t,e.key,e.pe);for(const n of e.removedTargetIds)this.je(n,e.key,e.pe)}He(n){this.forEachTarget(n,e=>{var t=this.Je(e);switch(n.state){case 0:this.Ye(e)&&t.Me(n.resumeToken);break;case 1:t.ke(),t.ve||t.Oe(),t.Me(n.resumeToken);break;case 2:t.ke(),t.ve||this.removeTarget(e);break;case 3:this.Ye(e)&&(t.qe(),t.Me(n.resumeToken));break;case 4:this.Ye(e)&&(this.Ze(e),t.Me(n.resumeToken));break;default:b()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Ke.forEach((e,t)=>{this.Ye(t)&&n(t)})}Xe(e){const t=e.targetId,n=e.ye.count,r=this.et(t);if(r){var i=r.target;if(ma(i))if(0===n){const e=new S(i.path);this.je(t,e,k.newNoDocument(e,E.min()))}else y(1===n);else{const r=this.tt(t);if(r!==n){const n=this.nt(e),s=n?this.rt(n,e,r):1;if(0!==s){this.Ze(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.We=this.We.insert(t,e)}}}}}nt(e){if(!(r=e.ye.unchangedNames)||!r.bits)return null;var{bits:{bitmap:t="",padding:n=0},hashCount:r=0}=r;let i,s;try{i=bs(t).toUint8Array()}catch(e){if(e instanceof ys)return Qr("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{s=new Do(i,n,r)}catch(e){return Qr(e instanceof No?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===s.Ae?null:s}rt(e,t,n){return t.ye.count===n-this.ot(e,t.targetId)?0:2}ot(n,r){var e=this.Qe.getRemoteKeysForTarget(r);let i=0;return e.forEach(e=>{var t=`projects/${(t=this.Qe.st()).projectId}/databases/${t.database}/documents/`+e.path.canonicalString();n.mightContain(t)||(this.je(r,e,null),i++)}),i}_t(r){const i=new Map;this.Ke.forEach((e,t)=>{var n=this.et(t);if(n){if(e.current&&ma(n.target)){const i=new S(n.target.path);null!==this.$e.get(i)||this.ut(t,i)||this.je(t,i,k.newNoDocument(i,r))}e.Fe&&(i.set(t,e.xe()),e.Oe())}});let s=O();this.Ue.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{e=this.et(e);return!e||"TargetPurposeLimboResolution"===e.purpose||(n=!1)}),n&&(s=s.add(e))}),this.$e.forEach((e,t)=>t.setReadTime(r));var e=new ko(r,i,this.We,this.$e,s);return this.$e=Pa,this.Ue=Vo(),this.We=new A(I),e}ze(e,t){var n;this.Ye(e)&&(n=this.ut(e,t.key)?2:0,this.Je(e).Ne(t.key,n),this.$e=this.$e.insert(t.key,t),this.Ue=this.Ue.insert(t.key,this.ct(t.key).add(e)))}je(e,t,n){var r;this.Ye(e)&&(r=this.Je(e),this.ut(e,t)?r.Ne(t,1):r.Be(t),this.Ue=this.Ue.insert(t,this.ct(t).delete(e)),n)&&(this.$e=this.$e.insert(t,n))}removeTarget(e){this.Ke.delete(e)}tt(e){var t=this.Je(e).xe();return this.Qe.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Le(e){this.Je(e).Le()}Je(e){let t=this.Ke.get(e);return t||(t=new Fo,this.Ke.set(e,t)),t}ct(e){let t=this.Ue.get(e);return t||(t=new D(I),this.Ue=this.Ue.insert(e,t)),t}Ye(e){var t=null!==this.et(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t}et(e){var t=this.Ke.get(e);return t&&t.ve?null:this.Qe.lt(e)}Ze(t){this.Ke.set(t,new Fo),this.Qe.getRemoteKeysForTarget(t).forEach(e=>{this.je(t,e,null)})}ut(e,t){return this.Qe.getRemoteKeysForTarget(e).has(t)}}function Vo(){return new A(S.comparator)}function Bo(){return new A(S.comparator)}const Uo={asc:"ASCENDING",desc:"DESCENDING"},qo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},jo={and:"AND",or:"OR"};class Go{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Ko(e,t){return e.useProto3Json||Ri(t)?t:{value:t}}function zo(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Qo(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function F(e){return y(!!e),E.fromTimestamp((e=_s(e),new l(e.seconds,e.nanos)))}function $o(e,t){return new T(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function Ho(e){e=T.fromString(e);return y(lu(e)),e}function Wo(e,t){return $o(e.databaseId,t.path)}function Yo(e,t){t=Ho(t);if(t.get(1)!==e.databaseId.projectId)throw new _(w.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+e.databaseId.projectId);if(t.get(3)!==e.databaseId.database)throw new _(w.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+e.databaseId.database);return new S(eu(t))}function Xo(e,t){return $o(e.databaseId,t)}function Jo(e){e=Ho(e);return 4===e.length?T.emptyPath():eu(e)}function Zo(e){return new T(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function eu(e){return y(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function tu(e,t,n){return{name:Wo(e,t),fields:n.value.mapValue.fields}}function nu(e,t,n){var e=Yo(e,t.name),r=F(t.updateTime),i=t.createTime?F(t.createTime):E.min(),t=new zs({mapValue:{fields:t.fields}}),e=k.newFoundDocument(e,r,i,t);return n&&e.setHasCommittedMutations(),n?e.setHasCommittedMutations():e}function ru(e,t){let n;if(t instanceof co)n={update:tu(e,t.key,t.value)};else if(t instanceof yo)n={delete:Wo(e,t.key)};else if(t instanceof fo)n={update:tu(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof vo))return b();n={verify:Wo(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>{var t=e.transform;if(t instanceof Ya)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Xa)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof Za)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof to)return{fieldPath:e.field.canonicalString(),increment:t.Te};throw b()})),t.precondition.isNone||(n.currentDocument=(r=e,void 0!==(e=t.precondition).updateTime?{updateTime:zo(r,(t=e.updateTime).toTimestamp())}:void 0!==e.exists?{exists:e.exists}:b())),n;var r}function iu(r,e){const t=e.currentDocument?void 0!==(s=e.currentDocument).updateTime?L.updateTime(F(s.updateTime)):void 0!==s.exists?L.exists(s.exists):L.none():L.none(),n=e.updateTransforms?e.updateTransforms.map(t=>{{var n=r;let e=null;if("setToServerValue"in t)y("REQUEST_TIME"===t.setToServerValue),e=new Ya;else if("appendMissingElements"in t){const n=t.appendMissingElements.values||[];e=new Xa(n)}else if("removeAllFromArray"in t){const n=t.removeAllFromArray.values||[];e=new Za(n)}else"increment"in t?e=new to(n,t.increment):b();return n=f.fromServerFormat(t.fieldPath),new io(n,e)}}):[];var i;if(e.update){e.update.name;var s=Yo(r,e.update.name),a=new zs({mapValue:{fields:e.update.fields}});if(e.updateMask){i=e.updateMask.fieldPaths||[];const r=new ps(i.map(e=>f.fromServerFormat(e)));return new fo(s,a,r,t,n)}return new co(s,a,t,n)}if(e.delete){const n=Yo(r,e.delete);return new yo(n,t)}if(e.verify){const n=Yo(r,e.verify);return new vo(n,t)}return b()}function su(e,t){return{documents:[Xo(e,t.path)]}}function au(e,t){var n={structuredQuery:{}},r=t.path,r=(null!==t.collectionGroup?(n.parent=Xo(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Xo(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),function(e){if(0!==e.length)return function t(e){if(e instanceof R){var n=e;if("=="===n.op){if(Bs(n.value))return{unaryFilter:{field:uu(n.field),op:"IS_NAN"}};if(Vs(n.value))return{unaryFilter:{field:uu(n.field),op:"IS_NULL"}}}else if("!="===n.op){if(Bs(n.value))return{unaryFilter:{field:uu(n.field),op:"IS_NOT_NAN"}};if(Vs(n.value))return{unaryFilter:{field:uu(n.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:uu(n.field),op:(r=n.op,qo[r]),value:n.value}}}return e instanceof M?1===(n=(r=e).getFilters().map(e=>t(e))).length?n[0]:{compositeFilter:{op:(r=r.op,jo[r]),filters:n}}:b();var r}(M.create(e,"and"))}(t.filters));return r&&(n.structuredQuery.where=r),(r=function(e){if(0!==e.length)return e.map(e=>{return{field:uu((e=e).field),direction:(e=e.dir,Uo[e])}})}(t.orderBy))&&(n.structuredQuery.orderBy=r),null!==(r=Ko(e,t.limit))&&(n.structuredQuery.limit=r),t.startAt&&(n.structuredQuery.startAt={before:(e=t.startAt).inclusive,values:e.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function ou(e){let t=Jo(e.parent);var n,r,i,s=e.structuredQuery,a=s.from?s.from.length:0;let o=null,u=(0<a&&(y(1===a),(a=s.from[0]).allDescendants?o=a.collectionId:t=t.child(a.collectionId)),[]),h=(s.where&&(u=(a=function t(e){if(void 0!==e.unaryFilter){var n=e;switch(n.unaryFilter.op){case"IS_NAN":var r=hu(n.unaryFilter.field);return R.create(r,"==",{doubleValue:NaN});case"IS_NULL":r=hu(n.unaryFilter.field);return R.create(r,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":r=hu(n.unaryFilter.field);return R.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":r=hu(n.unaryFilter.field);return R.create(r,"!=",{nullValue:"NULL_VALUE"});default:return b()}}else{return void 0!==e.fieldFilter?(s=e,R.create(hu(s.fieldFilter.field),function(){switch(s.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return b()}}(),s.fieldFilter.value)):void 0!==e.compositeFilter?(i=e,M.create(i.compositeFilter.filters.map(e=>t(e)),function(){switch(i.compositeFilter.op){case"AND":return"and";case"OR":return"or";default:return b()}}())):b();var i,s}}(s.where))instanceof M&&Zs(a)?a.getFilters():[a]),[]),l=(s.orderBy&&(h=s.orderBy.map(e=>{return t=e,new Ws(hu(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}());var t})),null),c=(s.limit&&(l=Ri(n="object"==typeof(e=s.limit)?e.value:e)?null:n),null),d=(s.startAt&&(c=(i=!!(r=s.startAt).before,n=r.values||[],new Qs(n,i))),null);return s.endAt&&(d=(i=!(r=s.endAt).before,s=r.values||[],new Qs(s,i))),_a(t,o,h,u,l,"F",c,d)}function uu(e){return{fieldPath:e.canonicalString()}}function hu(e){return f.fromServerFormat(e.fieldPath)}function lu(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class cu{constructor(e,t,n,r,i=E.min(),s=E.min(),a=vs.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new cu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new cu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new cu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new cu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class du{constructor(e){this.ht=e}}function fu(e,t){var n,r=t.key,i={prefixPath:r.getCollectionPath().popLast().toArray(),collectionGroup:r.collectionGroup,documentId:r.path.lastSegment(),readTime:gu(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())i.document={name:Wo(n=e.ht,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:zo(n,e.version.toTimestamp()),createTime:zo(n,e.createTime.toTimestamp())};else if(t.isNoDocument())i.noDocument={path:r.path.toArray(),readTime:mu(t.version)};else{if(!t.isUnknownDocument())return b();i.unknownDocument={path:r.path.toArray(),version:mu(t.version)}}return i}function gu(e){e=e.toTimestamp();return[e.seconds,e.nanoseconds]}function mu(e){e=e.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function pu(e){e=new l(e.seconds,e.nanoseconds);return E.fromTimestamp(e)}function yu(t,n){const r=(n.baseMutations||[]).map(e=>iu(t.ht,e));for(let e=0;e<n.mutations.length-1;++e){const r=n.mutations[e];if(e+1<n.mutations.length&&void 0!==n.mutations[e+1].transform){const i=n.mutations[e+1];r.updateTransforms=i.transform.fieldTransforms,n.mutations.splice(e+1,1),++e}}const i=n.mutations.map(e=>iu(t.ht,e)),e=l.fromMillis(n.localWriteTimeMs);return new wo(n.batchId,e,r,i)}function vu(e){var t=pu(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?pu(e.lastLimboFreeSnapshotVersion):E.min(),r=void 0!==e.query.documents?(y(1===(r=e.query).documents.length),Ca(ba(Jo(r.documents[0])))):Ca(ou(e.query));return new cu(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,vs.fromBase64String(e.resumeToken))}function wu(e,t){var n=mu(t.snapshotVersion),r=mu(t.lastLimboFreeSnapshotVersion),e=(ma(t.target)?su:au)(e.ht,t.target),i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:fa(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:e}}function _u(e){var t=ou({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Da(t,t.limit,"L"):t}function bu(e,t){return new bo(t.largestBatchId,iu(e.ht,t.overlayMutation))}function Iu(e,t){var n=t.path.lastSegment();return[e,Li(t.path.popLast()),n]}function Eu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:mu(r.readTime),documentKey:Li(r.documentKey.path),largestBatchId:r.largestBatchId}}class Tu{getBundleMetadata(e,t){return Su(e).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:pu(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return Su(e).put({bundleId:t.id,createTime:mu(F(t.createTime)),version:t.version})}getNamedQuery(e,t){return xu(e).get(t).next(e=>{if(e)return{name:e.name,query:_u(e.bundledQuery),readTime:pu(e.readTime)}})}saveNamedQuery(e,t){return xu(e).put({name:t.name,readTime:mu(F(t.readTime)),bundledQuery:t.bundledQuery})}}function Su(e){return us(e,"bundles")}function xu(e){return us(e,"namedQueries")}class Cu{constructor(e,t){this.serializer=e,this.userId=t}static Pt(e,t){t=t.uid||"";return new Cu(e,t)}getOverlay(e,t){return Au(e).get(Iu(this.userId,t)).next(e=>e?bu(this.serializer,e):null)}getOverlays(e,t){const n=qa();return C.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){const i=[];return e.forEach((e,t)=>{t=new bo(r,t);i.push(this.It(n,t))}),C.waitFor(i)}removeOverlaysForBatchId(t,e,n){const r=new Set,i=(e.forEach(e=>r.add(Li(e.getCollectionPath()))),[]);return r.forEach(e=>{e=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);i.push(Au(t).J("collectionPathOverlayIndex",e))}),C.waitFor(i)}getOverlaysForCollection(e,t,n){const r=qa(),i=Li(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return Au(e).G("collectionPathOverlayIndex",s).next(e=>{for(const t of e){const e=bu(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){const i=qa();let s;n=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Au(e).Z({index:"collectionGroupOverlayIndex",range:n},(e,t,n)=>{t=bu(this.serializer,t);i.size()<r||t.largestBatchId===s?(i.set(t.getKey(),t),s=t.largestBatchId):n.done()}).next(()=>i)}It(e,t){return Au(e).put(function(e,t,n){var[,r,i]=Iu(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ru(e.ht,n.mutation)}}(this.serializer,this.userId,t))}}function Au(e){return us(e,"documentOverlays")}class Du{constructor(){}dt(e,t){this.Tt(e,t),t.Et()}Tt(e,t){var n,r;"nullValue"in e?this.At(t,5):"booleanValue"in e?(this.At(t,10),t.Rt(e.booleanValue?1:0)):"integerValue"in e?(this.At(t,15),t.Rt(N(e.integerValue))):"doubleValue"in e?(n=N(e.doubleValue),isNaN(n)?this.At(t,13):(this.At(t,15),Mi(n)?t.Rt(0):t.Rt(n))):"timestampValue"in e?(r=e.timestampValue,this.At(t,20),"string"==typeof r?t.Vt(r):(t.Vt(""+(r.seconds||"")),t.Rt(r.nanos||0))):"stringValue"in e?(this.ft(e.stringValue,t),this.gt(t)):"bytesValue"in e?(this.At(t,30),t.yt(bs(e.bytesValue)),this.gt(t)):"referenceValue"in e?this.wt(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.At(t,45),t.Rt(r.latitude||0),t.Rt(r.longitude||0)):"mapValue"in e?js(e)?this.At(t,Number.MAX_SAFE_INTEGER):(this.St(e.mapValue,t),this.gt(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.gt(t)):b()}ft(e,t){this.At(t,25),this.Dt(e,t)}Dt(e,t){t.Vt(e)}St(e,t){var n=e.fields||{};this.At(t,55);for(const e of Object.keys(n))this.ft(e,t),this.Tt(n[e],t)}bt(e,t){var n=e.values||[];this.At(t,50);for(const e of n)this.Tt(e,t)}wt(e,t){this.At(t,37),S.fromName(e).path.forEach(e=>{this.At(t,60),this.Dt(e,t)})}At(e,t){e.Rt(t)}gt(e){e.Rt(2)}}function Nu(e){e=64-function(t){let n=0;for(let e=0;e<8;++e){var r=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&t[e]);if(n+=r,8!==r)break}return n}(e);return Math.ceil(e/8)}Du.Ct=new Du;class ku{constructor(){this.buffer=new Uint8Array(1024),this.position=0}vt(e){var t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){var t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ot(n.value),n=t.next();this.Nt()}Bt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{const e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Lt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ot(e);else if(e<2048)this.Ot(960|e>>>6),this.Ot(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ot(480|e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e);else{const e=t.codePointAt(0);this.Ot(240|e>>>18),this.Ot(128|63&e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e)}}this.Nt()}kt(t){var n=this.qt(t),t=Nu(n);this.Qt(1+t),this.buffer[this.position++]=255&t;for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=255&n[e]}Kt(t){var n=this.qt(t),t=Nu(n);this.Qt(1+t),this.buffer[this.position++]=~(255&t);for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=~(255&n[e])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){e=e,(t=new DataView(new ArrayBuffer(8))).setFloat64(0,e,!1);var t,n=new Uint8Array(t.buffer),r=0!=(128&n[0]);n[0]^=r?255:128;for(let e=1;e<n.length;++e)n[e]^=r?255:0;return n}Ft(e){e&=255;0==e?(this.Ut(0),this.Ut(255)):255==e?(this.Ut(255),this.Ut(0)):this.Ut(e)}Ot(e){var t=255&e;0==t?(this.Gt(0),this.Gt(255)):255==t?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(t){t+=this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);t=new Uint8Array(e);t.set(this.buffer),this.buffer=t}}}class Ru{constructor(e){this.jt=e}yt(e){this.jt.vt(e)}Vt(e){this.jt.Bt(e)}Rt(e){this.jt.kt(e)}Et(){this.jt.$t()}}class Mu{constructor(e){this.jt=e}yt(e){this.jt.xt(e)}Vt(e){this.jt.Lt(e)}Rt(e){this.jt.Kt(e)}Et(){this.jt.Wt()}}class Ou{constructor(){this.jt=new ku,this.Ht=new Ru(this.jt),this.Jt=new Mu(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return 0===e?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}}class Lu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Zt(){var e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Lu(this.indexId,this.documentKey,this.arrayValue,n)}}function Fu(e,t){var n=e.indexId-t.indexId;return 0!=n||0!==(n=Pu(e.arrayValue,t.arrayValue))||0!==(n=Pu(e.directionalValue,t.directionalValue))?n:S.comparator(e.documentKey,t.documentKey)}function Pu(t,n){for(let e=0;e<t.length&&e<n.length;++e){var r=t[e]-n[e];if(0!=r)return r}return t.length-n.length}class Vu{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Xt=e.orderBy,this.en=[];for(const t of e.filters){const e=t;e.isInequality()?this.tn=e:this.en.push(e)}}nn(e){y(e.collectionGroup===this.collectionId);var t=hi(e);if(void 0!==t&&!this.rn(t))return!1;var n=li(e);let r=new Set,i=0,s=0;for(;i<n.length&&this.rn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i!==n.length){if(void 0!==this.tn){if(!r.has(this.tn.field.canonicalString())){const e=n[i];if(!this.sn(this.tn,e)||!this.on(this.Xt[s++],e))return!1}++i}for(;i<n.length;++i){const e=n[i];if(s>=this.Xt.length||!this.on(this.Xt[s++],e))return!1}}return!0}_n(){let e=new D(f.comparator);var t=[];for(const n of this.en)n.field.isKeyField()||("array-contains"===n.op||"array-contains-any"===n.op?t.push(new ci(n.field,2)):e.has(n.field)||(e=e.add(n.field),t.push(new ci(n.field,0))));for(const r of this.Xt)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new ci(r.field,"asc"===r.dir?0:1)));return new ui(ui.UNKNOWN_ID,this.collectionId,t,di.empty())}rn(e){for(const t of this.en)if(this.sn(t,e))return!0;return!1}sn(e,t){return!(void 0===e||!e.field.isEqual(t.fieldPath))&&(e="array-contains"===e.op||"array-contains-any"===e.op,2===t.kind==e)}on(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Bu(e){return e instanceof R}function Uu(e){return e instanceof M&&Zs(e)}function qu(e){return Bu(e)||Uu(e)||function(e){if(e instanceof M&&Js(e)){for(const t of e.getFilters())if(!Bu(t)&&!Uu(t))return!1;return!0}return!1}(e)}function ju(e,t){var n,r;return y(e instanceof R||e instanceof M),y(t instanceof R||t instanceof M),Ku(e instanceof R?t instanceof R?(n=e,r=t,M.create([n,r],"and")):Gu(e,t):t instanceof R?Gu(t,e):function(e,t){if(y(0<e.filters.length&&0<t.filters.length),Xs(e)&&Xs(t))return ta(e,t.getFilters());const n=Js(e)?e:t,r=Js(e)?t:e,i=n.filters.map(e=>ju(e,r));return M.create(i,"or")}(e,t))}function Gu(t,e){return Xs(e)?ta(e,t.getFilters()):(e=e.filters.map(e=>ju(t,e)),M.create(e,"or"))}function Ku(t){if(y(t instanceof R||t instanceof M),t instanceof R)return t;var e=t.getFilters();if(1===e.length)return Ku(e[0]);if(ea(t))return t;const n=e.map(e=>Ku(e)),r=[];return n.forEach(e=>{e instanceof R?r.push(e):e instanceof M&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:M.create(r,t.op)}class zu{constructor(){this.an=new Qu}addToCollectionParentIndex(e,t){return this.an.add(t),C.resolve()}getCollectionParents(e,t){return C.resolve(this.an.getEntries(t))}addFieldIndex(e,t){return C.resolve()}deleteFieldIndex(e,t){return C.resolve()}deleteAllFieldIndexes(e){return C.resolve()}createTargetIndexes(e,t){return C.resolve()}getDocumentsMatchingTarget(e,t){return C.resolve(null)}getIndexType(e,t){return C.resolve(0)}getFieldIndexes(e,t){return C.resolve([])}getNextCollectionGroupToUpdate(e){return C.resolve(null)}getMinOffset(e,t){return C.resolve(mi.min())}getMinOffsetFromCollectionGroup(e,t){return C.resolve(mi.min())}updateCollectionGroup(e,t,n){return C.resolve()}updateIndexEntries(e,t){return C.resolve()}}class Qu{constructor(){this.index={}}add(e){var t=e.lastSegment(),e=e.popLast(),n=this.index[t]||new D(T.comparator),r=!n.has(e);return this.index[t]=n.add(e),r}has(e){var t=e.lastSegment(),e=e.popLast(),t=this.index[t];return t&&t.has(e)}getEntries(e){return(this.index[e]||new D(T.comparator)).toArray()}}const $u=new Uint8Array(0);class Hu{constructor(e,t){this.user=e,this.databaseId=t,this.un=new Qu,this.cn=new Fa(e=>fa(e),(e,t)=>ga(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){var n,r;return this.un.has(t)?C.resolve():(n=t.lastSegment(),r=t.popLast(),e.addOnCommittedListener(()=>{this.un.add(t)}),r={collectionId:n,parent:Li(r)},Wu(e).put(r))}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[si(n),""],!1,!0);return Wu(e).G(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Pi(t.parent))}return r})}addFieldIndex(e,t){const n=Xu(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;var i=n.add(r);if(t.indexState){const n=Ju(e);return i.next(e=>{n.put(Eu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){const n=Xu(e),r=Ju(e),i=Yu(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=Xu(e),n=Yu(e),r=Ju(e);return t.J().next(()=>n.J()).next(()=>r.J())}createTargetIndexes(n,e){return C.forEach(this.ln(e),t=>this.getIndexType(n,t).next(e=>{if(0===e||1===e){const e=new Vu(t);return this.addFieldIndex(n,e._n())}}))}getDocumentsMatchingTarget(e,h){const l=Yu(e);let c=!0;const n=new Map;return C.forEach(this.ln(h),t=>this.hn(e,t).next(e=>{c=c&&!!e,n.set(t,e)})).next(()=>{if(c){let u=O();const c=[];return C.forEach(n,(e,t)=>{m("IndexedDbIndexManager",`Using index ${n=e,`id=${n.indexId}|cg=${n.collectionGroup}|f=`+n.fields.map(e=>e.fieldPath+":"+e.kind).join(",")} to execute `+fa(h));var n=function(e,t){var n=hi(t);if(void 0!==n)for(const t of pa(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){var n=new Map;for(const r of li(t))for(const t of pa(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),i=function(e,t){var n=[];let r=!0;for(const i of li(t)){const t=(0===i.kind?ya:va)(e,i.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Qs(n,r)}(t,e),s=function(e,t){var n=[];let r=!0;for(const i of li(t)){const t=(0===i.kind?va:ya)(e,i.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Qs(n,r)}(t,e),a=this.Pn(e,t,i),o=this.Pn(e,t,s),r=this.In(e,t,r),r=this.dn(e.indexId,n,a,i.inclusive,o,s.inclusive,r);return C.forEach(r,e=>l.H(e,h.limit).next(e=>{e.forEach(e=>{e=S.fromSegments(e.documentKey);u.has(e)||(u=u.add(e),c.push(e))})}))}).next(()=>c)}return C.resolve(null)})}ln(t){var e;return this.cn.get(t)||(e=0===t.filters.length?[t]:(0===(e=M.create(t.filters,"and")).getFilters().length?[]:(e=function t(e){var n;return y(e instanceof R||e instanceof M),e instanceof R?e:1===e.filters.length?t(e.filters[0]):(n=e.filters.map(e=>t(e)),qu(n=Ku(n=M.create(n,e.op)))?n:(y(n instanceof M),y(Xs(n)),y(1<n.filters.length),n.filters.reduce((e,t)=>ju(e,t))))}(function t(n){var e;if(y(n instanceof R||n instanceof M),n instanceof R){if(n instanceof ua){const r=(null==(e=null==(e=n.value.arrayValue)?void 0:e.values)?void 0:e.map(e=>R.create(n.field,"==",e)))||[];return M.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return M.create(r,n.op)}(e)),y(qu(e)),Bu(e)||Uu(e)?[e]:e.getFilters())).map(e=>da(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this.cn.set(t,e),e)}dn(t,n,r,i,s,a,o){const u=(null!=n?n.length:1)*Math.max(r.length,s.length),h=u/(null!=n?n.length:1),l=[];for(let e=0;e<u;++e){const u=n?this.Tn(n[e/h]):$u,c=this.En(t,u,r[e%h],i),d=this.An(t,u,s[e%h],a),f=o.map(e=>this.En(t,u,e,!0));l.push(...this.createRange(c,d,f))}return l}En(e,t,n,r){e=new Lu(e,S.empty(),t,n);return r?e:e.Zt()}An(e,t,n,r){e=new Lu(e,S.empty(),t,n);return r?e.Zt():e}hn(e,t){const r=new Vu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.nn(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.ln(t);return C.forEach(r,t=>this.hn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new D(f.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&1<r.length&&2===n?1:n)}Rn(e,t){var n=new Ou;for(const i of li(e)){const e=t.data.field(i.fieldPath);if(null==e)return null;var r=n.Yt(i.kind);Du.Ct.dt(e,r)}return n.zt()}Tn(e){var t=new Ou;return Du.Ct.dt(e,t.Yt(0)),t.zt()}Vn(e,t){var n=new Ou;return Du.Ct.dt(Ls(this.databaseId,t),n.Yt(0===(t=li(e)).length?0:t[t.length-1].kind)),n.zt()}In(e,t,n){if(null===n)return[];let r=[],i=(r.push(new Ou),0);for(const s of li(e)){const e=n[i++];for(const n of r)if(this.mn(t,s.fieldPath)&&Ps(e))r=this.fn(r,s,e);else{const t=n.Yt(s.kind);Du.Ct.dt(e,t)}}return this.gn(r)}Pn(e,t,n){return this.In(e,t,n.position)}gn(t){var n=[];for(let e=0;e<t.length;++e)n[e]=t[e].zt();return n}fn(e,t,n){const r=[...e],i=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new Ou;r.seed(n.zt()),Du.Ct.dt(e,r.Yt(t.kind)),i.push(r)}return i}mn(e,t){return!!e.filters.find(e=>e instanceof R&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=Xu(e),s=Ju(e);return(t?n.G("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.G()).next(e=>{const i=[];return C.forEach(e,r=>s.get([r.indexId,this.uid]).next(e=>{var t,n;i.push((t=r,e=e?new di(e.sequenceNumber,new mi(pu(e.readTime),new S(Pi(e.documentKey)),e.largestBatchId)):di.empty(),n=t.fields.map(([e,t])=>new ci(f.fromServerFormat(e),t)),new ui(t.indexId,t.collectionGroup,n,e)))})).next(()=>i)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:I(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const i=Xu(e),s=Ju(e);return this.pn(e).next(t=>i.G("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>C.forEach(e,e=>s.put(Eu(e.indexId,this.user,t,r)))))}updateIndexEntries(i,e){const n=new Map;return C.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?C.resolve(e):this.getFieldIndexes(i,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),C.forEach(e,n=>this.yn(i,t,n).next(e=>{var t=this.wn(r,n);return e.isEqual(t)?C.resolve():this.Sn(i,r,n,e,t)}))))})}bn(e,t,n,r){return Yu(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.Vn(n,t.key),documentKey:t.key.path.toArray()})}Dn(e,t,n,r){return Yu(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.Vn(n,t.key),t.key.path.toArray()])}yn(e,n,r){e=Yu(e);let i=new D(Fu);return e.Z({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.Vn(r,n)])},(e,t)=>{i=i.add(new Lu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>i)}wn(e,t){let n=new D(Fu);var r=this.Rn(t,e);if(null!=r){const s=hi(t);if(null!=s){var i=e.data.field(s.fieldPath);if(Ps(i))for(const s of i.arrayValue.values||[])n=n.add(new Lu(t.indexId,e.key,this.Tn(s),r))}else n=n.add(new Lu(t.indexId,e.key,$u,r))}return n}Sn(t,i,s,e,a){m("IndexedDbIndexManager","Updating index entries for document '%s'",i.key);const o=[];{var u=Fu,h=e=>{o.push(this.bn(t,i,s,e))},l=e=>{o.push(this.Dn(t,i,s,e))},c=e.getIterator(),d=a.getIterator();let n=ms(c),r=ms(d);for(;n||r;){let e=!1,t=!1;if(n&&r){const h=u(n,r);h<0?t=!0:0<h&&(e=!0)}else null!=n?t=!0:e=!0;e?(h(r),r=ms(d)):t?(l(n),n=ms(c)):(n=ms(c),r=ms(d))}}return C.waitFor(o)}pn(e){let r=1;return Ju(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>Fu(e,t)).filter((e,t,n)=>!t||0!==Fu(e,n[t-1]));var r=[];r.push(e);for(const i of n){const n=Fu(i,e),s=Fu(i,t);if(0===n)r[0]=e.Zt();else if(0<n&&s<0)r.push(i),r.push(i.Zt());else if(0<s)break}r.push(t);const i=[];for(let e=0;e<r.length;e+=2){if(this.Cn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,$u,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,$u,[]];i.push(IDBKeyRange.bound(t,n))}return i}Cn(e,t){return 0<Fu(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Zu)}getMinOffset(t,e){return C.mapArray(this.ln(e),e=>this.hn(t,e).next(e=>e||b())).next(Zu)}}function Wu(e){return us(e,"collectionParents")}function Yu(e){return us(e,"indexEntries")}function Xu(e){return us(e,"indexConfiguration")}function Ju(e){return us(e,"indexState")}function Zu(t){y(0!==t.length);let n=t[0].indexState.offset,r=n.largestBatchId;for(let e=1;e<t.length;e++){var i=t[e].indexState.offset;pi(i,n)<0&&(n=i),r<i.largestBatchId&&(r=i.largestBatchId)}return new mi(n.readTime,n.documentKey,r)}const eh={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class th{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new th(e,th.DEFAULT_COLLECTION_PERCENTILE,th.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function nh(e,t,n){const r=e.store("mutations"),i=e.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId);let o=0;e=r.Z({range:a},(e,t,n)=>(o++,n.delete()));s.push(e.next(()=>{y(1===o)}));const u=[];for(const e of n.mutations){const r=Ui(t,e.key.path,n.batchId);s.push(i.delete(r)),u.push(e.key)}return C.waitFor(s).next(()=>u)}function rh(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw b();t=e.noDocument}return JSON.stringify(t).length}th.DEFAULT_COLLECTION_PERCENTILE=10,th.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,th.DEFAULT=new th(41943040,th.DEFAULT_COLLECTION_PERCENTILE,th.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),th.DISABLED=new th(-1,0,0);class ih{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.vn={}}static Pt(e,t,n,r){y(""!==e.uid);e=e.isAuthenticated()?e.uid:"";return new ih(e,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ah(e).Z({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(l,c,d,f){const g=oh(l),m=ah(l);return m.add({}).next(e=>{y("number"==typeof e);const t=new wo(e,c,d,f),n=(i=this.serializer,s=this.userId,o=(a=t).baseMutations.map(e=>ru(i.ht,e)),u=a.mutations.map(e=>ru(i.ht,e)),{userId:s,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var i,s,a,o,u;let h=new D((e,t)=>I(e.canonicalString(),t.canonicalString()));for(const l of f){const c=Ui(this.userId,l.key.path,e);h=h.add(l.key.path.popLast()),r.push(m.put(n)),r.push(g.put(c,qi))}return h.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(l,e))}),l.addOnCommittedListener(()=>{this.vn[e]=t.keys()}),C.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return ah(e).get(t).next(e=>e?(y(e.userId===this.userId),yu(this.serializer,e)):null)}Fn(e,t){return this.vn[t]?C.resolve(this.vn[t]):this.lookupMutationBatch(e,t).next(e=>{return e?(e=e.keys(),this.vn[t]=e):null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let i=null;return ah(e).Z({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(y(t.batchId>=r),i=yu(this.serializer,t)),n.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return ah(e).Z({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ah(e).G("userMutationsIndex",t).next(e=>e.map(e=>yu(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(s,a){const e=Bi(this.userId,a.path),t=IDBKeyRange.lowerBound(e),o=[];return oh(s).Z({range:t},(e,t,n)=>{var[e,r,i]=e,r=Pi(r);if(e===this.userId&&a.path.isEqual(r))return ah(s).get(i).next(e=>{if(!e)throw b();y(e.userId===this.userId),o.push(yu(this.serializer,e))});n.done()}).next(()=>o)}getAllMutationBatchesAffectingDocumentKeys(t,e){let a=new D(I);const n=[];return e.forEach(s=>{var e=Bi(this.userId,s.path),e=IDBKeyRange.lowerBound(e),e=oh(t).Z({range:e},(e,t,n)=>{var[e,r,i]=e,r=Pi(r);e===this.userId&&s.path.isEqual(r)?a=a.add(i):n.done()});n.push(e)}),C.waitFor(n).next(()=>this.Mn(t,a))}getAllMutationBatchesAffectingQuery(e,t){const s=t.path,a=s.length+1,n=Bi(this.userId,s),r=IDBKeyRange.lowerBound(n);let o=new D(I);return oh(e).Z({range:r},(e,t,n)=>{var[e,r,i]=e,r=Pi(r);e===this.userId&&s.isPrefixOf(r)?r.length===a&&(o=o.add(i)):n.done()}).next(()=>this.Mn(e,o))}Mn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(ah(t).get(e).next(e=>{if(null===e)throw b();y(e.userId===this.userId),n.push(yu(this.serializer,e))}))}),C.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return nh(t.ue,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.xn(n.batchId)}),C.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}xn(e){delete this.vn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return C.resolve();const t=IDBKeyRange.lowerBound([this.userId]),r=[];return oh(n).Z({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Pi(e[1]);r.push(t)}else n.done()}).next(()=>{y(0===r.length)})})}containsKey(e,t){return sh(e,this.userId,t)}On(e){return uh(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function sh(e,i,t){const n=Bi(i,t.path),s=n[1],r=IDBKeyRange.lowerBound(n);let a=!1;return oh(e).Z({range:r,Y:!0},(e,t,n)=>{var[e,r]=e;e===i&&r===s&&(a=!0),n.done()}).next(()=>a)}function ah(e){return us(e,"mutations")}function oh(e){return us(e,"documentMutations")}function uh(e){return us(e,"mutationQueues")}class hh{constructor(e){this.Nn=e}next(){return this.Nn+=2,this.Nn}static Bn(){return new hh(0)}static Ln(){return new hh(-1)}}class lh{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(n){return this.kn(n).next(e=>{var t=new hh(e.highestTargetId);return e.highestTargetId=t.next(),this.qn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.kn(e).next(e=>E.fromTimestamp(new l(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.kn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.kn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.qn(t,e)))}addTargetData(t,n){return this.Qn(t,n).next(()=>this.kn(t).next(e=>(e.targetCount+=1,this.Kn(n,e),this.qn(t,e))))}updateTargetData(e,t){return this.Qn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>ch(t).delete(e.targetId)).next(()=>this.kn(t)).next(e=>(y(0<e.targetCount),--e.targetCount,this.qn(t,e)))}removeTargets(n,r,i){let s=0;const a=[];return ch(n).Z((e,t)=>{t=vu(t);t.sequenceNumber<=r&&null===i.get(t.targetId)&&(s++,a.push(this.removeTargetData(n,t)))}).next(()=>C.waitFor(a)).next(()=>s)}forEachTarget(e,n){return ch(e).Z((e,t)=>{t=vu(t);n(t)})}kn(e){return dh(e).get("targetGlobalKey").next(e=>(y(null!==e),e))}qn(e,t){return dh(e).put("targetGlobalKey",t)}Qn(e,t){return ch(e).put(wu(this.serializer,t))}Kn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.kn(e).next(e=>e.targetCount)}getTargetData(e,r){var t=fa(r),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let i=null;return ch(e).Z({range:t,index:"queryTargetsIndex"},(e,t,n)=>{t=vu(t);ga(r,t.target)&&(i=t,n.done())}).next(()=>i)}addMatchingKeys(n,e,r){const i=[],s=fh(n);return e.forEach(e=>{var t=Li(e.path);i.push(s.put({targetId:r,path:t})),i.push(this.referenceDelegate.addReference(n,r,e))}),C.waitFor(i)}removeMatchingKeys(n,e,r){const i=fh(n);return C.forEach(e,e=>{var t=Li(e.path);return C.waitFor([i.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){e=fh(e),t=IDBKeyRange.bound([t],[t+1],!1,!0);return e.delete(t)}getMatchingKeysForTargetId(e,t){t=IDBKeyRange.bound([t],[t+1],!1,!0),e=fh(e);let r=O();return e.Z({range:t,Y:!0},(e,t,n)=>{e=Pi(e[1]),e=new S(e);r=r.add(e)}).next(()=>r)}containsKey(e,t){t=Li(t.path),t=IDBKeyRange.bound([t],[si(t)],!1,!0);let r=0;return fh(e).Z({index:"documentTargetsIndex",Y:!0,range:t},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}lt(e,t){return ch(e).get(t).next(e=>e?vu(e):null)}}function ch(e){return us(e,"targets")}function dh(e){return us(e,"targetGlobal")}function fh(e){return us(e,"targetDocuments")}function gh([e,t],[n,r]){e=I(e,n);return 0===e?I(t,r):e}class mh{constructor(e){this.$n=e,this.buffer=new D(gh),this.Un=0}Wn(){return++this.Un}Gn(e){var t=[e,this.Wn()];if(this.buffer.size<this.$n)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();gh(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class ph{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.zn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.jn(6e4)}stop(){this.zn&&(this.zn.cancel(),this.zn=null)}get started(){return null!==this.zn}jn(e){m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.zn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.zn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Ti(e)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await wi(e)}await this.jn(3e5)})}}class yh{constructor(e,t){this.Hn=e,this.params=t}calculateTargetCount(e,t){return this.Hn.Jn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return C.resolve(ki.ae);const n=new mh(t);return this.Hn.forEachTarget(e,e=>n.Gn(e.sequenceNumber)).next(()=>this.Hn.Yn(e,e=>n.Gn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Hn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Hn.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),C.resolve(eh)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold `+this.params.cacheSizeCollectionThreshold),eh):this.Zn(t,n))}getCacheSize(e){return this.Hn.getCacheSize(e)}Zn(t,n){let r,i,s,a,o,u,h;const l=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(i=e>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from `+e),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,i))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(s=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(h=Date.now(),zr()<=c.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-l}ms
	Determined least recently used ${i} in `+(o-a)+"ms\n"+`	Removed ${s} targets in `+(u-o)+"ms\n"+`	Removed ${e} documents in `+(h-u)+"ms\n"+`Total Duration: ${h-l}ms`),C.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:e})))}}class vh{constructor(e,t){this.db=e,this.garbageCollector=(e=this,new yh(e,t))}Jn(e){const n=this.Xn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Xn(e){let t=0;return this.Yn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Yn(e,n){return this.er(e,(e,t)=>n(t))}addReference(e,t,n){return wh(e,n)}removeReference(e,t,n){return wh(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return wh(e,t)}tr(t,n){let r=!1;return uh(t).X(e=>sh(t,e,n).next(e=>(e&&(r=!0),C.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const i=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let a=0;return this.er(n,(t,e)=>{if(e<=r){const r=this.tr(n,t).next(e=>{if(!e)return a++,i.getEntry(n,t).next(()=>(i.removeEntry(t,E.min()),fh(n).delete([0,Li(t.path)])))});s.push(r)}}).next(()=>C.waitFor(s)).next(()=>i.apply(n)).next(()=>a)}removeTarget(e,t){t=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,t)}updateLimboDocument(e,t){return wh(e,t)}er(e,r){e=fh(e);let i,s=ki.ae;return e.Z({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(s!==ki.ae&&r(new S(Pi(i)),s),s=n,i=t):s=ki.ae}).next(()=>{s!==ki.ae&&r(new S(Pi(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function wh(e,t){return fh(e).put((e=e.currentSequenceNumber,{targetId:0,path:Li(t.path),sequenceNumber:e}))}class _h{constructor(){this.changes=new Fa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,k.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?C.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class bh{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Sh(e).put(n)}removeEntry(e,t,n){return Sh(e).delete((e=n,[(n=t.path.toArray()).slice(0,n.length-2),n[n.length-2],gu(e),n[n.length-1]]))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.nr(t,e)))}getEntry(e,n){let r=k.newInvalidDocument(n);return Sh(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(xh(n))},(e,t)=>{r=this.rr(n,t)}).next(()=>r)}ir(e,n){let r={size:0,document:k.newInvalidDocument(n)};return Sh(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(xh(n))},(e,t)=>{r={document:this.rr(n,t),size:rh(t)}}).next(()=>r)}getEntries(e,t){let n=Pa;return this.sr(e,t,(e,t)=>{t=this.rr(e,t);n=n.insert(e,t)}).next(()=>n)}_r(e,t){let r=Pa,i=new A(S.comparator);return this.sr(e,t,(e,t)=>{var n=this.rr(e,t);r=r.insert(e,n),i=i.insert(e,rh(t))}).next(()=>({documents:r,ar:i}))}sr(e,t,i){if(t.isEmpty())return C.resolve();let n=new D(Ah);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(xh(n.first()),xh(n.last())),s=n.getIterator();let a=s.getNext();return Sh(e).Z({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=S.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&Ah(a,r)<0;)i(a,null),a=s.getNext();a&&a.isEqual(r)&&(i(a,t),a=s.hasNext()?s.getNext():null),a?n.W(xh(a)):n.done()}).next(()=>{for(;a;)i(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,n,t,r,i){var s=n.path,t=[s.popLast().toArray(),s.lastSegment(),gu(t.readTime),t.documentKey.path.isEmpty()?"":t.documentKey.path.lastSegment()],s=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Sh(e).G(IDBKeyRange.bound(t,s,!0)).next(e=>{null!=i&&i.incrementDocumentReadCount(e.length);let t=Pa;for(const i of e){const e=this.rr(S.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(Ma(n,e)||r.has(e.key))&&(t=t.insert(e.key,e))}return t})}getAllFromCollectionGroup(e,t,n,r){let i=Pa;n=Ch(t,n),t=Ch(t,mi.max());return Sh(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(n,t,!0)},(e,t,n)=>{t=this.rr(S.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(t.key,t)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new Eh(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Th(e).get("remoteDocumentGlobalKey").next(e=>(y(!!e),e))}nr(e,t){return Th(e).put("remoteDocumentGlobalKey",t)}rr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=nu(e.ht,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=S.fromSegments(t.noDocument.path),r=pu(t.noDocument.readTime);n=k.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return b();{const e=S.fromSegments(t.unknownDocument.path),i=pu(t.unknownDocument.version);n=k.newUnknownDocument(e,i)}}return t.readTime&&n.setReadTime((t=t.readTime,e=new l(t[0],t[1]),E.fromTimestamp(e))),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(E.min()))return e}return k.newInvalidDocument(e)}}function Ih(e){return new bh(e)}class Eh extends _h{constructor(e,t){super(),this.ur=e,this.trackRemovals=t,this.cr=new Fa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(s){const a=[];let o=0,u=new D((e,t)=>I(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.cr.get(e);if(a.push(this.ur.removeEntry(s,e,n.readTime)),t.isValidDocument()){var r=fu(this.ur.serializer,t),i=(u=u.add(e.path.popLast()),rh(r));o+=i-n.size,a.push(this.ur.addEntry(s,e,r))}else if(o-=n.size,this.trackRemovals){const o=fu(this.ur.serializer,t.convertToNoDocument(E.min()));a.push(this.ur.addEntry(s,e,o))}}),u.forEach(e=>{a.push(this.ur.indexManager.addToCollectionParentIndex(s,e))}),a.push(this.ur.updateMetadata(s,o)),C.waitFor(a)}getFromCache(e,t){return this.ur.ir(e,t).next(e=>(this.cr.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.ur._r(e,t).next(({documents:n,ar:e})=>(e.forEach((e,t)=>{this.cr.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Th(e){return us(e,"remoteDocumentGlobal")}function Sh(e){return us(e,"remoteDocumentsV14")}function xh(e){e=e.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Ch(e,t){var n=t.documentKey.path.toArray();return[e,gu(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Ah(e,t){var n=e.path.toArray(),r=t.path.toArray();let i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=I(n[e],r[e]))return i;return(i=I(n.length,r.length))||(i=I(n[n.length-2],r[r.length-2]))||I(n[n.length-1],r[r.length-1])}class Dh{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Nh{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&ho(r.mutation,e,ps.empty(),l.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,O()).next(()=>e))}getLocalViewOfDocuments(e,t,n=O()){const r=qa();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=Ba();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=qa();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,O()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,i){let s=Pa;const a=qa(),n=qa();return t.forEach((e,t)=>{var n=r.get(t.key);i.has(t.key)&&(void 0===n||n.mutation instanceof fo)?s=s.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),ho(n.mutation,t,n.mutation.getFieldMask(),l.now())):a.set(t.key,ps.empty())}),this.recalculateAndSaveOverlays(e,s).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{return n.set(e,new Dh(t,null!=(t=a.get(e))?t:null))}),n))}recalculateAndSaveOverlays(s,a){const o=qa();let u=new A((e,t)=>e-t),h=O();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(s,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||ps.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||O()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{for(var e=[],t=u.getReverseIterator();t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,i=qa();r.forEach(e=>{var t;h.has(e)||(null!==(t=uo(a.get(e),o.get(e)))&&i.set(e,t),h=h.add(e))}),e.push(this.documentOverlayCache.saveOverlays(s,n,i))}return C.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n,r){return i=t,S.isDocumentKey(i.path)&&null===i.collectionGroup&&0===i.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Sa(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r);var i}getNextDocuments(s,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(s,t,a,o).next(n=>{var e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(s,t,a.largestBatchId,o-n.size):C.resolve(qa());let r=-1,i=n;return e.next(e=>C.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?C.resolve():this.remoteDocumentCache.getEntry(s,t).next(e=>{i=i.insert(t,e)}))).next(()=>this.populateOverlays(s,e,n)).next(()=>this.computeViews(s,i,e,O())).next(e=>({batchId:r,changes:Ua(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new S(t)).next(e=>{let t=Ba();return t=e.isFoundDocument()?t.insert(e.key,e):t})}getDocumentsMatchingCollectionGroupQuery(n,r,i,s){const a=r.collectionGroup;let o=Ba();return this.indexManager.getCollectionParents(n,a).next(e=>C.forEach(e,e=>{t=r,e=e.child(a);var t,e=new wa(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(n,e,i,s).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,i,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(t,i.path,n.largestBatchId).next(e=>(s=e,this.remoteDocumentCache.getDocumentsMatchingQuery(t,i,n,s,r))).next(n=>{s.forEach((e,t)=>{t=t.getKey();null===n.get(t)&&(n=n.insert(t,k.newInvalidDocument(t)))});let r=Ba();return n.forEach((e,t)=>{var n=s.get(e);void 0!==n&&ho(n.mutation,t,ps.empty(),l.now()),Ma(i,t)&&(r=r.insert(e,t))}),r})}}class kh{constructor(e){this.serializer=e,this.lr=new Map,this.hr=new Map}getBundleMetadata(e,t){return C.resolve(this.lr.get(t))}saveBundleMetadata(e,t){return this.lr.set(t.id,{id:t.id,version:t.version,createTime:F(t.createTime)}),C.resolve()}getNamedQuery(e,t){return C.resolve(this.hr.get(t))}saveNamedQuery(e,t){return this.hr.set(t.name,{name:t.name,query:_u(t.bundledQuery),readTime:F(t.readTime)}),C.resolve()}}class Rh{constructor(){this.overlays=new A(S.comparator),this.Pr=new Map}getOverlay(e,t){return C.resolve(this.overlays.get(t))}getOverlays(e,t){const n=qa();return C.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.It(n,r,t)}),C.resolve()}removeOverlaysForBatchId(e,t,n){var r=this.Pr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Pr.delete(n)),C.resolve()}getOverlaysForCollection(e,t,n){const r=qa(),i=t.length+1,s=new S(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return C.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let i=new A((e,t)=>e-t);for(var s=this.overlays.getIterator();s.hasNext();){const t=s.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=i.get(t.largestBatchId);null===e&&(e=qa(),i=i.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=qa(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return C.resolve(a)}It(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.Pr.get(r.largestBatchId).delete(n.key);this.Pr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new bo(t,n));let i=this.Pr.get(t);void 0===i&&(i=O(),this.Pr.set(t,i)),this.Pr.set(t,i.add(n.key))}}class Mh{constructor(){this.Ir=new D(Oh.dr),this.Tr=new D(Oh.Er)}isEmpty(){return this.Ir.isEmpty()}addReference(e,t){e=new Oh(e,t);this.Ir=this.Ir.add(e),this.Tr=this.Tr.add(e)}Ar(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Rr(new Oh(e,t))}Vr(e,t){e.forEach(e=>this.removeReference(e,t))}mr(e){const t=new S(new T([])),n=new Oh(t,e),r=new Oh(t,e+1),i=[];return this.Tr.forEachInRange([n,r],e=>{this.Rr(e),i.push(e.key)}),i}gr(){this.Ir.forEach(e=>this.Rr(e))}Rr(e){this.Ir=this.Ir.delete(e),this.Tr=this.Tr.delete(e)}pr(e){var t=new S(new T([])),n=new Oh(t,e),t=new Oh(t,e+1);let r=O();return this.Tr.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Oh(e,0);return null!==(t=this.Ir.firstAfterOrEqual(t))&&e.isEqual(t.key)}}class Oh{constructor(e,t){this.key=e,this.yr=t}static dr(e,t){return S.comparator(e.key,t.key)||I(e.yr,t.yr)}static Er(e,t){return I(e.yr,t.yr)||S.comparator(e.key,t.key)}}class Lh{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.wr=1,this.Sr=new D(Oh.dr)}checkEmpty(e){return C.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var i=this.wr,t=(this.wr++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1],new wo(i,t,n,r));this.mutationQueue.push(t);for(const t of r)this.Sr=this.Sr.add(new Oh(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return C.resolve(t)}lookupMutationBatch(e,t){return C.resolve(this.br(t))}getNextMutationBatchAfterBatchId(e,t){t=(t=this.Dr(t+1))<0?0:t;return C.resolve(this.mutationQueue.length>t?this.mutationQueue[t]:null)}getHighestUnacknowledgedBatchId(){return C.resolve(0===this.mutationQueue.length?-1:this.wr-1)}getAllMutationBatches(e){return C.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Oh(t,0),r=new Oh(t,Number.POSITIVE_INFINITY),i=[];return this.Sr.forEachInRange([n,r],e=>{e=this.br(e.yr);i.push(e)}),C.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new D(I);return t.forEach(e=>{var t=new Oh(e,0),e=new Oh(e,Number.POSITIVE_INFINITY);this.Sr.forEachInRange([t,e],e=>{n=n.add(e.yr)})}),C.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;S.isDocumentKey(i)||(i=i.child(""));t=new Oh(new S(i),0);let s=new D(I);return this.Sr.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(s=s.add(e.yr)),!0)},t),C.resolve(this.Cr(s))}Cr(e){const t=[];return e.forEach(e=>{e=this.br(e);null!==e&&t.push(e)}),t}removeMutationBatch(n,r){y(0===this.vr(r.batchId,"removed")),this.mutationQueue.shift();let i=this.Sr;return C.forEach(r.mutations,e=>{var t=new Oh(e.key,r.batchId);return i=i.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.Sr=i})}xn(e){}containsKey(e,t){var n=new Oh(t,0),n=this.Sr.firstAfterOrEqual(n);return C.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,C.resolve()}vr(e,t){return this.Dr(e)}Dr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}br(e){e=this.Dr(e);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class Fh{constructor(e){this.Fr=e,this.docs=new A(S.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){var n=t.key,r=this.docs.get(n),r=r?r.size:0,i=this.Fr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){var n=this.docs.get(t);return C.resolve(n?n.document.mutableCopy():k.newInvalidDocument(t))}getEntries(e,t){let n=Pa;return t.forEach(e=>{var t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():k.newInvalidDocument(e))}),C.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Pa;const s=t.path,a=new S(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||pi(gi(a),n)<=0||(r.has(a.key)||Ma(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return C.resolve(i)}getAllFromCollectionGroup(e,t,n,r){b()}Mr(e,t){return C.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Ph(this)}getSize(e){return C.resolve(this.size)}}class Ph extends _h{constructor(e){super(),this.ur=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.ur.addEntry(n,t)):this.ur.removeEntry(e)}),C.waitFor(r)}getFromCache(e,t){return this.ur.getEntry(e,t)}getAllFromCache(e,t){return this.ur.getEntries(e,t)}}class Vh{constructor(e){this.persistence=e,this.Or=new Fa(e=>fa(e),ga),this.lastRemoteSnapshotVersion=E.min(),this.highestTargetId=0,this.Nr=0,this.Br=new Mh,this.targetCount=0,this.Lr=hh.Bn()}forEachTarget(e,n){return this.Or.forEach((e,t)=>n(t)),C.resolve()}getLastRemoteSnapshotVersion(e){return C.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return C.resolve(this.Nr)}allocateTargetId(e){return this.highestTargetId=this.Lr.next(),C.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Nr&&(this.Nr=t),C.resolve()}Qn(e){this.Or.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Lr=new hh(t),this.highestTargetId=t),e.sequenceNumber>this.Nr&&(this.Nr=e.sequenceNumber)}addTargetData(e,t){return this.Qn(t),this.targetCount+=1,C.resolve()}updateTargetData(e,t){return this.Qn(t),C.resolve()}removeTargetData(e,t){return this.Or.delete(t.target),this.Br.mr(t.targetId),--this.targetCount,C.resolve()}removeTargets(n,r,i){let s=0;const a=[];return this.Or.forEach((e,t)=>{t.sequenceNumber<=r&&null===i.get(t.targetId)&&(this.Or.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),s++)}),C.waitFor(a).next(()=>s)}getTargetCount(e){return C.resolve(this.targetCount)}getTargetData(e,t){t=this.Or.get(t)||null;return C.resolve(t)}addMatchingKeys(e,t,n){return this.Br.Ar(t,n),C.resolve()}removeMatchingKeys(t,e,n){this.Br.Vr(e,n);const r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(e=>{i.push(r.markPotentiallyOrphaned(t,e))}),C.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Br.mr(t),C.resolve()}getMatchingKeysForTargetId(e,t){t=this.Br.pr(t);return C.resolve(t)}containsKey(e,t){return C.resolve(this.Br.containsKey(t))}}class Bh{constructor(e,t){this.kr={},this.overlays={},this.qr=new ki(0),this.Qr=!1,this.Qr=!0,this.referenceDelegate=e(this),this.Kr=new Vh(this),this.indexManager=new zu,this.remoteDocumentCache=(e=e=>this.referenceDelegate.$r(e),new Fh(e)),this.serializer=new du(t),this.Ur=new kh(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Qr=!1,Promise.resolve()}get started(){return this.Qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Rh,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.kr[e.toKey()];return n||(n=new Lh(t,this.referenceDelegate),this.kr[e.toKey()]=n),n}getTargetCache(){return this.Kr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ur}runTransaction(e,t,n){m("MemoryPersistence","Starting transaction:",e);const r=new Uh(this.qr.next());return this.referenceDelegate.Wr(),n(r).next(e=>this.referenceDelegate.Gr(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}zr(t,n){return C.or(Object.values(this.kr).map(e=>()=>e.containsKey(t,n)))}}class Uh extends vi{constructor(e){super(),this.currentSequenceNumber=e}}class qh{constructor(e){this.persistence=e,this.jr=new Mh,this.Hr=null}static Jr(e){return new qh(e)}get Yr(){if(this.Hr)return this.Hr;throw b()}addReference(e,t,n){return this.jr.addReference(n,t),this.Yr.delete(n.toString()),C.resolve()}removeReference(e,t,n){return this.jr.removeReference(n,t),this.Yr.add(n.toString()),C.resolve()}markPotentiallyOrphaned(e,t){return this.Yr.add(t.toString()),C.resolve()}removeTarget(e,t){this.jr.mr(t.targetId).forEach(e=>this.Yr.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Yr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Wr(){this.Hr=new Set}Gr(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return C.forEach(this.Yr,e=>{const t=S.fromPath(e);return this.Zr(n,t).next(e=>{e||r.removeEntry(t,E.min())})}).next(()=>(this.Hr=null,r.apply(n)))}updateLimboDocument(e,t){return this.Zr(e,t).next(e=>{e?this.Yr.delete(t.toString()):this.Yr.add(t.toString())})}$r(e){return 0}Zr(e,t){return C.or([()=>C.resolve(this.jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.zr(e,t)])}}class jh{constructor(e){this.serializer=e}B(t,e,n,r){const s=new _i("createOrUpgrade",e);var i;n<1&&1<=r&&(t.createObjectStore("owner"),(i=t).createObjectStore("mutationQueues",{keyPath:"userId"}),i.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vi,{unique:!0}),i.createObjectStore("documentMutations"),Gh(t),t.createObjectStore("remoteDocuments"));let a=C.resolve();return n<3&&3<=r&&(0!==n&&((i=t).deleteObjectStore("targetDocuments"),i.deleteObjectStore("targets"),i.deleteObjectStore("targetGlobal"),Gh(t)),a=a.next(()=>{return e=s.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:E.min().toTimestamp(),targetCount:0},e.put("targetGlobalKey",t);var e,t})),n<4&&4<=r&&(a=(a=0!==n?a.next(()=>{return r=t,(i=s).store("mutations").G().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vi,{unique:!0});const t=i.store("mutations"),n=e.map(e=>t.put(e));return C.waitFor(n)});var r,i}):a).next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.ei(s))),n<6&&6<=r&&(a=a.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.ti(s)))),n<7&&7<=r&&(a=a.next(()=>this.ni(s))),n<8&&8<=r&&(a=a.next(()=>this.ri(t,s))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.ii(s))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{var e;(e=t.createObjectStore("documentOverlays",{keyPath:Zi})).createIndex("collectionPathOverlayIndex",es,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",ts,{unique:!1})})),n<13&&13<=r&&(a=a.next(()=>{var e;(e=t.createObjectStore("remoteDocumentsV14",{keyPath:ji})).createIndex("documentKeyIndex",Gi),e.createIndex("collectionGroupIndex",Ki)}).next(()=>this.si(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.oi(t,s))),a=n<15&&15<=r?a.next(()=>{var e;(e=t).createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Wi}).createIndex("sequenceNumberIndex",Yi,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Xi}).createIndex("documentKeyIndex",Ji,{unique:!1})}):a}ti(t){let n=0;return t.store("remoteDocuments").Z((e,t)=>{n+=rh(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}ei(n){const e=n.store("mutationQueues"),r=n.store("mutations");return e.G().next(e=>C.forEach(e,t=>{var e=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return r.G("userMutationsIndex",e).next(e=>C.forEach(e,e=>{y(e.userId===t.userId);e=yu(this.serializer,e);return nh(n,t.userId,e).next(()=>{})}))}))}ni(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{const s=[];return t.Z((e,t)=>{const n=new T(e),r=[0,Li(n)];s.push(a.get(r).next(e=>{return e?C.resolve():(e=n,a.put({targetId:0,path:Li(e),sequenceNumber:i.highestListenSequenceNumber}))}))}).next(()=>C.waitFor(s))})}ri(e,t){e.createObjectStore("collectionParents",{keyPath:Hi});const n=t.store("collectionParents"),r=new Qu,i=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Li(r)})}};return t.store("remoteDocuments").Z({Y:!0},(e,t)=>{e=new T(e);return i(e.popLast())}).next(()=>t.store("documentMutations").Z({Y:!0},([,e],t)=>{e=Pi(e);return i(e.popLast())}))}ii(e){const n=e.store("targets");return n.Z((e,t)=>{t=vu(t),t=wu(this.serializer,t);return n.put(t)})}si(e,i){const t=i.store("remoteDocuments"),s=[];return t.Z((e,t)=>{var n=i.store("remoteDocumentsV14"),r=((r=t).document?new S(T.fromString(r.document.name).popFirst(5)):r.noDocument?S.fromSegments(r.noDocument.path):r.unknownDocument?S.fromSegments(r.unknownDocument.path):b()).path.toArray(),r={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};s.push(n.put(r))}).next(()=>C.waitFor(s))}oi(e,i){const t=i.store("mutations"),s=Ih(this.serializer),a=new Bh(qh.Jr,this.serializer.ht);return t.G().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!=(t=r.get(e.userId))?t:O();yu(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),C.forEach(r,(e,t)=>{var t=new o(t),n=Cu.Pt(this.serializer,t),r=a.getIndexManager(t),t=ih.Pt(t,this.serializer,r,a.referenceDelegate);return new Nh(s,t,n,r).recalculateAndSaveOverlaysForDocumentKeys(new os(i,ki.ae),e).next()})})}}function Gh(e){e.createObjectStore("targetDocuments",{keyPath:Qi}).createIndex("documentTargetsIndex",$i,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",zi,{unique:!0}),e.createObjectStore("targetGlobal")}const Kh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class zh{constructor(e,t,n,r,i,s,a,o,u,h,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this._i=i,this.window=s,this.document=a,this.ai=u,this.ui=h,this.ci=l,this.qr=null,this.Qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.li=null,this.inForeground=!1,this.hi=null,this.Pi=null,this.Ii=Number.NEGATIVE_INFINITY,this.di=e=>Promise.resolve(),!zh.C())throw new _(w.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new vh(this,r),this.Ti=t+"main",this.serializer=new du(o),this.Ei=new bi(this.Ti,this.ci,new jh(this.serializer)),this.Kr=new lh(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Ih(this.serializer),this.Ur=new Tu,this.window&&this.window.localStorage?this.Ai=this.window.localStorage:(this.Ai=null,!1===h&&d("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ri().then(()=>{if(this.isPrimary||this.allowTabSynchronization)return this.Vi(),this.mi(),this.fi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Kr.getHighestSequenceNumber(e));throw new _(w.FAILED_PRECONDITION,Kh)}).then(e=>{this.qr=new ki(e,this.ai)}).then(()=>{this.Qr=!0}).catch(e=>(this.Ei&&this.Ei.close(),Promise.reject(e)))}gi(t){return this.di=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ei.k(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this._i.enqueueAndForget(async()=>{this.started&&await this.Ri()}))}Ri(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>$h(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.pi(t).next(e=>{e||(this.isPrimary=!1,this._i.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.yi(t)).next(e=>this.isPrimary&&!e?this.wi(t).next(()=>!1):!!e&&this.Si(t).next(()=>!0))).catch(e=>{if(Ti(e))return m("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(this.allowTabSynchronization)return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1;throw e}).then(e=>{this.isPrimary!==e&&this._i.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}pi(e){return Qh(e).get("owner").next(e=>C.resolve(this.bi(e)))}Di(e){return $h(e).delete(this.clientId)}async Ci(){if(this.isPrimary&&!this.vi(this.Ii,18e5)){this.Ii=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=us(e,"clientMetadata");return r.G().next(e=>{const t=this.Fi(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return C.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ai)for(const t of e)this.Ai.removeItem(this.Mi(t.clientId))}}fi(){this.Pi=this._i.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Ri().then(()=>this.Ci()).then(()=>this.fi()))}bi(e){return!!e&&e.ownerId===this.clientId}yi(t){return this.ui?C.resolve(!0):Qh(t).get("owner").next(e=>{if(null!==e&&this.vi(e.leaseTimestampMs,5e3)&&!this.xi(e.ownerId)){if(this.bi(e)&&this.networkEnabled)return!0;if(!this.bi(e)){if(e.allowTabSynchronization)return!1;throw new _(w.FAILED_PRECONDITION,Kh)}}return!(!this.networkEnabled||!this.inForeground)||$h(t).G().next(e=>void 0===this.Fi(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,e=this.networkEnabled===e.networkEnabled;if(t||n&&e)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&m("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Qr=!1,this.Oi(),this.Pi&&(this.Pi.cancel(),this.Pi=null),this.Ni(),this.Bi(),await this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new os(e,ki.ae);return this.wi(t).next(()=>this.Di(t))}),this.Ei.close(),this.Li()}Fi(e,t){return e.filter(e=>this.vi(e.updateTimeMs,t)&&!this.xi(e.clientId))}ki(){return this.runTransaction("getActiveClients","readonly",e=>$h(e).G().next(e=>this.Fi(e,18e5).map(e=>e.clientId)))}get started(){return this.Qr}getMutationQueue(e,t){return ih.Pt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Kr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Hu(e,this.serializer.ht.databaseId)}getDocumentOverlayCache(e){return Cu.Pt(this.serializer,e)}getBundleCache(){return this.Ur}runTransaction(t,n,r){m("IndexedDbPersistence","Starting transaction:",t);var e="readonly"===n?"readonly":"readwrite",i=15===(i=this.ci)?as:14===i?ss:13===i?is:12===i?rs:11===i?ns:void b();let s;return this.Ei.runTransaction(t,e,i,e=>(s=new os(e,this.qr?this.qr.next():ki.ae),"readwrite-primary"===n?this.pi(s).next(e=>!!e||this.yi(s)).next(e=>{if(e)return r(s);throw d(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this._i.enqueueRetryable(()=>this.di(!1)),new _(w.FAILED_PRECONDITION,yi)}).next(e=>this.Si(s).next(()=>e)):this.qi(s).next(()=>r(s)))).then(e=>(s.raiseOnCommittedEvent(),e))}qi(e){return Qh(e).get("owner").next(e=>{if(null!==e&&this.vi(e.leaseTimestampMs,5e3)&&!this.xi(e.ownerId)&&!this.bi(e)&&!(this.ui||this.allowTabSynchronization&&e.allowTabSynchronization))throw new _(w.FAILED_PRECONDITION,Kh)})}Si(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Qh(e).put("owner",t)}static C(){return bi.C()}wi(e){const t=Qh(e);return t.get("owner").next(e=>this.bi(e)?(m("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):C.resolve())}vi(e,t){var n=Date.now();return!(e<n-t||n<e&&(d(`Detected an update time that is in the future: ${e} > `+n),1))}Vi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.hi=()=>{this._i.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Ri()))},this.document.addEventListener("visibilitychange",this.hi),this.inForeground="visible"===this.document.visibilityState)}Ni(){this.hi&&(this.document.removeEventListener("visibilitychange",this.hi),this.hi=null)}mi(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.li=()=>{this.Oi();var e=/(?:Version|Mobile)\/1[456]/;K()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this._i.enterRestrictedMode(!0),this._i.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.li))}Bi(){this.li&&(this.window.removeEventListener("pagehide",this.li),this.li=null)}xi(e){var t;try{var n=null!==(null==(t=this.Ai)?void 0:t.getItem(this.Mi(e)));return m("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return d("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Oi(){if(this.Ai)try{this.Ai.setItem(this.Mi(this.clientId),String(Date.now()))}catch(e){d("Failed to set zombie client id.",e)}}Li(){if(this.Ai)try{this.Ai.removeItem(this.Mi(this.clientId))}catch(e){}}Mi(e){return`firestore_zombie_${this.persistenceKey}_`+e}}function Qh(e){return us(e,"owner")}function $h(e){return us(e,"clientMetadata")}function Hh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Wh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Qi=n,this.Ki=r}static $i(e,t){let n=O(),r=O();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Wh(e,t.fromCache,n,r)}}class Yh{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class Xh{constructor(){this.Ui=!1,this.Wi=!1,this.Gi=100,this.zi=8}initialize(e,t){this.ji=e,this.indexManager=t,this.Ui=!0}getDocumentsMatchingQuery(n,r,e,t){const i={result:null};return this.Hi(n,r).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.Ji(n,r,t,e).next(e=>{i.result=e})}).next(()=>{if(!i.result){const t=new Yh;return this.Yi(n,r,t).next(e=>{if(i.result=e,this.Wi)return this.Zi(n,r,t,e.size)})}}).next(()=>i.result)}Zi(e,t,n,r){return n.documentReadCount<this.Gi?(zr()<=c.DEBUG&&m("QueryEngine","SDK will not create cache indexes for query:",Ra(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Gi,"documents"),C.resolve()):(zr()<=c.DEBUG&&m("QueryEngine","Query:",Ra(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.zi*r?(zr()<=c.DEBUG&&m("QueryEngine","The SDK decides to create cache indexes for query:",Ra(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Ca(t))):C.resolve())}Hi(i,s){if(Ia(s))return C.resolve(null);let t=Ca(s);return this.indexManager.getIndexType(i,t).next(e=>0===e?null:(null!==s.limit&&1===e&&(s=Da(s,null,"F"),t=Ca(s)),this.indexManager.getDocumentsMatchingTarget(i,t).next(e=>{const r=O(...e);return this.ji.getDocuments(i,r).next(n=>this.indexManager.getMinOffset(i,t).next(e=>{var t=this.Xi(s,n);return this.es(s,t,r,e.readTime)?this.Hi(i,Da(s,null,"F")):this.ts(i,t,s,e)}))})))}Ji(t,n,r,i){return Ia(n)||i.isEqual(E.min())?C.resolve(null):this.ji.getDocuments(t,r).next(e=>{e=this.Xi(n,e);return this.es(n,e,r,i)?C.resolve(null):(zr()<=c.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Ra(n)),this.ts(t,e,n,fi(i,-1)).next(e=>e))})}Xi(n,e){let r=new D(La(n));return e.forEach((e,t)=>{Ma(n,t)&&(r=r.add(t))}),r}es(e,t,n,r){return null!==e.limit&&(n.size!==t.size||!!(n="F"===e.limitType?t.last():t.first())&&(n.hasPendingWrites||0<n.version.compareTo(r)))}Yi(e,t,n){return zr()<=c.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",Ra(t)),this.ji.getDocumentsMatchingQuery(e,t,mi.min(),n)}ts(e,n,t,r){return this.ji.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class Jh{constructor(e,t,n,r){this.persistence=e,this.ns=t,this.serializer=r,this.rs=new A(I),this.ss=new Fa(e=>fa(e),ga),this.os=new Map,this._s=e.getRemoteDocumentCache(),this.Kr=e.getTargetCache(),this.Ur=e.getBundleCache(),this.us(n)}us(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Nh(this._s,this.mutationQueue,this.documentOverlayCache,this.indexManager),this._s.setIndexManager(this.indexManager),this.ns.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.rs))}}function Zh(e,t,n,r){return new Jh(e,t,n,r)}async function el(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",i=>{let s;return a.mutationQueue.getAllMutationBatches(i).next(e=>(s=e,a.us(t),a.mutationQueue.getAllMutationBatches(i))).next(e=>{const t=[],n=[];let r=O();for(const i of s){t.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}for(const i of e){n.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(i,r).next(e=>({cs:e,removedBatchIds:t,addedBatchIds:n}))})})}function tl(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Kr.getLastRemoteSnapshotVersion(e))}function nl(e,s,t){let n=O(),a=O();return t.forEach(e=>n=n.add(e)),s.getEntries(e,n).next(r=>{let i=Pa;return t.forEach((e,t)=>{var n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(E.min())?(s.removeEntry(e,t.readTime),i=i.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(s.addEntry(t),i=i.insert(e,t)):m("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{ls:i,hs:a}})}function rl(e,r){const i=e;return i.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return i.Kr.getTargetData(t,r).next(e=>e?(n=e,C.resolve(n)):i.Kr.allocateTargetId(t).next(e=>(n=new cu(r,e,"TargetPurposeListen",t.currentSequenceNumber),i.Kr.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=i.rs.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(i.rs=i.rs.insert(e.targetId,e),i.ss.set(r,e.targetId)),e})}async function il(e,t,n){const r=e,i=r.rs.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,e=>r.persistence.referenceDelegate.removeTarget(e,i))}catch(e){if(!Ti(e))throw e;m("LocalStore",`Failed to update sequence numbers for target ${t}: `+e)}r.rs=r.rs.remove(t),r.ss.delete(i.target)}function sl(e,s,a){const o=e;let u=E.min(),h=O();return o.persistence.runTransaction("Execute query","readwrite",t=>{return e=o,n=t,r=Ca(s),(void 0!==(i=e.ss.get(r))?C.resolve(e.rs.get(i)):e.Kr.getTargetData(n,r)).next(e=>{if(e)return u=e.lastLimboFreeSnapshotVersion,o.Kr.getMatchingKeysForTargetId(t,e.targetId).next(e=>{h=e})}).next(()=>o.ns.getDocumentsMatchingQuery(t,s,a?u:E.min(),a?h:O())).next(e=>(ul(o,Oa(s),e),{documents:e,Ps:h}));var e,n,r,i})}function al(e,t){const n=e,r=n.Kr,i=n.rs.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",e=>r.lt(e,t).next(e=>e?e.target:null))}function ol(e,t){const n=e,r=n.os.get(t)||E.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n._s.getAllFromCollectionGroup(e,t,fi(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(ul(n,t,e),e))}function ul(e,t,n){let r=e.os.get(t)||E.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.os.set(t,r)}function hl(e,t){return`firestore_clients_${e}_`+t}function ll(e,t,n){let r=`firestore_mutations_${e}_`+n;return t.isAuthenticated()&&(r+="_"+t.uid),r}function cl(e,t){return`firestore_targets_${e}_`+t}class dl{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Es(e,t,n){var r=JSON.parse(n);let i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new _(r.error.code,r.error.message)),s?new dl(e,t,r.state,i):(d("SharedClientState",`Failed to parse mutation state for ID '${t}': `+n),null)}As(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class fl{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Es(e,t){var n=JSON.parse(t);let r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new _(n.error.code,n.error.message)),i?new fl(e,n.state,r):(d("SharedClientState",`Failed to parse target state for ID '${e}': `+t),null)}As(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class gl{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Es(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,i=Ka;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=Oi(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new gl(e,i):(d("SharedClientState",`Failed to parse client data for instance '${e}': `+t),null)}}class ml{constructor(e,t){this.clientId=e,this.onlineState=t}static Es(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new ml(t.clientId,t.onlineState):(d("SharedClientState","Failed to parse online state: "+e),null)}}class pl{constructor(){this.activeTargetIds=Ka}Rs(e){this.activeTargetIds=this.activeTargetIds.add(e)}Vs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}As(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class yl{constructor(e,t,n,r,i){this.window=e,this._i=t,this.persistenceKey=n,this.fs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.gs=this.ps.bind(this),this.ys=new A(I),this.started=!1,this.ws=[];e=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Ss=hl(this.persistenceKey,this.fs),this.bs="firestore_sequence_number_"+this.persistenceKey,this.ys=this.ys.insert(this.fs,new pl),this.Ds=new RegExp(`^firestore_clients_${e}_([^_]*)$`),this.Cs=new RegExp(`^firestore_mutations_${e}_(\\d+)(?:_(.*))?$`),this.vs=new RegExp(`^firestore_targets_${e}_(\\d+)$`),this.Fs="firestore_online_state_"+this.persistenceKey,this.Ms="firestore_bundle_loaded_v2_"+this.persistenceKey,this.window.addEventListener("storage",this.gs)}static C(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.ki();for(const n of e)if(n!==this.fs){const e=this.getItem(hl(this.persistenceKey,n));var t;e&&(t=gl.Es(n,e))&&(this.ys=this.ys.insert(t.clientId,t))}this.xs();const n=this.storage.getItem(this.Fs);if(n){const e=this.Os(n);e&&this.Ns(e)}for(const e of this.ws)this.ps(e);this.ws=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.bs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Bs(this.ys)}isActiveQueryTarget(n){let r=!1;return this.ys.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Ls(e,"pending")}updateMutationState(e,t,n){this.Ls(e,t,n),this.ks(e)}addLocalQueryTarget(e){let t="not-current";var n;return!this.isActiveQueryTarget(e)||(n=this.storage.getItem(cl(this.persistenceKey,e)))&&(n=fl.Es(e,n))&&(t=n.state),this.qs.Rs(e),this.xs(),t}removeLocalQueryTarget(e){this.qs.Vs(e),this.xs()}isLocalQueryTarget(e){return this.qs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(cl(this.persistenceKey,e))}updateQueryState(e,t,n){this.Qs(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.ks(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Ks(e)}notifyBundleLoaded(e){this.$s(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.gs),this.removeItem(this.Ss),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return m("SharedClientState","READ",e,t),t}setItem(e,t){m("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){m("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ps(e){const r=e;r.storageArea===this.storage&&(m("SharedClientState","EVENT",r.key,r.newValue),r.key!==this.Ss?this._i.enqueueRetryable(async()=>{if(this.started){if(null!==r.key){var e;if(this.Ds.test(r.key))return null==r.newValue?(e=this.Us(r.key),this.Ws(e,null)):(e=this.Gs(r.key,r.newValue))?this.Ws(e.clientId,e):void 0;if(this.Cs.test(r.key)){if(null!==r.newValue){var t=this.zs(r.key,r.newValue);if(t)return this.js(t)}}else if(this.vs.test(r.key)){if(null!==r.newValue&&(t=this.Hs(r.key,r.newValue)))return this.Js(t)}else if(r.key===this.Fs){if(null!==r.newValue){var n=this.Os(r.newValue);if(n)return this.Ns(n)}}else r.key===this.bs?(n=function(e){let t=ki.ae;if(null!=e)try{var n=JSON.parse(e);y("number"==typeof n),t=n}catch(e){d("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(r.newValue))!==ki.ae&&this.sequenceNumberHandler(n):r.key===this.Ms&&(e=this.Ys(r.newValue),await Promise.all(e.map(e=>this.syncEngine.Zs(e))))}}else this.ws.push(r)}):d("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get qs(){return this.ys.get(this.fs)}xs(){this.setItem(this.Ss,this.qs.As())}Ls(e,t,n){t=new dl(this.currentUser,e,t,n),n=ll(this.persistenceKey,this.currentUser,e);this.setItem(n,t.As())}ks(e){e=ll(this.persistenceKey,this.currentUser,e);this.removeItem(e)}Ks(e){e={clientId:this.fs,onlineState:e};this.storage.setItem(this.Fs,JSON.stringify(e))}Qs(e,t,n){var r=cl(this.persistenceKey,e),e=new fl(e,t,n);this.setItem(r,e.As())}$s(e){e=JSON.stringify(Array.from(e));this.setItem(this.Ms,e)}Us(e){e=this.Ds.exec(e);return e?e[1]:null}Gs(e,t){e=this.Us(e);return gl.Es(e,t)}zs(e,t){var e=this.Cs.exec(e),n=Number(e[1]),e=void 0!==e[2]?e[2]:null;return dl.Es(new o(e),n,t)}Hs(e,t){e=this.vs.exec(e),e=Number(e[1]);return fl.Es(e,t)}Os(e){return ml.Es(e)}Ys(e){return JSON.parse(e)}async js(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Xs(e.batchId,e.state,e.error);m("SharedClientState","Ignoring mutation for non-active user "+e.user.uid)}Js(e){return this.syncEngine.eo(e.targetId,e.state,e.error)}Ws(e,t){const n=t?this.ys.insert(e,t):this.ys.remove(e),r=this.Bs(this.ys),i=this.Bs(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.no(s,a).then(()=>{this.ys=n})}Ns(e){this.ys.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Bs(e){let n=Ka;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class vl{constructor(){this.ro=new pl,this.io={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.ro.Rs(e),this.io[e]||"not-current"}updateQueryState(e,t,n){this.io[e]=t}removeLocalQueryTarget(e){this.ro.Vs(e)}isLocalQueryTarget(e){return this.ro.activeTargetIds.has(e)}clearQueryState(e){delete this.io[e]}getAllActiveQueryTargets(){return this.ro.activeTargetIds}isActiveQueryTarget(e){return this.ro.activeTargetIds.has(e)}start(){return this.ro=new pl,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class wl{so(e){}shutdown(){}}class _l{constructor(){this.oo=()=>this._o(),this.ao=()=>this.uo(),this.co=[],this.lo()}so(e){this.co.push(e)}shutdown(){window.removeEventListener("online",this.oo),window.removeEventListener("offline",this.ao)}lo(){window.addEventListener("online",this.oo),window.addEventListener("offline",this.ao)}_o(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.co)e(0)}uo(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.co)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let bl=null;function Il(){return null===bl?bl=268435456+Math.round(2147483648*Math.random()):bl++,"0x"+bl.toString(16)}const El={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Tl{constructor(e){this.ho=e.ho,this.Po=e.Po}Io(e){this.To=e}Eo(e){this.Ao=e}onMessage(e){this.Ro=e}close(){this.Po()}send(e){this.ho(e)}Vo(){this.To()}mo(e){this.Ao(e)}fo(e){this.Ro(e)}}const Sl="WebChannelConnection";class xl extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.po=t+"://"+e.host,this.yo=`projects/${n}/databases/`+r,this.wo="(default)"===this.databaseId.database?"project_id="+n:`project_id=${n}&database_id=`+r}get So(){return!1}bo(t,e,n,r,i){const s=Il(),a=this.Do(t,e);m("RestConnection",`Sending RPC '${t}' ${s}:`,a,n);e={"google-cloud-resource-prefix":this.yo,"x-goog-request-params":this.wo};return this.Co(e,r,i),this.vo(t,a,e,n).then(e=>(m("RestConnection",`Received RPC '${t}' ${s}: `,e),e),e=>{throw Qr("RestConnection",`RPC '${t}' ${s} failed with error: `,e,"url: ",a,"request:",n),e})}Fo(e,t,n,r,i,s){return this.bo(e,t,n,r,i)}Co(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+Gr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}Do(e,t){e=El[e];return this.po+`/v1/${t}:`+e}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}vo(o,t,n,r){const u=Il();return new Promise((i,s)=>{const a=new Ur;a.setWithCredentials(!0),a.listenOnce(Pr.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case Fr.NO_ERROR:var e=a.getResponseJson();m(Sl,`XHR for RPC '${o}' ${u} received:`,JSON.stringify(e)),i(e);break;case Fr.TIMEOUT:m(Sl,`RPC '${o}' ${u} timed out`),s(new _(w.DEADLINE_EXCEEDED,"Request time out"));break;case Fr.HTTP_ERROR:var t=a.getStatus();if(m(Sl,`RPC '${o}' ${u} failed with status:`,t,"response text:",a.getResponseText()),0<t){let e=a.getResponseJson();var n=null==(e=Array.isArray(e)?e[0]:e)?void 0:e.error;if(n&&n.status&&n.message){r=n.status.toLowerCase().replace(/_/g,"-");const o=0<=Object.values(w).indexOf(r)?r:w.UNKNOWN;s(new _(o,n.message))}else s(new _(w.UNKNOWN,"Server responded with status "+a.getStatus()))}else s(new _(w.UNAVAILABLE,"Connection failed."));break;default:b()}}finally{m(Sl,`RPC '${o}' ${u} completed.`)}var r});var e=JSON.stringify(r);m(Sl,`RPC '${o}' ${u} sending request:`,r),a.send(t,"POST",e,n,15)})}Mo(i,e,t){const s=Il(),n=[this.po,"/","google.firestore.v1.Firestore","/",i,"/channel"],r=new cr,a=Lr(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/`+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(o.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(o.useFetchStreams=!0),this.Co(o.initMessageHeaders,e,t),o.encodeInitMessageHeaders=!0;e=n.join("");m(Sl,`Creating RPC '${i}' stream ${s}: `+e,o);const h=r.createWebChannel(e,o);let l=!1,c=!1;const d=new Tl({ho:e=>{c?m(Sl,`Not sending because RPC '${i}' stream ${s} is closed:`,e):(l||(m(Sl,`Opening RPC '${i}' stream ${s} transport.`),h.open(),l=!0),m(Sl,`RPC '${i}' stream ${s} sending:`,e),h.send(e))},Po:()=>h.close()}),f=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return f(h,Br.EventType.OPEN,()=>{c||m(Sl,`RPC '${i}' stream ${s} transport opened.`)}),f(h,Br.EventType.CLOSE,()=>{c||(c=!0,m(Sl,`RPC '${i}' stream ${s} transport closed`),d.mo())}),f(h,Br.EventType.ERROR,e=>{c||(c=!0,Qr(Sl,`RPC '${i}' stream ${s} transport errored:`,e),d.mo(new _(w.UNAVAILABLE,"The operation could not be completed")))}),f(h,Br.EventType.MESSAGE,n=>{if(!c){var n=n.data[0],r=(y(!!n),n.error||(null==(r=n[0])?void 0:r.error));if(r){m(Sl,`RPC '${i}' stream ${s} received error:`,r);const n=r.status;let e=function(e){e=g[e];if(void 0!==e)return To(e)}(n),t=r.message;void 0===e&&(e=w.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),c=!0,d.mo(new _(e,t)),h.close()}else m(Sl,`RPC '${i}' stream ${s} received:`,n),d.fo(n)}}),f(a,Vr.STAT_EVENT,e=>{10===e.stat?m(Sl,`RPC '${i}' stream ${s} detected buffering proxy`):11===e.stat&&m(Sl,`RPC '${i}' stream ${s} detected no buffering proxy`)}),setTimeout(()=>{d.Vo()},0),d}}function Cl(){return"undefined"!=typeof window?window:null}function Al(){return"undefined"!=typeof document?document:null}function Dl(e){return new Go(e,!0)}class Nl{constructor(e,t,n=1e3,r=1.5,i=6e4){this._i=e,this.timerId=t,this.xo=n,this.Oo=r,this.No=i,this.Bo=0,this.Lo=null,this.ko=Date.now(),this.reset()}reset(){this.Bo=0}qo(){this.Bo=this.No}Qo(e){this.cancel();var t=Math.floor(this.Bo+this.Ko()),n=Math.max(0,Date.now()-this.ko),r=Math.max(0,t-n);0<r&&m("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Bo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Lo=this._i.enqueueAfterDelay(this.timerId,r,()=>(this.ko=Date.now(),e())),this.Bo*=this.Oo,this.Bo<this.xo&&(this.Bo=this.xo),this.Bo>this.No&&(this.Bo=this.No)}$o(){null!==this.Lo&&(this.Lo.skipDelay(),this.Lo=null)}cancel(){null!==this.Lo&&(this.Lo.cancel(),this.Lo=null)}Ko(){return(Math.random()-.5)*this.Bo}}class kl{constructor(e,t,n,r,i,s,a,o){this._i=e,this.Uo=n,this.Wo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Go=0,this.zo=null,this.jo=null,this.stream=null,this.Ho=new Nl(e,t)}Jo(){return 1===this.state||5===this.state||this.Yo()}Yo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Zo()}async stop(){this.Jo()&&await this.close(0)}Xo(){this.state=0,this.Ho.reset()}e_(){this.Yo()&&null===this.zo&&(this.zo=this._i.enqueueAfterDelay(this.Uo,6e4,()=>this.t_()))}n_(e){this.r_(),this.stream.send(e)}async t_(){if(this.Yo())return this.close(0)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}i_(){this.jo&&(this.jo.cancel(),this.jo=null)}async close(e,t){this.r_(),this.i_(),this.Ho.cancel(),this.Go++,4!==e?this.Ho.reset():t&&t.code===w.RESOURCE_EXHAUSTED?(d(t.toString()),d("Using maximum backoff delay to prevent overloading the backend."),this.Ho.qo()):t&&t.code===w.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.s_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Eo(t)}s_(){}auth(){this.state=1;const e=this.o_(this.Go),n=this.Go;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.Go===n&&this.__(e,t)},t=>{e(()=>{var e=new _(w.UNKNOWN,"Fetching auth token failed: "+t.message);return this.a_(e)})})}__(e,t){const n=this.o_(this.Go);this.stream=this.u_(e,t),this.stream.Io(()=>{n(()=>(this.state=2,this.jo=this._i.enqueueAfterDelay(this.Wo,1e4,()=>(this.Yo()&&(this.state=3),Promise.resolve())),this.listener.Io()))}),this.stream.Eo(e=>{n(()=>this.a_(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Zo(){this.state=5,this.Ho.Qo(async()=>{this.state=0,this.start()})}a_(e){return m("PersistentStream","close with error: "+e),this.stream=null,this.close(4,e)}o_(t){return e=>{this._i.enqueueAndForget(()=>this.Go===t?e():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Rl extends kl{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}u_(e,t){return this.connection.Mo("Listen",e,t)}onMessage(e){this.Ho.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:b(),i=t.targetChange.targetIds||[],s=(f=t.targetChange.resumeToken,e.useProto3Json?(y(void 0===f||"string"==typeof f),vs.fromBase64String(f||"")):(y(void 0===f||f instanceof Uint8Array),vs.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?w.UNKNOWN:To(f.code),new _(o,f.message||""));n=new Lo(r,i,s,o||null)}else if("documentChange"in t){t.documentChange;(l=t.documentChange).document,l.document.name,l.document.updateTime;var s=Yo(e,l.document.name),o=F(l.document.updateTime),u=l.document.createTime?F(l.document.createTime):E.min(),h=new zs({mapValue:{fields:l.document.fields}}),u=k.newFoundDocument(s,o,u,h),h=l.targetIds||[],l=l.removedTargetIds||[];n=new Mo(h,l,u.key,u)}else if("documentDelete"in t)t.documentDelete,(h=t.documentDelete).document,l=Yo(e,h.document),u=h.readTime?F(h.readTime):E.min(),u=k.newNoDocument(l,u),h=h.removedTargetIds||[],n=new Mo([],h,u.key,u);else if("documentRemove"in t){t.documentRemove;(d=t.documentRemove).document;var c=Yo(e,d.document),d=d.removedTargetIds||[];n=new Mo([],d,c,null)}else{if(!("filter"in t))return b();{t.filter;const e=t.filter;e.targetId;var{count:d=0,unchangedNames:c}=e,d=new Io(d,c),c=e.targetId;n=new Oo(c,d)}}var f;return n}(this.serializer,e),e=!("targetChange"in(e=e))||(e=e.targetChange).targetIds&&e.targetIds.length||!e.readTime?E.min():F(e.readTime);return this.listener.c_(t,e)}l_(e){var t={};t.database=Zo(this.serializer),t.addTarget=function(e,t){var n;const r=t.target;if((n=ma(r)?{documents:su(e,r)}:{query:au(e,r)}).targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=Qo(e,t.resumeToken);const r=Ko(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(E.min())){n.readTime=zo(e,t.snapshotVersion.toTimestamp());const r=Ko(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);this.serializer;var n=null==(n=function(){switch(e.purpose){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return b()}}())?null:{"goog-listen-tags":n};n&&(t.labels=n),this.n_(t)}h_(e){var t={};t.database=Zo(this.serializer),t.removeTarget=e,this.n_(t)}}class Ml extends kl{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.P_=!1}get I_(){return this.P_}start(){this.P_=!1,this.lastStreamToken=void 0,super.start()}s_(){this.P_&&this.d_([])}u_(e,t){return this.connection.Mo("Write",e,t)}onMessage(e){var t,n,r;return y(!!e.streamToken),this.lastStreamToken=e.streamToken,this.P_?(this.Ho.reset(),n=e.writeResults,r=e.commitTime,n=n&&0<n.length?(y(void 0!==r),n.map(t=>{{var n=r;let e=t.updateTime?F(t.updateTime):F(n);return e.isEqual(E.min())&&(e=F(n)),new so(e,t.transformResults||[])}})):[],t=F(e.commitTime),this.listener.T_(t,n)):(y(!e.writeResults||0===e.writeResults.length),this.P_=!0,this.listener.E_())}A_(){var e={};e.database=Zo(this.serializer),this.n_(e)}d_(e){e={streamToken:this.lastStreamToken,writes:e.map(e=>ru(this.serializer,e))};this.n_(e)}}class Ol extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.R_=!1}V_(){if(this.R_)throw new _(w.FAILED_PRECONDITION,"The client has already been terminated.")}bo(n,r,i){return this.V_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.bo(n,r,i,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===w.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(w.UNKNOWN,e.toString())})}Fo(n,r,i,s){return this.V_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.Fo(n,r,i,e,t,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===w.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(w.UNKNOWN,e.toString())})}terminate(){this.R_=!0}}class Ll{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.f_=0,this.g_=null,this.p_=!0}y_(){0===this.f_&&(this.w_("Unknown"),this.g_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.g_=null,this.S_("Backend didn't respond within 10 seconds."),this.w_("Offline"),Promise.resolve())))}b_(e){"Online"===this.state?this.w_("Unknown"):(this.f_++,1<=this.f_&&(this.D_(),this.S_("Connection failed 1 times. Most recent error: "+e.toString()),this.w_("Offline")))}set(e){this.D_(),this.f_=0,"Online"===e&&(this.p_=!1),this.w_(e)}w_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}S_(e){e=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.p_?(d(e),this.p_=!1):m("OnlineStateTracker",e)}D_(){null!==this.g_&&(this.g_.cancel(),this.g_=null)}}class Fl{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.C_=[],this.v_=new Map,this.F_=new Set,this.M_=[],this.x_=i,this.x_.so(e=>{n.enqueueAndForget(async()=>{var e;zl(this)&&(m("RemoteStore","Restarting streams for network reachability change."),(e=this).F_.add(4),await Vl(e),e.O_.set("Unknown"),e.F_.delete(4),await Pl(e))})}),this.O_=new Ll(n,r)}}async function Pl(e){if(zl(e))for(const t of e.M_)await t(!0)}async function Vl(e){for(const t of e.M_)await t(!1)}function Bl(e,t){e.v_.has(t.targetId)||(e.v_.set(t.targetId,t),Kl(e)?Gl(e):ec(e).Yo()&&ql(e,t))}function Ul(e,t){var n=ec(e);e.v_.delete(t),n.Yo()&&jl(e,t),0===e.v_.size&&(n.Yo()?n.e_():zl(e)&&e.O_.set("Unknown"))}function ql(e,t){var n;e.N_.Le(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(E.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),ec(e).l_(t)}function jl(e,t){e.N_.Le(t),ec(e).h_(t)}function Gl(t){t.N_=new Po({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),lt:e=>t.v_.get(e)||null,st:()=>t.datastore.serializer.databaseId}),ec(t).start(),t.O_.y_()}function Kl(e){return zl(e)&&!ec(e).Jo()&&0<e.v_.size}function zl(e){return 0===e.F_.size}function Ql(e){e.N_=void 0}async function $l(e,t,n){if(!Ti(t))throw t;e.F_.add(1),await Vl(e),e.O_.set("Offline"),n=n||(()=>tl(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),e.F_.delete(1),await Pl(e)})}function Hl(t,n){return n().catch(e=>$l(t,e,n))}async function Wl(e){var t,n=e,r=tc(n);let i=0<n.C_.length?n.C_[n.C_.length-1].batchId:-1;for(;zl(t=n)&&t.C_.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(n.localStore,i);if(null===e){0===n.C_.length&&r.e_();break}i=e.batchId;var s=n,a=e;s.C_.push(a),(s=tc(s)).Yo()&&s.I_&&s.d_(a.mutations)}catch(e){await $l(n,e)}Yl(n)&&Xl(n)}function Yl(e){return zl(e)&&!tc(e).Jo()&&0<e.C_.length}function Xl(e){tc(e).start()}async function Jl(e,t){e.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");var n=zl(e);e.F_.add(3),await Vl(e),n&&e.O_.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.F_.delete(3),await Pl(e)}async function Zl(e,t){t?(e.F_.delete(2),await Pl(e)):(e.F_.add(2),await Vl(e),e.O_.set("Unknown"))}function ec(t){return t.B_||(t.B_=(e=t.datastore,n=t.asyncQueue,r={Io:async function(n){n.v_.forEach((e,t)=>{ql(n,e)})}.bind(null,t),Eo:async function(e,t){Ql(e),Kl(e)?(e.O_.b_(t),Gl(e)):e.O_.set("Unknown")}.bind(null,t),c_:async function(e,r,t){if(e.O_.set("Online"),r instanceof Lo&&2===r.state&&r.cause)try{(async function(e){var t=r.cause;for(const n of r.targetIds)e.v_.has(n)&&(await e.remoteSyncer.rejectListen(n,t),e.v_.delete(n),e.N_.removeTarget(n))})(e)}catch(t){m("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),t),await $l(e,t)}else if(r instanceof Mo?e.N_.Ge(r):r instanceof Oo?e.N_.Xe(r):e.N_.He(r),!t.isEqual(E.min()))try{const r=await tl(e.localStore);0<=t.compareTo(r)&&(s=t,(n=(i=e).N_._t(s)).targetChanges.forEach((e,t)=>{var n;0<e.resumeToken.approximateByteSize()&&(n=i.v_.get(t))&&i.v_.set(t,n.withResumeToken(e.resumeToken,s))}),n.targetMismatches.forEach((e,t)=>{var n=i.v_.get(e);n&&(i.v_.set(e,n.withResumeToken(vs.EMPTY_BYTE_STRING,n.snapshotVersion)),jl(i,e),e=new cu(n.target,e,t,n.sequenceNumber),ql(i,e))}),await i.remoteSyncer.applyRemoteEvent(n))}catch(r){m("RemoteStore","Failed to raise snapshot:",r),await $l(e,r)}var i,s,n}.bind(null,t)},e.V_(),new Rl(n,e.connection,e.authCredentials,e.appCheckCredentials,e.serializer,r)),t.M_.push(async e=>{e?(t.B_.Xo(),Kl(t)?Gl(t):t.O_.set("Unknown")):(await t.B_.stop(),Ql(t))})),t.B_;var e,n,r}function tc(t){return t.L_||(t.L_=(e=t.datastore,n=t.asyncQueue,r={Io:async function(e){tc(e).A_()}.bind(null,t),Eo:async function(e,t){if(t&&tc(e).I_){var n=e,r=t;if(Eo(t=r.code)&&t!==w.ABORTED){const i=n.C_.shift();tc(n).Xo(),await Hl(n,()=>n.remoteSyncer.rejectFailedWrite(i.batchId,r)),await Wl(n)}await 0}Yl(e)&&Xl(e)}.bind(null,t),E_:async function(e){var t=tc(e);for(const n of e.C_)t.d_(n.mutations)}.bind(null,t),T_:async function(e,t,n){const r=e.C_.shift(),i=_o.from(r,t,n);await Hl(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await Wl(e)}.bind(null,t)},e.V_(),new Ml(n,e.connection,e.authCredentials,e.appCheckCredentials,e.serializer,r)),t.M_.push(async e=>{e?(t.L_.Xo(),await Wl(t)):(await t.L_.stop(),0<t.C_.length&&(m("RemoteStore",`Stopping write stream with ${t.C_.length} pending writes`),t.C_=[]))})),t.L_;var e,n,r}class nc{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Hr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){var s=Date.now()+n,e=new nc(e,t,s,r,i);return e.start(n),e}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new _(w.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function rc(e,t){if(d("AsyncQueue",t+": "+e),Ti(e))return new _(w.UNAVAILABLE,t+": "+e);throw e}class ic{constructor(n){this.comparator=n?(e,t)=>n(e,t)||S.comparator(e.key,t.key):(e,t)=>S.comparator(e.key,t.key),this.keyedMap=Ba(),this.sortedSet=new A(this.comparator)}static emptySet(e){return new ic(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){e=this.keyedMap.get(e);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){var t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof ic))return!1;if(this.size!==e.size)return!1;for(var t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){var n=new ic;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class sc{constructor(){this.k_=new A(S.comparator)}track(e){var t=e.doc.key,n=this.k_.get(t);!n||0!==e.type&&3===n.type?this.k_=this.k_.insert(t,e):3===e.type&&1!==n.type?this.k_=this.k_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.k_=this.k_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.k_=this.k_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.k_=this.k_.remove(t):1===e.type&&2===n.type?this.k_=this.k_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.k_=this.k_.insert(t,{type:2,doc:e.doc}):b()}q_(){const n=[];return this.k_.inorderTraversal((e,t)=>{n.push(t)}),n}}class ac{constructor(e,t,n,r,i,s,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new ac(e,t,ic.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Na(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;var t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class oc{constructor(){this.Q_=void 0,this.listeners=[]}}class uc{constructor(){this.queries=new Fa(e=>ka(e),Na),this.onlineState="Unknown",this.K_=new Set}}async function hc(e,t){const n=e,r=t.query;let i=!1,s=n.queries.get(r);if(s||(i=!0,s=new oc),i)try{s.Q_=await n.onListen(r)}catch(e){const n=rc(e,`Initialization of query '${Ra(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,s),s.listeners.push(t),t.U_(n.onlineState),s.Q_&&t.W_(s.Q_)&&cc(n)}async function lc(e,t){var n=t.query;let r=!1;var i=e.queries.get(n);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),r=0===i.listeners.length)}if(r)return e.queries.delete(n),e.onUnlisten(n)}function cc(e){e.K_.forEach(e=>{e.next()})}class dc{constructor(e,t,n){this.query=e,this.G_=t,this.z_=!1,this.j_=null,this.onlineState="Unknown",this.options=n||{}}W_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new ac(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.z_?this.H_(e)&&(this.G_.next(e),t=!0):this.J_(e,this.onlineState)&&(this.Y_(e),t=!0),this.j_=e,t}onError(e){this.G_.error(e)}U_(e){this.onlineState=e;let t=!1;return this.j_&&!this.z_&&this.J_(this.j_,e)&&(this.Y_(this.j_),t=!0),t}J_(e,t){return!e.fromCache||(!this.options.Z_||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}H_(e){var t;return 0<e.docChanges.length||(t=this.j_&&this.j_.hasPendingWrites!==e.hasPendingWrites,!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges)}Y_(e){e=ac.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.z_=!0,this.G_.next(e)}}class fc{constructor(e,t){this.X_=e,this.byteLength=t}ea(){return"metadata"in this.X_}}class gc{constructor(e){this.serializer=e}Is(e){return Yo(this.serializer,e)}ds(e){return e.metadata.exists?nu(this.serializer,e.document,!1):k.newNoDocument(this.Is(e.metadata.name),this.Ts(e.metadata.readTime))}Ts(e){return F(e)}}class mc{constructor(e,t,n){this.ta=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=pc(e)}na(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;var n;return e.X_.namedQuery?this.queries.push(e.X_.namedQuery):e.X_.documentMetadata?(this.documents.push({metadata:e.X_.documentMetadata}),e.X_.documentMetadata.exists||++t,n=T.fromString(e.X_.documentMetadata.name),this.collectionGroups.add(n.get(n.length-2))):e.X_.document&&(this.documents[this.documents.length-1].document=e.X_.document,++t),t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ra(e){const t=new Map,n=new gc(this.serializer);for(const i of e)if(i.metadata.queries){const e=n.Is(i.metadata.name);for(const n of i.metadata.queries){var r=(t.get(n)||O()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const i=e;let s=O(),a=Pa;for(const e of n){const n=t.Is(e.metadata.name);e.document&&(s=s.add(n));var o=t.ds(e);o.setReadTime(t.Ts(e.metadata.readTime)),a=a.insert(n,o)}const u=i._s.newChangeBuffer({trackRemovals:!0}),h=await rl(i,Ca(ba(T.fromString("__bundle__/docs/"+r))));return i.persistence.runTransaction("Apply bundle documents","readwrite",t=>nl(t,u,a).next(e=>(u.apply(t),e)).next(e=>i.Kr.removeMatchingKeysForTargetId(t,h.targetId).next(()=>i.Kr.addMatchingKeys(t,s,h.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(t,e.ls,e.hs)).next(()=>e.ls)))}(this.localStore,new gc(this.serializer),this.documents,this.ta.id),t=this.ra(this.documents);for(const e of this.queries)await async function(e,n,r=O()){const i=await rl(e,Ca(_u(n.bundledQuery))),s=e;return s.persistence.runTransaction("Save named query","readwrite",e=>{var t=F(n.readTime);return 0<=i.snapshotVersion.compareTo(t)?s.Ur.saveNamedQuery(e,n):(t=i.withResumeToken(vs.EMPTY_BYTE_STRING,t),s.rs=s.rs.insert(t.targetId,t),s.Kr.updateTargetData(e,t).next(()=>s.Kr.removeMatchingKeysForTargetId(e,i.targetId)).next(()=>s.Kr.addMatchingKeys(e,r,i.targetId)).next(()=>s.Ur.saveNamedQuery(e,n)))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,ia:this.collectionGroups,sa:e}}}function pc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class yc{constructor(e){this.key=e}}class vc{constructor(e){this.key=e}}class wc{constructor(e,t){this.query=e,this.oa=t,this._a=null,this.hasCachedResults=!1,this.current=!1,this.aa=O(),this.mutatedKeys=O(),this.ua=La(e),this.ca=new ic(this.ua)}get la(){return this.oa}ha(e,t){const a=t?t.Pa:new sc,o=(t||this).ca;let u=(t||this).mutatedKeys,h=o,l=!1;const c="F"===this.query.limitType&&o.size===this.query.limit?o.last():null,d="L"===this.query.limitType&&o.size===this.query.limit?o.first():null;if(e.inorderTraversal((e,t)=>{var n=o.get(e),t=Ma(this.query,t)?t:null,r=!!n&&this.mutatedKeys.has(n.key),i=!!t&&(t.hasLocalMutations||this.mutatedKeys.has(t.key)&&t.hasCommittedMutations);let s=!1;n&&t?n.data.isEqual(t.data)?r!==i&&(a.track({type:3,doc:t}),s=!0):!this.Ia(n,t)&&(a.track({type:2,doc:t}),s=!0,c&&0<this.ua(t,c)||d&&this.ua(t,d)<0)&&(l=!0):!n&&t?(a.track({type:0,doc:t}),s=!0):n&&!t&&(a.track({type:1,doc:n}),s=!0,c||d)&&(l=!0),s&&(u=t?(h=h.add(t),i?u.add(e):u.delete(e)):(h=h.delete(e),u.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),u=u.delete(e.key),a.track({type:1,doc:e})}return{ca:h,Pa:a,es:l,mutatedKeys:u}}Ia(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.ca,i=(this.ca=e.ca,this.mutatedKeys=e.mutatedKeys,e.Pa.q_()),t=(i.sort((e,t)=>{return n=e.type,r=t.type,(i=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return b()}})(n)-i(r)||this.ua(e.doc,t.doc);var n,r,i}),this.da(n),t?this.Ta():[]),s=0===this.aa.size&&this.current?1:0,a=s!==this._a;return this._a=s,0!==i.length||a?{snapshot:new ac(this.query,e.ca,r,i,e.mutatedKeys,0==s,a,!1,!!n&&0<n.resumeToken.approximateByteSize()),Ea:t}:{Ea:t}}U_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ca:this.ca,Pa:new sc,mutatedKeys:this.mutatedKeys,es:!1},!1)):{Ea:[]}}Aa(e){return!this.oa.has(e)&&!!this.ca.has(e)&&!this.ca.get(e).hasLocalMutations}da(e){e&&(e.addedDocuments.forEach(e=>this.oa=this.oa.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.oa=this.oa.delete(e)),this.current=e.current)}Ta(){if(!this.current)return[];const t=this.aa,n=(this.aa=O(),this.ca.forEach(e=>{this.Aa(e.key)&&(this.aa=this.aa.add(e.key))}),[]);return t.forEach(e=>{this.aa.has(e)||n.push(new vc(e))}),this.aa.forEach(e=>{t.has(e)||n.push(new yc(e))}),n}Ra(e){this.oa=e.Ps,this.aa=O();e=this.ha(e.documents);return this.applyChanges(e,!0)}Va(){return ac.fromInitialDocuments(this.query,this.ca,this.mutatedKeys,0===this._a,this.hasCachedResults)}}class _c{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class bc{constructor(e){this.key=e,this.ma=!1}}class Ic{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.fa={},this.ga=new Fa(e=>ka(e),Na),this.pa=new Map,this.ya=new Set,this.wa=new A(S.comparator),this.Sa=new Map,this.ba=new Mh,this.Da={},this.Ca=new Map,this.va=hh.Ln(),this.onlineState="Unknown",this.Fa=void 0}get isPrimaryClient(){return!0===this.Fa}}async function Ec(n,e,t,r,i){n.Ma=(e,i,t)=>async function(e,t,n){let r=t.view.ha(i);r.es&&(r=await sl(e.localStore,t.query,!1).then(({documents:e})=>t.view.ha(e,r)));n=n&&n.targetChanges.get(t.targetId),n=t.view.applyChanges(r,e.isPrimaryClient,n);return Nc(e,t.targetId,n.Ea),n.snapshot}(n,e,t);var s=await sl(n.localStore,e,!0),a=new wc(e,s.Ps),s=a.ha(s.documents),r=Ro.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState,i),i=a.applyChanges(s,n.isPrimaryClient,r),s=(Nc(n,t,i.Ea),new _c(e,t,a));return n.ga.set(e,s),n.pa.has(t)?n.pa.get(t).push(e):n.pa.set(t,[e]),i.snapshot}async function Tc(e,t){const n=e;try{const e=await function(e,u){const h=e,l=u.snapshotVersion;let c=h.rs;return h.persistence.runTransaction("Apply remote event","readwrite-primary",a=>{const e=h._s.newChangeBuffer({trackRemovals:!0}),o=(c=h.rs,[]);u.targetChanges.forEach((t,n)=>{var r,i,s=c.get(n);if(s){o.push(h.Kr.removeMatchingKeys(a,t.removedDocuments,n).next(()=>h.Kr.addMatchingKeys(a,t.addedDocuments,n)));let e=s.withSequenceNumber(a.currentSequenceNumber);null!==u.targetMismatches.get(n)?e=e.withResumeToken(vs.EMPTY_BYTE_STRING,E.min()).withLastLimboFreeSnapshotVersion(E.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),c=c.insert(n,e),s=s,r=e,i=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=r.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size)||o.push(h.Kr.updateTargetData(a,e))}});let t=Pa,n=O();if(u.documentUpdates.forEach(e=>{u.resolvedLimboDocuments.has(e)&&o.push(h.persistence.referenceDelegate.updateLimboDocument(a,e))}),o.push(nl(a,e,u.documentUpdates).next(e=>{t=e.ls,n=e.hs})),!l.isEqual(E.min())){const u=h.Kr.getLastRemoteSnapshotVersion(a).next(e=>h.Kr.setTargetsMetadata(a,a.currentSequenceNumber,l));o.push(u)}return C.waitFor(o).next(()=>e.apply(a)).next(()=>h.localDocuments.getLocalViewOfDocuments(a,t,n)).next(()=>t)}).then(e=>(h.rs=c,e))}(n.localStore,t);t.targetChanges.forEach((e,t)=>{t=n.Sa.get(t);t&&(y(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?t.ma=!0:0<e.modifiedDocuments.size?y(t.ma):0<e.removedDocuments.size&&(y(t.ma),t.ma=!1))}),await Rc(n,e,t)}catch(e){await wi(e)}}function Sc(n,r,e){var t=n;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const n=[];t.ga.forEach((e,t)=>{t=t.view.U_(r);t.snapshot&&n.push(t.snapshot)});{e=t.eventManager;var i=r;e.onlineState=i;let n=!1;e.queries.forEach((e,t)=>{for(const e of t.listeners)e.U_(i)&&(n=!0)}),n&&cc(e)}n.length&&t.fa.c_(n),t.onlineState=r,t.isPrimaryClient&&t.sharedClientState.setOnlineState(r)}}function xc(e,t){(e.Ca.get(t)||[]).forEach(e=>{e.resolve()}),e.Ca.delete(t)}function Cc(e,t,n){var r=e;let i=r.Da[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.Da[r.currentUser.toKey()]=i}}function Ac(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.pa.get(e))t.ga.delete(r),n&&t.fa.xa(r,n);t.pa.delete(e),t.isPrimaryClient&&t.ba.mr(e).forEach(e=>{t.ba.containsKey(e)||Dc(t,e)})}function Dc(e,t){e.ya.delete(t.path.canonicalString());var n=e.wa.get(t);null!==n&&(Ul(e.remoteStore,n),e.wa=e.wa.remove(t),e.Sa.delete(n),kc(e))}function Nc(e,t,n){for(const a of n)a instanceof yc?(e.ba.addReference(a.key,t),r=e,i=void 0,s=void 0,i=a.key,s=i.path.canonicalString(),r.wa.get(i)||r.ya.has(s)||(m("SyncEngine","New document in limbo: "+i),r.ya.add(s),kc(r))):a instanceof vc?(m("SyncEngine","Document no longer in limbo: "+a.key),e.ba.removeReference(a.key,t),e.ba.containsKey(a.key)||Dc(e,a.key)):b();var r,i,s}function kc(e){for(;0<e.ya.size&&e.wa.size<e.maxConcurrentLimboResolutions;){var t=e.ya.values().next().value,n=(e.ya.delete(t),new S(T.fromString(t))),t=e.va.next();e.Sa.set(t,new bc(n)),e.wa=e.wa.insert(n,t),Bl(e.remoteStore,new cu(Ca(ba(n.path)),t,"TargetPurposeLimboResolution",ki.ae))}}async function Rc(e,n,r){const i=e,s=[],a=[],o=[];if(!i.ga.isEmpty()){i.ga.forEach((e,t)=>{o.push(i.Ma(t,n,r).then(e=>{(e||r)&&i.isPrimaryClient&&i.sharedClientState.updateQueryState(t.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(s.push(e),e=Wh.$i(t.targetId,e),a.push(e))}))}),await Promise.all(o),i.fa.c_(s);{var t=i.localStore,u=a;const h=t;try{await h.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>C.forEach(u,t=>C.forEach(t.Qi,e=>h.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>C.forEach(t.Ki,e=>h.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(t){if(!Ti(t))throw t;m("LocalStore","Failed to update sequence numbers: "+t)}for(const t of u){const u=t.targetId;if(!t.fromCache){const t=h.rs.get(u),l=t.snapshotVersion,c=t.withLastLimboFreeSnapshotVersion(l);h.rs=h.rs.insert(u,c)}}}}}async function Mc(t,n){var r,i,s,a=t,o=[],u=[];for(const t of n){let e;var h=a.pa.get(t);if(h&&0!==h.length){e=await rl(a.localStore,Ca(h[0]));for(const t of h){const n=a.ga.get(t),l=(r=n,0,s=await sl((i=a).localStore,r.query,!0),s=r.view.Ra(s),i.isPrimaryClient&&Nc(i,r.targetId,s.Ea),await s);l.snapshot&&u.push(l.snapshot)}}else{h=await al(a.localStore,t);e=await rl(a.localStore,h),await Ec(a,Oc(h),t,!1,e.resumeToken)}o.push(e)}return a.fa.c_(u),o}function Oc(e){return _a(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Lc(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=Tc.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=function(e,t){const n=e,r=n.Sa.get(t);if(r&&r.ma)return O().add(r.key);{let e=O();const r=n.pa.get(t);if(r)for(const t of r){const r=n.ga.get(t);e=e.unionWith(r.view.la)}return e}}.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=async function(e,t,n){const r=e,i=(r.sharedClientState.updateQueryState(t,"rejected",n),r.Sa.get(t)),s=i&&i.key;if(s){let e=new A(S.comparator);e=e.insert(s,k.newNoDocument(s,E.min()));const n=O().add(s),i=new ko(E.min(),new Map,new A(I),e,n);await Tc(r,i),r.wa=r.wa.remove(s),r.Sa.delete(t),kc(r)}else await il(r.localStore,t,!1).then(()=>Ac(r,t,n)).catch(wi)}.bind(null,e),e.fa.c_=function(e,t){var n=e;let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.listeners)t.W_(e)&&(r=!0);i.Q_=e}}r&&cc(n)}.bind(null,e.eventManager),e.fa.xa=function(e,t,n){var r=e.queries.get(t);if(r)for(const e of r.listeners)e.onError(n);e.queries.delete(t)}.bind(null,e.eventManager),e}function Fc(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=async function(e,t){var n=e,r=t.batch.batchId;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=i._s.newChangeBuffer({trackRemovals:!0});return function(e,t,r,i){const s=r.batch,n=s.keys();let a=C.resolve();return n.forEach(n=>{a=a.next(()=>i.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);y(null!==t),e.version.compareTo(t)<0&&(s.applyToRemoteDocument(e,r),e.isValidDocument())&&(e.setReadTime(r.commitVersion),i.addEntry(e))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,s))}(i,e,r,n).next(()=>n.apply(e)).next(()=>i.mutationQueue.performConsistencyCheck(e)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(t){let n=O();for(let e=0;e<t.mutationResults.length;++e)0<t.mutationResults[e].transformResults.length&&(n=n.add(t.batch.mutations[e].key));return n}(r))).next(()=>i.localDocuments.getDocuments(e,t))})}(n.localStore,t);Cc(n,r,null),xc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Rc(n,e)}catch(e){await wi(e)}}.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=async function(e,t,n){var r=e;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return i.mutationQueue.lookupMutationBatch(t,r).next(e=>(y(null!==e),n=e.keys(),i.mutationQueue.removeMutationBatch(t,e))).next(()=>i.mutationQueue.performConsistencyCheck(t)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>i.localDocuments.getDocuments(t,n))})}(r.localStore,t);Cc(r,t,n),xc(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Rc(r,e)}catch(n){await wi(n)}}.bind(null,e),e}class Pc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Dl(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Zh(this.persistence,new Xh,e.initialUser,this.serializer)}createPersistence(e){return new Bh(qh.Jr,this.serializer)}createSharedClientState(e){return new vl}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Vc extends Pc{constructor(e,t,n){super(),this.Na=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Na.initialize(this,e),await Fc(this.Na.syncEngine),await Wl(this.Na.remoteStore),await this.persistence.gi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return Zh(this.persistence,new Xh,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new ph(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){t=new Ni(t,this.persistence);return new Di(e.asyncQueue,t)}createPersistence(e){var t=Hh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?th.withCacheSize(this.cacheSizeBytes):th.DEFAULT;return new zh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Cl(),Al(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new vl}}class Bc extends Vc{constructor(e,t){super(e,t,!1),this.Na=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);e=this.Na.syncEngine;this.sharedClientState instanceof yl&&(this.sharedClientState.syncEngine={Xs:async function(e,t,n,r){var i=await function(e,n){const r=e,i=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>i.Fn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):C.resolve(null)))}(e.localStore,t);null!==i?("pending"===n?await Wl(e.remoteStore):"acknowledged"===n||"rejected"===n?(Cc(e,t,r||null),xc(e,t),e.localStore.mutationQueue.xn(t)):b(),await Rc(e,i)):m("SyncEngine","Cannot apply mutation batch with id: "+t)}.bind(null,e),eo:async function(e,t,n,r){var i=e;if(i.Fa)m("SyncEngine","Ignoring unexpected query state notification.");else{var s=i.pa.get(t);if(s&&0<s.length)switch(n){case"current":case"not-current":{const e=await ol(i.localStore,Oa(s[0])),r=ko.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,vs.EMPTY_BYTE_STRING);await Rc(i,e,r);break}case"rejected":await il(i.localStore,t,!0),Ac(i,t,r);break;default:b()}}}.bind(null,e),no:async function(e,t,n){const r=Lc(e);if(r.Fa){for(const e of t)if(r.pa.has(e))m("SyncEngine","Adding an already active target "+e);else{const t=await al(r.localStore,e),n=await rl(r.localStore,t);await Ec(r,Oc(t),n.targetId,!1,n.resumeToken),Bl(r.remoteStore,n)}for(const e of n)r.pa.has(e)&&await il(r.localStore,e,!1).then(()=>{Ul(r.remoteStore,e),Ac(r,e)}).catch(wi)}}.bind(null,e),ki:function(e){return e.localStore.persistence.ki()}.bind(null,e),Zs:async function(e,t){const n=e;return ol(n.localStore,t).then(e=>Rc(n,e))}.bind(null,e)},await this.sharedClientState.start()),await this.persistence.gi(async e=>{{var r=this.Na.syncEngine,t=e;const i=r;if(Lc(i),Fc(i),!0===t&&!0!==i.Fa){const r=i.sharedClientState.getAllActiveQueryTargets(),t=await Mc(i,r.toArray());i.Fa=!0,await Zl(i.remoteStore,!0);for(const r of t)Bl(i.remoteStore,r)}else if(!1===t&&!1!==i.Fa){const r=[];let n=Promise.resolve();i.pa.forEach((e,t)=>{i.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Ac(i,t),il(i.localStore,t,!0))),Ul(i.remoteStore,t)}),await n,await Mc(i,r);{const s=i;s.Sa.forEach((e,t)=>{Ul(s.remoteStore,t)}),s.ba.gr(),s.Sa=new Map,s.wa=new A(S.comparator)}i.Fa=!1,await Zl(i.remoteStore,!1)}}await 0,this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t,n=Cl();if(yl.C(n))return t=Hh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),new yl(n,e.asyncQueue,t,e.clientId,e.initialUser);throw new _(w.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.")}}class Uc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Sc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=async function(e,t){var n,r=e;r.currentUser.isEqual(t)||(m("SyncEngine","User change. New user:",t.toKey()),n=await el(r.localStore,t),r.currentUser=t,(e=r).Ca.forEach(e=>{e.forEach(e=>{e.reject(new _(w.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.Ca.clear(),r.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),await Rc(r,n.cs))}.bind(null,this.syncEngine),await Zl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new uc}createDatastore(e){var t=Dl(e.databaseInfo.databaseId),n=(s=e.databaseInfo,new xl(s)),r=e.authCredentials,i=e.appCheckCredentials,s=n;return e=t,new Ol(r,i,s,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>Sc(this.syncEngine,e,0),e=new(_l.C()?_l:wl),new Fl(t,n,r,i,e);var t,n,r,i}createSyncEngine(e,t){var n=this.localStore,r=this.remoteStore,i=this.eventManager,s=this.sharedClientState,a=e.initialUser,e=e.maxConcurrentLimboResolutions;return n=new Ic(n,r,i,s,a,e),t&&(n.Fa=!0),n}terminate(){return async function(e){m("RemoteStore","RemoteStore shutting down."),e.F_.add(5),await Vl(e),e.x_.shutdown(),e.O_.set("Unknown")}(this.remoteStore)}}function qc(t,n=10240){let r=0;return{async read(){var e;return r<t.byteLength?(e={value:t.slice(r,r+n),done:!1},r+=n,e):{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class jc{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ba(this.observer.next,e)}error(e){this.observer.error?this.Ba(this.observer.error,e):d("Uncaught Error in snapshot listener:",e.toString())}La(){this.muted=!0}Ba(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class Gc{constructor(e,t){this.ka=e,this.serializer=t,this.metadata=new Hr,this.buffer=new Uint8Array,this.qa=new TextDecoder("utf-8"),this.Qa().then(e=>{e&&e.ea()?this.metadata.resolve(e.X_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             `+JSON.stringify(null==e?void 0:e.X_)))},e=>this.metadata.reject(e))}close(){return this.ka.cancel()}async getMetadata(){return this.metadata.promise}async Oa(){return await this.getMetadata(),this.Qa()}async Qa(){var e,t,n=await this.Ka();return null===n?null:(e=this.qa.decode(n),t=Number(e),isNaN(t)&&this.$a(`length string (${e}) is not valid number`),e=await this.Ua(t),new fc(JSON.parse(e),n.length+t))}Wa(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Ka(){for(;this.Wa()<0&&!await this.Ga(););var e,t;return 0===this.buffer.length?null:((e=this.Wa())<0&&this.$a("Reached the end of bundle when a length string is expected."),t=this.buffer.slice(0,e),this.buffer=this.buffer.slice(e),t)}async Ua(e){for(;this.buffer.length<e;)await this.Ga()&&this.$a("Reached the end of bundle when more is expected.");var t=this.qa.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}$a(e){throw this.ka.cancel(),new Error("Invalid bundle format: "+e)}async Ga(){var e,t=await this.ka.read();return t.done||((e=new Uint8Array(this.buffer.length+t.value.length)).set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e),t.done}}class Kc{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new _(w.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");e=await async function(e,t){const a=e,n=Zo(a.serializer)+"/documents",r={documents:t.map(e=>Wo(a.serializer,e))},i=await a.Fo("BatchGetDocuments",n,r,t.length),o=new Map,s=(i.forEach(e=>{i=a.serializer;var t,n,r,i,s="found"in e?(s=i,y(!!(t=e).found),t.found.name,t.found.updateTime,s=Yo(s,t.found.name),n=F(t.found.updateTime),r=t.found.createTime?F(t.found.createTime):E.min(),t=new zs({mapValue:{fields:t.found.fields}}),k.newFoundDocument(s,n,r,t)):"missing"in e?function(e,t){y(!!t.missing),y(!!t.readTime);e=Yo(e,t.missing),t=F(t.readTime);return k.newNoDocument(e,t)}(i,e):b();o.set(s.key.toString(),s)}),[]);return t.forEach(e=>{e=o.get(e.toString());y(!!e),s.push(e)}),s}(this.datastore,e);return e.forEach(e=>this.recordVersion(e)),e}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new yo(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{t=S.fromPath(t);this.mutations.push(new vo(t,this.precondition(t)))});{var e=this.datastore,n=this.mutations;const r=e,i=Zo(r.serializer)+"/documents",s={writes:n.map(e=>ru(r.serializer,e))};await r.bo("Commit",i,s)}await 0,this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw b();t=E.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new _(w.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){var t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(E.min())?L.exists(!1):L.updateTime(t):L.none()}preconditionForUpdate(e){var t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return L.exists(!0);if(t.isEqual(E.min()))throw new _(w.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return L.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class zc{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.za=n.maxAttempts,this.Ho=new Nl(this.asyncQueue,"transaction_retry")}run(){--this.za,this.ja()}ja(){this.Ho.Qo(async()=>{const t=new Kc(this.datastore),e=this.Ha(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.Ja(e)}))}).catch(e=>{this.Ja(e)})})}Ha(e){try{var t=this.updateFunction(e);return!Ri(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Ja(e){0<this.za&&this.Ya(e)?(--this.za,this.asyncQueue.enqueueAndForget(()=>(this.ja(),Promise.resolve()))):this.deferred.reject(e)}Ya(e){return"FirebaseError"===e.name&&("aborted"===(e=e.code)||"failed-precondition"===e||"already-exists"===e||!Eo(e))}}class Qc{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=o.UNAUTHENTICATED,this.clientId=ri.V(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{m("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(m("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new _(w.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Hr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=rc(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function $c(e,t){e.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await el(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function Hc(e,n){e.asyncQueue.verifyOperationInProgress();var t=await Yc(e),r=(m("FirestoreClient","Initializing OnlineComponentProvider"),await e.getConfiguration());await n.initialize(t,r),e.setCredentialChangeListener(e=>Jl(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>Jl(n.remoteStore,t)),e._onlineComponents=n}function Wc(e){return"FirebaseError"===e.name?e.code===w.FAILED_PRECONDITION||e.code===w.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Yc(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){m("FirestoreClient","Using user provided OfflineComponentProvider");try{await $c(t,t._uninitializedComponentsProvider._offline)}catch(e){var n=e;if(!Wc(n))throw n;Qr("Error using user provided cache. Falling back to memory cache: "+n),await $c(t,new Pc)}}else m("FirestoreClient","Using default OfflineComponentProvider"),await $c(t,new Pc);return t._offlineComponents}async function Xc(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(m("FirestoreClient","Using user provided OnlineComponentProvider"),await Hc(e,e._uninitializedComponentsProvider._online)):(m("FirestoreClient","Using default OnlineComponentProvider"),await Hc(e,new Uc))),e._onlineComponents}function Jc(e){return Yc(e).then(e=>e.persistence)}function Zc(e){return Yc(e).then(e=>e.localStore)}function ed(e){return Xc(e).then(e=>e.remoteStore)}function td(e){return Xc(e).then(e=>e.syncEngine)}async function nd(e){var e=await Xc(e),t=e.eventManager;return t.onListen=async function(e,t){var n=Lc(e);let r,i;const s=n.ga.get(t);if(s)r=s.targetId,n.sharedClientState.addLocalQueryTarget(r),i=s.view.Va();else{const e=await rl(n.localStore,Ca(t)),s=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,i=await Ec(n,t,r,"current"===s,e.resumeToken),n.isPrimaryClient&&Bl(n.remoteStore,e)}return i}.bind(null,e.syncEngine),t.onUnlisten=async function(e,t){const n=e,r=n.ga.get(t),i=n.pa.get(r.targetId);1<i.length?(n.pa.set(r.targetId,i.filter(e=>!Na(e,t))),n.ga.delete(t)):n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await il(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Ul(n.remoteStore,r.targetId),Ac(n,r.targetId)}).catch(wi)):(Ac(n,r.targetId),await il(n.localStore,r.targetId,!0))}.bind(null,e.syncEngine),t}function rd(t,u,h={}){const l=new Hr;return t.asyncQueue.enqueueAndForget(async()=>{{var n=await nd(t),r=t.asyncQueue,i=u,s=h,a=l;const e=new jc({next:e=>{r.enqueueAndForget(()=>lc(n,o));var t=e.docs.has(i);!t&&e.fromCache?a.reject(new _(w.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&s&&"server"===s.source?a.reject(new _(w.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new dc(ba(i.path),e,{includeMetadataChanges:!0,Z_:!0});return hc(n,o)}}),l.promise}function id(o,u,h={}){const l=new Hr;return o.asyncQueue.enqueueAndForget(async()=>{{var t=await nd(o),n=o.asyncQueue,e=u,r=h,i=l;const s=new jc({next:e=>{n.enqueueAndForget(()=>lc(t,a)),e.fromCache&&"server"===r.source?i.reject(new _(w.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(e)},error:e=>i.reject(e)}),a=new dc(e,s,{includeMetadataChanges:!0,Z_:!0});return hc(t,a)}}),l.promise}function sd(r,e,t,i){e=Dl(e),t=function(e){if(e instanceof Uint8Array)return qc(e,void 0);if(e instanceof ArrayBuffer)return qc(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof t?So().encode(t):t);const s=new Gc(t,e);r.asyncQueue.enqueueAndForget(async()=>{{var e=await td(r),t=s;const n=e;!async function(t,n,r){try{var i=await n.getMetadata();if(await function(e,t){const n=e,r=F(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ur.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,i))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);r._updateProgress(pc(i));var s=new mc(i,t.localStore,n.serializer);let e=await n.Oa();for(;e;){const t=await s.na(e);t&&r._updateProgress(t),e=await n.Oa()}var a=await s.complete();return await Rc(t,a.sa,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ur.saveBundleMetadata(e,t))}(t.localStore,i),r._completeWith(a.progress),Promise.resolve(a.ia)}catch(t){return Qr("SyncEngine","Loading bundle failed with "+t),r._failWith(t),Promise.resolve(new Set)}}(n,t,i).then(e=>{n.sharedClientState.notifyBundleLoaded(e)})}})}function ad(e){var t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const od=new Map;function ud(e,t,n){if(!n)throw new _(w.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function hd(e,t,n,r){if(!0===t&&!0===r)throw new _(w.INVALID_ARGUMENT,e+` and ${n} cannot be used together.`)}function ld(e){if(!S.isDocumentKey(e))throw new _(w.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function cd(e){if(S.isDocumentKey(e))throw new _(w.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function dd(e){return void 0===e?"undefined":null===e?"null":"string"==typeof e?(20<e.length&&(e=e.substring(0,20)+"..."),JSON.stringify(e)):"number"==typeof e||"boolean"==typeof e?""+e:"object"!=typeof e?"function"==typeof e?"a function":b():e instanceof Array?"an array":(e=e.constructor?e.constructor.name:null)?`a custom ${e} object`:"an object"}function P(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new _(w.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");e=dd(e);throw new _(w.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: `+e)}function fd(e,t){if(t<=0)throw new _(w.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class gd{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new _(w.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new _(w.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}hd("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=ad(null!=(t=e.experimentalLongPollingOptions)?t:{});var t=this.experimentalLongPollingOptions;if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(30<t.timeoutSeconds)throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class md{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new gd({}),this._settingsFrozen=!1}get app(){if(this._app)return this._app;throw new _(w.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available")}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new _(w.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new gd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Yr;switch(e.type){case"firstParty":return new ei(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new _(w.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return e=this,(t=od.get(e))&&(m("ComponentProvider","Removing Datastore"),od.delete(e),t.terminate()),Promise.resolve();var e,t}}class pd{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new pd(this.firestore,e,this._query)}}class V{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new yd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new V(this.firestore,e,this._key)}}class yd extends pd{constructor(e,t,n){super(e,t,ba(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){var e=this._path.popLast();return e.isEmpty()?null:new V(this.firestore,null,new S(e))}withConverter(e){return new yd(this.firestore,e,this._path)}}function vd(e,t,...n){var r;if(e=v(e),ud("collection","path",t),e instanceof md)return cd(r=T.fromString(t,...n)),new yd(e,null,r);if(e instanceof V||e instanceof yd)return cd(r=e._path.child(T.fromString(t,...n))),new yd(e.firestore,null,r);throw new _(w.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function wd(e,t,...n){var r;if(e=v(e),ud("doc","path",t=1===arguments.length?ri.V():t),e instanceof md)return ld(r=T.fromString(t,...n)),new V(e,null,new S(r));if(e instanceof V||e instanceof yd)return ld(r=e._path.child(T.fromString(t,...n))),new V(e.firestore,e instanceof yd?e.converter:null,new S(r));throw new _(w.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function _d(e,t){return e=v(e),t=v(t),(e instanceof V||e instanceof yd)&&(t instanceof V||t instanceof yd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function bd(e,t){return e=v(e),t=v(t),e instanceof pd&&t instanceof pd&&e.firestore===t.firestore&&Na(e._query,t._query)&&e.converter===t.converter}class Id{constructor(){this.Za=Promise.resolve(),this.Xa=[],this.eu=!1,this.tu=[],this.nu=null,this.ru=!1,this.iu=!1,this.su=[],this.Ho=new Nl(this,"async_queue_retry"),this.ou=()=>{var e=Al();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Ho.$o()};var e=Al();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.ou)}get isShuttingDown(){return this.eu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this._u(),this.au(e)}enterRestrictedMode(e){this.eu||(this.eu=!0,this.iu=e||!1,(e=Al())&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.ou))}enqueue(e){if(this._u(),this.eu)return new Promise(()=>{});const t=new Hr;return this.au(()=>this.eu&&this.iu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Xa.push(e),this.uu()))}async uu(){if(0!==this.Xa.length){try{await this.Xa[0](),this.Xa.shift(),this.Ho.reset()}catch(e){if(!Ti(e))throw e;m("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Xa.length&&this.Ho.Qo(()=>this.uu())}}au(e){var t=this.Za.then(()=>(this.ru=!0,e().catch(e=>{throw this.nu=e,this.ru=!1,d("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return t=e.stack?e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack:t}(e)),e}).then(e=>(this.ru=!1,e))));return this.Za=t}enqueueAfterDelay(e,t,n){this._u(),-1<this.su.indexOf(e)&&(t=0);e=nc.createAndSchedule(this,e,t,n,e=>this.cu(e));return this.tu.push(e),e}_u(){this.nu&&b()}verifyOperationInProgress(){}async lu(){for(var e;await(e=this.Za),e!==this.Za;);}hu(e){for(const t of this.tu)if(t.timerId===e)return!0;return!1}Pu(t){return this.lu().then(()=>{this.tu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.tu)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.lu()})}Iu(e){this.su.push(e)}cu(e){e=this.tu.indexOf(e);this.tu.splice(e,1)}}function Ed(e){var t=e;if("object"==typeof t&&null!==t){var n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return 1}}class Td{constructor(){this._progressObserver={},this._taskCompletionResolver=new Hr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class B extends md{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Id,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||xd(this),this._firestoreClient.terminate()}}function Sd(e){return e._firestoreClient||xd(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function xd(e){var t,n,r,i,s=e._freezeSettings(),a=(t=e._databaseId,n=(null==(a=e._app)?void 0:a.options.appId)||"",r=e._persistenceKey,i=s,new Ss(t,n,r,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,ad(i.experimentalLongPollingOptions),i.useFetchStreams));e._firestoreClient=new Qc(e._authCredentials,e._appCheckCredentials,e._queue,a),null!=(a=s.localCache)&&a._offlineComponentProvider&&null!=(t=s.localCache)&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.localCache.kind,_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider})}function Cd(e,t,n){const r=new Hr;return e.asyncQueue.enqueue(async()=>{try{await $c(e,n),await Hc(e,t),r.resolve()}catch(e){const t=e;if(!Wc(t))throw t;Qr("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function Ad(t,e){return r=Sd(t=P(t,B)),i=e,r.asyncQueue.enqueue(async()=>{{var e=await Zc(r),t=i;const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Ur.getNamedQuery(e,t))}}).then(e=>e?new pd(t,null,e.query):null);var r,i}function Dd(e){if(e._initialized||e._terminated)throw new _(w.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Nd{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Nd(vs.fromBase64String(e))}catch(e){throw new _(w.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Nd(vs.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class kd{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new _(w.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new f(t)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Rd{constructor(e){this._methodName=e}}class Md{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new _(w.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new _(w.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return I(this._lat,e._lat)||I(this._long,e._long)}}const Od=/^__.*__$/;class Ld{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new fo(e,this.data,this.fieldMask,t,this.fieldTransforms):new co(e,this.data,t,this.fieldTransforms)}}class Fd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new fo(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Pd(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw b()}}class Vd{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.du(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Tu(){return this.settings.Tu}Eu(e){return new Vd(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Au(e){var t=null==(t=this.path)?void 0:t.child(e),t=this.Eu({path:t,Ru:!1});return t.Vu(e),t}mu(e){var t=null==(t=this.path)?void 0:t.child(e),e=this.Eu({path:t,Ru:!1});return e.du(),e}fu(e){return this.Eu({path:void 0,Ru:!0})}gu(e){return sf(e,this.settings.methodName,this.settings.pu||!1,this.path,this.settings.yu)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}du(){if(this.path)for(let e=0;e<this.path.length;e++)this.Vu(this.path.get(e))}Vu(e){if(0===e.length)throw this.gu("Document fields must not be empty");if(Pd(this.Tu)&&Od.test(e))throw this.gu('Document fields cannot begin and end with "__"')}}class Bd{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Dl(e)}wu(e,t,n,r=!1){return new Vd({Tu:e,methodName:t,yu:n,path:f.emptyPath(),Ru:!1,pu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Ud(e){var t=e._freezeSettings(),n=Dl(e._databaseId);return new Bd(e._databaseId,!!t.ignoreUndefinedProperties,n)}function qd(e,t,n,r,i,s={}){var a=e.wu(s.merge||s.mergeFields?2:0,t,n,i),e=(ef("Data must be an object, but it was:",a,r),Jd(r,a));let o,u;if(s.merge)o=new ps(a.fieldMask),u=a.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=tf(t,r,n);if(!a.contains(i))throw new _(w.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);af(e,i)||e.push(i)}o=new ps(e),u=a.fieldTransforms.filter(e=>o.covers(e.field))}else o=null,u=a.fieldTransforms;return new Ld(new zs(e),o,u)}class jd extends Rd{_toFieldTransform(e){if(2!==e.Tu)throw 1===e.Tu?e.gu(this._methodName+"() can only appear at the top level of your update data"):e.gu(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof jd}}function Gd(e,t,n){return new Vd({Tu:3,yu:t.settings.yu,methodName:e._methodName,Ru:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class Kd extends Rd{_toFieldTransform(e){return new io(e.path,new Ya)}isEqual(e){return e instanceof Kd}}class zd extends Rd{constructor(e,t){super(e),this.Su=t}_toFieldTransform(e){const t=Gd(this,e,!0),n=this.Su.map(e=>Xd(e,t)),r=new Xa(n);return new io(e.path,r)}isEqual(e){return this===e}}class Qd extends Rd{constructor(e,t){super(e),this.Su=t}_toFieldTransform(e){const t=Gd(this,e,!0),n=this.Su.map(e=>Xd(e,t)),r=new Za(n);return new io(e.path,r)}isEqual(e){return this===e}}class $d extends Rd{constructor(e,t){super(e),this.bu=t}_toFieldTransform(e){var t=new to(e.serializer,$a(e.serializer,this.bu));return new io(e.path,t)}isEqual(e){return this===e}}function Hd(e,i,s,t){const a=e.wu(1,i,s),o=(ef("Data must be an object, but it was:",a,t),[]),u=zs.empty();ls(t,(e,t)=>{var n=rf(i,e,s),r=(t=v(t),a.mu(n));if(t instanceof jd)o.push(n);else{const e=Xd(t,r);null!=e&&(o.push(n),u.set(n,e))}});e=new ps(o);return new Fd(u,e,a.fieldTransforms)}function Wd(t,n,e,r,i,s){var a=t.wu(1,n,e),o=[tf(n,r,e)],u=[i];if(s.length%2!=0)throw new _(w.INVALID_ARGUMENT,`Function ${n}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(tf(n,s[e])),u.push(s[e+1]);var h=[],l=zs.empty();for(let e=o.length-1;0<=e;--e)if(!af(h,o[e])){const n=o[e];var c=v(u[e]);const r=a.mu(n);if(c instanceof jd)h.push(n);else{const t=Xd(c,r);null!=t&&(h.push(n),l.set(n,t))}}t=new ps(h);return new Fd(l,t,a.fieldTransforms)}function Yd(e,t,n,r=!1){return Xd(n,e.wu(r?4:3,t))}function Xd(e,n){if(Zd(e=v(e)))return ef("Unsupported field value:",n,e),Jd(e,n);if(e instanceof Rd){{var t=e;var r=n;if(!Pd(r.Tu))throw r.gu(t._methodName+"() can only be used with update() and set()");if(!r.path)throw r.gu(t._methodName+"() is not currently supported inside arrays");t=t._toFieldTransform(r);t&&r.fieldTransforms.push(t)}return null}if(void 0===e&&n.ignoreUndefinedProperties)return null;if(n.path&&n.fieldMask.push(n.path),e instanceof Array){if(n.settings.Ru&&4!==n.Tu)throw n.gu("Nested arrays are not supported");{var i=n,s=[];let t=0;for(const o of e){let e=Xd(o,i.fu(t));null==e&&(e={nullValue:"NULL_VALUE"}),s.push(e),t++}return{arrayValue:{values:s}}}}r=0,t=n;if(null===(r=v(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof r)return $a(t.serializer,r);if("boolean"==typeof r)return{booleanValue:r};if("string"==typeof r)return{stringValue:r};if(r instanceof Date)return a=l.fromDate(r),{timestampValue:zo(t.serializer,a)};if(r instanceof l)return a=new l(r.seconds,1e3*Math.floor(r.nanoseconds/1e3)),{timestampValue:zo(t.serializer,a)};if(r instanceof Md)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof Nd)return{bytesValue:Qo(t.serializer,r._byteString)};if(r instanceof V){var a=t.databaseId,n=r.firestore._databaseId;if(n.isEqual(a))return{referenceValue:$o(r.firestore._databaseId||t.databaseId,r._key.path)};throw t.gu(`Document reference is for database ${n.projectId}/${n.database} but should be for database ${a.projectId}/`+a.database)}throw t.gu("Unsupported field value: "+dd(r))}function Jd(e,n){const r={};return cs(e)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):ls(e,(e,t)=>{t=Xd(t,n.Au(e));null!=t&&(r[e]=t)}),{mapValue:{fields:r}}}function Zd(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof l||e instanceof Md||e instanceof Nd||e instanceof V||e instanceof Rd)}function ef(e,t,n){var r;if(!Zd(n)||"object"!=typeof(r=n)||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r))throw"an object"===(r=dd(n))?t.gu(e+" a custom object"):t.gu(e+" "+r)}function tf(e,t,n){if((t=v(t))instanceof kd)return t._internalPath;if("string"==typeof t)return rf(e,t);throw sf("Field path arguments must be of type string or ",e,!1,void 0,n)}const nf=new RegExp("[~\\*/\\[\\]]");function rf(t,n,r){if(0<=n.search(nf))throw sf(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new kd(...n.split("."))._internalPath}catch(e){throw sf(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function sf(e,t,n,r,i){var s=r&&!r.isEmpty(),a=void 0!==i;let o=`Function ${t}() called with invalid data`,u=(n&&(o+=" (via `toFirestore()`)"),o+=". ","");return(s||a)&&(u+=" (found",s&&(u+=" in field "+r),a&&(u+=" in document "+i),u+=")"),new _(w.INVALID_ARGUMENT,o+e+u)}function af(e,t){return e.some(e=>e.isEqual(t))}class of{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new V(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){var e;if(this._document)return this._converter?(e=new uf(this._firestore,this._userDataWriter,this._key,this._document,null),this._converter.fromFirestore(e)):this._userDataWriter.convertValue(this._document.data.value)}get(e){if(this._document){e=this._document.data.field(hf("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e)}}}class uf extends of{data(){return super.data()}}function hf(e,t){return"string"==typeof t?rf(e,t):(t instanceof kd?t:t._delegate)._internalPath}function lf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new _(w.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class cf{}class df extends cf{}function ff(e,t,...n){let r=[];t instanceof cf&&r.push(t),r=r.concat(n);n=(t=r).filter(e=>!1).length,t=t.filter(e=>e instanceof gf).length;if(1<n||0<n&&0<t)throw new _(w.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.");for(const t of r)e=t._apply(e);return e}class gf extends df{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new gf(e,t,n)}_apply(e){var t=this._parse(e);return If(e._query,t),new pd(e.firestore,e.converter,Aa(e._query,t))}_parse(t){var n=Ud(t.firestore);{var r=t._query,i="where",s=n,a=t.firestore._databaseId,o=(n=this._field,t=this._op,this._value);let e;if(n.isKeyField()){if("array-contains"===t||"array-contains-any"===t)throw new _(w.INVALID_ARGUMENT,`Invalid Query. You can't perform '${t}' queries on documentId().`);if("in"===t||"not-in"===t){bf(o,t);const i=[];for(const s of o)i.push(_f(a,r,s));e={arrayValue:{values:i}}}else e=_f(a,r,o)}else"in"!==t&&"not-in"!==t&&"array-contains-any"!==t||bf(o,t),e=Yd(s,i,o,"in"===t||"not-in"===t);return R.create(n,t,e)}}}(class extends cf{});class mf extends df{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new mf(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new _(w.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new _(w.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");t=new Ws(t,n);return n=t,null===Ea(e)&&null!==(e=Ta(e))&&Ef(0,e,n.field),t}(e._query,this._field,this._direction);return new pd(e.firestore,e.converter,(t=(e=e._query).explicitOrderBy.concat([t]),new wa(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class pf extends df{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new pf(e,t,n)}_apply(e){return new pd(e.firestore,e.converter,Da(e._query,this._limit,this._limitType))}}class yf extends df{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new yf(e,t,n)}_apply(e){var t,n=wf(e,this.type,this._docOrFields,this._inclusive);return new pd(e.firestore,e.converter,(t=e._query,e=n,new wa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class vf extends df{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new vf(e,t,n)}_apply(e){var t,n=wf(e,this.type,this._docOrFields,this._inclusive);return new pd(e.firestore,e.converter,(t=e._query,e=n,new wa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function wf(e,t,n,r){if(n[0]=v(n[0]),n[0]instanceof of){var i=e._query,s=e.firestore._databaseId,a=t,o=n[0]._document,u=r;if(!o)throw new _(w.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);var h=[];for(const a of xa(i))if(a.field.isKeyField())h.push(Ls(s,o.key));else{const i=o.data.field(a.field);if(Is(i))throw new _(w.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===i){const i=a.field.canonicalString();throw new _(w.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${i}' (used as the orderBy) does not exist.`)}h.push(i)}return new Qs(h,u)}var a=Ud(e.firestore),l=e._query,c=e.firestore._databaseId,d=a,f=t,g=n,i=r,m=l.explicitOrderBy;if(g.length>m.length)throw new _(w.INVALID_ARGUMENT,`Too many arguments provided to ${f}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);var p=[];for(let e=0;e<g.length;e++){var y=g[e];if(m[e].field.isKeyField()){if("string"!=typeof y)throw new _(w.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${f}(), but got a `+typeof y);if(!Sa(l)&&-1!==y.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${f}() must be a plain document ID, but '${y}' contains a slash.`);const d=l.path.child(T.fromString(y));if(!S.isDocumentKey(d))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${f}() must result in a valid document path, but '${d}' is not because it contains an odd number of segments.`);const g=new S(d);p.push(Ls(c,g))}else{const l=Yd(d,f,y);p.push(l)}}return new Qs(p,i)}function _f(e,t,n){if("string"==typeof(n=v(n))){if(""===n)throw new _(w.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Sa(t)&&-1!==n.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);t=t.path.child(T.fromString(n));if(S.isDocumentKey(t))return Ls(e,new S(t));throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${t}' is not because it has an odd number of segments (${t.length}).`)}if(n instanceof V)return Ls(e,n._key);throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${dd(n)}.`)}function bf(e,t){if(!Array.isArray(e)||0===e.length)throw new _(w.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function If(e,t){if(t.isInequality()){const r=Ta(e),i=t.field;if(null!==r&&!r.isEqual(i))throw new _(w.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${i.toString()}'`);var n=Ea(e);null!==n&&Ef(0,i,n)}const r=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new _(w.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new _(w.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}function Ef(e,t,n){if(!n.isEqual(t))throw new _(w.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Tf{convertValue(e,t="none"){switch(Ds(e)){case 0:return null;case 1:return e.booleanValue;case 2:return N(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(bs(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw b()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,n="none"){const r={};return ls(e,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new Md(N(e.latitude),N(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=Es(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Ts(e));default:return null}}convertTimestamp(e){e=_s(e);return new l(e.seconds,e.nanos)}convertDocumentKey(e,t){var e=T.fromString(e),n=(y(lu(e)),new xs(e.get(1),e.get(3))),e=new S(e.popFirst(5));return n.isEqual(t)||d(`Document ${e} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),e}}function Sf(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class xf extends Tf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Nd(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new V(this.firestore,null,e)}}class Cf{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Af extends of{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){var t;if(this._document)return this._converter?(t=new Df(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null),this._converter.fromFirestore(t,e)):this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}get(e,t={}){if(this._document){e=this._document.data.field(hf("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e,t.serverTimestamps)}}}class Df extends Af{data(e={}){return super.data(e)}}class Nf{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Cf(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new Df(this._firestore,this._userDataWriter,e.key,e,new Cf(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){e=!!e.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new _(w.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(s,t){if(s._snapshot.oldDocs.isEmpty()){let n=0;return s._snapshot.docChanges.map(e=>{var t=new Df(s._firestore,s._userDataWriter,e.doc.key,e.doc,new Cf(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let i=s._snapshot.oldDocs;return s._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new Df(s._firestore,s._userDataWriter,e.doc.key,e.doc,new Cf(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=i.indexOf(e.doc.key),i=i.delete(e.doc.key)),1!==e.type&&(i=i.add(e.doc),r=i.indexOf(e.doc.key)),{type:function(){switch(e.type){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return b()}}(),doc:t,oldIndex:n,newIndex:r}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function kf(e,t){return e instanceof Af&&t instanceof Af?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Nf&&t instanceof Nf&&e._firestore===t._firestore&&bd(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class Rf extends Tf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Nd(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new V(this.firestore,null,e)}}function Mf(e,t,n){e=P(e,V);var r=P(e.firestore,B),t=Sf(e.converter,t,n);return Pf(r,[qd(Ud(r),"setDoc",e._key,t,null!==e.converter,n).toMutation(e._key,L.none())])}function Of(e,t,n,...r){e=P(e,V);var i=P(e.firestore,B),s=Ud(i);return Pf(i,[("string"==typeof(t=v(t))||t instanceof kd?Wd(s,"updateDoc",e._key,t,n,r):Hd(s,"updateDoc",e._key,t)).toMutation(e._key,L.exists(!0))])}function Lf(t,...n){t=v(t);let e={includeMetadataChanges:!1},r=0;"object"!=typeof n[r]||Ed(n[r])||(e=n[r],r++);var i={includeMetadataChanges:e.includeMetadataChanges};if(Ed(n[r])){const t=n[r];n[r]=null==(h=t.next)?void 0:h.bind(t),n[r+1]=null==(h=t.error)?void 0:h.bind(t),n[r+2]=null==(h=t.complete)?void 0:h.bind(t)}let s,a,o;if(t instanceof V)a=P(t.firestore,B),o=ba(t._key.path),s={next:e=>{n[r]&&n[r](Vf(a,t,e))},error:n[r+1],complete:n[r+2]};else{const c=P(t,pd),d=(a=P(c.firestore,B),o=c._query,new Rf(a));s={next:e=>{n[r]&&n[r](new Nf(a,d,c,e))},error:n[r+1],complete:n[r+2]},lf(t._query)}{var u=Sd(a),h=o,l=s;const f=new jc(l),g=new dc(h,f,i);return u.asyncQueue.enqueueAndForget(async()=>hc(await nd(u),g)),()=>{f.La(),u.asyncQueue.enqueueAndForget(async()=>lc(await nd(u),g))}}}function Ff(e,t){{var n=Sd(e=P(e,B));e=Ed(t)?t:{next:t};const r=new jc(e);return n.asyncQueue.enqueueAndForget(async()=>{return e=await nd(n),t=r,e.K_.add(t),void t.next();var e,t}),()=>{r.La(),n.asyncQueue.enqueueAndForget(async()=>{var e,t;e=await nd(n),t=r,e.K_.delete(t)})}}}function Pf(e,t){{var n=Sd(e),r=t;const i=new Hr;return n.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){var r=Fc(t);try{const t=await function(e,i){const s=e,a=l.now(),o=i.reduce((e,t)=>e.add(t.key),O());let u,h;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Pa,r=O();return s._s.getEntries(n,o).next(e=>{(t=e).forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>s.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;var t=[];for(const n of i){const i=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=Wa(r.transform,e||null);null!=i&&(n=null===n?zs.empty():n).set(r.field,i)}return n||null}(n,u.get(n.key).overlayedDocument);null!=i&&t.push(new fo(n.key,i,function r(e){const i=[];return ls(e.fields,(e,t)=>{var n=new f([e]);if(Us(t)){const e=r(t.mapValue).fields;if(0===e.length)i.push(n);else for(const t of e)i.push(n.child(t))}else i.push(n)}),new ps(i)}(i.value.mapValue),L.exists(!0)))}return s.mutationQueue.addMutationBatch(n,a,t,i)}).next(e=>{var t=(h=e).applyToLocalDocumentSet(u,r);return s.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:h.batchId,changes:Ua(u)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId);{var i=r;var s=t.batchId;var a=n;let e=i.Da[i.currentUser.toKey()];e=(e=e||new A(I)).insert(s,a),i.Da[i.currentUser.toKey()]=e}await Rc(r,t.changes),await Wl(r.remoteStore)}catch(t){const e=rc(t,"Failed to persist write");n.reject(e)}}(await td(n),r,i)),i.promise}}function Vf(e,t,n){var r=n.docs.get(t._key),i=new Rf(e);return new Af(e,i,t._key,r,new Cf(n.hasPendingWrites,n.fromCache),t.converter)}const Bf={maxAttempts:5};class Uf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Ud(e)}set(e,t,n){this._verifyNotCommitted();e=qf(e,this._firestore),t=Sf(e.converter,t,n),t=qd(this._dataReader,"WriteBatch.set",e._key,t,null!==e.converter,n);return this._mutations.push(t.toMutation(e._key,L.none())),this}update(e,t,n,...r){this._verifyNotCommitted();e=qf(e,this._firestore),n="string"==typeof(t=v(t))||t instanceof kd?Wd(this._dataReader,"WriteBatch.update",e._key,t,n,r):Hd(this._dataReader,"WriteBatch.update",e._key,t);return this._mutations.push(n.toMutation(e._key,L.exists(!0))),this}delete(e){this._verifyNotCommitted();e=qf(e,this._firestore);return this._mutations=this._mutations.concat(new yo(e._key,L.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new _(w.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function qf(e,t){if((e=v(e)).firestore!==t)throw new _(w.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class jf extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Ud(e)}get(e){const t=qf(e,this._firestore),n=new xf(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return b();e=e[0];if(e.isFoundDocument())return new of(this._firestore,n,e.key,e,t.converter);if(e.isNoDocument())return new of(this._firestore,n,t._key,null,t.converter);throw b()})}set(e,t,n){e=qf(e,this._firestore),t=Sf(e.converter,t,n),t=qd(this._dataReader,"Transaction.set",e._key,t,null!==e.converter,n);return this._transaction.set(e._key,t),this}update(e,t,n,...r){e=qf(e,this._firestore),n="string"==typeof(t=v(t))||t instanceof kd?Wd(this._dataReader,"Transaction.update",e._key,t,n,r):Hd(this._dataReader,"Transaction.update",e._key,t);return this._transaction.update(e._key,n),this}delete(e){e=qf(e,this._firestore);return this._transaction.delete(e._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=qf(e,this._firestore),n=new Rf(this._firestore);return super.get(e).then(e=>new Af(this._firestore,n,t._key,e._document,new Cf(!1,!1),t.converter))}}function Gf(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new _("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function Kf(){if("undefined"==typeof Uint8Array)throw new _("unimplemented","Uint8Arrays are not available in this environment.")}function zf(){if("undefined"==typeof atob)throw new _("unimplemented","Blobs are unavailable in Firestore in this environment.")}Or=pg.SDK_VERSION,Gr=Or,pg._registerComponent(new H("firestore",(e,{instanceIdentifier:t,options:n})=>{var r=e.getProvider("app").getImmediate(),e=new B(new Jr(e.getProvider("auth-internal")),new ni(e.getProvider("app-check-internal")),function(e,t){if(Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))return new xs(e.options.projectId,t);throw new _(w.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.')}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),e._setSettings(n),e},"PUBLIC").setMultipleInstances(!0)),pg.registerVersion(Ee,"4.2.0",void 0),pg.registerVersion(Ee,"4.2.0","esm2017");class Qf{constructor(e){this._delegate=e}static fromBase64String(e){return zf(),new Qf(Nd.fromBase64String(e))}static fromUint8Array(e){return Kf(),new Qf(Nd.fromUint8Array(e))}toBase64(){return zf(),this._delegate.toBase64()}toUint8Array(){return Kf(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function $f(e){if("object"==typeof e&&null!==e){var t=e;for(const n of["next","error","complete"])if(n in t&&"function"==typeof t[n])return 1}}class Hf{enableIndexedDbPersistence(e,t){var e=e._delegate,t={forceOwnership:t},n=(Dd(e=P(e,B)),Sd(e));if(n._uninitializedComponentsProvider)throw new _(w.FAILED_PRECONDITION,"SDK cache is already specified.");Qr("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var e=e._freezeSettings(),r=new Uc;return Cd(n,r,new Vc(r,e.cacheSizeBytes,null==t?void 0:t.forceOwnership))}enableMultiTabIndexedDbPersistence(e){Dd(e=P(e=e._delegate,B));var t=Sd(e);if(t._uninitializedComponentsProvider)throw new _(w.FAILED_PRECONDITION,"SDK cache is already specified.");Qr("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var e=e._freezeSettings(),n=new Uc;return Cd(t,n,new Bc(n,e.cacheSizeBytes))}clearIndexedDbPersistence(e){{var t=e._delegate;if(t._initialized&&!t._terminated)throw new _(w.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const n=new Hr;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{e=Hh(t._databaseId,t._persistenceKey),await(bi.C()?(e=e+"main",void await bi.delete(e)):Promise.resolve()),n.resolve()}catch(e){n.reject(e)}var e}),n.promise}}}class Wf{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof xs||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Qr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(n,r,e={}){{var[n,r,e,i={}]=[this._delegate,n,r,e];const s=(n=P(n,md))._getSettings(),t=r+":"+e;if("firestore.googleapis.com"!==s.host&&s.host!==t&&Qr("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:t,ssl:!1})),i.mockUserToken){let e,t;if("string"==typeof i.mockUserToken)e=i.mockUserToken,t=o.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var t=t||"demo-project",n=e.iat||0,r=e.sub||e.user_id;if(r)return r=Object.assign({iss:"https://securetoken.google.com/"+t,aud:t,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},e),[U(JSON.stringify({alg:"none",type:"JWT"})),U(JSON.stringify(r)),""].join(".");throw new Error("mockUserToken must contain 'sub' or 'user_id' field!")}(i.mockUserToken,null==(r=n._app)?void 0:r.options.projectId);const s=i.mockUserToken.sub||i.mockUserToken.user_id;if(!s)throw new _(w.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new o(s)}n._authCredentials=new Xr(new Wr(e,t))}}}enableNetwork(){return e=this._delegate,(n=Sd(e=P(e,B))).asyncQueue.enqueue(async()=>{var e=await Jc(n),t=await ed(n);return e.setNetworkEnabled(!0),(e=t).F_.delete(0),Pl(e)});var e,n}disableNetwork(){return e=this._delegate,(n=Sd(e=P(e,B))).asyncQueue.enqueue(async()=>{var e=await Jc(n),t=await ed(n);return e.setNetworkEnabled(!1),async function(){var e=t;e.F_.add(0),await Vl(e),e.O_.set("Offline")}()});var e,n}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,hd("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){var e=this._delegate;{var t=Sd(e=P(e,B));const n=new Hr;return t.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;zl(n.remoteStore)||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();var r;-1===e?t.resolve():((r=n.Ca.get(e)||[]).push(t),n.Ca.set(e,r))}catch(e){const n=rc(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await td(t),n)),n.promise}}onSnapshotsInSync(e){return Ff(this._delegate,e)}get app(){if(this._appCompat)return this._appCompat;throw new _("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available")}collection(e){try{return new hg(this,vd(this._delegate,e))}catch(e){throw tg(e,"collection()","Firestore.collection()")}}doc(e){try{return new eg(this,wd(this._delegate,e))}catch(e){throw tg(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new ag(this,function(e,t){if(e=P(e,md),ud("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new pd(e,null,new wa(T.emptyPath(),t))}(this._delegate,e))}catch(e){throw tg(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){var n=this._delegate,r=e=>t(new Xf(this,e)),e=void 0;if(n=P(n,B),(e=Object.assign(Object.assign({},Bf),e)).maxAttempts<1)throw new _(w.INVALID_ARGUMENT,"Max attempts must be at least 1");{var i=Sd(n),s=e=>r(new jf(n,e)),a=e;const o=new Hr;return i.asyncQueue.enqueueAndForget(async()=>{var e=await Xc(i).then(e=>e.datastore);new zc(i.asyncQueue,e,a,s,o).run()}),o.promise}}batch(){return Sd(this._delegate),new Jf(new Uf(this._delegate,e=>Pf(this._delegate,e)))}loadBundle(e){return n=Sd(t=P(this._delegate,B)),r=new Td,sd(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return Ad(this._delegate,e).then(e=>e?new ag(this,e):null)}}class Yf extends Tf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Qf(new Nd(e))}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return eg.forKey(e,this.firestore,null)}}class Xf{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Yf(e)}get(e){const t=lg(e);return this._delegate.get(t).then(e=>new ig(this._firestore,new Af(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){e=lg(e);return n?(Gf("Transaction.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=lg(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=lg(e);return this._delegate.delete(e),this}}class Jf{constructor(e){this._delegate=e}set(e,t,n){e=lg(e);return n?(Gf("WriteBatch.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=lg(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=lg(e);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}}class Zf{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){e=new Df(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new sg(this._firestore,e),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){var n=Zf.INSTANCES;let r=n.get(e),i=(r||(r=new WeakMap,n.set(e,r)),r.get(t));return i||(i=new Zf(e,new Yf(e),t),r.set(t,i)),i}}Zf.INSTANCES=new WeakMap;class eg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Yf(e)}static forPath(e,t,n){if(e.length%2!=0)throw new _("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new eg(t,new V(t._delegate,n,new S(e)))}static forKey(e,t,n){return new eg(t,new V(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new hg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new hg(this.firestore,vd(this._delegate,e))}catch(e){throw tg(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=v(e))instanceof V&&_d(this._delegate,e)}set(e,t){t=Gf("DocumentReference.set",t);try{return t?Mf(this._delegate,e,t):Mf(this._delegate,e)}catch(e){throw tg(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Of(this._delegate,e):Of(this._delegate,e,t,...n)}catch(e){throw tg(e,"updateDoc()","DocumentReference.update()")}}delete(){return Pf(P((e=this._delegate).firestore,B),[new yo(e._key,L.none())]);var e}onSnapshot(...e){var t=ng(e),e=rg(e,e=>new ig(this.firestore,new Af(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Lf(this._delegate,t,e)}get(e){return("cache"===(null==e?void 0:e.source)?function(t){t=P(t,V);const n=P(t.firestore,B),e=Sd(n),r=new Rf(n);return function(e,t){const n=new Hr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{var r=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new _(w.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){r=rc(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Zc(e),t,n)),n.promise}(e,t._key).then(e=>new Af(n,r,t._key,e,new Cf(null!==e&&e.hasLocalMutations,!0),t.converter))}:"server"===(null==e?void 0:e.source)?function(t){t=P(t,V);const n=P(t.firestore,B);return rd(Sd(n),t._key,{source:"server"}).then(e=>Vf(n,t,e))}:function(t){t=P(t,V);const n=P(t.firestore,B);return rd(Sd(n),t._key).then(e=>Vf(n,t,e))})(this._delegate).then(e=>new ig(this.firestore,new Af(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new eg(this.firestore,e?this._delegate.withConverter(Zf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function tg(e,t,n){return e.message=e.message.replace(t,n),e}function ng(e){for(const t of e)if("object"==typeof t&&!$f(t))return t;return{}}function rg(e,t){let n;return{next:e=>{n.next&&n.next(t(e))},error:null==(e=(n=$f(e[0])?e[0]:$f(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]}).error)?void 0:e.bind(n),complete:null==(e=n.complete)?void 0:e.bind(n)}}class ig{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new eg(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return kf(this._delegate,e._delegate)}}class sg extends ig{data(e){e=this._delegate.data(e);return void 0===e&&b(),e}}class ag{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Yf(e)}where(e,t,n){try{return new ag(this.firestore,ff(this._delegate,(r=n,i=t,s=hf("where",e),gf._create(s,i,r))))}catch(e){throw tg(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,i,s}orderBy(e,t){try{return new ag(this.firestore,ff(this._delegate,([n,r="asc"]=[e,t],i=r,s=hf("orderBy",n),mf._create(s,i))))}catch(e){throw tg(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,i,s}limit(e){try{return new ag(this.firestore,ff(this._delegate,(fd("limit",t=e),pf._create("limit",t,"F"))))}catch(e){throw tg(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new ag(this.firestore,ff(this._delegate,(fd("limitToLast",t=e),pf._create("limitToLast",t,"L"))))}catch(e){throw tg(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new ag(this.firestore,ff(this._delegate,([...t]=[...e],yf._create("startAt",t,!0))))}catch(e){throw tg(e,"startAt()","Query.startAt()")}var t}startAfter(...e){try{return new ag(this.firestore,ff(this._delegate,([...t]=[...e],yf._create("startAfter",t,!1))))}catch(e){throw tg(e,"startAfter()","Query.startAfter()")}var t}endBefore(...e){try{return new ag(this.firestore,ff(this._delegate,([...t]=[...e],vf._create("endBefore",t,!1))))}catch(e){throw tg(e,"endBefore()","Query.endBefore()")}var t}endAt(...e){try{return new ag(this.firestore,ff(this._delegate,([...t]=[...e],vf._create("endAt",t,!0))))}catch(e){throw tg(e,"endAt()","Query.endAt()")}var t}isEqual(e){return bd(this._delegate,e._delegate)}get(e){return("cache"===(null==e?void 0:e.source)?function(t){t=P(t,pd);const n=P(t.firestore,B),e=Sd(n),r=new Rf(n);return function(e,t){const n=new Hr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{var r=await sl(e,t,!0),i=new wc(t,r.Ps),s=i.ha(r.documents),a=i.applyChanges(s,!1);n.resolve(a.snapshot)}catch(e){r=rc(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Zc(e),t,n)),n.promise}(e,t._query).then(e=>new Nf(n,r,t,e))}:"server"===(null==e?void 0:e.source)?function(t){t=P(t,pd);const n=P(t.firestore,B),e=Sd(n),r=new Rf(n);return id(e,t._query,{source:"server"}).then(e=>new Nf(n,r,t,e))}:function(t){t=P(t,pd);const n=P(t.firestore,B),e=Sd(n),r=new Rf(n);return lf(t._query),id(e,t._query).then(e=>new Nf(n,r,t,e))})(this._delegate).then(e=>new ug(this.firestore,new Nf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=ng(e),e=rg(e,e=>new ug(this.firestore,new Nf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Lf(this._delegate,t,e)}withConverter(e){return new ag(this.firestore,e?this._delegate.withConverter(Zf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class og{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new sg(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class ug{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new ag(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new sg(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new og(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new sg(this._firestore,e))})}isEqual(e){return kf(this._delegate,e._delegate)}}class hg extends ag{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new eg(this.firestore,e):null}doc(e){try{return void 0===e?new eg(this.firestore,wd(this._delegate)):new eg(this.firestore,wd(this._delegate,e))}catch(e){throw tg(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=P(e.firestore,B),r=wd(e),i=Sf(e.converter,t);return Pf(n,[qd(Ud(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,L.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new eg(this.firestore,e))}isEqual(e){return _d(this._delegate,e._delegate)}withConverter(e){return new hg(this.firestore,e?this._delegate.withConverter(Zf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function lg(e){return P(e,V)}var Ie={Firestore:Wf,GeoPoint:Md,Timestamp:l,Blob:Qf,Transaction:Xf,WriteBatch:Jf,DocumentReference:eg,DocumentSnapshot:ig,Query:ag,QueryDocumentSnapshot:sg,QuerySnapshot:ug,CollectionReference:hg,FieldPath:class fg{constructor(...e){this._delegate=new kd(...e)}static documentId(){return new fg(f.keyField().canonicalString())}isEqual(e){return(e=v(e))instanceof kd&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class gg{constructor(e){this._delegate=e}static serverTimestamp(){var e=new Kd("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new gg(e)}static delete(){var e=new jd("deleteField");return e._methodName="FieldValue.delete",new gg(e)}static arrayUnion(...e){[...e]=[...e];e=new zd("arrayUnion",e);return e._methodName="FieldValue.arrayUnion",new gg(e)}static arrayRemove(...e){[...e]=[...e];e=new Qd("arrayRemove",e);return e._methodName="FieldValue.arrayRemove",new gg(e)}static increment(e){e=new $d("increment",e);return e._methodName="FieldValue.increment",new gg(e)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){Kr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1},cg=n.default,dg=(e,t)=>new Wf(e,t,new Hf);cg.INTERNAL.registerComponent(new H("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),e=e.getProvider("firestore").getImmediate();return dg(t,e)},"PUBLIC").setServiceProps(Object.assign({},Ie))),cg.registerVersion("@firebase/firestore-compat","0.3.18")}.apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});