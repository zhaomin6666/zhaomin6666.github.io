!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(pg,yg){"use strict";try{!function(){var c,n=(n=pg)&&"object"==typeof n&&"default"in n?n:{default:n};function i(n){const r=[];let s=0;for(let t=0;t<n.length;t++){let e=n.charCodeAt(t);e<128?r[s++]=e:(e<2048?r[s++]=e>>6|192:(55296==(64512&e)&&t+1<n.length&&56320==(64512&n.charCodeAt(t+1))?(e=65536+((1023&e)<<10)+(1023&n.charCodeAt(++t)),r[s++]=e>>18|240,r[s++]=e>>12&63|128):r[s++]=e>>12|224,r[s++]=e>>6&63|128),r[s++]=63&e|128)}return r}const a={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();var s=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let n=0;n<r.length;n+=3){var a=r[n],o=n+1<r.length,u=o?r[n+1]:0,h=n+2<r.length,l=h?r[n+2]:0;let e=(15&u)<<2|l>>6,t=63&l;h||(t=64,o||(e=64)),i.push(s[a>>2],s[(3&a)<<4|u>>4],s[e],s[t])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(i(e),t)},decodeString(n,r){if(this.HAS_NATIVE_SUPPORT&&!r)return atob(n);{var s=this.decodeStringToByteArray(n,r);const u=[];let e=0,t=0;for(;e<s.length;){var i,a,o=s[e++];o<128?u[t++]=String.fromCharCode(o):191<o&&o<224?(i=s[e++],u[t++]=String.fromCharCode((31&o)<<6|63&i)):239<o&&o<365?(a=((7&o)<<18|(63&s[e++])<<12|(63&s[e++])<<6|63&s[e++])-65536,u[t++]=String.fromCharCode(55296+(a>>10)),u[t++]=String.fromCharCode(56320+(1023&a))):(i=s[e++],a=s[e++],u[t++]=String.fromCharCode((15&o)<<12|(63&i)<<6|63&a))}return u.join("")}},decodeStringToByteArray(t,e){this.init_();var n=e?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let e=0;e<t.length;){var s=n[t.charAt(e++)],i=e<t.length?n[t.charAt(e)]:0,a=++e<t.length?n[t.charAt(e)]:64,o=++e<t.length?n[t.charAt(e)]:64;if(++e,null==s||null==i||null==a||null==o)throw new u;r.push(s<<2|i>>4),64!==a&&(r.push(i<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),(this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e)>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class u extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}function U(e){return e=i(e),a.encodeByteArray(e,!0).replace(/\./g,"")}const q=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,j=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return a.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}};function G(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function K(){return!function(){var e=null==(e=(()=>{try{return q()||("undefined"!=typeof process&&void 0!==process.env&&(e=process.env.__FIREBASE_DEFAULTS__)?JSON.parse(e):void 0)||j()}catch(e){console.info("Unable to get __FIREBASE_DEFAULTS__ due to: "+e)}var e})())?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class z extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,z.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Q.prototype.create)}}class Q{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,t=t[0]||{},n=this.service+"/"+e,e=(e=this.errors[e])?(r=t,e.replace($,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",e=this.serviceName+`: ${e} (${n}).`;return new z(n,e,t)}}const $=/\{\$([^}]+)}/g;function v(e){return e&&e._delegate?e._delegate:e}class H{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(Or=c=c||{})[Or.DEBUG=0]="DEBUG",Or[Or.VERBOSE=1]="VERBOSE",Or[Or.INFO=2]="INFO",Or[Or.WARN=3]="WARN",Or[Or.ERROR=4]="ERROR",Or[Or.SILENT=5]="SILENT";const W={debug:c.DEBUG,verbose:c.VERBOSE,info:c.INFO,warn:c.WARN,error:c.ERROR,silent:c.SILENT},Y=c.INFO,X={[c.DEBUG]:"log",[c.VERBOSE]:"log",[c.INFO]:"info",[c.WARN]:"warn",[c.ERROR]:"error"},J=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=X[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var Z="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},x=Z||self;function ee(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function te(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}Math.random();function ne(e,t,n){return e.call.apply(e.bind,arguments)}function re(t,n,e){var r;if(t)return 2<arguments.length?(r=Array.prototype.slice.call(arguments,2),function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}):function(){return t.apply(n,arguments)};throw Error()}function se(e,t,n){return(se=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ne:re).apply(null,arguments)}function ie(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function e(e,i){function t(){}t.prototype=i.prototype,e.$=i.prototype,e.prototype=new t,(e.prototype.constructor=e).ac=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function ae(){this.s=this.s,this.o=this.o}ae.prototype.s=!1,ae.prototype.sa=function(){this.s||(this.s=!0,this.N())},ae.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const oe=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(t,n){if("string"==typeof t)return"string"!=typeof n||1!=n.length?-1:t.indexOf(n,0);for(let e=0;e<t.length;e++)if(e in t&&t[e]===n)return e;return-1};function ue(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function he(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(ee(n)){var r=t.length||0,s=n.length||0;t.length=r+s;for(let e=0;e<s;e++)t[r+e]=n[e]}else t.push(n)}}function le(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}le.prototype.h=function(){this.defaultPrevented=!0};var ce=function(){if(!x.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{x.addEventListener("test",()=>{},t),x.removeEventListener("test",()=>{},t)}catch(e){}return e}();function de(e){return/^[\s\xa0]*$/.test(e)}function fe(){var e=x.navigator;return(e=e&&e.userAgent)?e:""}function ge(e){return-1!=fe().indexOf(e)}function me(e){return me[" "](e),e}me[" "]=function(){};var pe=ge("Opera"),ye=ge("Trident")||ge("MSIE"),t=ge("Edge"),ve=t||ye,we=ge("Gecko")&&!(-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge"))&&!(ge("Trident")||ge("MSIE"))&&!ge("Edge"),_e=-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge");function be(){var e=x.document;return e?e.documentMode:void 0}var Ie="",Ee=(Ee=fe(),we?/rv:([^\);]+)(\)|;)/.exec(Ee):t?/Edge\/([\d\.]+)/.exec(Ee):ye?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(Ee):_e?/WebKit\/(\S+)/.exec(Ee):pe?/(?:Version)[ \/]?(\S+)/.exec(Ee):void 0),Te=((Ee&&(Ie=Ee?Ee[1]:""),ye&&null!=(Ee=be())&&Ee>parseFloat(Ie))?dg=String(Ee):dg=Ie,x.document&&ye&&(be()||parseInt(dg,10))||void 0);function Se(e,t){if(le.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(we){e:{try{me(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:xe[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&Se.$.h.call(this)}}e(Se,le);var xe={2:"touch",3:"pen",4:"mouse"},Ce=(Se.prototype.h=function(){Se.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1},"closure_listenable_"+(1e6*Math.random()|0)),Ae=0;function De(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.la=s,this.key=++Ae,this.fa=this.ia=!1}function Ne(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function ke(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function Re(e){const t={};for(const n in e)t[n]=e[n];return t}const Me="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Oe(t){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e])t[n]=r[n];for(let e=0;e<Me.length;e++)n=Me[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function Le(e){this.src=e,this.g={},this.h=0}function Fe(e,t){var n,r,s,i=t.type;i in e.g&&(n=e.g[i],(s=0<=(r=oe(n,t)))&&Array.prototype.splice.call(n,r,1),s&&(Ne(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function Pe(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.fa&&i.listener==t&&i.capture==!!n&&i.la==r)return s}return-1}Le.prototype.add=function(e,t,n,r,s){var i=e.toString(),a=((e=this.g[i])||(e=this.g[i]=[],this.h++),Pe(e,t,r,s));return-1<a?(t=e[a],n||(t.ia=!1)):((t=new De(t,this.src,i,!!r,s)).ia=n,e.push(t)),t};var Ve="closure_lm_"+(1e6*Math.random()|0),Be={};function Ue(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var a=te(s)?!!s.capture:!!s,o=Ke(e);if(o||(e[Ve]=o=new Le(e)),!(n=o.add(t,n,r,a,i)).proxy)if(r=function(){const n=Ge;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=ce?s:a)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(je(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function qe(e){var t,n,r;"number"!=typeof e&&e&&!e.fa&&((t=e.src)&&t[Ce]?Fe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(je(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Ke(t))?(Fe(n,e),0==n.h&&(n.src=null,t[Ve]=null)):Ne(e)))}function je(e){return e in Be?Be[e]:Be[e]="on"+e}function Ge(e,t){var n,r;return!!e.fa||(t=new Se(t,this),n=e.listener,r=e.la||e.src,e.ia&&qe(e),n.call(r,t))}function Ke(e){return(e=e[Ve])instanceof Le?e:null}var ze="__closure_events_fn_"+(1e9*Math.random()>>>0);function Qe(t){return"function"==typeof t?t:(t[ze]||(t[ze]=function(e){return t.handleEvent(e)}),t[ze])}function s(){ae.call(this),this.i=new Le(this),(this.S=this).J=null}function $e(e,t){var n,r=e.J;if(r)for(n=[];r;r=r.J)n.push(r);if(e=e.S,r=t.type||t,"string"==typeof t?t=new le(t,e):t instanceof le?t.target=t.target||e:(a=t,Oe(t=new le(r,e),a)),a=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],a=He(i,r,!0,t)&&a;if(a=He(i=t.g=e,r,!0,t)&&a,a=He(i,r,!1,t)&&a,n)for(s=0;s<n.length;s++)a=He(i=t.g=n[s],r,!1,t)&&a}function He(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var a,o,u=t[i];u&&!u.fa&&u.capture==n&&(a=u.listener,o=u.la||u.src,u.ia&&Fe(e.i,u),s=!1!==a.call(o,r)&&s)}return s&&!r.defaultPrevented}e(s,ae),s.prototype[Ce]=!0,s.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,s,i){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);else s=te(s)?!!s.capture:!!s,r=Qe(r),t&&t[Ce]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=Pe(a=t.g[n],r,s,i))&&(Ne(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&Ke(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?Pe(n,r,s,i):t)?n[t]:null)&&qe(r))}(this,e,t,n,r)},s.prototype.N=function(){if(s.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)Ne(n[r]);delete t.g[e],t.h--}}this.J=null},s.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},s.prototype.P=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var We=x.JSON.stringify,Ye=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Xe,e=>e.reset());class Xe{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let Je,Ze=!1,et=new class{constructor(){this.h=this.g=null}add(e,t){const n=Ye.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},tt=()=>{const e=x.Promise.resolve(void 0);Je=()=>{e.then(nt)}};var nt=()=>{for(var e;e=function(){var e=et;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){x.setTimeout(()=>{throw e},0)}(e)}var t=Ye;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Ze=!1};function rt(e,t){s.call(this),this.h=e||1,this.g=t||x,this.j=se(this.qb,this),this.l=Date.now()}function st(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function it(e,t,n){if("function"==typeof e)n&&(e=se(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=se(e.handleEvent,e)}return 2147483647<Number(t)?-1:x.setTimeout(e,t||0)}e(rt,s),(t=rt.prototype).ga=!1,t.T=null,t.qb=function(){var e;this.ga&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),$e(this,"tick"),this.ga&&(st(this),this.start())))},t.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},t.N=function(){rt.$.N.call(this),st(this),delete this.g};class at extends ae{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=it(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(x.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ot(e){ae.call(this),this.h=e,this.g={}}e(ot,ae);var ut=[];function ht(e,t,n,r){Array.isArray(n)||(n&&(ut[0]=n.toString()),n=ut);for(var s=0;s<n.length;s++){var i=function e(t,n,r,s,i){if(s&&s.once)return function e(t,n,r,s,i){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}return r=Qe(r),t&&t[Ce]?t.P(n,r,te(s)?!!s.capture:!!s,i):Ue(t,n,r,!0,s,i)}(t,n,r,s,i);if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}return r=Qe(r),t&&t[Ce]?t.O(n,r,te(s)?!!s.capture:!!s,i):Ue(t,n,r,!1,s,i)}(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function lt(e){ke(e.g,function(e,t){this.g.hasOwnProperty(t)&&qe(e)},e),e.g={}}function ct(){this.g=!0}function dt(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var a=1;a<s.length;a++)s[a]=""}}}return We(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}ot.prototype.N=function(){ot.$.N.call(this),lt(this)},ot.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ct.prototype.Ea=function(){this.g=!1},ct.prototype.info=function(){};var ft={},gt=null;function mt(){return gt=gt||new s}function pt(e){le.call(this,ft.Ta,e)}function yt(){var e=mt();$e(e,new pt(e))}function vt(e,t){le.call(this,ft.STAT_EVENT,e),this.stat=t}function wt(e){var t=mt();$e(t,new vt(t,e))}function _t(e,t){le.call(this,ft.Ua,e),this.size=t}function bt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return x.setTimeout(function(){e()},t)}ft.Ta="serverreachability",e(pt,le),ft.STAT_EVENT="statevent",e(vt,le),ft.Ua="timingevent",e(_t,le);_e={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},pe={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function It(){}function Et(e){return e.h||(e.h=e.i())}function Tt(){}function St(){le.call(this,"d")}function xt(){le.call(this,"c")}function Ct(){}function At(e,t,n,r){this.l=e,this.j=t,this.m=n,this.W=r||1,this.U=new ot(this),this.P=kt,this.V=new rt(e=ve?125:void 0),this.I=null,this.i=!1,this.s=this.A=this.v=this.L=this.G=this.Y=this.B=null,this.F=[],this.g=null,this.C=0,this.o=this.u=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new Dt}function Dt(){this.i=null,this.g="",this.h=!1}It.prototype.h=null,Z={OPEN:"a",vb:"b",Ra:"c",Hb:"d"},e(St,le),e(xt,le),e(Ct,It),Ct.prototype.g=function(){return new XMLHttpRequest},Ct.prototype.i=function(){return{}};var Nt=new Ct,kt=45e3,Rt={},Mt={};function Ot(e,t,n){e.L=1,e.v=Xt($t(t)),e.s=n,e.S=!0,Lt(e,null)}function Lt(e,t){e.G=Date.now(),Vt(e),e.A=$t(e.v);var a,o,u,h,l,c,n=e.A,r=e.W;Array.isArray(r)||(r=[String(r)]),cn(n.i,"t",r),e.C=0,n=e.l.J,e.h=new Dt,e.g=hr(e.l,n?t:null,!e.s),0<e.O&&(e.M=new at(se(e.Pa,e,e.g),e.O)),ht(e.U,e.g,"readystatechange",e.nb),t=e.I?Re(e.I):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.A,e.u,e.s,t)):(e.u="GET",e.g.ha(e.A,e.u,null,t)),yt(),a=e.j,o=e.u,u=e.A,h=e.m,l=e.W,c=e.s,a.info(function(){if(a.g)if(c)for(var e="",t=c.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=c;return"XMLHTTP REQ ("+h+") [attempt "+l+"]: "+o+"\n"+u+"\n"+e})}function Ft(e){return e.g&&"GET"==e.u&&2!=e.L&&e.l.Ha}function Pt(e,t,n){let r=!0,s;for(;!e.J&&e.C<n.length;){if((s=(u=void 0,o=(i=e).C,-1==(u=(a=n).indexOf("\n",o))?Mt:(o=Number(a.substring(o,u)),isNaN(o)?Rt:(u+=1)+o>a.length?Mt:(a=a.slice(u,u+o),i.C=u+o,a))))==Mt){4==t&&(e.o=4,wt(14),r=!1),dt(e.j,e.m,null,"[Incomplete Response]");break}if(s==Rt){e.o=4,wt(15),dt(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}dt(e.j,e.m,s,null),Gt(e,s)}var i,a,o,u;Ft(e)&&s!=Mt&&s!=Rt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,wt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),tr(t),t.M=!0,wt(11))):(dt(e.j,e.m,n,"[Invalid Chunked Response]"),jt(e),qt(e))}function Vt(e){e.Y=Date.now()+e.P,Bt(e,e.P)}function Bt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=bt(se(e.lb,e),t)}function Ut(e){e.B&&(x.clearTimeout(e.B),e.B=null)}function qt(e){0==e.l.H||e.J||sr(e.l,e)}function jt(e){Ut(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,st(e.V),lt(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function Gt(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||yn(n.i,e)))if(!e.K&&yn(n.i,e)&&3==n.H){try{var r=n.Ja.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;rr(n),$n(n)}er(n),wt(18)}}else n.Fa=s[1],0<n.Fa-n.V&&s[2]<37500&&n.G&&0==n.A&&!n.v&&(n.v=bt(se(n.ib,n),6e3));if(pn(n.i)<=1&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else ar(n,11)}else if(!e.K&&n.g!=e||rr(n),!de(t))for(s=n.Ja.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.V=i[0],i=i[1],2==n.H)if("c"==i[0]){n.K=i[1],n.pa=i[2];var a=i[3],o=(null!=a&&(n.ra=a,n.l.info("VER="+n.ra)),i[4]);null!=o&&(n.Ga=o,n.l.info("SVER="+n.Ga));var u,h,l=i[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const g=e.g;if(g){const m=g.g?g.g.getResponseHeader("X-Client-Wire-Protocol"):null;!m||(u=r.i).g||-1==m.indexOf("spdy")&&-1==m.indexOf("quic")&&-1==m.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(vn(u,u.h),u.h=null)),r.F&&(h=g.g?g.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.Da=h,p(r.I,r.F,h))}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms"));var c,d,f=e;(r=n).wa=ur(r,r.J?r.pa:null,r.Y),f.K?(wn(r.i,f),c=f,(d=r.L)&&c.setTimeout(d),c.B&&(Ut(c),Vt(c)),r.g=f):Zn(r),0<n.j.length&&Wn(n)}else"stop"!=i[0]&&"close"!=i[0]||ar(n,7);else 3==n.H&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?ar(n,7):Qn(n):"noop"!=i[0]&&n.h&&n.h.Aa(i),n.A=0)}yt()}catch(e){}}function Kt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(ee(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(ee(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n)}else{t=[],n=0;for(const r in e)t[n++]=r}return t}}}(e),r=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(ee(e))for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);else for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),s=r.length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}(t=At.prototype).setTimeout=function(e){this.P=e},t.nb=function(e){e=e.target;const t=this.M;t&&3==Un(e)?t.l():this.Pa(e)},t.Pa=function(e){try{if(e==this.g)e:{var t=Un(this.g),n=this.g.Ia();if(this.g.da(),!(t<3)&&(3!=t||ve||this.g&&(this.h.h||this.g.ja()||qn(this.g)))){this.J||4!=t||7==n||yt(),Ut(this);var r=this.g.da();this.ca=r;t:if(Ft(this)){var s=qn(this.g),i=(e="",s.length),a=4==Un(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){jt(this),qt(this);var o="";break t}this.h.i=new x.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:a&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.ja();if(this.i=200==r,p=this.j,y=this.u,v=this.A,w=this.m,_=this.W,b=t,I=r,p.info(function(){return"XMLHTTP RESP ("+w+") [ attempt "+_+"]: "+y+"\n"+v+"\n"+b+" "+I}),this.i){if(this.aa&&!this.K){t:{if(this.g){var u,h=this.g;if((u=h.g?h.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!de(u)){var l=u;break t}}l=null}if(!(r=l)){this.i=!1,this.o=3,wt(12),jt(this),qt(this);break e}dt(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Gt(this,r)}this.S?(Pt(this,t,o),ve&&this.i&&3==t&&(ht(this.U,this.V,"tick",this.mb),this.V.start())):(dt(this.j,this.m,o,null),Gt(this,o)),4==t&&jt(this),this.i&&!this.J&&(4==t?sr(this.l,this):(this.i=!1,Vt(this)))}else{{var c=this.g;const E={};c=(c.g&&2<=Un(c)&&c.g.getAllResponseHeaders()||"").split("\r\n");for(let e=0;e<c.length;e++)if(!de(c[e])){var d=function(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(c[e]),f=d[0];if("string"==typeof(d=d[1])){d=d.trim();const T=E[f]||[];(E[f]=T).push(d)}}function g(e){return e.join(", ")}var m=E;for(const S in m)g.call(void 0,m[S],S,m)}400==r&&0<o.indexOf("Unknown SID")?(this.o=3,wt(12)):(this.o=0,wt(13)),jt(this),qt(this)}}}}catch(e){}var p,y,v,w,_,b,I},t.mb=function(){var e,t;this.g&&(e=Un(this.g),t=this.g.ja(),this.C<t.length&&(Ut(this),Pt(this,e,t),this.i&&4!=e&&Vt(this)))},t.cancel=function(){this.J=!0,jt(this)},t.lb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.L&&(yt(),wt(17)),jt(this),this.o=2,qt(this)):Bt(this,this.Y-n)};var zt=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Qt(e){var t,n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof Qt?(this.h=e.h,Ht(this,e.j),this.s=e.s,this.g=e.g,Wt(this,e.m),this.l=e.l,t=e.i,(n=new on).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Yt(this,n),this.o=e.o):e&&(t=String(e).match(zt))?(this.h=!1,Ht(this,t[1]||"",!0),this.s=Jt(t[2]||""),this.g=Jt(t[3]||"",!0),Wt(this,t[4]),this.l=Jt(t[5]||"",!0),Yt(this,t[6]||"",!0),this.o=Jt(t[7]||"")):(this.h=!1,this.i=new on(null,this.h))}function $t(e){return new Qt(e)}function Ht(e,t,n){e.j=n?Jt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Wt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Yt(e,t,n){var r,s;t instanceof on?(e.i=t,r=e.i,(s=e.h)&&!r.j&&(un(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(hn(this,t),cn(this,n,e))},r)),r.j=s):(n||(t=Zt(t,sn)),e.i=new on(t,e.h))}function p(e,t,n){e.i.set(t,n)}function Xt(e){return p(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Jt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Zt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,en),n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function en(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Qt.prototype.toString=function(){var e=[],t=this.j,n=(t&&e.push(Zt(t,tn,!0),":"),this.g);return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Zt(t,tn,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Zt(n,"/"==n.charAt(0)?rn:nn,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Zt(n,an)),e.join("")};var tn=/[#\/\?@]/g,nn=/[#\?:]/g,rn=/[#\?]/g,sn=/[#\?@]/g,an=/#/g;function on(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function un(e){if(!e.g&&(e.g=new Map,e.h=0,e.i)){var t=e.i;if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,s=t[n].indexOf("="),i=null;0<=s?(r=t[n].substring(0,s),i=t[n].substring(s+1)):r=t[n],s=r,i=i?decodeURIComponent(i.replace(/\+/g," ")):"",e.add(decodeURIComponent(s.replace(/\+/g," ")),i)}}}}function hn(e,t){un(e),t=dn(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function ln(e,t){return un(e),t=dn(e,t),e.g.has(t)}function cn(e,t,n){hn(e,t),0<n.length&&(e.i=null,e.g.set(dn(e,t),ue(n)),e.h+=n.length)}function dn(e,t){return t=String(t),e.j?t.toLowerCase():t}(t=on.prototype).add=function(e,t){un(this),this.i=null,e=dn(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},t.forEach=function(n,r){un(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},t.ta=function(){un(this);const e=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let t=0;t<n.length;t++){var s=e[t];for(let e=0;e<s.length;e++)r.push(n[t])}return r},t.Z=function(t){un(this);let n=[];if("string"==typeof t)ln(this,t)&&(n=n.concat(this.g.get(dn(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},t.set=function(e,t){return un(this),this.i=null,ln(this,e=dn(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},t.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},t.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),i=this.Z(r),r=0;r<i.length;r++){var a=s;""!==i[r]&&(a+="="+encodeURIComponent(String(i[r]))),e.push(a)}return this.i=e.join("&")};var fn=class{constructor(e,t){this.g=e,this.map=t}};function gn(e){this.l=e||10,e=x.PerformanceNavigationTiming?0<(e=x.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(x.g&&x.g.Ka&&x.g.Ka()&&x.g.Ka().dc),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function mn(e){return e.h||e.g&&e.g.size>=e.j}function pn(e){return e.h?1:e.g?e.g.size:0}function yn(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function vn(e,t){e.g?e.g.add(t):e.h=t}function wn(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function _n(t){if(null!=t.h)return t.i.concat(t.h.F);if(null==t.g||0===t.g.size)return ue(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}}gn.prototype.cancel=function(){if(this.i=_n(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var bn,In=class{stringify(e){return x.JSON.stringify(e,void 0)}parse(e){return x.JSON.parse(e,void 0)}};function En(){this.g=new In}function Tn(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function Sn(e){this.l=e.ec||null,this.j=e.ob||!1}function xn(e,t){s.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=Cn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}e(Sn,It),Sn.prototype.g=function(){return new xn(this.l,this.j)},Sn.prototype.i=(bn={},function(){return bn}),e(xn,s);var Cn=0;function An(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function Dn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,Nn(e)}function Nn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(t=xn.prototype).open=function(e,t){if(this.readyState!=Cn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,Nn(this)},t.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||x).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},t.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Dn(this)),this.readyState=Cn},t.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,Nn(this)),this.g&&(this.readyState=3,Nn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==x.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;An(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},t.Xa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?Dn:Nn)(this),3==this.readyState&&An(this))},t.Za=function(e){this.g&&(this.response=this.responseText=e,Dn(this))},t.Ya=function(e){this.g&&(this.response=e,Dn(this))},t.ka=function(){this.g&&Dn(this)},t.setRequestHeader=function(e,t){this.v.append(e,t)},t.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},t.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(xn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var kn=x.JSON.parse;function r(e){s.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=Rn,this.L=this.M=!1}e(r,s);var Rn="",Mn=/^https?$/i,On=["POST","PUT"];function Ln(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Fn(e),Vn(e)}function Fn(e){e.F||(e.F=!0,$e(e,"complete"),$e(e,"error"))}function Pn(e){if(e.h&&(!e.C[1]||4!=Un(e)||2!=e.da()))if(e.v&&4==Un(e))it(e.La,0,e);else if($e(e,"readystatechange"),4==Un(e)){e.h=!1;try{var t,n,r,s=e.da();switch(s){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var i=!0;break;default:i=!1}if((t=i)||((n=0===s)&&(!(r=String(e.I).match(zt)[1]||null)&&x.self&&x.self.location&&(r=x.self.location.protocol.slice(0,-1)),n=!Mn.test(r?r.toLowerCase():"")),t=n),t)$e(e,"complete"),$e(e,"success");else{e.m=6;try{var a=2<Un(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.da()+"]",Fn(e)}}finally{Vn(e)}}}function Vn(e,t){if(e.g){Bn(e);const n=e.g,r=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||$e(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Bn(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(x.clearTimeout(e.A),e.A=null)}function Un(e){return e.g?e.g.readyState:0}function qn(e){try{if(e.g){if("response"in e.g)return e.g.response;switch(e.K){case Rn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}}return null}catch(e){return null}}function jn(e){let n="";return ke(e,function(e,t){n=(n=n+t+":")+e+"\r\n"}),n}function Gn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=jn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):p(e,t,n))}function Kn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function zn(e){this.Ga=0,this.j=[],this.l=new ct,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=Kn("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=Kn("baseRetryDelayMs",5e3,e),this.hb=Kn("retryDelaySeedMs",1e4,e),this.eb=Kn("forwardChannelMaxRetries",2,e),this.xa=Kn("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new gn(e&&e.concurrentRequestLimit),this.Ja=new En,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Qn(e){if(Hn(e),3==e.H){var t=e.W++,n=$t(e.I);if(p(n,"SID",e.K),p(n,"RID",t),p(n,"TYPE","terminate"),Xn(e,n),(t=new At(e,e.l,t)).L=2,t.v=Xt($t(n)),n=!1,x.navigator&&x.navigator.sendBeacon)try{n=x.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&x.Image&&((new Image).src=t.v,n=!0),n||(t.g=hr(t.l,null),t.g.ha(t.v)),t.G=Date.now(),Vt(t)}or(e)}function $n(e){e.g&&(tr(e),e.g.cancel(),e.g=null)}function Hn(e){$n(e),e.u&&(x.clearTimeout(e.u),e.u=null),rr(e),e.i.cancel(),e.m&&("number"==typeof e.m&&x.clearTimeout(e.m),e.m=null)}function Wn(e){var t;mn(e.i)||e.m||(e.m=!0,t=e.Na,Je||tt(),Ze||(Je(),Ze=!0),et.add(t,e),e.C=0)}function Yn(e,t){var n=t?t.m:e.W++,r=$t(e.I);p(r,"SID",e.K),p(r,"RID",n),p(r,"AID",e.V),Xn(e,r),e.o&&e.s&&Gn(r,e.o,e.s),n=new At(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=Jn(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),vn(e.i,n),Ot(n,r,t)}function Xn(e,n){e.na&&ke(e.na,function(e,t){p(n,t,e)}),e.h&&Kt({},function(e,t){p(n,t,e)})}function Jn(r,e,s){s=Math.min(r.j.length,s);var i=r.h?se(r.h.Va,r.h,r):null;e:{var a=r.j;let n=-1;for(;;){const h=["count="+s];-1==n?0<s?(n=a[0].g,h.push("ofs="+n)):n=0:h.push("ofs="+n);let t=!0;for(let e=0;e<s;e++){var o=a[e].g,u=a[e].map;if((o-=n)<0)n=Math.max(0,a[e].g-100),t=!1;else try{!function(e,r){const s="req"+o+"_"||"";try{Kt(e,function(e,t){let n=e;te(e)&&(n=We(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}(u,h)}catch(r){i&&i(u)}}if(t){i=h.join("&");break e}}}return r=r.j.splice(0,s),e.F=r,i}function Zn(e){var t;e.g||e.u||(e.ba=1,t=e.Ma,Je||tt(),Ze||(Je(),Ze=!0),et.add(t,e),e.A=0)}function er(e){return!(e.g||e.u||3<=e.A)&&(e.ba++,e.u=bt(se(e.Ma,e),ir(e,e.A)),e.A++,1)}function tr(e){null!=e.B&&(x.clearTimeout(e.B),e.B=null)}function nr(e){e.g=new At(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=$t(e.wa),n=(p(t,"RID","rpc"),p(t,"SID",e.K),p(t,"AID",e.V),p(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&p(t,"TO",e.qa),p(t,"TYPE","xmlhttp"),Xn(e,t),e.o&&e.s&&Gn(t,e.o,e.s),e.L&&e.g.setTimeout(e.L),e.g);e=e.pa,n.L=1,n.v=Xt($t(t)),n.s=null,n.S=!0,Lt(n,e)}function rr(e){null!=e.v&&(x.clearTimeout(e.v),e.v=null)}function sr(e,t){var n,r,s,i=null;if(e.g==t){rr(e),tr(e),e.g=null;var a=2}else{if(!yn(e.i,t))return;i=t.F,wn(e.i,t),a=1}if(0!=e.H)if(t.i)(1==a?(i=t.s?t.s.length:0,t=Date.now()-t.G,n=e.C,$e(a=mt(),new _t(a,i)),Wn):Zn)(e);else if(3==(n=t.o)||0==n&&0<t.ca||(1!=a||(s=t,pn((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.j=s.F.concat(r.j),0):1==r.H||2==r.H||r.C>=(r.cb?0:r.eb)||(r.m=bt(se(r.Na,r,s),ir(r,r.C)),r.C++,0))))&&(2!=a||!er(e)))switch(i&&0<i.length&&(t=e.i,t.i=t.i.concat(i)),n){case 1:ar(e,5);break;case 4:ar(e,10);break;case 3:ar(e,6);break;default:ar(e,2)}}function ir(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function ar(e,t){if(e.l.info("Error code "+t),2==t){n=null,e.h&&(n=null),r=se(e.pb,e),n||(n=new Qt("//www.google.com/images/cleardot.gif"),x.location&&"http"==x.location.protocol||Ht(n,"https"),Xt(n));var n=n.toString(),r,s=new ct;if(x.Image){const i=new Image;i.onload=ie(Tn,s,i,"TestLoadImage: loaded",!0,r),i.onerror=ie(Tn,s,i,"TestLoadImage: error",!1,r),i.onabort=ie(Tn,s,i,"TestLoadImage: abort",!1,r),i.ontimeout=ie(Tn,s,i,"TestLoadImage: timeout",!1,r),x.setTimeout(function(){i.ontimeout&&i.ontimeout()},1e4),i.src=n}else r(!1)}else wt(2);e.H=0,e.h&&e.h.za(t),or(e),Hn(e)}function or(e){var t;e.H=0,e.ma=[],e.h&&(0==(t=_n(e.i)).length&&0==e.j.length||(he(e.ma,t),he(e.ma,e.j),e.i.i.length=0,ue(e.j),e.j.length=0),e.h.ya())}function ur(e,t,n){var r,s,i=n instanceof Qt?$t(n):new Qt(n);return""!=i.g?(t&&(i.g=t+"."+i.g),Wt(i,i.m)):(i=(r=x.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,s=new Qt(null),i&&Ht(s,i),t&&(s.g=t),r&&Wt(s,r),n&&(s.l=n),i=s),n=e.F,t=e.Da,n&&t&&p(i,n,t),p(i,"VER",e.ra),Xn(e,i),i}function hr(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ha&&!e.va?new r(new Sn({ob:!0})):new r(e.va)).Oa(e.J),t}function lr(){}function cr(){if(ye&&!(10<=Number(Te)))throw Error("Environmental error: no available transport.")}function dr(e,t){s.call(this),this.g=new zn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!de(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!de(t)&&(this.g.F=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new mr(this)}function fr(e){St.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function gr(){xt.call(this),this.status=1}function mr(e){this.g=e}function pr(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function yr(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var s=0;s<16;++s)r[s]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(s=0;s<16;++s)r[s]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1];var s=e.g[2],i=e.g[3],a=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=(n=(s=(i=(t=n+((a=t+(i^n&(s^i))+r[0]+3614090360&4294967295)<<7&4294967295|a>>>25))+((a=i+(s^t&(n^s))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=s+(n^i&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^s&(i^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^n&(s^i))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=i+(s^t&(n^s))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=s+(n^i&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^s&(i^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^n&(s^i))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=i+(s^t&(n^s))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=s+(n^i&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^s&(i^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^n&(s^i))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=i+(s^t&(n^s))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=s+(n^i&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^s&(i^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^i&(n^s))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=i+(n^s&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=s+(t^n&(i^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(i^t&(s^i))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(s^i&(n^s))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=i+(n^s&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=s+(t^n&(i^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(i^t&(s^i))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(s^i&(n^s))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=i+(n^s&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=s+(t^n&(i^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(i^t&(s^i))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(s^i&(n^s))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=i+(n^s&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=s+(t^n&(i^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(i^t&(s^i))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^s^i)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=i+(t^n^s)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=s+(i^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(s^i^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^s^i)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=i+(t^n^s)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=s+(i^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(s^i^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^s^i)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=i+(t^n^s)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=s+(i^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(s^i^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^s^i)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=i+(t^n^s)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=s+(i^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(s^i^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(s^(n|~i))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=i+(n^(t|~s))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=s+(t^(i|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(i^(s|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(s^(n|~i))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=i+(n^(t|~s))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=s+(t^(i|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(i^(s|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(s^(n|~i))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=i+(n^(t|~s))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=s+(t^(i|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(i^(s|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((i=(t=n+((a=t+(s^(n|~i))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=i+(n^(t|~s))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((s=i+((a=s+(t^(i|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(s+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+s&4294967295,e.g[3]=e.g[3]+i&4294967295}function h(e,t){this.h=t;for(var n=[],r=!0,s=e.length-1;0<=s;s--){var i=0|e[s];r&&i==t||(n[s]=i,r=!1)}this.g=n}(t=r.prototype).Oa=function(e){this.M=e},t.ha=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=(this.u||Nt).g(),this.C=this.u?Et(this.u):Et(Nt),this.g.onreadystatechange=se(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void Ln(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),s=x.FormData&&e instanceof x.FormData,0<=oe(On,t)&&!r&&!s&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[i,a]of n)this.g.setRequestHeader(i,a);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{Bn(this),0<this.B&&((this.L=(o=this.g,ye&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=se(this.ua,this)):this.A=it(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){Ln(this,e)}var o},t.ua=function(){this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,$e(this,"timeout"),this.abort(8))},t.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,$e(this,"complete"),$e(this,"abort"),Vn(this))},t.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Vn(this,!0)),r.$.N.call(this)},t.La=function(){this.s||(this.G||this.v||this.l?Pn(this):this.kb())},t.kb=function(){Pn(this)},t.isActive=function(){return!!this.g},t.da=function(){try{return 2<Un(this)?this.g.status:-1}catch(e){return-1}},t.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},t.Wa=function(e){var t;if(this.g)return t=this.g.responseText,e&&0==t.indexOf(e)&&(t=t.substring(e.length)),kn(t)},t.Ia=function(){return this.m},t.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(t=zn.prototype).ra=8,t.H=1,t.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const i=new At(this,this.l,t);let e=this.s;if(this.U&&(e?Oe(e=Re(e),this.U):e=this.U),null!==this.o||this.O||(i.I=e,e=null),this.P)e:{for(var n=0,r=0;r<this.j.length;r++){var s=this.j[r];if(void 0===(s="__data__"in s.map&&"string"==typeof(s=s.map.__data__)?s.length:void 0))break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.j.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=Jn(this,i,n),p(r=$t(this.I),"RID",t),p(r,"CVER",22),this.F&&p(r,"X-HTTP-Session-Id",this.F),Xn(this,r),e&&(this.O?n="headers="+encodeURIComponent(String(jn(e)))+"&"+n:this.o&&Gn(r,this.o,e)),vn(this.i,i),this.bb&&p(r,"TYPE","init"),this.P?(p(r,"$req",n),p(r,"SID","null"),i.aa=!0,Ot(i,r,null)):Ot(i,r,n),this.H=2}}else 3==this.H&&(t?Yn(this,t):0==this.j.length||mn(this.i)||Yn(this))},t.Ma=function(){var e;this.u=null,nr(this),this.ca&&!(this.M||null==this.g||this.S<=0)&&(e=2*this.S,this.l.info("BP detection timer enabled: "+e),this.B=bt(se(this.jb,this),e))},t.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,wt(10),$n(this),nr(this))},t.ib=function(){null!=this.v&&(this.v=null,$n(this),er(this),wt(19))},t.pb=function(e){e?(this.l.info("Successfully pinged google.com"),wt(2)):(this.l.info("Failed to ping google.com"),wt(1))},t.isActive=function(){return!!this.h&&this.h.isActive(this)},(t=lr.prototype).Ba=function(){},t.Aa=function(){},t.za=function(){},t.ya=function(){},t.isActive=function(){return!0},t.Va=function(){},cr.prototype.g=function(e,t){return new dr(e,t)},e(dr,s),dr.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;wt(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=ur(e,null,e.Y),Wn(e)},dr.prototype.close=function(){Qn(this.g)},dr.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=We(e),e=t),n.j.push(new fn(n.fb++,e)),3==n.H&&Wn(n)},dr.prototype.N=function(){this.g.h=null,delete this.j,Qn(this.g),delete this.g,dr.$.N.call(this)},e(fr,St),e(gr,xt),e(mr,lr),mr.prototype.Ba=function(){$e(this.g,"a")},mr.prototype.Aa=function(e){$e(this.g,new fr(e))},mr.prototype.za=function(e){$e(this.g,new gr)},mr.prototype.ya=function(){$e(this.g,"b")},e(pr,function(){this.blockSize=-1}),pr.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},pr.prototype.j=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.m,s=this.h,i=0;i<t;){if(0==s)for(;i<=n;)yr(this,e,i),i+=this.blockSize;if("string"==typeof e){for(;i<t;)if(r[s++]=e.charCodeAt(i++),s==this.blockSize){yr(this,r),s=0;break}}else for(;i<t;)if(r[s++]=e[i++],s==this.blockSize){yr(this,r),s=0;break}}this.h=s,this.i+=t},pr.prototype.l=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;for(var n=8*this.i,t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var vr={};function wr(e){return-128<=e&&e<128?(t=e,n=function(e){return new h([0|e],e<0?-1:0)},r=vr,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new h([0|e],e<0?-1:0);var t,n,r}function _r(e){if(isNaN(e)||!isFinite(e))return Ir;if(e<0)return Cr(_r(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=br;return new h(t,0)}var br=4294967296,Ir=wr(0),Er=wr(1),Tr=wr(16777216);function Sr(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function xr(e){return-1==e.h}function Cr(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new h(n,~e.h).add(Er)}function Ar(e,t){return e.add(Cr(t))}function Dr(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function Nr(e,t){this.g=e,this.h=t}function kr(e,t){if(Sr(t))throw Error("division by zero");if(Sr(e))return new Nr(Ir,Ir);if(xr(e))return t=kr(Cr(e),t),new Nr(Cr(t.g),Cr(t.h));if(xr(t))return t=kr(e,Cr(t)),new Nr(Cr(t.g),t.h);if(30<e.g.length){if(xr(e)||xr(t))throw Error("slowDivide_ only works with positive integers.");for(var n=Er,r=t;r.X(e)<=0;)n=Rr(n),r=Rr(r);for(var s=Mr(n,1),i=Mr(r,1),r=Mr(r,2),n=Mr(n,2);!Sr(r);){var a=i.add(r);a.X(e)<=0&&(s=s.add(n),i=a),r=Mr(r,1),n=Mr(n,1)}return t=Ar(e,s.R(t)),new Nr(s,t)}for(s=Ir;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),a=(i=_r(n)).R(t);xr(a)||0<a.X(e);)a=(i=_r(n-=r)).R(t);Sr(i)&&(i=Er),s=s.add(i),e=Ar(e,a)}return new Nr(s,e)}function Rr(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.D(r)<<1|e.D(r-1)>>>31;return new h(n,e.h)}function Mr(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,s=[],i=0;i<r;i++)s[i]=0<t?e.D(i+n)>>>t|e.D(i+n+1)<<32-t:e.D(i+n);return new h(s,e.h)}(t=h.prototype).ea=function(){if(xr(this))return-Cr(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.D(n);e+=(0<=r?r:br+r)*t,t*=br}return e},t.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(Sr(this))return"0";if(xr(this))return"-"+Cr(this).toString(e);for(var t=_r(Math.pow(e,6)),n=this,r="";;){var s=kr(n,t).g,i=((0<(n=Ar(n,s.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(Sr(n=s))return i+r;for(;i.length<6;)i="0"+i;r=i+r}},t.D=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},t.X=function(e){return xr(e=Ar(this,e))?-1:Sr(e)?0:1},t.abs=function(){return xr(this)?Cr(this):this},t.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,s=0;s<=t;s++){var i=r+(65535&this.D(s))+(65535&e.D(s)),a=(i>>>16)+(this.D(s)>>>16)+(e.D(s)>>>16),r=a>>>16;i&=65535,a&=65535,n[s]=a<<16|i}return new h(n,-2147483648&n[n.length-1]?-1:0)},t.R=function(e){if(Sr(this)||Sr(e))return Ir;if(xr(this))return xr(e)?Cr(this).R(Cr(e)):Cr(Cr(this).R(e));if(xr(e))return Cr(this.R(Cr(e)));if(this.X(Tr)<0&&e.X(Tr)<0)return _r(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var s=0;s<e.g.length;s++){var i=this.D(r)>>>16,a=65535&this.D(r),o=e.D(s)>>>16,u=65535&e.D(s);n[2*r+2*s]+=a*u,Dr(n,2*r+2*s),n[2*r+2*s+1]+=i*u,Dr(n,2*r+2*s+1),n[2*r+2*s+1]+=a*o,Dr(n,2*r+2*s+1),n[2*r+2*s+2]+=i*o,Dr(n,2*r+2*s+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new h(n,0)},t.gb=function(e){return kr(this,e).h},t.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)&e.D(r);return new h(n,this.h&e.h)},t.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)|e.D(r);return new h(n,this.h|e.h)},t.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)^e.D(r);return new h(n,this.h^e.h)},cr.prototype.createWebChannel=cr.prototype.g,dr.prototype.send=dr.prototype.u,dr.prototype.open=dr.prototype.m,_e.NO_ERROR=0,_e.TIMEOUT=8,_e.HTTP_ERROR=6,pe.COMPLETE="complete",(Tt.EventType=Z).OPEN="a",Z.CLOSE="b",Z.ERROR="c",Z.MESSAGE="d",s.prototype.listen=s.prototype.O,r.prototype.listenOnce=r.prototype.P,r.prototype.getLastError=r.prototype.Sa,r.prototype.getLastErrorCode=r.prototype.Ia,r.prototype.getStatus=r.prototype.da,r.prototype.getResponseJson=r.prototype.Wa,r.prototype.getResponseText=r.prototype.ja,r.prototype.send=r.prototype.ha,r.prototype.setWithCredentials=r.prototype.Oa,pr.prototype.digest=pr.prototype.l,pr.prototype.update=pr.prototype.j,h.prototype.multiply=h.prototype.R,h.prototype.modulo=h.prototype.gb,h.prototype.compare=h.prototype.X,h.prototype.toNumber=h.prototype.ea,h.prototype.getBits=h.prototype.D,h.fromNumber=_r,h.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return Cr(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=_r(Math.pow(n,8)),s=Ir,i=0;i<t.length;i+=8)var a=Math.min(8,t.length-i),o=parseInt(t.substring(i,i+a),n),s=(a<8?(a=_r(Math.pow(n,a)),s.R(a)):s=s.R(r)).add(_r(o));return s};var g,Or,Lr=mt,Fr=_e,Pr=pe,Vr=ft,Br=Tt,Ur=r,qr=pr,jr=h,Ee="@firebase/firestore";class o{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}o.UNAUTHENTICATED=new o(null),o.GOOGLE_CREDENTIALS=new o("google-credentials-uid"),o.FIRST_PARTY=new o("first-party-uid"),o.MOCK_USER=new o("mock-user");let Gr="10.4.0";const Kr=new class{constructor(e){this.name=e,this._logLevel=Y,this._logHandler=J,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in c))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?W[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,c.DEBUG,...e),this._logHandler(this,c.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,c.VERBOSE,...e),this._logHandler(this,c.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,c.INFO,...e),this._logHandler(this,c.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,c.WARN,...e),this._logHandler(this,c.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,c.ERROR,...e),this._logHandler(this,c.ERROR,...e)}}("@firebase/firestore");function zr(){return Kr.logLevel}function m(e,...t){Kr.logLevel<=c.DEBUG&&(t=t.map($r),Kr.debug(`Firestore (${Gr}): `+e,...t))}function d(e,...t){Kr.logLevel<=c.ERROR&&(t=t.map($r),Kr.error(`Firestore (${Gr}): `+e,...t))}function Qr(e,...t){Kr.logLevel<=c.WARN&&(t=t.map($r),Kr.warn(`Firestore (${Gr}): `+e,...t))}function $r(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function E(e="Unexpected state"){e=`FIRESTORE (${Gr}) INTERNAL ASSERTION FAILED: `+e;throw d(e),new Error(e)}function y(e){e||E()}const w={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class _ extends z{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: `+this.message}}class Hr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Wr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization","Bearer "+e)}}class Yr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(o.UNAUTHENTICATED))}shutdown(){}}class Xr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Jr{constructor(e){this.t=e,this.currentUser=o.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new Hr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Hr,t.enqueueRetryable(()=>s(this.currentUser))};const a=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},o=e=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Hr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(y("string"==typeof e.accessToken),new Wr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return y(null===e||"string"==typeof e),new o(e)}}class Zr{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=o.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);var e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class es{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new Zr(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(o.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class ts{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class ns{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,n){const r=e=>{null!=e.error&&m("FirebaseAppCheckTokenProvider","Error getting App Check token; using placeholder token instead. Error: "+e.error.message);var t=e.token!==this.R;return this.R=e.token,m("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()},s=(this.o=e=>{t.enqueueRetryable(()=>r(e))},e=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)});this.A.onInit(e=>s(e)),setTimeout(()=>{var e;this.appCheck||((e=this.A.getImmediate({optional:!0}))?s(e):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(y("string"==typeof e.token),this.R=e.token,new ts(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class rs{static V(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=function(){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),t=new Uint8Array(40);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(t);else for(let e=0;e<40;e++)t[e]=Math.floor(256*Math.random());return t}();for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function T(e,t){return e<t?-1:t<e?1:0}function ss(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function is(e){return e+"\0"}class l{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new _(w.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new _(w.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new _(w.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new _(w.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return l.fromMillis(Date.now())}static fromDate(e){return l.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),e=Math.floor(1e6*(e-1e3*t));return new l(t,e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?T(this.nanoseconds,e.nanoseconds):T(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class b{constructor(e){this.timestamp=e}static fromTimestamp(e){return new b(e)}static min(){return new b(new l(0,0))}static max(){return new b(new l(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class as{constructor(e,t,n){void 0===t?t=0:t>e.length&&E(),void 0===n?n=e.length-t:n>e.length-t&&E(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===as.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof as?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(n){for(let e=this.offset,t=this.limit();e<t;e++)n(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,n){const r=Math.min(t.length,n.length);for(let e=0;e<r;e++){const r=t.get(e),s=n.get(e);if(r<s)return-1;if(r>s)return 1}return t.length<n.length?-1:t.length>n.length?1:0}}class I extends as{construct(e,t,n){return new I(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new _(w.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new I(t)}static emptyPath(){return new I([])}}const os=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class f extends as{construct(e,t,n){return new f(e,t,n)}static isValidIdentifier(e){return os.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=f.isValidIdentifier(e)?e:"`"+e+"`")).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new f(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new _(w.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new _(w.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new _(w.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new _(w.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new f(t)}static emptyPath(){return new f([])}}class S{constructor(e){this.path=e}static fromPath(e){return new S(I.fromString(e))}static fromName(e){return new S(I.fromString(e).popFirst(5))}static empty(){return new S(I.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===I.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return I.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new S(new I(e.slice()))}}class us{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function hs(e){return e.fields.find(e=>2===e.kind)}function ls(e){return e.fields.filter(e=>2!==e.kind)}us.UNKNOWN_ID=-1;class cs{constructor(e,t){this.fieldPath=e,this.kind=t}}class ds{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new ds(0,ms.min())}}function fs(e,t){var n=e.toTimestamp().seconds,e=e.toTimestamp().nanoseconds+1,e=b.fromTimestamp(1e9===e?new l(n+1,0):new l(n,e));return new ms(e,S.empty(),t)}function gs(e){return new ms(e.readTime,e.key,-1)}class ms{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new ms(b.min(),S.empty(),-1)}static max(){return new ms(b.max(),S.empty(),-1)}}function ps(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n||0!==(n=S.comparator(e.documentKey,t.documentKey))?n:T(e.largestBatchId,t.largestBatchId)}const ys="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class vs{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function ws(e){if(e.code!==w.FAILED_PRECONDITION||e.message!==ys)throw e;m("LocalStore","Unexpectedly lost primary lease")}class C{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&E(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new C((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof C?t:C.resolve(t)}catch(e){return C.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):C.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):C.reject(t)}static resolve(n){return new C((e,t)=>{e(n)})}static reject(n){return new C((e,t)=>{t(n)})}static waitFor(e){return new C((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=C.resolve(!1);for(const n of e)t=t.next(e=>e?C.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new C((t,n)=>{const r=o.length,s=new Array(r);let i=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{s[a]=e,++i===r&&t(s)},e=>n(e))}})}static doWhile(r,s){return new C((e,t)=>{const n=()=>{!0===r()?s().next(()=>{n()},t):e()};n()})}}class _s{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.m=new Hr,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{e.error?this.m.reject(new Es(t,e.error)):this.m.resolve()},this.transaction.onerror=e=>{e=As(e.target.error);this.m.reject(new Es(t,e))}}static open(e,t,n,r){try{return new _s(t,e.transaction(r,n))}catch(e){throw new Es(t,e)}}get g(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(m("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}p(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){e=this.transaction.objectStore(e);return new Ss(e)}}class bs{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===bs.D(G())&&d("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return m("SimpleDb","Removing database:",e),xs(window.indexedDB.deleteDatabase(e)).toPromise()}static C(){if(!function(){try{return"object"==typeof indexedDB}catch(e){}}())return!1;if(bs.v())return!0;const e=G(),t=bs.D(e),n=0<t&&t<10,r=bs.F(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static v(){var e;return"undefined"!=typeof process&&"YES"===(null==(e=process.env)?void 0:e.M)}static O(e,t){return e.store(t)}static D(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static F(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async N(s){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{e=e.target.result;t(e)},r.onblocked=()=>{n(new Es(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{e=e.target.error;"VersionError"===e.name?n(new _(w.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===e.name?n(new _(w.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+e)):n(new Es(s,e))},r.onupgradeneeded=e=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.S.B(t,r.transaction,e.oldVersion,this.version).next(()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(t){this.L=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.N(e);const t=_s.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.p(),e)).catch(e=>(t.abort(e),C.reject(e))).toPromise();return i.catch(()=>{}),await t.g,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Is{constructor(e){this.q=e,this.K=!1,this.$=null}get isDone(){return this.K}get U(){return this.$}set cursor(e){this.q=e}done(){this.K=!0}W(e){this.$=e}delete(){return xs(this.q.delete())}}class Es extends _{constructor(e,t){super(w.UNAVAILABLE,`IndexedDB transaction '${e}' failed: `+t),this.name="IndexedDbTransactionError"}}function Ts(e){return"IndexedDbTransactionError"===e.name}class Ss{constructor(e){this.store=e}put(e,t){return xs(void 0!==t?(m("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)))}add(e){return m("SimpleDb","ADD",this.store.name,e,e),xs(this.store.add(e))}get(t){return xs(this.store.get(t)).next(e=>(m("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return m("SimpleDb","DELETE",this.store.name,e),xs(this.store.delete(e))}count(){return m("SimpleDb","COUNT",this.store.name),xs(this.store.count())}G(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.j(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new C((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}H(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new C((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}J(e,t){m("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Y=!1;e=this.cursor(n);return this.j(e,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);e=this.cursor(n);return this.j(e,t)}X(r){const e=this.cursor({});return new C((n,t)=>{e.onerror=e=>{e=As(e.target.error);t(e)},e.onsuccess=e=>{const t=e.target.result;t?r(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}j(e,i){const a=[];return new C((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new Is(t),r=i(t.primaryKey,t.value,n);if(r instanceof C){const e=r.catch(e=>(n.done(),C.reject(e)));a.push(e)}n.isDone?s():null===n.U?t.continue():t.continue(n.U)}else s()}}).next(()=>C.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function xs(e){return new C((t,n)=>{e.onsuccess=e=>{e=e.target.result;t(e)},e.onerror=e=>{e=As(e.target.error);n(e)}})}let Cs=!1;function As(e){const t=bs.D(G());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new _("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Cs||(Cs=!0,setTimeout(()=>{throw e},0)),e}}return e}class Ds{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){m("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{m("IndexBackiller","Documents written: "+await this.ee.ne())}catch(e){Ts(e)?m("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await ws(e)}await this.te(6e4)})}}class Ns{constructor(e,t){this.localStore=e,this.persistence=t}async ne(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.re(e,t))}re(e,t){const n=new Set;let r=t,s=!0;return C.doWhile(()=>!0===s&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(s=!1):(m("IndexBackiller","Processing collection: "+t),this.ie(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}ie(r,s,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,s).next(n=>this.localStore.localDocuments.getNextDocuments(r,s,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.se(n,e)).next(e=>(m("IndexBackiller","Updating offset: "+e),this.localStore.indexManager.updateCollectionGroup(r,s,e))).next(()=>t.size)}))}se(e,t){let n=e;return t.changes.forEach((e,t)=>{t=gs(t);0<ps(t,n)&&(n=t)}),new ms(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ks{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this._e&&this._e(e),e}}function Rs(e){return null==e}function Ms(e){return 0===e&&1/e==-1/0}function Os(e){return"number"==typeof e&&Number.isInteger(e)&&!Ms(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Ls(t){let s="";for(let e=0;e<t.length;e++)0<s.length&&(s=Fs(s)),s=function(t){let n=s;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(t.get(e));return Fs(s)}function Fs(e){return e+""}function Ps(n){const r=n.length;if(y(2<=r),2===r)return y(""===n.charAt(0)&&""===n.charAt(1)),I.emptyPath();const s=r-2,i=[];let a="";for(let t=0;t<r;){const r=n.indexOf("",t);switch((r<0||r>s)&&E(),n.charAt(r+1)){case"":var o=n.substring(t,r);let e;0===a.length?e=o:(a+=o,e=a,a=""),i.push(e);break;case"":a=a+n.substring(t,r)+"\0";break;case"":a+=n.substring(t,r+1);break;default:E()}t=r+2}return new I(i)}ks.ae=-1;const Vs=["userId","batchId"];function Bs(e,t){return[e,Ls(t)]}function Us(e,t,n){return[e,Ls(t),n]}const qs={},js=["prefixPath","collectionGroup","readTime","documentId"],Gs=["prefixPath","collectionGroup","documentId"],Ks=["collectionGroup","readTime","prefixPath","documentId"],zs=["canonicalId","targetId"],Qs=["targetId","path"],$s=["path","targetId"],Hs=["collectionId","parent"],Ws=["indexId","uid"],Ys=["uid","sequenceNumber"],Xs=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Js=["indexId","uid","orderedDocumentKey"],Zs=["userId","collectionPath","documentId"],ei=["userId","collectionPath","largestBatchId"],ti=["userId","collectionGroup","largestBatchId"],ni=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],ri=[...ni,"documentOverlays"],si=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ii=si,ai=[...ii,"indexConfiguration","indexState","indexEntries"];class oi extends vs{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function ui(e,t){return bs.O(e.ue,t)}function hi(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function li(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ci(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class A{constructor(e,t){this.comparator=e,this.root=t||fi.EMPTY}insert(e,t){return new A(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,fi.BLACK,null,null))}remove(e){return new A(this.comparator,this.root.remove(e,this.comparator).copy(null,null,fi.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(e+":"+t),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new di(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new di(this.root,e,this.comparator,!1)}getReverseIterator(){return new di(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new di(this.root,e,this.comparator,!0)}}class di{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){var e;return 0===this.nodeStack.length?null:{key:(e=this.nodeStack[this.nodeStack.length-1]).key,value:e.value}}}class fi{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:fi.RED,this.left=null!=r?r:fi.EMPTY,this.right=null!=s?s:fi.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new fi(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return(r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return fi.EMPTY;let e=this;return(e=(e=e.left.isRed()||e.left.left.isRed()?e:e.moveRedLeft()).copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r=(r=r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()?r:r.moveRedLeft()).copy(null,null,null,r.left.remove(e,t),null);else{if(0===t(e,(r=(r=r.left.isRed()?r.rotateRight():r).right.isEmpty()||r.right.isRed()||r.right.left.isRed()?r:r.moveRedRight()).key)){if(r.right.isEmpty())return fi.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e=(e=(e=e.right.isRed()&&!e.left.isRed()?e.rotateLeft():e).left.isRed()&&e.left.left.isRed()?e.rotateRight():e).left.isRed()&&e.right.isRed()?e.colorFlip():e}moveRedLeft(){let e=this.colorFlip();return e=e.right.left.isRed()?(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip():e}moveRedRight(){let e=this.colorFlip();return e=e.left.left.isRed()?(e=e.rotateRight()).colorFlip():e}rotateLeft(){var e=this.copy(null,null,fi.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,fi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw E();if(this.right.isRed())throw E();var e=this.left.check();if(e!==this.right.check())throw E();return e+(this.isRed()?0:1)}}fi.EMPTY=null,fi.RED=!0,fi.BLACK=!1,fi.EMPTY=new class{constructor(){this.size=0}get key(){throw E()}get value(){throw E()}get color(){throw E()}get left(){throw E()}get right(){throw E()}copy(e,t,n,r,s){return this}insert(e,t,n){return new fi(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class D{constructor(e){this.comparator=e,this.data=new A(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new gi(this.data.getIterator())}getIteratorFrom(e){return new gi(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof D))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new D(this.comparator);return t.data=e,t}}class gi{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function mi(e){return e.hasNext()?e.getNext():void 0}class pi{constructor(e){(this.fields=e).sort(f.comparator)}static empty(){return new pi([])}unionWith(e){let t=new D(f.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new pi(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return ss(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class yi extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class vi{constructor(e){this.binaryString=e}static fromBase64String(e){e=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new yi("Invalid base64 string: "+e):e}}(e);return new vi(e)}static fromUint8Array(e){e=function(t){let n="";for(let e=0;e<t.length;++e)n+=String.fromCharCode(t[e]);return n}(e);return new vi(e)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){{var t=this.binaryString;const n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return T(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}vi.EMPTY_BYTE_STRING=new vi("");const wi=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function _i(t){if(y(!!t),"string"!=typeof t)return{seconds:N(t.seconds),nanos:N(t.nanos)};{let e=0;var n=wi.exec(t);y(!!n),n[1]&&(n=(n[1]+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function N(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function bi(e){return"string"==typeof e?vi.fromBase64String(e):vi.fromUint8Array(e)}function Ii(e){return"server_timestamp"===(null==(e=((null==(e=null==e?void 0:e.mapValue)?void 0:e.fields)||{}).__type__)?void 0:e.stringValue)}function Ei(e){e=e.mapValue.fields.__previous_value__;return Ii(e)?Ei(e):e}function Ti(e){e=_i(e.mapValue.fields.__local_write_time__.timestampValue);return new l(e.seconds,e.nanos)}class Si{constructor(e,t,n,r,s,i,a,o,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=u}}class xi{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new xi("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof xi&&e.projectId===this.projectId&&e.database===this.database}}const Ci={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ai={nullValue:"NULL_VALUE"};function Di(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ii(e)?4:ji(e)?9007199254740991:10:E()}function Ni(e,t){if(e===t)return!0;var n,r,s,i=Di(e);if(i!==Di(t))return!1;switch(i){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Ti(e).isEqual(Ti(t));case 3:return r=t,"string"==typeof e.timestampValue&&"string"==typeof r.timestampValue&&e.timestampValue.length===r.timestampValue.length?e.timestampValue===r.timestampValue:(s=_i(e.timestampValue),r=_i(r.timestampValue),s.seconds===r.seconds&&s.nanos===r.nanos);case 5:return e.stringValue===t.stringValue;case 6:return n=t,bi(e.bytesValue).isEqual(bi(n.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return s=t,N((n=e).geoPointValue.latitude)===N(s.geoPointValue.latitude)&&N(n.geoPointValue.longitude)===N(s.geoPointValue.longitude);case 2:return r=t,"integerValue"in(n=e)&&"integerValue"in r?N(n.integerValue)===N(r.integerValue):"doubleValue"in n&&"doubleValue"in r&&((n=N(n.doubleValue))===(r=N(r.doubleValue))?Ms(n)===Ms(r):isNaN(n)&&isNaN(r));case 9:return ss(e.arrayValue.values||[],t.arrayValue.values||[],Ni);case 10:{var a=e;const o=a.mapValue.fields||{},u=t.mapValue.fields||{};if(hi(o)!==hi(u))return!1;for(const a in o)if(o.hasOwnProperty(a)&&(void 0===u[a]||!Ni(o[a],u[a])))return!1;return!0;return}default:return E()}}function ki(e,t){return void 0!==(e.values||[]).find(e=>Ni(e,t))}function Ri(e,t){if(e===t)return 0;var n,r,s=Di(e),i=Di(t);if(s!==i)return T(s,i);switch(s){case 0:case 9007199254740991:return 0;case 1:return T(e.booleanValue,t.booleanValue);case 2:return r=t,(a=N((n=e).integerValue||n.doubleValue))<(g=N(r.integerValue||r.doubleValue))?-1:g<a?1:a===g?0:isNaN(a)?isNaN(g)?0:-1:1;case 3:return Mi(e.timestampValue,t.timestampValue);case 4:return Mi(Ti(e),Ti(t));case 5:return T(e.stringValue,t.stringValue);case 6:{var a=e.bytesValue;var o=t.bytesValue;const y=bi(a),v=bi(o);return y.compareTo(v);return}case 7:var o=e.referenceValue,u=t.referenceValue,h=o.split("/"),l=u.split("/");for(let e=0;e<h.length&&e<l.length;e++){const u=T(h[e],l[e]);if(0!==u)return u}return T(h.length,l.length);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(g=T(N(n.latitude),N(r.latitude)))?g:T(N(n.longitude),N(r.longitude));case 9:var u=e.arrayValue,c=t.arrayValue,d=u.values||[],f=c.values||[];for(let e=0;e<d.length&&e<f.length;++e){const c=Ri(d[e],f[e]);if(c)return c}return T(d.length,f.length);case 10:{var g=e.mapValue;var m=t.mapValue;if(g===Ci.mapValue&&m===Ci.mapValue)return 0;if(g===Ci.mapValue)return 1;if(m===Ci.mapValue)return-1;const w=g.fields||{},_=Object.keys(w),b=m.fields||{},I=Object.keys(b);_.sort(),I.sort();for(let e=0;e<_.length&&e<I.length;++e){const m=T(_[e],I[e]);if(0!==m)return m;var p=Ri(w[_[e]],b[I[e]]);if(0!==p)return p}return T(_.length,I.length);return}default:throw E()}}function Mi(e,t){var n;return"string"==typeof e&&"string"==typeof t&&e.length===t.length?T(e,t):(e=_i(e),t=_i(t),0!==(n=T(e.seconds,t.seconds))?n:T(e.nanos,t.nanos))}function Oi(e){return function n(r){{if("nullValue"in r)return"null";if("booleanValue"in r)return""+r.booleanValue;if("integerValue"in r)return""+r.integerValue;if("doubleValue"in r)return""+r.doubleValue;if("timestampValue"in r)return`time(${(t=_i(r.timestampValue)).seconds},${t.nanos})`;if("stringValue"in r)return r.stringValue;if("bytesValue"in r)return bi(r.bytesValue).toBase64();if("referenceValue"in r)return t=r.referenceValue,S.fromName(t).toString();if("geoPointValue"in r)return`geo(${(e=r.geoPointValue).latitude},${e.longitude})`;if("arrayValue"in r){let e="[",t=!0;for(const i of r.arrayValue.values||[])t?t=!1:e+=",",e+=n(i);return e+"]"}if("mapValue"in r){var s=r.mapValue;let e="{",t=!0;for(const a of Object.keys(s.fields||{}).sort())t?t=!1:e+=",",e+=a+":"+n(s.fields[a]);return e+"}"}return E()}var e,t}(e)}function Li(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/`+t.path.canonicalString()}}function Fi(e){return e&&"integerValue"in e}function Pi(e){return!!e&&"arrayValue"in e}function Vi(e){return e&&"nullValue"in e}function Bi(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Ui(e){return e&&"mapValue"in e}function qi(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return li(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=qi(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=qi(t.arrayValue.values[e]);return r}return Object.assign({},t)}function ji(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Gi(e,t){var n=Ri(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Ki(e,t){var n=Ri(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class zi{constructor(e){this.value=e}static empty(){return new zi({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let t=this.value;for(let e=0;e<n.length-1;++e)if(!Ui(t=(t.mapValue.fields||{})[n.get(e)]))return null;return(t=(t.mapValue.fields||{})[n.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=qi(t)}setAll(e){let n=f.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=qi(e):s.push(t.lastSegment())});e=this.getFieldsMap(n);this.applyChanges(e,r,s)}delete(e){const t=this.field(e.popLast());Ui(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Ni(this.value,e.value)}getFieldsMap(n){let r=this.value;r.mapValue.fields||(r.mapValue={fields:{}});for(let t=0;t<n.length;++t){let e=r.mapValue.fields[n.get(t)];Ui(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},r.mapValue.fields[n.get(t)]=e),r=e}return r.mapValue.fields}applyChanges(n,e,t){li(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new zi(qi(this.value))}}class k{constructor(e,t,n,r,s,i,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=a}static newInvalidDocument(e){return new k(e,0,b.min(),b.min(),b.min(),zi.empty(),0)}static newFoundDocument(e,t,n,r){return new k(e,1,t,b.min(),n,r,0)}static newNoDocument(e,t){return new k(e,2,t,b.min(),b.min(),zi.empty(),0)}static newUnknownDocument(e,t){return new k(e,3,t,b.min(),b.min(),zi.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(b.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=zi.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=zi.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=b.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof k&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new k(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Qi{constructor(e,t){this.position=e,this.inclusive=t}}function $i(t,n,r){let s=0;for(let e=0;e<t.position.length;e++){const i=n[e],a=t.position[e];if(s=i.field.isKeyField()?S.comparator(S.fromName(a.referenceValue),r.key):Ri(a,r.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function Hi(t,n){if(null===t)return null===n;if(null===n)return!1;if(t.inclusive!==n.inclusive||t.position.length!==n.position.length)return!1;for(let e=0;e<t.position.length;e++)if(!Ni(t.position[e],n.position[e]))return!1;return!0}class Wi{constructor(e,t="asc"){this.field=e,this.dir=t}}class Yi{}class R extends Yi{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new ra(e,t,n):"array-contains"===t?new oa(e,n):"in"===t?new ua(e,n):"not-in"===t?new ha(e,n):"array-contains-any"===t?new la(e,n):new R(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?sa:ia)(e,n)}matches(e){e=e.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(Ri(e,this.value)):null!==e&&Di(this.value)===Di(e)&&this.matchesComparison(Ri(e,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return E()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class M extends Yi{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new M(e,t)}matches(t){return Xi(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null===this.ce&&(this.ce=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ce}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){var e=this.le(e=>e.isInequality());return null!==e?e.field:null}le(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function Xi(e){return"and"===e.op}function Ji(e){return"or"===e.op}function Zi(e){return ea(e)&&Xi(e)}function ea(e){for(const t of e.filters)if(t instanceof M)return!1;return!0}function ta(e,t){t=e.filters.concat(t);return M.create(t,e.op)}function na(e){return e instanceof R?`${(t=e).field.canonicalString()} ${t.op} `+Oi(t.value):e instanceof M?e.op.toString()+" {"+e.getFilters().map(na).join(" ,")+"}":"Filter";var t}class ra extends R{constructor(e,t,n){super(e,t,n),this.key=S.fromName(n.referenceValue)}matches(e){e=S.comparator(e.key,this.key);return this.matchesComparison(e)}}class sa extends R{constructor(e,t){super(e,"in",t),this.keys=aa(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class ia extends R{constructor(e,t){super(e,"not-in",t),this.keys=aa(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function aa(e,t){return((null==(t=t.arrayValue)?void 0:t.values)||[]).map(e=>S.fromName(e.referenceValue))}class oa extends R{constructor(e,t){super(e,"array-contains",t)}matches(e){e=e.data.field(this.field);return Pi(e)&&ki(e.arrayValue,this.value)}}class ua extends R{constructor(e,t){super(e,"in",t)}matches(e){e=e.data.field(this.field);return null!==e&&ki(this.value.arrayValue,e)}}class ha extends R{constructor(e,t){super(e,"not-in",t)}matches(e){return!ki(this.value.arrayValue,{nullValue:"NULL_VALUE"})&&(null!==(e=e.data.field(this.field))&&!ki(this.value.arrayValue,e))}}class la extends R{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Pi(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>ki(this.value.arrayValue,e))}}class ca{constructor(e,t=null,n=[],r=[],s=null,i=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=a,this.he=null}}function da(e,t=null,n=[],r=[],s=null,i=null,a=null){return new ca(e,t,n,r,s,i,a)}function fa(e){const t=e;if(null===t.he){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e=(e=(e+="|f:")+t.filters.map(e=>function t(e){var n;return e instanceof R?e.field.canonicalString()+e.op.toString()+Oi(e.value):Zi(e)?e.filters.map(e=>t(e)).join(","):(n=e.filters.map(e=>t(e)).join(","),e.op+`(${n})`)}(e)).join(",")+"|ob:")+t.orderBy.map(e=>{return e.field.canonicalString()+e.dir}).join(","),Rs(t.limit)||(e=(e+="|l:")+t.limit),t.startAt&&(e=(e=(e+="|lb:")+(t.startAt.inclusive?"b:":"a:"))+t.startAt.position.map(e=>Oi(e)).join(",")),t.endAt&&(e=(e=(e+="|ub:")+(t.endAt.inclusive?"a:":"b:"))+t.endAt.position.map(e=>Oi(e)).join(",")),t.he=e}return t.he}function ga(t,n){if(t.limit!==n.limit)return!1;if(t.orderBy.length!==n.orderBy.length)return!1;for(let e=0;e<t.orderBy.length;e++)if(r=t.orderBy[e],s=n.orderBy[e],r.dir!==s.dir||!r.field.isEqual(s.field))return!1;var r,s;if(t.filters.length!==n.filters.length)return!1;for(let e=0;e<t.filters.length;e++)if(!function r(e,t){return e instanceof R?(n=e,(i=t)instanceof R&&n.op===i.op&&n.field.isEqual(i.field)&&Ni(n.value,i.value)):e instanceof M?(s=t)instanceof M&&e.op===s.op&&e.filters.length===s.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,s.filters[n]),!0):void E();var s,n,i}(t.filters[e],n.filters[e]))return!1;return t.collectionGroup===n.collectionGroup&&!!t.path.isEqual(n.path)&&!!Hi(t.startAt,n.startAt)&&Hi(t.endAt,n.endAt)}function ma(e){return S.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function pa(e,t){return e.filters.filter(e=>e instanceof R&&e.field.isEqual(t))}function ya(t,n,r){let s=Ai,i=!0;for(const r of pa(t,n)){let e=Ai,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?Ai:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Li(xi.empty(),S.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:E();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=Ai}Gi({value:s,inclusive:i},{value:e,inclusive:t})<0&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];Gi({value:s,inclusive:i},{value:t,inclusive:r.inclusive})<0&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}function va(t,n,r){let s=Ci,i=!0;for(const r of pa(t,n)){let e=Ci,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Li(xi.empty(),S.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?Ci:E(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=Ci}0<Ki({value:s,inclusive:i},{value:e,inclusive:t})&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<Ki({value:s,inclusive:i},{value:t,inclusive:r.inclusive})&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}class wa{constructor(e,t=null,n=[],r=[],s=null,i="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=a,this.endAt=o,this.Pe=null,this.Ie=null,this.de=null,this.startAt,this.endAt}}function _a(e,t,n,r,s,i,a,o){return new wa(e,t,n,r,s,i,a,o)}function ba(e){return new wa(e)}function Ia(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Ea(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function Ta(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function Sa(e){return null!==e.collectionGroup}function xa(t){const n=t;if(null===n.Pe){n.Pe=[];const t=Ta(n),e=Ea(n);if(null!==t&&null===e)t.isKeyField()||n.Pe.push(new Wi(t)),n.Pe.push(new Wi(f.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n.Pe.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.Pe.push(new Wi(f.keyField(),t))}}}return n.Pe}function Ca(e){const t=e;return t.Ie||(t.Ie=function(e,t){if("F"===e.limitType)return da(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);t=t.map(e=>{var t="desc"===e.dir?"asc":"desc";return new Wi(e.field,t)});var n=e.endAt?new Qi(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Qi(e.startAt.position,e.startAt.inclusive):null;return da(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}(t,xa(e))),t.Ie}function Aa(e,t){t.getFirstInequalityField(),Ta(e);t=e.filters.concat([t]);return new wa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)}function Da(e,t,n){return new wa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Na(e,t){return ga(Ca(e),Ca(t))&&e.limitType===t.limitType}function ka(e){return fa(Ca(e))+"|lt:"+e.limitType}function Ra(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>na(e)).join(", ")}]`),Rs(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>{return`${e.field.canonicalString()} (${e.dir})`}).join(", ")}]`),e.startAt&&(t=(t=(t+=", startAt: ")+(e.startAt.inclusive?"b:":"a:"))+e.startAt.position.map(e=>Oi(e)).join(",")),`Target(${t=e.endAt?(t=(t+=", endAt: ")+(e.endAt.inclusive?"a:":"b:"))+e.endAt.position.map(e=>Oi(e)).join(","):t})`}(Ca(e))}; limitType=${e.limitType})`}function Ma(n,e){return e.isFoundDocument()&&(s=n,a=(i=e).key.path,null!==s.collectionGroup?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(a):S.isDocumentKey(s.path)?s.path.isEqual(a):s.path.isImmediateParentOf(a))&&function(e){for(const t of xa(n))if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(s=e,(!(e=n).startAt||(r=$i(t=e.startAt,n=xa(e),s),t.inclusive?r<=0:r<0))&&(!e.endAt||(r=$i(t=e.endAt,e=xa(e),s),t.inclusive?0<=r:0<r)));var t,r,s,i,a}function Oa(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function La(s){return(e,t)=>{let n=!1;for(const r of xa(s)){const s=function(e,t,n){var r,s=e.field.isKeyField()?S.comparator(t.key,n.key):(r=e.field,n=n,t=t.data.field(r),n=n.data.field(r),null!==t&&null!==n?Ri(t,n):E());switch(e.dir){case"asc":return s;case"desc":return-1*s;default:return E()}}(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}class Fa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(t,n){const e=this.mapKeyFn(t),r=this.inner[e];if(void 0===r)this.inner[e]=[[t,n]];else{for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return void(r[e]=[t,n]);r.push([t,n])}this.innerSize++}delete(t){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r)for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return 1===r.length?delete this.inner[n]:r.splice(e,1),this.innerSize--,!0;return!1}forEach(r){li(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return ci(this.inner)}size(){return this.innerSize}}const Pa=new A(S.comparator),Va=new A(S.comparator);function Ba(...e){let t=Va;for(const n of e)t=t.insert(n.key,n);return t}function Ua(e){let n=Va;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function qa(){return new Fa(e=>e.toString(),(e,t)=>e.isEqual(t))}const ja=new A(S.comparator),Ga=new D(S.comparator);function O(...e){let t=Ga;for(const n of e)t=t.add(n);return t}const Ka=new D(T);function za(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ms(t)?"-0":t}}function Qa(e){return{integerValue:""+e}}function $a(e,t){return Os(t)?Qa(t):za(e,t)}class Ha{constructor(){this._=void 0}}function Wa(e,t){return e instanceof to?Fi(e=t)||e&&"doubleValue"in e?t:{integerValue:0}:null}class Ya extends Ha{}class Xa extends Ha{constructor(e){super(),this.elements=e}}function Ja(e,t){const n=ro(t);for(const t of e.elements)n.some(e=>Ni(e,t))||n.push(t);return{arrayValue:{values:n}}}class Za extends Ha{constructor(e){super(),this.elements=e}}function eo(e,t){let n=ro(t);for(const t of e.elements)n=n.filter(e=>!Ni(e,t));return{arrayValue:{values:n}}}class to extends Ha{constructor(e,t){super(),this.serializer=e,this.Te=t}}function no(e){return N(e.integerValue||e.doubleValue)}function ro(e){return Pi(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class so{constructor(e,t){this.field=e,this.transform=t}}class io{constructor(e,t){this.version=e,this.transformResults=t}}class L{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new L}static exists(e){return new L(void 0,e)}static updateTime(e){return new L(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function ao(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class oo{}function uo(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new yo(e.key,L.none()):new co(e.key,e.data,L.none());{const s=e.data,i=zi.empty();let t=new D(f.comparator);for(var r of n.fields)if(!t.has(r)){let e=s.field(r);null===e&&1<r.length&&(r=r.popLast(),e=s.field(r)),null===e?i.delete(r):i.set(r,e),t=t.add(r)}return new fo(e.key,i,new pi(t.toArray()),L.none())}}function ho(e,t,n,r){if(e instanceof co){var s=e,i=t,a=n,o=r;if(!ao(s.precondition,i))return a;const u=s.value.clone(),h=po(s.fieldTransforms,o,i);return u.setAll(h),i.convertToFoundDocument(i.version,u).setHasLocalMutations(),null}if(e instanceof fo){a=e,s=t,o=n,i=r;if(!ao(a.precondition,s))return o;const l=po(a.fieldTransforms,i,s),c=s.data;return c.setAll(go(a)),c.setAll(l),s.convertToFoundDocument(s.version,c).setHasLocalMutations(),null===o?null:o.unionWith(a.fieldMask.fields).unionWith(a.fieldTransforms.map(e=>e.field))}return ao(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function lo(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&ss(n,r,(e,t)=>{return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Xa&&t instanceof Xa||e instanceof Za&&t instanceof Za?ss(e.elements,t.elements,Ni):e instanceof to&&t instanceof to?Ni(e.Te,t.Te):e instanceof Ya&&t instanceof Ya)}))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class co extends oo{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class fo extends oo{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function go(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function mo(t,n,r){const s=new Map;y(t.length===r.length);for(let e=0;e<r.length;e++){var i=t[e],a=i.transform,o=n.data.field(i.field);s.set(i.field,(i=a,a=o,o=r[e],i instanceof Xa?Ja(i,a):i instanceof Za?eo(i,a):o))}return s}function po(e,t,n){const r=new Map;for(const u of e){const e=u.transform,h=n.data.field(u.field);r.set(u.field,(s=e,a=h,i=t,0,s instanceof Ya?function(e){const t={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return(e=e&&Ii(e)?Ei(e):e)&&(t.fields.__previous_value__=e),{mapValue:t}}(a):s instanceof Xa?Ja(s,a):s instanceof Za?eo(s,a):(o=no(a=Wa(s,a))+no(s.Te),Fi(a)&&Fi(s.Te)?Qa(o):za(s.serializer,o))))}var s,i,a,o;return r}class yo extends oo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class vo extends oo{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class wo{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){var n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const h=this.mutations[e];if(h.key.isEqual(t.key)){r=void 0;s=void 0;i=void 0;a=void 0;o=void 0;u=void 0;a=void 0;o=void 0;u=void 0;var r=h;var s=t;var i=n[e];if(r instanceof co){var a=r,o=s,u=i;const l=a.value.clone(),c=mo(a.fieldTransforms,o,u.transformResults);l.setAll(c),o.convertToFoundDocument(u.version,l).setHasCommittedMutations()}else if(r instanceof fo){a=r,o=s,u=i;if(ao(a.precondition,o)){const d=mo(a.fieldTransforms,o,u.transformResults),f=o.data;f.setAll(go(a)),f.setAll(d),o.convertToFoundDocument(u.version,f).setHasCommittedMutations()}else o.convertToUnknownDocument(u.version)}else s.convertToNoDocument(i.version).setHasCommittedMutations()}}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=ho(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=ho(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(i,a){const o=qa();return this.mutations.forEach(e=>{const t=i.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var s=uo(n,r);null!==s&&o.set(e.key,s),n.isValidDocument()||n.convertToNoDocument(b.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),O())}isEqual(e){return this.batchId===e.batchId&&ss(this.mutations,e.mutations,(e,t)=>lo(e,t))&&ss(this.baseMutations,e.baseMutations,(e,t)=>lo(e,t))}}class _o{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){y(e.mutations.length===n.length);let r=ja;var s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new _o(e,t,n,r)}}class bo{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class Io{constructor(e,t){this.count=e,this.unchangedNames=t}}function Eo(e){switch(e){default:return E(),0;case w.CANCELLED:case w.UNKNOWN:case w.DEADLINE_EXCEEDED:case w.RESOURCE_EXHAUSTED:case w.INTERNAL:case w.UNAVAILABLE:case w.UNAUTHENTICATED:return;case w.INVALID_ARGUMENT:case w.NOT_FOUND:case w.ALREADY_EXISTS:case w.PERMISSION_DENIED:case w.FAILED_PRECONDITION:case w.ABORTED:case w.OUT_OF_RANGE:case w.UNIMPLEMENTED:case w.DATA_LOSS:return 1}}function To(e){if(void 0===e)return d("GRPC error has no .code"),w.UNKNOWN;switch(e){case g.OK:return w.OK;case g.CANCELLED:return w.CANCELLED;case g.UNKNOWN:return w.UNKNOWN;case g.DEADLINE_EXCEEDED:return w.DEADLINE_EXCEEDED;case g.RESOURCE_EXHAUSTED:return w.RESOURCE_EXHAUSTED;case g.INTERNAL:return w.INTERNAL;case g.UNAVAILABLE:return w.UNAVAILABLE;case g.UNAUTHENTICATED:return w.UNAUTHENTICATED;case g.INVALID_ARGUMENT:return w.INVALID_ARGUMENT;case g.NOT_FOUND:return w.NOT_FOUND;case g.ALREADY_EXISTS:return w.ALREADY_EXISTS;case g.PERMISSION_DENIED:return w.PERMISSION_DENIED;case g.FAILED_PRECONDITION:return w.FAILED_PRECONDITION;case g.ABORTED:return w.ABORTED;case g.OUT_OF_RANGE:return w.OUT_OF_RANGE;case g.UNIMPLEMENTED:return w.UNIMPLEMENTED;case g.DATA_LOSS:return w.DATA_LOSS;default:return E()}}function So(){return new TextEncoder}pe=g={OK:0,0:"OK",CANCELLED:1,1:"CANCELLED",UNKNOWN:2,2:"UNKNOWN",INVALID_ARGUMENT:3,3:"INVALID_ARGUMENT",DEADLINE_EXCEEDED:4,4:"DEADLINE_EXCEEDED",NOT_FOUND:5,5:"NOT_FOUND",ALREADY_EXISTS:6,6:"ALREADY_EXISTS",PERMISSION_DENIED:7,7:"PERMISSION_DENIED",UNAUTHENTICATED:16,16:"UNAUTHENTICATED",RESOURCE_EXHAUSTED:8,8:"RESOURCE_EXHAUSTED",FAILED_PRECONDITION:9,9:"FAILED_PRECONDITION",ABORTED:10,10:"ABORTED",OUT_OF_RANGE:11,11:"OUT_OF_RANGE",UNIMPLEMENTED:12,12:"UNIMPLEMENTED",INTERNAL:13,13:"INTERNAL",UNAVAILABLE:14,14:"UNAVAILABLE",DATA_LOSS:15,15:"DATA_LOSS"};const xo=new jr([4294967295,4294967295],0);function Co(e){const t=So().encode(e),n=new qr;return n.update(t),new Uint8Array(n.digest())}function Ao(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new jr([n,r],0),new jr([s,i],0)]}class Do{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new No("Invalid padding: "+t);if(n<0)throw new No("Invalid hash count: "+n);if(0<e.length&&0===this.hashCount)throw new No("Invalid hash count: "+n);if(0===e.length&&0!==t)throw new No("Invalid padding when bitmap length is 0: "+t);this.Ae=8*e.length-t,this.Re=jr.fromNumber(this.Ae)}Ve(e,t,n){let r=e.add(t.multiply(jr.fromNumber(n)));return(r=1===r.compare(xo)?new jr([r.getBits(0),r.getBits(1)],0):r).modulo(this.Re).toNumber()}me(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ae)return!1;const t=Co(e),[n,r]=Ao(t);for(let e=0;e<this.hashCount;e++){const t=this.Ve(n,r,e);if(!this.me(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new Do(s,r,t);return n.forEach(e=>i.insert(e)),i}insert(e){if(0!==this.Ae){var[t,n]=Ao(Co(e));for(let e=0;e<this.hashCount;e++){var r=this.Ve(t,n,e);this.fe(r)}}}fe(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class No extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class ko{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Ro.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new ko(b.min(),r,new A(T),Pa,O())}}class Ro{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Ro(n,t,O(),O(),O())}}class Mo{constructor(e,t,n,r){this.ge=e,this.removedTargetIds=t,this.key=n,this.pe=r}}class Oo{constructor(e,t){this.targetId=e,this.ye=t}}class Lo{constructor(e,t,n=vi.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Fo{constructor(){this.we=0,this.Se=Bo(),this.be=vi.EMPTY_BYTE_STRING,this.De=!1,this.Ce=!0}get current(){return this.De}get resumeToken(){return this.be}get ve(){return 0!==this.we}get Fe(){return this.Ce}Me(e){0<e.approximateByteSize()&&(this.Ce=!0,this.be=e)}xe(){let n=O(),r=O(),s=O();return this.Se.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:E()}}),new Ro(this.be,this.De,n,r,s)}Oe(){this.Ce=!1,this.Se=Bo()}Ne(e,t){this.Ce=!0,this.Se=this.Se.insert(e,t)}Be(e){this.Ce=!0,this.Se=this.Se.remove(e)}Le(){this.we+=1}ke(){--this.we}qe(){this.Ce=!0,this.De=!0}}class Po{constructor(e){this.Qe=e,this.Ke=new Map,this.$e=Pa,this.Ue=Vo(),this.We=new A(T)}Ge(e){for(const t of e.ge)e.pe&&e.pe.isFoundDocument()?this.ze(t,e.pe):this.je(t,e.key,e.pe);for(const n of e.removedTargetIds)this.je(n,e.key,e.pe)}He(n){this.forEachTarget(n,e=>{const t=this.Je(e);switch(n.state){case 0:this.Ye(e)&&t.Me(n.resumeToken);break;case 1:t.ke(),t.ve||t.Oe(),t.Me(n.resumeToken);break;case 2:t.ke(),t.ve||this.removeTarget(e);break;case 3:this.Ye(e)&&(t.qe(),t.Me(n.resumeToken));break;case 4:this.Ye(e)&&(this.Ze(e),t.Me(n.resumeToken));break;default:E()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Ke.forEach((e,t)=>{this.Ye(t)&&n(t)})}Xe(e){const t=e.targetId,n=e.ye.count,r=this.et(t);if(r){var s=r.target;if(ma(s))if(0===n){const e=new S(s.path);this.je(t,e,k.newNoDocument(e,b.min()))}else y(1===n);else{const r=this.tt(t);if(r!==n){const n=this.nt(e),i=n?this.rt(n,e,r):1;if(0!==i){this.Ze(t);const e=2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.We=this.We.insert(t,e)}}}}}nt(e){if(!(r=e.ye.unchangedNames)||!r.bits)return null;var{bits:{bitmap:t="",padding:n=0},hashCount:r=0}=r;let s,i;try{s=bi(t).toUint8Array()}catch(e){if(e instanceof yi)return Qr("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{i=new Do(s,n,r)}catch(e){return Qr(e instanceof No?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===i.Ae?null:i}rt(e,t,n){return t.ye.count===n-this.ot(e,t.targetId)?0:2}ot(n,r){const e=this.Qe.getRemoteKeysForTarget(r);let s=0;return e.forEach(e=>{var t=`projects/${(t=this.Qe.st()).projectId}/databases/${t.database}/documents/`+e.path.canonicalString();n.mightContain(t)||(this.je(r,e,null),s++)}),s}_t(r){const s=new Map;this.Ke.forEach((e,t)=>{var n=this.et(t);if(n){if(e.current&&ma(n.target)){const s=new S(n.target.path);null!==this.$e.get(s)||this.ut(t,s)||this.je(t,s,k.newNoDocument(s,r))}e.Fe&&(s.set(t,e.xe()),e.Oe())}});let i=O();this.Ue.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{e=this.et(e);return!e||"TargetPurposeLimboResolution"===e.purpose||(n=!1)}),n&&(i=i.add(e))}),this.$e.forEach((e,t)=>t.setReadTime(r));var e=new ko(r,s,this.We,this.$e,i);return this.$e=Pa,this.Ue=Vo(),this.We=new A(T),e}ze(e,t){var n;this.Ye(e)&&(n=this.ut(e,t.key)?2:0,this.Je(e).Ne(t.key,n),this.$e=this.$e.insert(t.key,t),this.Ue=this.Ue.insert(t.key,this.ct(t.key).add(e)))}je(e,t,n){if(this.Ye(e)){const r=this.Je(e);this.ut(e,t)?r.Ne(t,1):r.Be(t),this.Ue=this.Ue.insert(t,this.ct(t).delete(e)),n&&(this.$e=this.$e.insert(t,n))}}removeTarget(e){this.Ke.delete(e)}tt(e){var t=this.Je(e).xe();return this.Qe.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Le(e){this.Je(e).Le()}Je(e){let t=this.Ke.get(e);return t||(t=new Fo,this.Ke.set(e,t)),t}ct(e){let t=this.Ue.get(e);return t||(t=new D(T),this.Ue=this.Ue.insert(e,t)),t}Ye(e){var t=null!==this.et(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t}et(e){var t=this.Ke.get(e);return t&&t.ve?null:this.Qe.lt(e)}Ze(t){this.Ke.set(t,new Fo),this.Qe.getRemoteKeysForTarget(t).forEach(e=>{this.je(t,e,null)})}ut(e,t){return this.Qe.getRemoteKeysForTarget(e).has(t)}}function Vo(){return new A(S.comparator)}function Bo(){return new A(S.comparator)}const Uo={asc:"ASCENDING",desc:"DESCENDING"},qo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},jo={and:"AND",or:"OR"};class Go{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Ko(e,t){return e.useProto3Json||Rs(t)?t:{value:t}}function zo(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Qo(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function F(e){return y(!!e),b.fromTimestamp((e=_i(e),new l(e.seconds,e.nanos)))}function $o(e,t){return new I(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function Ho(e){e=I.fromString(e);return y(lu(e)),e}function Wo(e,t){return $o(e.databaseId,t.path)}function Yo(e,t){const n=Ho(t);if(n.get(1)!==e.databaseId.projectId)throw new _(w.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new _(w.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new S(eu(n))}function Xo(e,t){return $o(e.databaseId,t)}function Jo(e){e=Ho(e);return 4===e.length?I.emptyPath():eu(e)}function Zo(e){return new I(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function eu(e){return y(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function tu(e,t,n){return{name:Wo(e,t),fields:n.value.mapValue.fields}}function nu(e,t,n){const r=Yo(e,t.name),s=F(t.updateTime),i=t.createTime?F(t.createTime):b.min(),a=new zi({mapValue:{fields:t.fields}}),o=k.newFoundDocument(r,s,i,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function ru(e,t){let n;if(t instanceof co)n={update:tu(e,t.key,t.value)};else if(t instanceof yo)n={delete:Wo(e,t.key)};else if(t instanceof fo)n={update:tu(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof vo))return E();n={verify:Wo(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>{var t=e.transform;if(t instanceof Ya)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Xa)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof Za)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof to)return{fieldPath:e.field.canonicalString(),increment:t.Te};throw E()})),t.precondition.isNone||(n.currentDocument=(r=e,void 0!==(e=t.precondition).updateTime?{updateTime:zo(r,(t=e.updateTime).toTimestamp())}:void 0!==e.exists?{exists:e.exists}:E())),n;var r}function su(r,t){const e=t.currentDocument?void 0!==(s=t.currentDocument).updateTime?L.updateTime(F(s.updateTime)):void 0!==s.exists?L.exists(s.exists):L.none():L.none(),n=t.updateTransforms?t.updateTransforms.map(t=>{{var n=r;let e=null;if("setToServerValue"in t)y("REQUEST_TIME"===t.setToServerValue),e=new Ya;else if("appendMissingElements"in t){const n=t.appendMissingElements.values||[];e=new Xa(n)}else if("removeAllFromArray"in t){const n=t.removeAllFromArray.values||[];e=new Za(n)}else"increment"in t?e=new to(n,t.increment):E();return n=f.fromServerFormat(t.fieldPath),new so(n,e)}}):[];if(t.update){t.update.name;var s=Yo(r,t.update.name),i=new zi({mapValue:{fields:t.update.fields}});if(t.updateMask){const r=function(){const e=t.updateMask.fieldPaths||[];return new pi(e.map(e=>f.fromServerFormat(e)))}();return new fo(s,i,r,e,n)}return new co(s,i,e,n)}if(t.delete){const n=Yo(r,t.delete);return new yo(n,e)}if(t.verify){const n=Yo(r,t.verify);return new vo(n,e)}return E()}function iu(e,t){return{documents:[Xo(e,t.path)]}}function au(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Xo(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Xo(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(e){if(0!==e.length)return function t(e){if(e instanceof R){var n=e;if("=="===n.op){if(Bi(n.value))return{unaryFilter:{field:uu(n.field),op:"IS_NAN"}};if(Vi(n.value))return{unaryFilter:{field:uu(n.field),op:"IS_NULL"}}}else if("!="===n.op){if(Bi(n.value))return{unaryFilter:{field:uu(n.field),op:"IS_NOT_NAN"}};if(Vi(n.value))return{unaryFilter:{field:uu(n.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:uu(n.field),op:(r=n.op,qo[r]),value:n.value}}}return e instanceof M?1===(n=(r=e).getFilters().map(e=>t(e))).length?n[0]:{compositeFilter:{op:(r=r.op,jo[r]),filters:n}}:E();var r}(M.create(e,"and"))}(t.filters);return s&&(n.structuredQuery.where=s),(s=function(e){if(0!==e.length)return e.map(e=>{return{field:uu(e.field),direction:(e=e.dir,Uo[e])}})}(t.orderBy))&&(n.structuredQuery.orderBy=s),null!==(s=Ko(e,t.limit))&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt={before:(e=t.startAt).inclusive,values:e.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function ou(e){let t=Jo(e.parent);var n,r,s,i=e.structuredQuery,a=i.from?i.from.length:0;let o=null,u=(0<a&&(y(1===a),(a=i.from[0]).allDescendants?o=a.collectionId:t=t.child(a.collectionId)),[]),h=(i.where&&(u=function(){const e=function t(e){if(void 0!==e.unaryFilter){var n=e;switch(n.unaryFilter.op){case"IS_NAN":var r=hu(n.unaryFilter.field);return R.create(r,"==",{doubleValue:NaN});case"IS_NULL":r=hu(n.unaryFilter.field);return R.create(r,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":r=hu(n.unaryFilter.field);return R.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":r=hu(n.unaryFilter.field);return R.create(r,"!=",{nullValue:"NULL_VALUE"});default:return E()}}else{return void 0!==e.fieldFilter?(i=e,R.create(hu(i.fieldFilter.field),function(){switch(i.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return E()}}(),i.fieldFilter.value)):void 0!==e.compositeFilter?(s=e,M.create(s.compositeFilter.filters.map(e=>t(e)),function(){switch(s.compositeFilter.op){case"AND":return"and";case"OR":return"or";default:return E()}}())):E();var s,i}}(i.where);return e instanceof M&&Zi(e)?e.getFilters():[e]}()),[]),l=(i.orderBy&&(h=i.orderBy.map(e=>{var t=e;return new Wi(hu(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())})),null),c=(i.limit&&(l=Rs(n="object"==typeof(e=i.limit)?e.value:e)?null:n),null),d=(i.startAt&&(c=(s=!!(r=i.startAt).before,n=r.values||[],new Qi(n,s))),null);return i.endAt&&(d=(s=!(r=i.endAt).before,i=r.values||[],new Qi(i,s))),_a(t,o,h,u,l,"F",c,d)}function uu(e){return{fieldPath:e.canonicalString()}}function hu(e){return f.fromServerFormat(e.fieldPath)}function lu(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class cu{constructor(e,t,n,r,s=b.min(),i=b.min(),a=vi.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new cu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new cu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new cu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new cu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class du{constructor(e){this.ht=e}}function fu(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:gu(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:Wo(s=e.ht,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:zo(s,e.version.toTimestamp()),createTime:zo(s,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:mu(t.version)};else{if(!t.isUnknownDocument())return E();r.unknownDocument={path:n.path.toArray(),version:mu(t.version)}}var s;return r}function gu(e){e=e.toTimestamp();return[e.seconds,e.nanoseconds]}function mu(e){e=e.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function pu(e){e=new l(e.seconds,e.nanoseconds);return b.fromTimestamp(e)}function yu(t,n){const r=(n.baseMutations||[]).map(e=>su(t.ht,e));for(let e=0;e<n.mutations.length-1;++e){const r=n.mutations[e];if(e+1<n.mutations.length&&void 0!==n.mutations[e+1].transform){const s=n.mutations[e+1];r.updateTransforms=s.transform.fieldTransforms,n.mutations.splice(e+1,1),++e}}const s=n.mutations.map(e=>su(t.ht,e)),e=l.fromMillis(n.localWriteTimeMs);return new wo(n.batchId,e,r,s)}function vu(e){var t=pu(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?pu(e.lastLimboFreeSnapshotVersion):b.min(),r=void 0!==e.query.documents?(y(1===(r=e.query).documents.length),Ca(ba(Jo(r.documents[0])))):Ca(ou(e.query));return new cu(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,vi.fromBase64String(e.resumeToken))}function wu(e,t){var n=mu(t.snapshotVersion),r=mu(t.lastLimboFreeSnapshotVersion),e=(ma(t.target)?iu:au)(e.ht,t.target),s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:fa(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:e}}function _u(e){var t=ou({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Da(t,t.limit,"L"):t}function bu(e,t){return new bo(t.largestBatchId,su(e.ht,t.overlayMutation))}function Iu(e,t){var n=t.path.lastSegment();return[e,Ls(t.path.popLast()),n]}function Eu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:mu(r.readTime),documentKey:Ls(r.documentKey.path),largestBatchId:r.largestBatchId}}class Tu{getBundleMetadata(e,t){return Su(e).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:pu(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return Su(e).put({bundleId:t.id,createTime:mu(F(t.createTime)),version:t.version})}getNamedQuery(e,t){return xu(e).get(t).next(e=>{if(e)return{name:e.name,query:_u(e.bundledQuery),readTime:pu(e.readTime)}})}saveNamedQuery(e,t){return xu(e).put({name:t.name,readTime:mu(F(t.readTime)),bundledQuery:t.bundledQuery})}}function Su(e){return ui(e,"bundles")}function xu(e){return ui(e,"namedQueries")}class Cu{constructor(e,t){this.serializer=e,this.userId=t}static Pt(e,t){t=t.uid||"";return new Cu(e,t)}getOverlay(e,t){return Au(e).get(Iu(this.userId,t)).next(e=>e?bu(this.serializer,e):null)}getOverlays(e,t){const n=qa();return C.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){const s=[];return e.forEach((e,t)=>{t=new bo(r,t);s.push(this.It(n,t))}),C.waitFor(s)}removeOverlaysForBatchId(t,e,n){const r=new Set,s=(e.forEach(e=>r.add(Ls(e.getCollectionPath()))),[]);return r.forEach(e=>{e=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);s.push(Au(t).J("collectionPathOverlayIndex",e))}),C.waitFor(s)}getOverlaysForCollection(e,t,n){const r=qa(),s=Ls(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Au(e).G("collectionPathOverlayIndex",i).next(e=>{for(const t of e){const e=bu(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,s){const i=qa();let a;n=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Au(e).Z({index:"collectionGroupOverlayIndex",range:n},(e,t,n)=>{const r=bu(this.serializer,t);i.size()<s||r.largestBatchId===a?(i.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>i)}It(e,t){return Au(e).put(function(e,t,n){var[,r,s]=Iu(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ru(e.ht,n.mutation)}}(this.serializer,this.userId,t))}}function Au(e){return ui(e,"documentOverlays")}class Du{constructor(){}dt(e,t){this.Tt(e,t),t.Et()}Tt(e,t){var n,r;"nullValue"in e?this.At(t,5):"booleanValue"in e?(this.At(t,10),t.Rt(e.booleanValue?1:0)):"integerValue"in e?(this.At(t,15),t.Rt(N(e.integerValue))):"doubleValue"in e?(n=N(e.doubleValue),isNaN(n)?this.At(t,13):(this.At(t,15),Ms(n)?t.Rt(0):t.Rt(n))):"timestampValue"in e?(r=e.timestampValue,this.At(t,20),"string"==typeof r?t.Vt(r):(t.Vt(""+(r.seconds||"")),t.Rt(r.nanos||0))):"stringValue"in e?(this.ft(e.stringValue,t),this.gt(t)):"bytesValue"in e?(this.At(t,30),t.yt(bi(e.bytesValue)),this.gt(t)):"referenceValue"in e?this.wt(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.At(t,45),t.Rt(r.latitude||0),t.Rt(r.longitude||0)):"mapValue"in e?ji(e)?this.At(t,Number.MAX_SAFE_INTEGER):(this.St(e.mapValue,t),this.gt(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.gt(t)):E()}ft(e,t){this.At(t,25),this.Dt(e,t)}Dt(e,t){t.Vt(e)}St(e,t){var n=e.fields||{};this.At(t,55);for(const e of Object.keys(n))this.ft(e,t),this.Tt(n[e],t)}bt(e,t){var n=e.values||[];this.At(t,50);for(const e of n)this.Tt(e,t)}wt(e,t){this.At(t,37),S.fromName(e).path.forEach(e=>{this.At(t,60),this.Dt(e,t)})}At(e,t){e.Rt(t)}gt(e){e.Rt(2)}}function Nu(e){e=64-function(t){let n=0;for(let e=0;e<8;++e){var r=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&t[e]);if(n+=r,8!==r)break}return n}(e);return Math.ceil(e/8)}Du.Ct=new Du;class ku{constructor(){this.buffer=new Uint8Array(1024),this.position=0}vt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ot(n.value),n=t.next();this.Nt()}Bt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{const e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Lt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ot(e);else if(e<2048)this.Ot(960|e>>>6),this.Ot(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ot(480|e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e);else{const e=t.codePointAt(0);this.Ot(240|e>>>18),this.Ot(128|63&e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e)}}this.Nt()}kt(t){var n=this.qt(t),t=Nu(n);this.Qt(1+t),this.buffer[this.position++]=255&t;for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=255&n[e]}Kt(t){var n=this.qt(t),t=Nu(n);this.Qt(1+t),this.buffer[this.position++]=~(255&t);for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=~(255&n[e])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Ft(e){e&=255;0==e?(this.Ut(0),this.Ut(255)):255==e?(this.Ut(255),this.Ut(0)):this.Ut(e)}Ot(e){var t=255&e;0==t?(this.Gt(0),this.Gt(255)):255==t?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(t){t+=this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class Ru{constructor(e){this.jt=e}yt(e){this.jt.vt(e)}Vt(e){this.jt.Bt(e)}Rt(e){this.jt.kt(e)}Et(){this.jt.$t()}}class Mu{constructor(e){this.jt=e}yt(e){this.jt.xt(e)}Vt(e){this.jt.Lt(e)}Rt(e){this.jt.Kt(e)}Et(){this.jt.Wt()}}class Ou{constructor(){this.jt=new ku,this.Ht=new Ru(this.jt),this.Jt=new Mu(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return 0===e?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}}class Lu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Zt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Lu(this.indexId,this.documentKey,this.arrayValue,n)}}function Fu(e,t){let n=e.indexId-t.indexId;return 0!==n||(0!==(n=Pu(e.arrayValue,t.arrayValue))||0!==(n=Pu(e.directionalValue,t.directionalValue)))?n:S.comparator(e.documentKey,t.documentKey)}function Pu(t,n){for(let e=0;e<t.length&&e<n.length;++e){var r=t[e]-n[e];if(0!=r)return r}return t.length-n.length}class Vu{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Xt=e.orderBy,this.en=[];for(const t of e.filters){const e=t;e.isInequality()?this.tn=e:this.en.push(e)}}nn(e){y(e.collectionGroup===this.collectionId);var t=hs(e);if(void 0!==t&&!this.rn(t))return!1;const n=ls(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.rn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s!==n.length){if(void 0!==this.tn){if(!r.has(this.tn.field.canonicalString())){const e=n[s];if(!this.sn(this.tn,e)||!this.on(this.Xt[i++],e))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.Xt.length||!this.on(this.Xt[i++],e))return!1}}return!0}_n(){let e=new D(f.comparator);const t=[];for(const n of this.en)n.field.isKeyField()||("array-contains"===n.op||"array-contains-any"===n.op?t.push(new cs(n.field,2)):e.has(n.field)||(e=e.add(n.field),t.push(new cs(n.field,0))));for(const r of this.Xt)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new cs(r.field,"asc"===r.dir?0:1)));return new us(us.UNKNOWN_ID,this.collectionId,t,ds.empty())}rn(e){for(const t of this.en)if(this.sn(t,e))return!0;return!1}sn(e,t){return!(void 0===e||!e.field.isEqual(t.fieldPath))&&(e="array-contains"===e.op||"array-contains-any"===e.op,2===t.kind==e)}on(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Bu(e){return e instanceof R}function Uu(e){return e instanceof M&&Zi(e)}function qu(e){return Bu(e)||Uu(e)||function(e){if(e instanceof M&&Ji(e)){for(const t of e.getFilters())if(!Bu(t)&&!Uu(t))return!1;return!0}return!1}(e)}function ju(e,t){var n,r;return y(e instanceof R||e instanceof M),y(t instanceof R||t instanceof M),Ku(e instanceof R?t instanceof R?(n=e,r=t,M.create([n,r],"and")):Gu(e,t):t instanceof R?Gu(t,e):function(e,t){if(y(0<e.filters.length&&0<t.filters.length),Xi(e)&&Xi(t))return ta(e,t.getFilters());const n=Ji(e)?e:t,r=Ji(e)?t:e,s=n.filters.map(e=>ju(e,r));return M.create(s,"or")}(e,t))}function Gu(t,e){return Xi(e)?ta(e,t.getFilters()):(e=e.filters.map(e=>ju(t,e)),M.create(e,"or"))}function Ku(t){if(y(t instanceof R||t instanceof M),t instanceof R)return t;const e=t.getFilters();if(1===e.length)return Ku(e[0]);if(ea(t))return t;const n=e.map(e=>Ku(e)),r=[];return n.forEach(e=>{e instanceof R?r.push(e):e instanceof M&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:M.create(r,t.op)}class zu{constructor(){this.an=new Qu}addToCollectionParentIndex(e,t){return this.an.add(t),C.resolve()}getCollectionParents(e,t){return C.resolve(this.an.getEntries(t))}addFieldIndex(e,t){return C.resolve()}deleteFieldIndex(e,t){return C.resolve()}deleteAllFieldIndexes(e){return C.resolve()}createTargetIndexes(e,t){return C.resolve()}getDocumentsMatchingTarget(e,t){return C.resolve(null)}getIndexType(e,t){return C.resolve(0)}getFieldIndexes(e,t){return C.resolve([])}getNextCollectionGroupToUpdate(e){return C.resolve(null)}getMinOffset(e,t){return C.resolve(ms.min())}getMinOffsetFromCollectionGroup(e,t){return C.resolve(ms.min())}updateCollectionGroup(e,t,n){return C.resolve()}updateIndexEntries(e,t){return C.resolve()}}class Qu{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new D(I.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new D(I.comparator)).toArray()}}const $u=new Uint8Array(0);class Hu{constructor(e,t){this.user=e,this.databaseId=t,this.un=new Qu,this.cn=new Fa(e=>fa(e),(e,t)=>ga(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){var n,r;return this.un.has(t)?C.resolve():(n=t.lastSegment(),r=t.popLast(),e.addOnCommittedListener(()=>{this.un.add(t)}),r={collectionId:n,parent:Ls(r)},Wu(e).put(r))}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[is(n),""],!1,!0);return Wu(e).G(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Ps(t.parent))}return r})}addFieldIndex(e,t){const n=Xu(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])},s=(delete r.indexId,n.add(r));if(t.indexState){const n=Ju(e);return s.next(e=>{n.put(Eu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=Xu(e),r=Ju(e),s=Yu(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=Xu(e),n=Yu(e),r=Ju(e);return t.J().next(()=>n.J()).next(()=>r.J())}createTargetIndexes(n,e){return C.forEach(this.ln(e),t=>this.getIndexType(n,t).next(e=>{if(0===e||1===e){const e=new Vu(t);return this.addFieldIndex(n,e._n())}}))}getDocumentsMatchingTarget(e,h){const l=Yu(e);let c=!0;const n=new Map;return C.forEach(this.ln(h),t=>this.hn(e,t).next(e=>{c=c&&!!e,n.set(t,e)})).next(()=>{if(c){let u=O();const c=[];return C.forEach(n,(e,t)=>{m("IndexedDbIndexManager",`Using index ${n=e,`id=${n.indexId}|cg=${n.collectionGroup}|f=`+n.fields.map(e=>e.fieldPath+":"+e.kind).join(",")} to execute `+fa(h));var n=function(e,t){var n=hs(t);if(void 0!==n)for(const t of pa(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){const n=new Map;for(const r of ls(t))for(const t of pa(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const s of ls(t)){const t=(0===s.kind?ya:va)(e,s.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Qi(n,r)}(t,e),i=function(e,t){const n=[];let r=!0;for(const s of ls(t)){const t=(0===s.kind?va:ya)(e,s.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Qi(n,r)}(t,e),a=this.Pn(e,t,s),o=this.Pn(e,t,i),r=this.In(e,t,r),r=this.dn(e.indexId,n,a,s.inclusive,o,i.inclusive,r);return C.forEach(r,e=>l.H(e,h.limit).next(e=>{e.forEach(e=>{e=S.fromSegments(e.documentKey);u.has(e)||(u=u.add(e),c.push(e))})}))}).next(()=>c)}return C.resolve(null)})}ln(t){var e;return this.cn.get(t)||(e=0===t.filters.length?[t]:function(e){if(0===e.getFilters().length)return[];const t=function t(e){if(y(e instanceof R||e instanceof M),e instanceof R)return e;if(1===e.filters.length)return t(e.filters[0]);var n=e.filters.map(e=>t(e));let r=M.create(n,e.op);return qu(r=Ku(r))?r:(y(r instanceof M),y(Xi(r)),y(1<r.filters.length),r.filters.reduce((e,t)=>ju(e,t)))}(function t(n){var e;if(y(n instanceof R||n instanceof M),n instanceof R){if(n instanceof ua){const r=(null==(e=null==(e=n.value.arrayValue)?void 0:e.values)?void 0:e.map(e=>R.create(n.field,"==",e)))||[];return M.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return M.create(r,n.op)}(e));return y(qu(t)),Bu(t)||Uu(t)?[t]:t.getFilters()}(M.create(t.filters,"and")).map(e=>da(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this.cn.set(t,e),e)}dn(t,n,r,s,i,a,o){const u=(null!=n?n.length:1)*Math.max(r.length,i.length),h=u/(null!=n?n.length:1),l=[];for(let e=0;e<u;++e){const u=n?this.Tn(n[e/h]):$u,c=this.En(t,u,r[e%h],s),d=this.An(t,u,i[e%h],a),f=o.map(e=>this.En(t,u,e,!0));l.push(...this.createRange(c,d,f))}return l}En(e,t,n,r){const s=new Lu(e,S.empty(),t,n);return r?s:s.Zt()}An(e,t,n,r){const s=new Lu(e,S.empty(),t,n);return r?s.Zt():s}hn(e,t){const r=new Vu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.nn(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.ln(t);return C.forEach(r,t=>this.hn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new D(f.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&1<r.length&&2===n?1:n)}Rn(e,t){const n=new Ou;for(const s of ls(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;var r=n.Yt(s.kind);Du.Ct.dt(e,r)}return n.zt()}Tn(e){const t=new Ou;return Du.Ct.dt(e,t.Yt(0)),t.zt()}Vn(e,t){const n=new Ou;return Du.Ct.dt(Li(this.databaseId,t),n.Yt(0===(t=ls(e)).length?0:t[t.length-1].kind)),n.zt()}In(e,t,n){if(null===n)return[];let r=[],s=(r.push(new Ou),0);for(const i of ls(e)){const e=n[s++];for(const n of r)if(this.mn(t,i.fieldPath)&&Pi(e))r=this.fn(r,i,e);else{const t=n.Yt(i.kind);Du.Ct.dt(e,t)}}return this.gn(r)}Pn(e,t,n){return this.In(e,t,n.position)}gn(t){const n=[];for(let e=0;e<t.length;++e)n[e]=t[e].zt();return n}fn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new Ou;r.seed(n.zt()),Du.Ct.dt(e,r.Yt(t.kind)),s.push(r)}return s}mn(e,t){return!!e.filters.find(e=>e instanceof R&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=Xu(e),i=Ju(e);return(t?n.G("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.G()).next(e=>{const s=[];return C.forEach(e,r=>i.get([r.indexId,this.uid]).next(e=>{var t,n;s.push((t=r,e=e?new ds(e.sequenceNumber,new ms(pu(e.readTime),new S(Ps(e.documentKey)),e.largestBatchId)):ds.empty(),n=t.fields.map(([e,t])=>new cs(f.fromServerFormat(e),t)),new us(t.indexId,t.collectionGroup,n,e)))})).next(()=>s)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:T(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const s=Xu(e),i=Ju(e);return this.pn(e).next(t=>s.G("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>C.forEach(e,e=>i.put(Eu(e.indexId,this.user,t,r)))))}updateIndexEntries(s,e){const n=new Map;return C.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?C.resolve(e):this.getFieldIndexes(s,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),C.forEach(e,n=>this.yn(s,t,n).next(e=>{var t=this.wn(r,n);return e.isEqual(t)?C.resolve():this.Sn(s,r,n,e,t)}))))})}bn(e,t,n,r){return Yu(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.Vn(n,t.key),documentKey:t.key.path.toArray()})}Dn(e,t,n,r){return Yu(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.Vn(n,t.key),t.key.path.toArray()])}yn(e,n,r){const t=Yu(e);let s=new D(Fu);return t.Z({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.Vn(r,n)])},(e,t)=>{s=s.add(new Lu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>s)}wn(e,t){let n=new D(Fu);var r=this.Rn(t,e);if(null!=r){const i=hs(t);if(null!=i){var s=e.data.field(i.fieldPath);if(Pi(s))for(const i of s.arrayValue.values||[])n=n.add(new Lu(t.indexId,e.key,this.Tn(i),r))}else n=n.add(new Lu(t.indexId,e.key,$u,r))}return n}Sn(t,s,i,e,a){m("IndexedDbIndexManager","Updating index entries for document '%s'",s.key);const o=[];{var u=Fu,h=e=>{o.push(this.bn(t,s,i,e))},l=e=>{o.push(this.Dn(t,s,i,e))},c=e.getIterator(),d=a.getIterator();let n=mi(c),r=mi(d);for(;n||r;){let e=!1,t=!1;if(n&&r){const h=u(n,r);h<0?t=!0:0<h&&(e=!0)}else null!=n?t=!0:e=!0;e?(h(r),r=mi(d)):t?(l(n),n=mi(c)):(n=mi(c),r=mi(d))}}return C.waitFor(o)}pn(e){let r=1;return Ju(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>Fu(e,t)).filter((e,t,n)=>!t||0!==Fu(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=Fu(s,e),i=Fu(s,t);if(0===n)r[0]=e.Zt();else if(0<n&&i<0)r.push(s),r.push(s.Zt());else if(0<i)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2){if(this.Cn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,$u,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,$u,[]];s.push(IDBKeyRange.bound(t,n))}return s}Cn(e,t){return 0<Fu(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Zu)}getMinOffset(t,e){return C.mapArray(this.ln(e),e=>this.hn(t,e).next(e=>e||E())).next(Zu)}}function Wu(e){return ui(e,"collectionParents")}function Yu(e){return ui(e,"indexEntries")}function Xu(e){return ui(e,"indexConfiguration")}function Ju(e){return ui(e,"indexState")}function Zu(t){y(0!==t.length);let n=t[0].indexState.offset,r=n.largestBatchId;for(let e=1;e<t.length;e++){var s=t[e].indexState.offset;ps(s,n)<0&&(n=s),r<s.largestBatchId&&(r=s.largestBatchId)}return new ms(n.readTime,n.documentKey,r)}const eh={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class th{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new th(e,th.DEFAULT_COLLECTION_PERCENTILE,th.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function nh(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.Z({range:a},(e,t,n)=>(o++,n.delete())),h=(i.push(u.next(()=>{y(1===o)})),[]);for(const e of n.mutations){const r=Us(t,e.key.path,n.batchId);i.push(s.delete(r)),h.push(e.key)}return C.waitFor(i).next(()=>h)}function rh(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw E();t=e.noDocument}return JSON.stringify(t).length}th.DEFAULT_COLLECTION_PERCENTILE=10,th.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,th.DEFAULT=new th(41943040,th.DEFAULT_COLLECTION_PERCENTILE,th.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),th.DISABLED=new th(-1,0,0);class sh{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.vn={}}static Pt(e,t,n,r){y(""!==e.uid);e=e.isAuthenticated()?e.uid:"";return new sh(e,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ah(e).Z({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(l,c,d,f){const g=oh(l),m=ah(l);return m.add({}).next(e=>{y("number"==typeof e);const t=new wo(e,c,d,f),n=(s=this.serializer,i=this.userId,o=(a=t).baseMutations.map(e=>ru(s.ht,e)),u=a.mutations.map(e=>ru(s.ht,e)),{userId:i,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var s,i,a,o,u;let h=new D((e,t)=>T(e.canonicalString(),t.canonicalString()));for(const l of f){const c=Us(this.userId,l.key.path,e);h=h.add(l.key.path.popLast()),r.push(m.put(n)),r.push(g.put(c,qs))}return h.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(l,e))}),l.addOnCommittedListener(()=>{this.vn[e]=t.keys()}),C.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return ah(e).get(t).next(e=>e?(y(e.userId===this.userId),yu(this.serializer,e)):null)}Fn(e,t){return this.vn[t]?C.resolve(this.vn[t]):this.lookupMutationBatch(e,t).next(e=>{return e?(e=e.keys(),this.vn[t]=e):null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return ah(e).Z({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(y(t.batchId>=r),s=yu(this.serializer,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return ah(e).Z({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ah(e).G("userMutationsIndex",t).next(e=>e.map(e=>yu(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(i,a){const e=Bs(this.userId,a.path),t=IDBKeyRange.lowerBound(e),o=[];return oh(i).Z({range:t},(e,t,n)=>{var[e,r,s]=e,r=Ps(r);if(e===this.userId&&a.path.isEqual(r))return ah(i).get(s).next(e=>{if(!e)throw E();y(e.userId===this.userId),o.push(yu(this.serializer,e))});n.done()}).next(()=>o)}getAllMutationBatchesAffectingDocumentKeys(t,e){let a=new D(T);const n=[];return e.forEach(i=>{var e=Bs(this.userId,i.path),e=IDBKeyRange.lowerBound(e),e=oh(t).Z({range:e},(e,t,n)=>{var[e,r,s]=e,r=Ps(r);e===this.userId&&i.path.isEqual(r)?a=a.add(s):n.done()});n.push(e)}),C.waitFor(n).next(()=>this.Mn(t,a))}getAllMutationBatchesAffectingQuery(e,t){const i=t.path,a=i.length+1,n=Bs(this.userId,i),r=IDBKeyRange.lowerBound(n);let o=new D(T);return oh(e).Z({range:r},(e,t,n)=>{var[e,r,s]=e,r=Ps(r);e===this.userId&&i.isPrefixOf(r)?r.length===a&&(o=o.add(s)):n.done()}).next(()=>this.Mn(e,o))}Mn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(ah(t).get(e).next(e=>{if(null===e)throw E();y(e.userId===this.userId),n.push(yu(this.serializer,e))}))}),C.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return nh(t.ue,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.xn(n.batchId)}),C.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}xn(e){delete this.vn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return C.resolve();const t=IDBKeyRange.lowerBound([this.userId]),r=[];return oh(n).Z({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Ps(e[1]);r.push(t)}else n.done()}).next(()=>{y(0===r.length)})})}containsKey(e,t){return ih(e,this.userId,t)}On(e){return uh(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function ih(e,s,t){const n=Bs(s,t.path),i=n[1],r=IDBKeyRange.lowerBound(n);let a=!1;return oh(e).Z({range:r,Y:!0},(e,t,n)=>{var[e,r]=e;e===s&&r===i&&(a=!0),n.done()}).next(()=>a)}function ah(e){return ui(e,"mutations")}function oh(e){return ui(e,"documentMutations")}function uh(e){return ui(e,"mutationQueues")}class hh{constructor(e){this.Nn=e}next(){return this.Nn+=2,this.Nn}static Bn(){return new hh(0)}static Ln(){return new hh(-1)}}class lh{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(n){return this.kn(n).next(e=>{const t=new hh(e.highestTargetId);return e.highestTargetId=t.next(),this.qn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.kn(e).next(e=>b.fromTimestamp(new l(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.kn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.kn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.qn(t,e)))}addTargetData(t,n){return this.Qn(t,n).next(()=>this.kn(t).next(e=>(e.targetCount+=1,this.Kn(n,e),this.qn(t,e))))}updateTargetData(e,t){return this.Qn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>ch(t).delete(e.targetId)).next(()=>this.kn(t)).next(e=>(y(0<e.targetCount),--e.targetCount,this.qn(t,e)))}removeTargets(n,r,s){let i=0;const a=[];return ch(n).Z((e,t)=>{t=vu(t);t.sequenceNumber<=r&&null===s.get(t.targetId)&&(i++,a.push(this.removeTargetData(n,t)))}).next(()=>C.waitFor(a)).next(()=>i)}forEachTarget(e,n){return ch(e).Z((e,t)=>{t=vu(t);n(t)})}kn(e){return dh(e).get("targetGlobalKey").next(e=>(y(null!==e),e))}qn(e,t){return dh(e).put("targetGlobalKey",t)}Qn(e,t){return ch(e).put(wu(this.serializer,t))}Kn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.kn(e).next(e=>e.targetCount)}getTargetData(e,r){var t=fa(r),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let s=null;return ch(e).Z({range:t,index:"queryTargetsIndex"},(e,t,n)=>{t=vu(t);ga(r,t.target)&&(s=t,n.done())}).next(()=>s)}addMatchingKeys(n,e,r){const s=[],i=fh(n);return e.forEach(e=>{var t=Ls(e.path);s.push(i.put({targetId:r,path:t})),s.push(this.referenceDelegate.addReference(n,r,e))}),C.waitFor(s)}removeMatchingKeys(n,e,r){const s=fh(n);return C.forEach(e,e=>{var t=Ls(e.path);return C.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=fh(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=fh(e);let s=O();return r.Z({range:n,Y:!0},(e,t,n)=>{e=Ps(e[1]),e=new S(e);s=s.add(e)}).next(()=>s)}containsKey(e,t){t=Ls(t.path),t=IDBKeyRange.bound([t],[is(t)],!1,!0);let r=0;return fh(e).Z({index:"documentTargetsIndex",Y:!0,range:t},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}lt(e,t){return ch(e).get(t).next(e=>e?vu(e):null)}}function ch(e){return ui(e,"targets")}function dh(e){return ui(e,"targetGlobal")}function fh(e){return ui(e,"targetDocuments")}function gh([e,t],[n,r]){e=T(e,n);return 0===e?T(t,r):e}class mh{constructor(e){this.$n=e,this.buffer=new D(gh),this.Un=0}Wn(){return++this.Un}Gn(e){var t=[e,this.Wn()];if(this.buffer.size<this.$n)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();gh(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class ph{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.zn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.jn(6e4)}stop(){this.zn&&(this.zn.cancel(),this.zn=null)}get started(){return null!==this.zn}jn(e){m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.zn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.zn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Ts(e)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await ws(e)}await this.jn(3e5)})}}class yh{constructor(e,t){this.Hn=e,this.params=t}calculateTargetCount(e,t){return this.Hn.Jn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return C.resolve(ks.ae);const n=new mh(t);return this.Hn.forEachTarget(e,e=>n.Gn(e.sequenceNumber)).next(()=>this.Hn.Yn(e,e=>n.Gn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Hn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Hn.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),C.resolve(eh)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold `+this.params.cacheSizeCollectionThreshold),eh):this.Zn(t,n))}getCacheSize(e){return this.Hn.getCacheSize(e)}Zn(t,n){let r,s,i,a,o,u,h;const l=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from `+e),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(h=Date.now(),zr()<=c.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-l}ms
	Determined least recently used ${s} in `+(o-a)+"ms\n"+`	Removed ${i} targets in `+(u-o)+"ms\n"+`	Removed ${e} documents in `+(h-u)+"ms\n"+`Total Duration: ${h-l}ms`),C.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class vh{constructor(e,t){this.db=e,this.garbageCollector=(e=this,new yh(e,t))}Jn(e){const n=this.Xn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Xn(e){let t=0;return this.Yn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Yn(e,n){return this.er(e,(e,t)=>n(t))}addReference(e,t,n){return wh(e,n)}removeReference(e,t,n){return wh(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return wh(e,t)}tr(t,n){let r=!1;return uh(t).X(e=>ih(t,e,n).next(e=>(e&&(r=!0),C.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let a=0;return this.er(n,(t,e)=>{if(e<=r){const r=this.tr(n,t).next(e=>{if(!e)return a++,s.getEntry(n,t).next(()=>(s.removeEntry(t,b.min()),fh(n).delete([0,Ls(t.path)])))});i.push(r)}}).next(()=>C.waitFor(i)).next(()=>s.apply(n)).next(()=>a)}removeTarget(e,t){t=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,t)}updateLimboDocument(e,t){return wh(e,t)}er(e,r){const t=fh(e);let s,i=ks.ae;return t.Z({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==ks.ae&&r(new S(Ps(s)),i),i=n,s=t):i=ks.ae}).next(()=>{i!==ks.ae&&r(new S(Ps(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function wh(e,t){return fh(e).put((e=e.currentSequenceNumber,{targetId:0,path:Ls(t.path),sequenceNumber:e}))}class _h{constructor(){this.changes=new Fa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,k.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?C.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class bh{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Sh(e).put(n)}removeEntry(e,n,t){return Sh(e).delete(function(e){const t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],gu(e),t[t.length-1]]}(t))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.nr(t,e)))}getEntry(e,n){let r=k.newInvalidDocument(n);return Sh(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(xh(n))},(e,t)=>{r=this.rr(n,t)}).next(()=>r)}ir(e,n){let r={size:0,document:k.newInvalidDocument(n)};return Sh(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(xh(n))},(e,t)=>{r={document:this.rr(n,t),size:rh(t)}}).next(()=>r)}getEntries(e,t){let n=Pa;return this.sr(e,t,(e,t)=>{t=this.rr(e,t);n=n.insert(e,t)}).next(()=>n)}_r(e,t){let r=Pa,s=new A(S.comparator);return this.sr(e,t,(e,t)=>{var n=this.rr(e,t);r=r.insert(e,n),s=s.insert(e,rh(t))}).next(()=>({documents:r,ar:s}))}sr(e,t,s){if(t.isEmpty())return C.resolve();let n=new D(Ah);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(xh(n.first()),xh(n.last())),i=n.getIterator();let a=i.getNext();return Sh(e).Z({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=S.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&Ah(a,r)<0;)s(a,null),a=i.getNext();a&&a.isEqual(r)&&(s(a,t),a=i.hasNext()?i.getNext():null),a?n.W(xh(a)):n.done()}).next(()=>{for(;a;)s(a,null),a=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(e,n,t,r,s){const i=n.path,a=[i.popLast().toArray(),i.lastSegment(),gu(t.readTime),t.documentKey.path.isEmpty()?"":t.documentKey.path.lastSegment()],o=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Sh(e).G(IDBKeyRange.bound(a,o,!0)).next(e=>{null!=s&&s.incrementDocumentReadCount(e.length);let t=Pa;for(const s of e){const e=this.rr(S.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(Ma(n,e)||r.has(e.key))&&(t=t.insert(e.key,e))}return t})}getAllFromCollectionGroup(e,t,n,r){let s=Pa;n=Ch(t,n),t=Ch(t,ms.max());return Sh(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(n,t,!0)},(e,t,n)=>{t=this.rr(S.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(s=s.insert(t.key,t)).size===r&&n.done()}).next(()=>s)}newChangeBuffer(e){return new Eh(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Th(e).get("remoteDocumentGlobalKey").next(e=>(y(!!e),e))}nr(e,t){return Th(e).put("remoteDocumentGlobalKey",t)}rr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=nu(e.ht,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=S.fromSegments(t.noDocument.path),r=pu(t.noDocument.readTime);n=k.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return E();{const e=S.fromSegments(t.unknownDocument.path),s=pu(t.unknownDocument.version);n=k.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime((t=t.readTime,e=new l(t[0],t[1]),b.fromTimestamp(e))),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(b.min()))return e}return k.newInvalidDocument(e)}}function Ih(e){return new bh(e)}class Eh extends _h{constructor(e,t){super(),this.ur=e,this.trackRemovals=t,this.cr=new Fa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const a=[];let o=0,u=new D((e,t)=>T(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.cr.get(e);if(a.push(this.ur.removeEntry(i,e,n.readTime)),t.isValidDocument()){var r=fu(this.ur.serializer,t),s=(u=u.add(e.path.popLast()),rh(r));o+=s-n.size,a.push(this.ur.addEntry(i,e,r))}else if(o-=n.size,this.trackRemovals){const o=fu(this.ur.serializer,t.convertToNoDocument(b.min()));a.push(this.ur.addEntry(i,e,o))}}),u.forEach(e=>{a.push(this.ur.indexManager.addToCollectionParentIndex(i,e))}),a.push(this.ur.updateMetadata(i,o)),C.waitFor(a)}getFromCache(e,t){return this.ur.ir(e,t).next(e=>(this.cr.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.ur._r(e,t).next(({documents:n,ar:e})=>(e.forEach((e,t)=>{this.cr.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Th(e){return ui(e,"remoteDocumentGlobal")}function Sh(e){return ui(e,"remoteDocumentsV14")}function xh(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Ch(e,t){const n=t.documentKey.path.toArray();return[e,gu(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Ah(e,t){var n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=T(n[e],r[e]))return s;return(s=T(n.length,r.length))||((s=T(n[n.length-2],r[r.length-2]))||T(n[n.length-1],r[r.length-1]))}class Dh{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Nh{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&ho(r.mutation,e,pi.empty(),l.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,O()).next(()=>e))}getLocalViewOfDocuments(e,t,n=O()){const r=qa();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=Ba();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=qa();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,O()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,s){let i=Pa;const a=qa(),n=qa();return t.forEach((e,t)=>{const n=r.get(t.key);s.has(t.key)&&(void 0===n||n.mutation instanceof fo)?i=i.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),ho(n.mutation,t,n.mutation.getFieldMask(),l.now())):a.set(t.key,pi.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{return n.set(e,new Dh(t,null!=(t=a.get(e))?t:null))}),n))}recalculateAndSaveOverlays(i,a){const o=qa();let u=new A((e,t)=>e-t),h=O();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(i,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||pi.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||O()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,s=qa();r.forEach(e=>{var t;h.has(e)||(null!==(t=uo(a.get(e),o.get(e)))&&s.set(e,t),h=h.add(e))}),e.push(this.documentOverlayCache.saveOverlays(i,n,s))}return C.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n,r){return s=t,S.isDocumentKey(s.path)&&null===s.collectionGroup&&0===s.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Sa(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r);var s}getNextDocuments(i,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(i,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(i,t,a.largestBatchId,o-n.size):C.resolve(qa());let r=-1,s=n;return e.next(e=>C.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?C.resolve():this.remoteDocumentCache.getEntry(i,t).next(e=>{s=s.insert(t,e)}))).next(()=>this.populateOverlays(i,e,n)).next(()=>this.computeViews(i,s,e,O())).next(e=>({batchId:r,changes:Ua(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new S(t)).next(e=>{let t=Ba();return t=e.isFoundDocument()?t.insert(e.key,e):t})}getDocumentsMatchingCollectionGroupQuery(n,r,s,i){const a=r.collectionGroup;let o=Ba();return this.indexManager.getCollectionParents(n,a).next(e=>C.forEach(e,e=>{t=r,e=e.child(a);var t,e=new wa(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(n,e,s,i).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,s,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(t,s.path,n.largestBatchId).next(e=>(i=e,this.remoteDocumentCache.getDocumentsMatchingQuery(t,s,n,i,r))).next(n=>{i.forEach((e,t)=>{t=t.getKey();null===n.get(t)&&(n=n.insert(t,k.newInvalidDocument(t)))});let r=Ba();return n.forEach((e,t)=>{var n=i.get(e);void 0!==n&&ho(n.mutation,t,pi.empty(),l.now()),Ma(s,t)&&(r=r.insert(e,t))}),r})}}class kh{constructor(e){this.serializer=e,this.lr=new Map,this.hr=new Map}getBundleMetadata(e,t){return C.resolve(this.lr.get(t))}saveBundleMetadata(e,t){return this.lr.set(t.id,{id:t.id,version:t.version,createTime:F(t.createTime)}),C.resolve()}getNamedQuery(e,t){return C.resolve(this.hr.get(t))}saveNamedQuery(e,t){return this.hr.set(t.name,{name:t.name,query:_u(t.bundledQuery),readTime:F(t.readTime)}),C.resolve()}}class Rh{constructor(){this.overlays=new A(S.comparator),this.Pr=new Map}getOverlay(e,t){return C.resolve(this.overlays.get(t))}getOverlays(e,t){const n=qa();return C.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.It(n,r,t)}),C.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.Pr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Pr.delete(n)),C.resolve()}getOverlaysForCollection(e,t,n){const r=qa(),s=t.length+1,i=new S(t.child("")),a=this.overlays.getIteratorFrom(i);for(;a.hasNext();){const e=a.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return C.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new A((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=qa(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=qa(),o=s.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return C.resolve(a)}It(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.Pr.get(r.largestBatchId).delete(n.key);this.Pr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new bo(t,n));let s=this.Pr.get(t);void 0===s&&(s=O(),this.Pr.set(t,s)),this.Pr.set(t,s.add(n.key))}}class Mh{constructor(){this.Ir=new D(Oh.dr),this.Tr=new D(Oh.Er)}isEmpty(){return this.Ir.isEmpty()}addReference(e,t){e=new Oh(e,t);this.Ir=this.Ir.add(e),this.Tr=this.Tr.add(e)}Ar(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Rr(new Oh(e,t))}Vr(e,t){e.forEach(e=>this.removeReference(e,t))}mr(e){const t=new S(new I([])),n=new Oh(t,e),r=new Oh(t,e+1),s=[];return this.Tr.forEachInRange([n,r],e=>{this.Rr(e),s.push(e.key)}),s}gr(){this.Ir.forEach(e=>this.Rr(e))}Rr(e){this.Ir=this.Ir.delete(e),this.Tr=this.Tr.delete(e)}pr(e){var t=new S(new I([])),n=new Oh(t,e),t=new Oh(t,e+1);let r=O();return this.Tr.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Oh(e,0);return null!==(t=this.Ir.firstAfterOrEqual(t))&&e.isEqual(t.key)}}class Oh{constructor(e,t){this.key=e,this.yr=t}static dr(e,t){return S.comparator(e.key,t.key)||T(e.yr,t.yr)}static Er(e,t){return T(e.yr,t.yr)||S.comparator(e.key,t.key)}}class Lh{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.wr=1,this.Sr=new D(Oh.dr)}checkEmpty(e){return C.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var s=this.wr,t=(this.wr++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1],new wo(s,t,n,r));this.mutationQueue.push(t);for(const t of r)this.Sr=this.Sr.add(new Oh(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return C.resolve(t)}lookupMutationBatch(e,t){return C.resolve(this.br(t))}getNextMutationBatchAfterBatchId(e,t){t=(t=this.Dr(t+1))<0?0:t;return C.resolve(this.mutationQueue.length>t?this.mutationQueue[t]:null)}getHighestUnacknowledgedBatchId(){return C.resolve(0===this.mutationQueue.length?-1:this.wr-1)}getAllMutationBatches(e){return C.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Oh(t,0),r=new Oh(t,Number.POSITIVE_INFINITY),s=[];return this.Sr.forEachInRange([n,r],e=>{e=this.br(e.yr);s.push(e)}),C.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new D(T);return t.forEach(e=>{var t=new Oh(e,0),e=new Oh(e,Number.POSITIVE_INFINITY);this.Sr.forEachInRange([t,e],e=>{n=n.add(e.yr)})}),C.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;S.isDocumentKey(s)||(s=s.child(""));t=new Oh(new S(s),0);let i=new D(T);return this.Sr.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(i=i.add(e.yr)),!0)},t),C.resolve(this.Cr(i))}Cr(e){const t=[];return e.forEach(e=>{e=this.br(e);null!==e&&t.push(e)}),t}removeMutationBatch(n,r){y(0===this.vr(r.batchId,"removed")),this.mutationQueue.shift();let s=this.Sr;return C.forEach(r.mutations,e=>{var t=new Oh(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.Sr=s})}xn(e){}containsKey(e,t){var n=new Oh(t,0),n=this.Sr.firstAfterOrEqual(n);return C.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,C.resolve()}vr(e,t){return this.Dr(e)}Dr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}br(e){e=this.Dr(e);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class Fh{constructor(e){this.Fr=e,this.docs=new A(S.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Fr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return C.resolve(n?n.document.mutableCopy():k.newInvalidDocument(t))}getEntries(e,t){let n=Pa;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():k.newInvalidDocument(e))}),C.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=Pa;const i=t.path,a=new S(i.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||ps(gs(a),n)<=0||(r.has(a.key)||Ma(t,a))&&(s=s.insert(a.key,a.mutableCopy()))}return C.resolve(s)}getAllFromCollectionGroup(e,t,n,r){E()}Mr(e,t){return C.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Ph(this)}getSize(e){return C.resolve(this.size)}}class Ph extends _h{constructor(e){super(),this.ur=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.ur.addEntry(n,t)):this.ur.removeEntry(e)}),C.waitFor(r)}getFromCache(e,t){return this.ur.getEntry(e,t)}getAllFromCache(e,t){return this.ur.getEntries(e,t)}}class Vh{constructor(e){this.persistence=e,this.Or=new Fa(e=>fa(e),ga),this.lastRemoteSnapshotVersion=b.min(),this.highestTargetId=0,this.Nr=0,this.Br=new Mh,this.targetCount=0,this.Lr=hh.Bn()}forEachTarget(e,n){return this.Or.forEach((e,t)=>n(t)),C.resolve()}getLastRemoteSnapshotVersion(e){return C.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return C.resolve(this.Nr)}allocateTargetId(e){return this.highestTargetId=this.Lr.next(),C.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Nr&&(this.Nr=t),C.resolve()}Qn(e){this.Or.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Lr=new hh(t),this.highestTargetId=t),e.sequenceNumber>this.Nr&&(this.Nr=e.sequenceNumber)}addTargetData(e,t){return this.Qn(t),this.targetCount+=1,C.resolve()}updateTargetData(e,t){return this.Qn(t),C.resolve()}removeTargetData(e,t){return this.Or.delete(t.target),this.Br.mr(t.targetId),--this.targetCount,C.resolve()}removeTargets(n,r,s){let i=0;const a=[];return this.Or.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.Or.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),C.waitFor(a).next(()=>i)}getTargetCount(e){return C.resolve(this.targetCount)}getTargetData(e,t){t=this.Or.get(t)||null;return C.resolve(t)}addMatchingKeys(e,t,n){return this.Br.Ar(t,n),C.resolve()}removeMatchingKeys(t,e,n){this.Br.Vr(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),C.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Br.mr(t),C.resolve()}getMatchingKeysForTargetId(e,t){t=this.Br.pr(t);return C.resolve(t)}containsKey(e,t){return C.resolve(this.Br.containsKey(t))}}class Bh{constructor(e,t){this.kr={},this.overlays={},this.qr=new ks(0),this.Qr=!1,this.Qr=!0,this.referenceDelegate=e(this),this.Kr=new Vh(this),this.indexManager=new zu,this.remoteDocumentCache=(e=e=>this.referenceDelegate.$r(e),new Fh(e)),this.serializer=new du(t),this.Ur=new kh(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Qr=!1,Promise.resolve()}get started(){return this.Qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Rh,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.kr[e.toKey()];return n||(n=new Lh(t,this.referenceDelegate),this.kr[e.toKey()]=n),n}getTargetCache(){return this.Kr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ur}runTransaction(e,t,n){m("MemoryPersistence","Starting transaction:",e);const r=new Uh(this.qr.next());return this.referenceDelegate.Wr(),n(r).next(e=>this.referenceDelegate.Gr(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}zr(t,n){return C.or(Object.values(this.kr).map(e=>()=>e.containsKey(t,n)))}}class Uh extends vs{constructor(e){super(),this.currentSequenceNumber=e}}class qh{constructor(e){this.persistence=e,this.jr=new Mh,this.Hr=null}static Jr(e){return new qh(e)}get Yr(){if(this.Hr)return this.Hr;throw E()}addReference(e,t,n){return this.jr.addReference(n,t),this.Yr.delete(n.toString()),C.resolve()}removeReference(e,t,n){return this.jr.removeReference(n,t),this.Yr.add(n.toString()),C.resolve()}markPotentiallyOrphaned(e,t){return this.Yr.add(t.toString()),C.resolve()}removeTarget(e,t){this.jr.mr(t.targetId).forEach(e=>this.Yr.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Yr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Wr(){this.Hr=new Set}Gr(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return C.forEach(this.Yr,e=>{const t=S.fromPath(e);return this.Zr(n,t).next(e=>{e||r.removeEntry(t,b.min())})}).next(()=>(this.Hr=null,r.apply(n)))}updateLimboDocument(e,t){return this.Zr(e,t).next(e=>{e?this.Yr.delete(t.toString()):this.Yr.add(t.toString())})}$r(e){return 0}Zr(e,t){return C.or([()=>C.resolve(this.jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.zr(e,t)])}}class jh{constructor(e){this.serializer=e}B(t,e,n,r){const i=new _s("createOrUpgrade",e);var s;n<1&&1<=r&&(t.createObjectStore("owner"),(s=t).createObjectStore("mutationQueues",{keyPath:"userId"}),s.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vs,{unique:!0}),s.createObjectStore("documentMutations"),Gh(t),t.createObjectStore("remoteDocuments"));let a=C.resolve();return n<3&&3<=r&&(0!==n&&((s=t).deleteObjectStore("targetDocuments"),s.deleteObjectStore("targets"),s.deleteObjectStore("targetGlobal"),Gh(t)),a=a.next(()=>{{const e=i.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:b.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",t)}})),n<4&&4<=r&&(a=(a=0!==n?a.next(()=>{var r=t,s=i;return s.store("mutations").G().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vs,{unique:!0});const t=s.store("mutations"),n=e.map(e=>t.put(e));return C.waitFor(n)})}):a).next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.ei(i))),n<6&&6<=r&&(a=a.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.ti(i)))),n<7&&7<=r&&(a=a.next(()=>this.ni(i))),n<8&&8<=r&&(a=a.next(()=>this.ri(t,i))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.ii(i))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{{const e=t.createObjectStore("documentOverlays",{keyPath:Zs});e.createIndex("collectionPathOverlayIndex",ei,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",ti,{unique:!1})}})),n<13&&13<=r&&(a=a.next(()=>{{const e=t.createObjectStore("remoteDocumentsV14",{keyPath:js});e.createIndex("documentKeyIndex",Gs),e.createIndex("collectionGroupIndex",Ks)}}).next(()=>this.si(t,i)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.oi(t,i))),a=n<15&&15<=r?a.next(()=>{var e=t;e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Ws}).createIndex("sequenceNumberIndex",Ys,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Xs}).createIndex("documentKeyIndex",Js,{unique:!1})}):a}ti(t){let n=0;return t.store("remoteDocuments").Z((e,t)=>{n+=rh(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}ei(n){const e=n.store("mutationQueues"),r=n.store("mutations");return e.G().next(e=>C.forEach(e,t=>{var e=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return r.G("userMutationsIndex",e).next(e=>C.forEach(e,e=>{y(e.userId===t.userId);e=yu(this.serializer,e);return nh(n,t.userId,e).next(()=>{})}))}))}ni(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(s=>{const i=[];return t.Z((e,t)=>{const n=new I(e),r=[0,Ls(n)];i.push(a.get(r).next(e=>e?C.resolve():(e=>a.put({targetId:0,path:Ls(e),sequenceNumber:s.highestListenSequenceNumber}))(n)))}).next(()=>C.waitFor(i))})}ri(e,t){e.createObjectStore("collectionParents",{keyPath:Hs});const n=t.store("collectionParents"),r=new Qu,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Ls(r)})}};return t.store("remoteDocuments").Z({Y:!0},(e,t)=>{const n=new I(e);return s(n.popLast())}).next(()=>t.store("documentMutations").Z({Y:!0},([,e],t)=>{const n=Ps(e);return s(n.popLast())}))}ii(e){const n=e.store("targets");return n.Z((e,t)=>{t=vu(t),t=wu(this.serializer,t);return n.put(t)})}si(e,a){const t=a.store("remoteDocuments"),o=[];return t.Z((e,t)=>{const n=a.store("remoteDocumentsV14"),r=((i=t).document?new S(I.fromString(i.document.name).popFirst(5)):i.noDocument?S.fromSegments(i.noDocument.path):i.unknownDocument?S.fromSegments(i.unknownDocument.path):E()).path.toArray(),s={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};var i;o.push(n.put(s))}).next(()=>C.waitFor(o))}oi(e,s){const t=s.store("mutations"),i=Ih(this.serializer),a=new Bh(qh.Jr,this.serializer.ht);return t.G().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!=(t=r.get(e.userId))?t:O();yu(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),C.forEach(r,(e,t)=>{var t=new o(t),n=Cu.Pt(this.serializer,t),r=a.getIndexManager(t),t=sh.Pt(t,this.serializer,r,a.referenceDelegate);return new Nh(i,t,n,r).recalculateAndSaveOverlaysForDocumentKeys(new oi(s,ks.ae),e).next()})})}}function Gh(e){e.createObjectStore("targetDocuments",{keyPath:Qs}).createIndex("documentTargetsIndex",$s,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",zs,{unique:!0}),e.createObjectStore("targetGlobal")}const Kh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class zh{constructor(e,t,n,r,s,i,a,o,u,h,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this._i=s,this.window=i,this.document=a,this.ai=u,this.ui=h,this.ci=l,this.qr=null,this.Qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.li=null,this.inForeground=!1,this.hi=null,this.Pi=null,this.Ii=Number.NEGATIVE_INFINITY,this.di=e=>Promise.resolve(),!zh.C())throw new _(w.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new vh(this,r),this.Ti=t+"main",this.serializer=new du(o),this.Ei=new bs(this.Ti,this.ci,new jh(this.serializer)),this.Kr=new lh(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Ih(this.serializer),this.Ur=new Tu,this.window&&this.window.localStorage?this.Ai=this.window.localStorage:(this.Ai=null,!1===h&&d("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ri().then(()=>{if(this.isPrimary||this.allowTabSynchronization)return this.Vi(),this.mi(),this.fi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Kr.getHighestSequenceNumber(e));throw new _(w.FAILED_PRECONDITION,Kh)}).then(e=>{this.qr=new ks(e,this.ai)}).then(()=>{this.Qr=!0}).catch(e=>(this.Ei&&this.Ei.close(),Promise.reject(e)))}gi(t){return this.di=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ei.k(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this._i.enqueueAndForget(async()=>{this.started&&await this.Ri()}))}Ri(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>$h(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.pi(t).next(e=>{e||(this.isPrimary=!1,this._i.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.yi(t)).next(e=>this.isPrimary&&!e?this.wi(t).next(()=>!1):!!e&&this.Si(t).next(()=>!0))).catch(e=>{if(Ts(e))return m("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(this.allowTabSynchronization)return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1;throw e}).then(e=>{this.isPrimary!==e&&this._i.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}pi(e){return Qh(e).get("owner").next(e=>C.resolve(this.bi(e)))}Di(e){return $h(e).delete(this.clientId)}async Ci(){if(this.isPrimary&&!this.vi(this.Ii,18e5)){this.Ii=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=ui(e,"clientMetadata");return r.G().next(e=>{const t=this.Fi(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return C.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ai)for(const t of e)this.Ai.removeItem(this.Mi(t.clientId))}}fi(){this.Pi=this._i.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Ri().then(()=>this.Ci()).then(()=>this.fi()))}bi(e){return!!e&&e.ownerId===this.clientId}yi(t){return this.ui?C.resolve(!0):Qh(t).get("owner").next(e=>{if(null!==e&&this.vi(e.leaseTimestampMs,5e3)&&!this.xi(e.ownerId)){if(this.bi(e)&&this.networkEnabled)return!0;if(!this.bi(e)){if(e.allowTabSynchronization)return!1;throw new _(w.FAILED_PRECONDITION,Kh)}}return!(!this.networkEnabled||!this.inForeground)||$h(t).G().next(e=>void 0===this.Fi(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,e=this.networkEnabled===e.networkEnabled;if(t||n&&e)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&m("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Qr=!1,this.Oi(),this.Pi&&(this.Pi.cancel(),this.Pi=null),this.Ni(),this.Bi(),await this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new oi(e,ks.ae);return this.wi(t).next(()=>this.Di(t))}),this.Ei.close(),this.Li()}Fi(e,t){return e.filter(e=>this.vi(e.updateTimeMs,t)&&!this.xi(e.clientId))}ki(){return this.runTransaction("getActiveClients","readonly",e=>$h(e).G().next(e=>this.Fi(e,18e5).map(e=>e.clientId)))}get started(){return this.Qr}getMutationQueue(e,t){return sh.Pt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Kr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Hu(e,this.serializer.ht.databaseId)}getDocumentOverlayCache(e){return Cu.Pt(this.serializer,e)}getBundleCache(){return this.Ur}runTransaction(t,n,r){m("IndexedDbPersistence","Starting transaction:",t);var e="readonly"===n?"readonly":"readwrite",s=15===(s=this.ci)?ai:14===s?ii:13===s?si:12===s?ri:11===s?ni:void E();let i;return this.Ei.runTransaction(t,e,s,e=>(i=new oi(e,this.qr?this.qr.next():ks.ae),"readwrite-primary"===n?this.pi(i).next(e=>!!e||this.yi(i)).next(e=>{if(e)return r(i);throw d(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this._i.enqueueRetryable(()=>this.di(!1)),new _(w.FAILED_PRECONDITION,ys)}).next(e=>this.Si(i).next(()=>e)):this.qi(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}qi(e){return Qh(e).get("owner").next(e=>{if(null!==e&&this.vi(e.leaseTimestampMs,5e3)&&!this.xi(e.ownerId)&&!this.bi(e)&&!(this.ui||this.allowTabSynchronization&&e.allowTabSynchronization))throw new _(w.FAILED_PRECONDITION,Kh)})}Si(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Qh(e).put("owner",t)}static C(){return bs.C()}wi(e){const t=Qh(e);return t.get("owner").next(e=>this.bi(e)?(m("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):C.resolve())}vi(e,t){var n=Date.now();return!(e<n-t||n<e&&(d(`Detected an update time that is in the future: ${e} > `+n),1))}Vi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.hi=()=>{this._i.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Ri()))},this.document.addEventListener("visibilitychange",this.hi),this.inForeground="visible"===this.document.visibilityState)}Ni(){this.hi&&(this.document.removeEventListener("visibilitychange",this.hi),this.hi=null)}mi(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.li=()=>{this.Oi();var e=/(?:Version|Mobile)\/1[456]/;K()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this._i.enterRestrictedMode(!0),this._i.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.li))}Bi(){this.li&&(this.window.removeEventListener("pagehide",this.li),this.li=null)}xi(e){var t;try{var n=null!==(null==(t=this.Ai)?void 0:t.getItem(this.Mi(e)));return m("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return d("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Oi(){if(this.Ai)try{this.Ai.setItem(this.Mi(this.clientId),String(Date.now()))}catch(e){d("Failed to set zombie client id.",e)}}Li(){if(this.Ai)try{this.Ai.removeItem(this.Mi(this.clientId))}catch(e){}}Mi(e){return`firestore_zombie_${this.persistenceKey}_`+e}}function Qh(e){return ui(e,"owner")}function $h(e){return ui(e,"clientMetadata")}function Hh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Wh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Qi=n,this.Ki=r}static $i(e,t){let n=O(),r=O();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Wh(e,t.fromCache,n,r)}}class Yh{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class Xh{constructor(){this.Ui=!1,this.Wi=!1,this.Gi=100,this.zi=8}initialize(e,t){this.ji=e,this.indexManager=t,this.Ui=!0}getDocumentsMatchingQuery(n,r,e,t){const s={result:null};return this.Hi(n,r).next(e=>{s.result=e}).next(()=>{if(!s.result)return this.Ji(n,r,t,e).next(e=>{s.result=e})}).next(()=>{if(!s.result){const t=new Yh;return this.Yi(n,r,t).next(e=>{if(s.result=e,this.Wi)return this.Zi(n,r,t,e.size)})}}).next(()=>s.result)}Zi(e,t,n,r){return n.documentReadCount<this.Gi?(zr()<=c.DEBUG&&m("QueryEngine","SDK will not create cache indexes for query:",Ra(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Gi,"documents"),C.resolve()):(zr()<=c.DEBUG&&m("QueryEngine","Query:",Ra(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.zi*r?(zr()<=c.DEBUG&&m("QueryEngine","The SDK decides to create cache indexes for query:",Ra(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Ca(t))):C.resolve())}Hi(s,i){if(Ia(i))return C.resolve(null);let t=Ca(i);return this.indexManager.getIndexType(s,t).next(e=>0===e?null:(null!==i.limit&&1===e&&(i=Da(i,null,"F"),t=Ca(i)),this.indexManager.getDocumentsMatchingTarget(s,t).next(e=>{const r=O(...e);return this.ji.getDocuments(s,r).next(n=>this.indexManager.getMinOffset(s,t).next(e=>{var t=this.Xi(i,n);return this.es(i,t,r,e.readTime)?this.Hi(s,Da(i,null,"F")):this.ts(s,t,i,e)}))})))}Ji(t,n,r,s){return Ia(n)||s.isEqual(b.min())?C.resolve(null):this.ji.getDocuments(t,r).next(e=>{e=this.Xi(n,e);return this.es(n,e,r,s)?C.resolve(null):(zr()<=c.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Ra(n)),this.ts(t,e,n,fs(s,-1)).next(e=>e))})}Xi(n,e){let r=new D(La(n));return e.forEach((e,t)=>{Ma(n,t)&&(r=r.add(t))}),r}es(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Yi(e,t,n){return zr()<=c.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",Ra(t)),this.ji.getDocumentsMatchingQuery(e,t,ms.min(),n)}ts(e,n,t,r){return this.ji.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class Jh{constructor(e,t,n,r){this.persistence=e,this.ns=t,this.serializer=r,this.rs=new A(T),this.ss=new Fa(e=>fa(e),ga),this.os=new Map,this._s=e.getRemoteDocumentCache(),this.Kr=e.getTargetCache(),this.Ur=e.getBundleCache(),this.us(n)}us(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Nh(this._s,this.mutationQueue,this.documentOverlayCache,this.indexManager),this._s.setIndexManager(this.indexManager),this.ns.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.rs))}}function Zh(e,t,n,r){return new Jh(e,t,n,r)}async function el(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",s=>{let i;return a.mutationQueue.getAllMutationBatches(s).next(e=>(i=e,a.us(t),a.mutationQueue.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=O();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(s,r).next(e=>({cs:e,removedBatchIds:t,addedBatchIds:n}))})})}function tl(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Kr.getLastRemoteSnapshotVersion(e))}function nl(e,i,t){let n=O(),a=O();return t.forEach(e=>n=n.add(e)),i.getEntries(e,n).next(r=>{let s=Pa;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(b.min())?(i.removeEntry(e,t.readTime),s=s.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(t),s=s.insert(e,t)):m("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{ls:s,hs:a}})}function rl(e,r){const s=e;return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.Kr.getTargetData(t,r).next(e=>e?(n=e,C.resolve(n)):s.Kr.allocateTargetId(t).next(e=>(n=new cu(r,e,"TargetPurposeListen",t.currentSequenceNumber),s.Kr.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.rs.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.rs=s.rs.insert(e.targetId,e),s.ss.set(r,e.targetId)),e})}async function sl(e,t,n){const r=e,s=r.rs.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!Ts(e))throw e;m("LocalStore",`Failed to update sequence numbers for target ${t}: `+e)}r.rs=r.rs.remove(t),r.ss.delete(s.target)}function il(e,n,r){const s=e;let i=b.min(),a=O();return s.persistence.runTransaction("Execute query","readwrite",t=>function(e,t,n){const r=e,s=r.ss.get(n);return void 0!==s?C.resolve(r.rs.get(s)):r.Kr.getTargetData(t,n)}(s,t,Ca(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.Kr.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>s.ns.getDocumentsMatchingQuery(t,n,r?i:b.min(),r?a:O())).next(e=>(ul(s,Oa(n),e),{documents:e,Ps:a})))}function al(e,t){const n=e,r=n.Kr,s=n.rs.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.lt(e,t).next(e=>e?e.target:null))}function ol(e,t){const n=e,r=n.os.get(t)||b.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n._s.getAllFromCollectionGroup(e,t,fs(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(ul(n,t,e),e))}function ul(e,t,n){let r=e.os.get(t)||b.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.os.set(t,r)}function hl(e,t){return`firestore_clients_${e}_`+t}function ll(e,t,n){let r=`firestore_mutations_${e}_`+n;return t.isAuthenticated()&&(r+="_"+t.uid),r}function cl(e,t){return`firestore_targets_${e}_`+t}class dl{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Es(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&((i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(s=new _(r.error.code,r.error.message))),i?new dl(e,t,r.state,s):(d("SharedClientState",`Failed to parse mutation state for ID '${t}': `+n),null)}As(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class fl{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Es(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&((s="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new _(n.error.code,n.error.message))),s?new fl(e,n.state,r):(d("SharedClientState",`Failed to parse target state for ID '${e}': `+t),null)}As(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class gl{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Es(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Ka;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=Os(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new gl(e,s):(d("SharedClientState",`Failed to parse client data for instance '${e}': `+t),null)}}class ml{constructor(e,t){this.clientId=e,this.onlineState=t}static Es(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new ml(t.clientId,t.onlineState):(d("SharedClientState","Failed to parse online state: "+e),null)}}class pl{constructor(){this.activeTargetIds=Ka}Rs(e){this.activeTargetIds=this.activeTargetIds.add(e)}Vs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}As(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class yl{constructor(e,t,n,r,s){this.window=e,this._i=t,this.persistenceKey=n,this.fs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.gs=this.ps.bind(this),this.ys=new A(T),this.started=!1,this.ws=[];e=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ss=hl(this.persistenceKey,this.fs),this.bs="firestore_sequence_number_"+this.persistenceKey,this.ys=this.ys.insert(this.fs,new pl),this.Ds=new RegExp(`^firestore_clients_${e}_([^_]*)$`),this.Cs=new RegExp(`^firestore_mutations_${e}_(\\d+)(?:_(.*))?$`),this.vs=new RegExp(`^firestore_targets_${e}_(\\d+)$`),this.Fs="firestore_online_state_"+this.persistenceKey,this.Ms="firestore_bundle_loaded_v2_"+this.persistenceKey,this.window.addEventListener("storage",this.gs)}static C(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.ki();for(const n of e)if(n!==this.fs){const e=this.getItem(hl(this.persistenceKey,n));var t;e&&(t=gl.Es(n,e))&&(this.ys=this.ys.insert(t.clientId,t))}this.xs();const n=this.storage.getItem(this.Fs);if(n){const e=this.Os(n);e&&this.Ns(e)}for(const e of this.ws)this.ps(e);this.ws=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.bs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Bs(this.ys)}isActiveQueryTarget(n){let r=!1;return this.ys.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Ls(e,"pending")}updateMutationState(e,t,n){this.Ls(e,t,n),this.ks(e)}addLocalQueryTarget(e){let t="not-current";var n;return!this.isActiveQueryTarget(e)||(n=this.storage.getItem(cl(this.persistenceKey,e)))&&(n=fl.Es(e,n))&&(t=n.state),this.qs.Rs(e),this.xs(),t}removeLocalQueryTarget(e){this.qs.Vs(e),this.xs()}isLocalQueryTarget(e){return this.qs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(cl(this.persistenceKey,e))}updateQueryState(e,t,n){this.Qs(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.ks(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Ks(e)}notifyBundleLoaded(e){this.$s(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.gs),this.removeItem(this.Ss),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return m("SharedClientState","READ",e,t),t}setItem(e,t){m("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){m("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ps(e){const s=e;s.storageArea===this.storage&&(m("SharedClientState","EVENT",s.key,s.newValue),s.key!==this.Ss?this._i.enqueueRetryable(async()=>{if(this.started){if(null!==s.key){var e;if(this.Ds.test(s.key))return null==s.newValue?(e=this.Us(s.key),this.Ws(e,null)):(e=this.Gs(s.key,s.newValue))?this.Ws(e.clientId,e):void 0;if(this.Cs.test(s.key)){if(null!==s.newValue){var t=this.zs(s.key,s.newValue);if(t)return this.js(t)}}else if(this.vs.test(s.key)){if(null!==s.newValue&&(t=this.Hs(s.key,s.newValue)))return this.Js(t)}else if(s.key===this.Fs){if(null!==s.newValue){var n=this.Os(s.newValue);if(n)return this.Ns(n)}}else if(s.key===this.bs)(n=function(e){let t=ks.ae;if(null!=e)try{var n=JSON.parse(e);y("number"==typeof n),t=n}catch(e){d("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(s.newValue))!==ks.ae&&this.sequenceNumberHandler(n);else if(s.key===this.Ms){const r=this.Ys(s.newValue);await Promise.all(r.map(e=>this.syncEngine.Zs(e)))}}}else this.ws.push(s)}):d("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get qs(){return this.ys.get(this.fs)}xs(){this.setItem(this.Ss,this.qs.As())}Ls(e,t,n){const r=new dl(this.currentUser,e,t,n),s=ll(this.persistenceKey,this.currentUser,e);this.setItem(s,r.As())}ks(e){e=ll(this.persistenceKey,this.currentUser,e);this.removeItem(e)}Ks(e){e={clientId:this.fs,onlineState:e};this.storage.setItem(this.Fs,JSON.stringify(e))}Qs(e,t,n){const r=cl(this.persistenceKey,e),s=new fl(e,t,n);this.setItem(r,s.As())}$s(e){e=JSON.stringify(Array.from(e));this.setItem(this.Ms,e)}Us(e){e=this.Ds.exec(e);return e?e[1]:null}Gs(e,t){e=this.Us(e);return gl.Es(e,t)}zs(e,t){var e=this.Cs.exec(e),n=Number(e[1]),e=void 0!==e[2]?e[2]:null;return dl.Es(new o(e),n,t)}Hs(e,t){e=this.vs.exec(e),e=Number(e[1]);return fl.Es(e,t)}Os(e){return ml.Es(e)}Ys(e){return JSON.parse(e)}async js(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Xs(e.batchId,e.state,e.error);m("SharedClientState","Ignoring mutation for non-active user "+e.user.uid)}Js(e){return this.syncEngine.eo(e.targetId,e.state,e.error)}Ws(e,t){const n=t?this.ys.insert(e,t):this.ys.remove(e),r=this.Bs(this.ys),s=this.Bs(n),i=[],a=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||a.push(e)}),this.syncEngine.no(i,a).then(()=>{this.ys=n})}Ns(e){this.ys.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Bs(e){let n=Ka;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class vl{constructor(){this.ro=new pl,this.io={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.ro.Rs(e),this.io[e]||"not-current"}updateQueryState(e,t,n){this.io[e]=t}removeLocalQueryTarget(e){this.ro.Vs(e)}isLocalQueryTarget(e){return this.ro.activeTargetIds.has(e)}clearQueryState(e){delete this.io[e]}getAllActiveQueryTargets(){return this.ro.activeTargetIds}isActiveQueryTarget(e){return this.ro.activeTargetIds.has(e)}start(){return this.ro=new pl,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class wl{so(e){}shutdown(){}}class _l{constructor(){this.oo=()=>this._o(),this.ao=()=>this.uo(),this.co=[],this.lo()}so(e){this.co.push(e)}shutdown(){window.removeEventListener("online",this.oo),window.removeEventListener("offline",this.ao)}lo(){window.addEventListener("online",this.oo),window.addEventListener("offline",this.ao)}_o(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.co)e(0)}uo(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.co)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let bl=null;function Il(){return null===bl?bl=268435456+Math.round(2147483648*Math.random()):bl++,"0x"+bl.toString(16)}const El={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Tl{constructor(e){this.ho=e.ho,this.Po=e.Po}Io(e){this.To=e}Eo(e){this.Ao=e}onMessage(e){this.Ro=e}close(){this.Po()}send(e){this.ho(e)}Vo(){this.To()}mo(e){this.Ao(e)}fo(e){this.Ro(e)}}const Sl="WebChannelConnection";class xl extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.po=t+"://"+e.host,this.yo=`projects/${n}/databases/`+r,this.wo="(default)"===this.databaseId.database?"project_id="+n:`project_id=${n}&database_id=`+r}get So(){return!1}bo(t,e,n,r,s){const i=Il(),a=this.Do(t,e);m("RestConnection",`Sending RPC '${t}' ${i}:`,a,n);e={"google-cloud-resource-prefix":this.yo,"x-goog-request-params":this.wo};return this.Co(e,r,s),this.vo(t,a,e,n).then(e=>(m("RestConnection",`Received RPC '${t}' ${i}: `,e),e),e=>{throw Qr("RestConnection",`RPC '${t}' ${i} failed with error: `,e,"url: ",a,"request:",n),e})}Fo(e,t,n,r,s,i){return this.bo(e,t,n,r,s)}Co(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+Gr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}Do(e,t){e=El[e];return this.po+`/v1/${t}:`+e}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}vo(o,t,n,r){const u=Il();return new Promise((s,i)=>{const a=new Ur;a.setWithCredentials(!0),a.listenOnce(Pr.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case Fr.NO_ERROR:var e=a.getResponseJson();m(Sl,`XHR for RPC '${o}' ${u} received:`,JSON.stringify(e)),s(e);break;case Fr.TIMEOUT:m(Sl,`RPC '${o}' ${u} timed out`),i(new _(w.DEADLINE_EXCEEDED,"Request time out"));break;case Fr.HTTP_ERROR:var t=a.getStatus();if(m(Sl,`RPC '${o}' ${u} failed with status:`,t,"response text:",a.getResponseText()),0<t){let e=a.getResponseJson();var n=null==(e=Array.isArray(e)?e[0]:e)?void 0:e.error;if(n&&n.status&&n.message){r=n.status.toLowerCase().replace(/_/g,"-");const o=0<=Object.values(w).indexOf(r)?r:w.UNKNOWN;i(new _(o,n.message))}else i(new _(w.UNKNOWN,"Server responded with status "+a.getStatus()))}else i(new _(w.UNAVAILABLE,"Connection failed."));break;default:E()}}finally{m(Sl,`RPC '${o}' ${u} completed.`)}var r});var e=JSON.stringify(r);m(Sl,`RPC '${o}' ${u} sending request:`,r),a.send(t,"POST",e,n,15)})}Mo(s,e,t){const i=Il(),n=[this.po,"/","google.firestore.v1.Firestore","/",s,"/channel"],r=new cr,a=Lr(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/`+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(o.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(o.useFetchStreams=!0),this.Co(o.initMessageHeaders,e,t),o.encodeInitMessageHeaders=!0;e=n.join("");m(Sl,`Creating RPC '${s}' stream ${i}: `+e,o);const h=r.createWebChannel(e,o);let l=!1,c=!1;const d=new Tl({ho:e=>{c?m(Sl,`Not sending because RPC '${s}' stream ${i} is closed:`,e):(l||(m(Sl,`Opening RPC '${s}' stream ${i} transport.`),h.open(),l=!0),m(Sl,`RPC '${s}' stream ${i} sending:`,e),h.send(e))},Po:()=>h.close()}),f=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return f(h,Br.EventType.OPEN,()=>{c||m(Sl,`RPC '${s}' stream ${i} transport opened.`)}),f(h,Br.EventType.CLOSE,()=>{c||(c=!0,m(Sl,`RPC '${s}' stream ${i} transport closed`),d.mo())}),f(h,Br.EventType.ERROR,e=>{c||(c=!0,Qr(Sl,`RPC '${s}' stream ${i} transport errored:`,e),d.mo(new _(w.UNAVAILABLE,"The operation could not be completed")))}),f(h,Br.EventType.MESSAGE,n=>{if(!c){var n=n.data[0],r=(y(!!n),n.error||(null==(r=n[0])?void 0:r.error));if(r){m(Sl,`RPC '${s}' stream ${i} received error:`,r);const n=r.status;let e=function(e){e=g[e];if(void 0!==e)return To(e)}(n),t=r.message;void 0===e&&(e=w.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),c=!0,d.mo(new _(e,t)),h.close()}else m(Sl,`RPC '${s}' stream ${i} received:`,n),d.fo(n)}}),f(a,Vr.STAT_EVENT,e=>{10===e.stat?m(Sl,`RPC '${s}' stream ${i} detected buffering proxy`):11===e.stat&&m(Sl,`RPC '${s}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{d.Vo()},0),d}}function Cl(){return"undefined"!=typeof window?window:null}function Al(){return"undefined"!=typeof document?document:null}function Dl(e){return new Go(e,!0)}class Nl{constructor(e,t,n=1e3,r=1.5,s=6e4){this._i=e,this.timerId=t,this.xo=n,this.Oo=r,this.No=s,this.Bo=0,this.Lo=null,this.ko=Date.now(),this.reset()}reset(){this.Bo=0}qo(){this.Bo=this.No}Qo(e){this.cancel();var t=Math.floor(this.Bo+this.Ko()),n=Math.max(0,Date.now()-this.ko),r=Math.max(0,t-n);0<r&&m("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Bo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Lo=this._i.enqueueAfterDelay(this.timerId,r,()=>(this.ko=Date.now(),e())),this.Bo*=this.Oo,this.Bo<this.xo&&(this.Bo=this.xo),this.Bo>this.No&&(this.Bo=this.No)}$o(){null!==this.Lo&&(this.Lo.skipDelay(),this.Lo=null)}cancel(){null!==this.Lo&&(this.Lo.cancel(),this.Lo=null)}Ko(){return(Math.random()-.5)*this.Bo}}class kl{constructor(e,t,n,r,s,i,a,o){this._i=e,this.Uo=n,this.Wo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Go=0,this.zo=null,this.jo=null,this.stream=null,this.Ho=new Nl(e,t)}Jo(){return 1===this.state||5===this.state||this.Yo()}Yo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Zo()}async stop(){this.Jo()&&await this.close(0)}Xo(){this.state=0,this.Ho.reset()}e_(){this.Yo()&&null===this.zo&&(this.zo=this._i.enqueueAfterDelay(this.Uo,6e4,()=>this.t_()))}n_(e){this.r_(),this.stream.send(e)}async t_(){if(this.Yo())return this.close(0)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}i_(){this.jo&&(this.jo.cancel(),this.jo=null)}async close(e,t){this.r_(),this.i_(),this.Ho.cancel(),this.Go++,4!==e?this.Ho.reset():t&&t.code===w.RESOURCE_EXHAUSTED?(d(t.toString()),d("Using maximum backoff delay to prevent overloading the backend."),this.Ho.qo()):t&&t.code===w.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.s_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Eo(t)}s_(){}auth(){this.state=1;const e=this.o_(this.Go),n=this.Go;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.Go===n&&this.__(e,t)},t=>{e(()=>{var e=new _(w.UNKNOWN,"Fetching auth token failed: "+t.message);return this.a_(e)})})}__(e,t){const n=this.o_(this.Go);this.stream=this.u_(e,t),this.stream.Io(()=>{n(()=>(this.state=2,this.jo=this._i.enqueueAfterDelay(this.Wo,1e4,()=>(this.Yo()&&(this.state=3),Promise.resolve())),this.listener.Io()))}),this.stream.Eo(e=>{n(()=>this.a_(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Zo(){this.state=5,this.Ho.Qo(async()=>{this.state=0,this.start()})}a_(e){return m("PersistentStream","close with error: "+e),this.stream=null,this.close(4,e)}o_(t){return e=>{this._i.enqueueAndForget(()=>this.Go===t?e():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Rl extends kl{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}u_(e,t){return this.connection.Mo("Listen",e,t)}onMessage(e){this.Ho.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:E(),s=t.targetChange.targetIds||[],i=(f=t.targetChange.resumeToken,e.useProto3Json?(y(void 0===f||"string"==typeof f),vi.fromBase64String(f||"")):(y(void 0===f||f instanceof Uint8Array),vi.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?w.UNKNOWN:To(f.code),new _(o,f.message||""));n=new Lo(r,s,i,o||null)}else if("documentChange"in t){t.documentChange;(l=t.documentChange).document,l.document.name,l.document.updateTime;var i=Yo(e,l.document.name),o=F(l.document.updateTime),u=l.document.createTime?F(l.document.createTime):b.min(),h=new zi({mapValue:{fields:l.document.fields}}),u=k.newFoundDocument(i,o,u,h),h=l.targetIds||[],l=l.removedTargetIds||[];n=new Mo(h,l,u.key,u)}else if("documentDelete"in t)t.documentDelete,(h=t.documentDelete).document,l=Yo(e,h.document),u=h.readTime?F(h.readTime):b.min(),u=k.newNoDocument(l,u),h=h.removedTargetIds||[],n=new Mo([],h,u.key,u);else if("documentRemove"in t){t.documentRemove;(d=t.documentRemove).document;var c=Yo(e,d.document),d=d.removedTargetIds||[];n=new Mo([],d,c,null)}else{if(!("filter"in t))return E();{t.filter;const e=t.filter;e.targetId;var{count:d=0,unchangedNames:c}=e,d=new Io(d,c),c=e.targetId;n=new Oo(c,d)}}var f;return n}(this.serializer,e),e=!("targetChange"in(e=e))||(e=e.targetChange).targetIds&&e.targetIds.length||!e.readTime?b.min():F(e.readTime);return this.listener.c_(t,e)}l_(e){const t={};t.database=Zo(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if((n=ma(r)?{documents:iu(e,r)}:{query:au(e,r)}).targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=Qo(e,t.resumeToken);const r=Ko(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(b.min())){n.readTime=zo(e,t.snapshotVersion.toTimestamp());const r=Ko(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);this.serializer;var n=null==(n=function(){switch(e.purpose){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return E()}}())?null:{"goog-listen-tags":n};n&&(t.labels=n),this.n_(t)}h_(e){const t={};t.database=Zo(this.serializer),t.removeTarget=e,this.n_(t)}}class Ml extends kl{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s,this.P_=!1}get I_(){return this.P_}start(){this.P_=!1,this.lastStreamToken=void 0,super.start()}s_(){this.P_&&this.d_([])}u_(e,t){return this.connection.Mo("Write",e,t)}onMessage(e){var t,n,r;return y(!!e.streamToken),this.lastStreamToken=e.streamToken,this.P_?(this.Ho.reset(),n=e.writeResults,r=e.commitTime,n=n&&0<n.length?(y(void 0!==r),n.map(t=>{{var n=r;let e=t.updateTime?F(t.updateTime):F(n);return e.isEqual(b.min())&&(e=F(n)),new io(e,t.transformResults||[])}})):[],t=F(e.commitTime),this.listener.T_(t,n)):(y(!e.writeResults||0===e.writeResults.length),this.P_=!0,this.listener.E_())}A_(){const e={};e.database=Zo(this.serializer),this.n_(e)}d_(e){e={streamToken:this.lastStreamToken,writes:e.map(e=>ru(this.serializer,e))};this.n_(e)}}class Ol extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.R_=!1}V_(){if(this.R_)throw new _(w.FAILED_PRECONDITION,"The client has already been terminated.")}bo(n,r,s){return this.V_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.bo(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===w.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(w.UNKNOWN,e.toString())})}Fo(n,r,s,i){return this.V_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.Fo(n,r,s,e,t,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===w.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(w.UNKNOWN,e.toString())})}terminate(){this.R_=!0}}class Ll{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.f_=0,this.g_=null,this.p_=!0}y_(){0===this.f_&&(this.w_("Unknown"),this.g_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.g_=null,this.S_("Backend didn't respond within 10 seconds."),this.w_("Offline"),Promise.resolve())))}b_(e){"Online"===this.state?this.w_("Unknown"):(this.f_++,1<=this.f_&&(this.D_(),this.S_("Connection failed 1 times. Most recent error: "+e.toString()),this.w_("Offline")))}set(e){this.D_(),this.f_=0,"Online"===e&&(this.p_=!1),this.w_(e)}w_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}S_(e){e=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.p_?(d(e),this.p_=!1):m("OnlineStateTracker",e)}D_(){null!==this.g_&&(this.g_.cancel(),this.g_=null)}}class Fl{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.C_=[],this.v_=new Map,this.F_=new Set,this.M_=[],this.x_=s,this.x_.so(e=>{n.enqueueAndForget(async()=>{if(zl(this)){m("RemoteStore","Restarting streams for network reachability change.");{const e=this;e.F_.add(4),await Vl(e),e.O_.set("Unknown"),e.F_.delete(4),await Pl(e)}}})}),this.O_=new Ll(n,r)}}async function Pl(e){if(zl(e))for(const t of e.M_)await t(!0)}async function Vl(e){for(const t of e.M_)await t(!1)}function Bl(e,t){const n=e;n.v_.has(t.targetId)||(n.v_.set(t.targetId,t),Kl(n)?Gl(n):ec(n).Yo()&&ql(n,t))}function Ul(e,t){const n=e,r=ec(n);n.v_.delete(t),r.Yo()&&jl(n,t),0===n.v_.size&&(r.Yo()?r.e_():zl(n)&&n.O_.set("Unknown"))}function ql(e,t){var n;e.N_.Le(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(b.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),ec(e).l_(t)}function jl(e,t){e.N_.Le(t),ec(e).h_(t)}function Gl(t){t.N_=new Po({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),lt:e=>t.v_.get(e)||null,st:()=>t.datastore.serializer.databaseId}),ec(t).start(),t.O_.y_()}function Kl(e){return zl(e)&&!ec(e).Jo()&&0<e.v_.size}function zl(e){return 0===e.F_.size}function Ql(e){e.N_=void 0}async function $l(e,t,n){if(!Ts(t))throw t;e.F_.add(1),await Vl(e),e.O_.set("Offline"),n=n||(()=>tl(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),e.F_.delete(1),await Pl(e)})}function Hl(t,n){return n().catch(e=>$l(t,e,n))}async function Wl(e){const t=e,n=tc(t);let r=0<t.C_.length?t.C_[t.C_.length-1].batchId:-1;for(;zl(a=t)&&a.C_.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.C_.length&&n.e_();break}r=e.batchId;{var s=t;var i=e;s.C_.push(i);const o=tc(s);o.Yo()&&o.I_&&o.d_(i.mutations)}}catch(e){await $l(t,e)}var a;Yl(t)&&Xl(t)}function Yl(e){return zl(e)&&!tc(e).Jo()&&0<e.C_.length}function Xl(e){tc(e).start()}async function Jl(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");e=zl(n);n.F_.add(3),await Vl(n),e&&n.O_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.F_.delete(3),await Pl(n)}async function Zl(e,t){const n=e;t?(n.F_.delete(2),await Pl(n)):(n.F_.add(2),await Vl(n),n.O_.set("Unknown"))}function ec(t){return t.B_||(t.B_=function(e,t,n){const r=e;return r.V_(),new Rl(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Io:async function(n){n.v_.forEach((e,t)=>{ql(n,e)})}.bind(null,t),Eo:async function(e,t){Ql(e),Kl(e)?(e.O_.b_(t),Gl(e)):e.O_.set("Unknown")}.bind(null,t),c_:async function(e,t,n){if(e.O_.set("Online"),t instanceof Lo&&2===t.state&&t.cause)try{var r=e,s=t.cause;for(const o of t.targetIds)r.v_.has(o)&&(await r.remoteSyncer.rejectListen(o,s),r.v_.delete(o),r.N_.removeTarget(o))}catch(n){m("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await $l(e,n)}else if(t instanceof Mo?e.N_.Ge(t):t instanceof Oo?e.N_.Xe(t):e.N_.He(t),!n.isEqual(b.min()))try{const t=await tl(e.localStore);if(0<=n.compareTo(t)){var i=e,a=n;const u=i.N_._t(a);await(u.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=i.v_.get(t);n&&i.v_.set(t,n.withResumeToken(e.resumeToken,a))}}),u.targetMismatches.forEach((e,t)=>{const n=i.v_.get(e);n&&(i.v_.set(e,n.withResumeToken(vi.EMPTY_BYTE_STRING,n.snapshotVersion)),jl(i,e),e=new cu(n.target,e,t,n.sequenceNumber),ql(i,e))}),i.remoteSyncer.applyRemoteEvent(u))}}catch(t){m("RemoteStore","Failed to raise snapshot:",t),await $l(e,t)}}.bind(null,t)}),t.M_.push(async e=>{e?(t.B_.Xo(),Kl(t)?Gl(t):t.O_.set("Unknown")):(await t.B_.stop(),Ql(t))})),t.B_}function tc(t){return t.L_||(t.L_=function(e,t,n){const r=e;return r.V_(),new Ml(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Io:async function(e){tc(e).A_()}.bind(null,t),Eo:async function(e,t){if(t&&tc(e).I_){var n=e,r=t;if(Eo(t=r.code)&&t!==w.ABORTED){const s=n.C_.shift();tc(n).Xo(),await Hl(n,()=>n.remoteSyncer.rejectFailedWrite(s.batchId,r)),await Wl(n)}await 0}Yl(e)&&Xl(e)}.bind(null,t),E_:async function(e){const t=tc(e);for(const n of e.C_)t.d_(n.mutations)}.bind(null,t),T_:async function(e,t,n){const r=e.C_.shift(),s=_o.from(r,t,n);await Hl(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await Wl(e)}.bind(null,t)}),t.M_.push(async e=>{e?(t.L_.Xo(),await Wl(t)):(await t.L_.stop(),0<t.C_.length&&(m("RemoteStore",`Stopping write stream with ${t.C_.length} pending writes`),t.C_=[]))})),t.L_}class nc{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Hr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,a=new nc(e,t,i,r,s);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new _(w.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function rc(e,t){if(d("AsyncQueue",t+": "+e),Ts(e))return new _(w.UNAVAILABLE,t+": "+e);throw e}class sc{constructor(n){this.comparator=n?(e,t)=>n(e,t)||S.comparator(e.key,t.key):(e,t)=>S.comparator(e.key,t.key),this.keyedMap=Ba(),this.sortedSet=new A(this.comparator)}static emptySet(e){return new sc(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){e=this.keyedMap.get(e);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof sc))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new sc;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class ic{constructor(){this.k_=new A(S.comparator)}track(e){var t=e.doc.key,n=this.k_.get(t);!n||0!==e.type&&3===n.type?this.k_=this.k_.insert(t,e):3===e.type&&1!==n.type?this.k_=this.k_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.k_=this.k_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.k_=this.k_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.k_=this.k_.remove(t):1===e.type&&2===n.type?this.k_=this.k_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.k_=this.k_.insert(t,{type:2,doc:e.doc}):E()}q_(){const n=[];return this.k_.inorderTraversal((e,t)=>{n.push(t)}),n}}class ac{constructor(e,t,n,r,s,i,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach(e=>{i.push({type:0,doc:e})}),new ac(e,t,sc.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Na(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class oc{constructor(){this.Q_=void 0,this.listeners=[]}}class uc{constructor(){this.queries=new Fa(e=>ka(e),Na),this.onlineState="Unknown",this.K_=new Set}}async function hc(e,t){const n=e,r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new oc),s)try{i.Q_=await n.onListen(r)}catch(e){const n=rc(e,`Initialization of query '${Ra(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.U_(n.onlineState),i.Q_&&t.W_(i.Q_)&&cc(n)}async function lc(e,t){const n=e,r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function cc(e){e.K_.forEach(e=>{e.next()})}class dc{constructor(e,t,n){this.query=e,this.G_=t,this.z_=!1,this.j_=null,this.onlineState="Unknown",this.options=n||{}}W_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new ac(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.z_?this.H_(e)&&(this.G_.next(e),t=!0):this.J_(e,this.onlineState)&&(this.Y_(e),t=!0),this.j_=e,t}onError(e){this.G_.error(e)}U_(e){this.onlineState=e;let t=!1;return this.j_&&!this.z_&&this.J_(this.j_,e)&&(this.Y_(this.j_),t=!0),t}J_(e,t){return!e.fromCache||(!this.options.Z_||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}H_(e){var t;return 0<e.docChanges.length||(t=this.j_&&this.j_.hasPendingWrites!==e.hasPendingWrites,!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges)}Y_(e){e=ac.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.z_=!0,this.G_.next(e)}}class fc{constructor(e,t){this.X_=e,this.byteLength=t}ea(){return"metadata"in this.X_}}class gc{constructor(e){this.serializer=e}Is(e){return Yo(this.serializer,e)}ds(e){return e.metadata.exists?nu(this.serializer,e.document,!1):k.newNoDocument(this.Is(e.metadata.name),this.Ts(e.metadata.readTime))}Ts(e){return F(e)}}class mc{constructor(e,t,n){this.ta=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=pc(e)}na(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.X_.namedQuery)this.queries.push(e.X_.namedQuery);else if(e.X_.documentMetadata){this.documents.push({metadata:e.X_.documentMetadata}),e.X_.documentMetadata.exists||++t;const n=I.fromString(e.X_.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.X_.document&&(this.documents[this.documents.length-1].document=e.X_.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ra(e){const t=new Map,n=new gc(this.serializer);for(const s of e)if(s.metadata.queries){const e=n.Is(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||O()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=e;let i=O(),a=Pa;for(const e of n){const n=t.Is(e.metadata.name),h=(e.document&&(i=i.add(n)),t.ds(e));h.setReadTime(t.Ts(e.metadata.readTime)),a=a.insert(n,h)}const o=s._s.newChangeBuffer({trackRemovals:!0}),u=await rl(s,Ca(ba(I.fromString("__bundle__/docs/"+r))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>nl(t,o,a).next(e=>(o.apply(t),e)).next(e=>s.Kr.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.Kr.addMatchingKeys(t,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(t,e.ls,e.hs)).next(()=>e.ls)))}(this.localStore,new gc(this.serializer),this.documents,this.ta.id),t=this.ra(this.documents);for(const e of this.queries)await async function(e,n,r=O()){const s=await rl(e,Ca(_u(n.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=F(n.readTime);return 0<=s.snapshotVersion.compareTo(t)?i.Ur.saveNamedQuery(e,n):(t=s.withResumeToken(vi.EMPTY_BYTE_STRING,t),i.rs=i.rs.insert(t.targetId,t),i.Kr.updateTargetData(e,t).next(()=>i.Kr.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.Kr.addMatchingKeys(e,r,s.targetId)).next(()=>i.Ur.saveNamedQuery(e,n)))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,ia:this.collectionGroups,sa:e}}}function pc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class yc{constructor(e){this.key=e}}class vc{constructor(e){this.key=e}}class wc{constructor(e,t){this.query=e,this.oa=t,this._a=null,this.hasCachedResults=!1,this.current=!1,this.aa=O(),this.mutatedKeys=O(),this.ua=La(e),this.ca=new sc(this.ua)}get la(){return this.oa}ha(e,t){const o=t?t.Pa:new ic,u=(t||this).ca;let h=(t||this).mutatedKeys,l=u,c=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=Ma(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(o.track({type:3,doc:r}),a=!0):this.Ia(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this.ua(r,d)||f&&this.ua(r,f)<0)&&(c=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(c=!0)),a&&(h=r?(l=l.add(r),i?h.add(e):h.delete(e)):(l=l.delete(e),h.delete(e)))}),null!==this.query.limit)for(;l.size>this.query.limit;){const e="F"===this.query.limitType?l.last():l.first();l=l.delete(e.key),h=h.delete(e.key),o.track({type:1,doc:e})}return{ca:l,Pa:o,es:c,mutatedKeys:h}}Ia(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.ca;this.ca=e.ca,this.mutatedKeys=e.mutatedKeys;const s=e.Pa.q_();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return E()}};return n(e)-n(t)}(e.type,t.type)||this.ua(e.doc,t.doc)),this.da(n);var t=t?this.Ta():[],i=0===this.aa.size&&this.current?1:0,a=i!==this._a;return this._a=i,0!==s.length||a?{snapshot:new ac(this.query,e.ca,r,s,e.mutatedKeys,0==i,a,!1,!!n&&0<n.resumeToken.approximateByteSize()),Ea:t}:{Ea:t}}U_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ca:this.ca,Pa:new ic,mutatedKeys:this.mutatedKeys,es:!1},!1)):{Ea:[]}}Aa(e){return!this.oa.has(e)&&!!this.ca.has(e)&&!this.ca.get(e).hasLocalMutations}da(e){e&&(e.addedDocuments.forEach(e=>this.oa=this.oa.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.oa=this.oa.delete(e)),this.current=e.current)}Ta(){if(!this.current)return[];const t=this.aa,n=(this.aa=O(),this.ca.forEach(e=>{this.Aa(e.key)&&(this.aa=this.aa.add(e.key))}),[]);return t.forEach(e=>{this.aa.has(e)||n.push(new vc(e))}),this.aa.forEach(e=>{t.has(e)||n.push(new yc(e))}),n}Ra(e){this.oa=e.Ps,this.aa=O();e=this.ha(e.documents);return this.applyChanges(e,!0)}Va(){return ac.fromInitialDocuments(this.query,this.ca,this.mutatedKeys,0===this._a,this.hasCachedResults)}}class _c{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class bc{constructor(e){this.key=e,this.ma=!1}}class Ic{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.fa={},this.ga=new Fa(e=>ka(e),Na),this.pa=new Map,this.ya=new Set,this.wa=new A(S.comparator),this.Sa=new Map,this.ba=new Mh,this.Da={},this.Ca=new Map,this.va=hh.Ln(),this.onlineState="Unknown",this.Fa=void 0}get isPrimaryClient(){return!0===this.Fa}}async function Ec(n,e,t,r,s){n.Ma=(e,s,t)=>async function(e,t,n){let r=t.view.ha(s);r.es&&(r=await il(e.localStore,t.query,!1).then(({documents:e})=>t.view.ha(e,r)));n=n&&n.targetChanges.get(t.targetId),n=t.view.applyChanges(r,e.isPrimaryClient,n);return Nc(e,t.targetId,n.Ea),n.snapshot}(n,e,t);const i=await il(n.localStore,e,!0),a=new wc(e,i.Ps),o=a.ha(i.documents),u=Ro.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState,s),h=a.applyChanges(o,n.isPrimaryClient,u);Nc(n,t,h.Ea);r=new _c(e,t,a);return n.ga.set(e,r),n.pa.has(t)?n.pa.get(t).push(e):n.pa.set(t,[e]),h.snapshot}async function Tc(e,t){const r=e;try{const e=await function(e,h){const l=e,c=h.snapshotVersion;let d=l.rs;return l.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=l._s.newChangeBuffer({trackRemovals:!0}),u=(d=l.rs,[]);h.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(l.Kr.removeMatchingKeys(o,t.removedDocuments,n).next(()=>l.Kr.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var s,i,a;null!==h.targetMismatches.get(n)?e=e.withResumeToken(vi.EMPTY_BYTE_STRING,b.min()).withLastLimboFreeSnapshotVersion(b.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,c)),d=d.insert(n,e),s=r,i=e,a=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(l.Kr.updateTargetData(o,e))}});let t=Pa,n=O();if(h.documentUpdates.forEach(e=>{h.resolvedLimboDocuments.has(e)&&u.push(l.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(nl(o,e,h.documentUpdates).next(e=>{t=e.ls,n=e.hs})),!c.isEqual(b.min())){const h=l.Kr.getLastRemoteSnapshotVersion(o).next(e=>l.Kr.setTargetsMetadata(o,o.currentSequenceNumber,c));u.push(h)}return C.waitFor(u).next(()=>e.apply(o)).next(()=>l.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(l.rs=d,e))}(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.Sa.get(t);n&&(y(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.ma=!0:0<e.modifiedDocuments.size?y(n.ma):0<e.removedDocuments.size&&(y(n.ma),n.ma=!1))}),await Rc(r,e,t)}catch(e){await ws(e)}}function Sc(n,r,e){const t=n;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const n=[];t.ga.forEach((e,t)=>{t=t.view.U_(r);t.snapshot&&n.push(t.snapshot)});{e=t.eventManager;var s=r;const i=e;i.onlineState=s;let n=!1;i.queries.forEach((e,t)=>{for(const e of t.listeners)e.U_(s)&&(n=!0)}),n&&cc(i)}n.length&&t.fa.c_(n),t.onlineState=r,t.isPrimaryClient&&t.sharedClientState.setOnlineState(r)}}function xc(e,t){(e.Ca.get(t)||[]).forEach(e=>{e.resolve()}),e.Ca.delete(t)}function Cc(e,t,n){const r=e;let s=r.Da[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Da[r.currentUser.toKey()]=s}}function Ac(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.pa.get(e))t.ga.delete(r),n&&t.fa.xa(r,n);t.pa.delete(e),t.isPrimaryClient&&t.ba.mr(e).forEach(e=>{t.ba.containsKey(e)||Dc(t,e)})}function Dc(e,t){e.ya.delete(t.path.canonicalString());var n=e.wa.get(t);null!==n&&(Ul(e.remoteStore,n),e.wa=e.wa.remove(t),e.Sa.delete(n),kc(e))}function Nc(e,t,n){for(const s of n)if(s instanceof yc){e.ba.addReference(s.key,t);{var r=e;const i=s.key,a=i.path.canonicalString();r.wa.get(i)||r.ya.has(a)||(m("SyncEngine","New document in limbo: "+i),r.ya.add(a),kc(r))}}else s instanceof vc?(m("SyncEngine","Document no longer in limbo: "+s.key),e.ba.removeReference(s.key,t),e.ba.containsKey(s.key)||Dc(e,s.key)):E()}function kc(e){for(;0<e.ya.size&&e.wa.size<e.maxConcurrentLimboResolutions;){var t=e.ya.values().next().value,n=(e.ya.delete(t),new S(I.fromString(t))),t=e.va.next();e.Sa.set(t,new bc(n)),e.wa=e.wa.insert(n,t),Bl(e.remoteStore,new cu(Ca(ba(n.path)),t,"TargetPurposeLimboResolution",ks.ae))}}async function Rc(e,n,r){const s=e,i=[],a=[],o=[];if(!s.ga.isEmpty()){s.ga.forEach((e,t)=>{o.push(s.Ma(t,n,r).then(e=>{(e||r)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(t.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(i.push(e),e=Wh.$i(t.targetId,e),a.push(e))}))}),await Promise.all(o),s.fa.c_(i);{var t=s.localStore,u=a;const h=t;try{await h.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>C.forEach(u,t=>C.forEach(t.Qi,e=>h.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>C.forEach(t.Ki,e=>h.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(t){if(!Ts(t))throw t;m("LocalStore","Failed to update sequence numbers: "+t)}for(const t of u){const u=t.targetId;if(!t.fromCache){const t=h.rs.get(u),l=t.snapshotVersion,c=t.withLastLimboFreeSnapshotVersion(l);h.rs=h.rs.insert(u,c)}}}}}async function Mc(t,n){const r=t,s=[],i=[];for(const t of n){let e;var a=r.pa.get(t);if(a&&0!==a.length){e=await rl(r.localStore,Ca(a[0]));for(const t of a){const n=r.ga.get(t),l=(o=n,0,h=await il((u=r).localStore,o.query,!0),h=o.view.Ra(h),u.isPrimaryClient&&Nc(u,o.targetId,h.Ea),await h);l.snapshot&&i.push(l.snapshot)}}else{a=await al(r.localStore,t);e=await rl(r.localStore,a),await Ec(r,Oc(a),t,!1,e.resumeToken)}s.push(e)}var o,u,h;return r.fa.c_(i),s}function Oc(e){return _a(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Lc(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Tc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=function(e,t){const n=e,r=n.Sa.get(t);if(r&&r.ma)return O().add(r.key);{let e=O();const r=n.pa.get(t);if(r)for(const t of r){const r=n.ga.get(t);e=e.unionWith(r.view.la)}return e}}.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=async function(e,t,n){const r=e,s=(r.sharedClientState.updateQueryState(t,"rejected",n),r.Sa.get(t)),i=s&&s.key;if(i){let e=new A(S.comparator);e=e.insert(i,k.newNoDocument(i,b.min()));const n=O().add(i),s=new ko(b.min(),new Map,new A(T),e,n);await Tc(r,s),r.wa=r.wa.remove(i),r.Sa.delete(t),kc(r)}else await sl(r.localStore,t,!1).then(()=>Ac(r,t,n)).catch(ws)}.bind(null,t),t.fa.c_=function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.W_(e)&&(r=!0);s.Q_=e}}r&&cc(n)}.bind(null,t.eventManager),t.fa.xa=function(e,t,n){const r=e,s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}.bind(null,t.eventManager),t}function Fc(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=async function(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s._s.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let a=C.resolve();return n.forEach(n=>{a=a.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);y(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),s.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.mutationQueue.performConsistencyCheck(e)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(t){let n=O();for(let e=0;e<t.mutationResults.length;++e)0<t.mutationResults[e].transformResults.length&&(n=n.add(t.batch.mutations[e].key));return n}(r))).next(()=>s.localDocuments.getDocuments(e,t))})}(n.localStore,t);Cc(n,r,null),xc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Rc(n,e)}catch(e){await ws(e)}}.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=async function(e,t,n){const r=e;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.mutationQueue.lookupMutationBatch(t,r).next(e=>(y(null!==e),n=e.keys(),s.mutationQueue.removeMutationBatch(t,e))).next(()=>s.mutationQueue.performConsistencyCheck(t)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>s.localDocuments.getDocuments(t,n))})}(r.localStore,t);Cc(r,t,n),xc(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Rc(r,e)}catch(n){await ws(n)}}.bind(null,t),t}class Pc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Dl(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Zh(this.persistence,new Xh,e.initialUser,this.serializer)}createPersistence(e){return new Bh(qh.Jr,this.serializer)}createSharedClientState(e){return new vl}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Vc extends Pc{constructor(e,t,n){super(),this.Na=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Na.initialize(this,e),await Fc(this.Na.syncEngine),await Wl(this.Na.remoteStore),await this.persistence.gi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return Zh(this.persistence,new Xh,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new ph(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){t=new Ns(t,this.persistence);return new Ds(e.asyncQueue,t)}createPersistence(e){var t=Hh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?th.withCacheSize(this.cacheSizeBytes):th.DEFAULT;return new zh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Cl(),Al(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new vl}}class Bc extends Vc{constructor(e,t){super(e,t,!1),this.Na=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);e=this.Na.syncEngine;this.sharedClientState instanceof yl&&(this.sharedClientState.syncEngine={Xs:async function(e,t,n,r){var s=await function(e,n){const r=e,s=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.Fn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):C.resolve(null)))}(e.localStore,t);null!==s?("pending"===n?await Wl(e.remoteStore):"acknowledged"===n||"rejected"===n?(Cc(e,t,r||null),xc(e,t),e.localStore.mutationQueue.xn(t)):E(),await Rc(e,s)):m("SyncEngine","Cannot apply mutation batch with id: "+t)}.bind(null,e),eo:async function(e,t,n,r){const s=e;if(s.Fa)m("SyncEngine","Ignoring unexpected query state notification.");else{var i=s.pa.get(t);if(i&&0<i.length)switch(n){case"current":case"not-current":{const e=await ol(s.localStore,Oa(i[0])),r=ko.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,vi.EMPTY_BYTE_STRING);await Rc(s,e,r);break}case"rejected":await sl(s.localStore,t,!0),Ac(s,t,r);break;default:E()}}}.bind(null,e),no:async function(e,t,n){const r=Lc(e);if(r.Fa){for(const e of t)if(r.pa.has(e))m("SyncEngine","Adding an already active target "+e);else{const t=await al(r.localStore,e),n=await rl(r.localStore,t);await Ec(r,Oc(t),n.targetId,!1,n.resumeToken),Bl(r.remoteStore,n)}for(const e of n)r.pa.has(e)&&await sl(r.localStore,e,!1).then(()=>{Ul(r.remoteStore,e),Ac(r,e)}).catch(ws)}}.bind(null,e),ki:function(e){return e.localStore.persistence.ki()}.bind(null,e),Zs:async function(e,t){const n=e;return ol(n.localStore,t).then(e=>Rc(n,e))}.bind(null,e)},await this.sharedClientState.start()),await this.persistence.gi(async e=>{{var r=this.Na.syncEngine,t=e;const s=r;if(Lc(s),Fc(s),!0===t&&!0!==s.Fa){const r=s.sharedClientState.getAllActiveQueryTargets(),t=await Mc(s,r.toArray());s.Fa=!0,await Zl(s.remoteStore,!0);for(const r of t)Bl(s.remoteStore,r)}else if(!1===t&&!1!==s.Fa){const r=[];let n=Promise.resolve();s.pa.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Ac(s,t),sl(s.localStore,t,!0))),Ul(s.remoteStore,t)}),await n,await Mc(s,r);{const i=s;i.Sa.forEach((e,t)=>{Ul(i.remoteStore,t)}),i.ba.gr(),i.Sa=new Map,i.wa=new A(S.comparator)}s.Fa=!1,await Zl(s.remoteStore,!1)}}await 0,this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t,n=Cl();if(yl.C(n))return t=Hh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),new yl(n,e.asyncQueue,t,e.clientId,e.initialUser);throw new _(w.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.")}}class Uc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Sc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=async function(e,t){const n=e;var r;n.currentUser.isEqual(t)||(m("SyncEngine","User change. New user:",t.toKey()),r=await el(n.localStore,t),n.currentUser=t,e=n,e.Ca.forEach(e=>{e.forEach(e=>{e.reject(new _(w.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.Ca.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await Rc(n,r.cs))}.bind(null,this.syncEngine),await Zl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new uc}createDatastore(e){var t=Dl(e.databaseInfo.databaseId),n=(i=e.databaseInfo,new xl(i)),r=e.authCredentials,s=e.appCheckCredentials,i=n;return e=t,new Ol(r,s,i,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Sc(this.syncEngine,e,0),e=new(_l.C()?_l:wl),new Fl(t,n,r,s,e);var t,n,r,s}createSyncEngine(e,t){{var n=this.localStore,r=this.remoteStore,s=this.eventManager,i=this.sharedClientState,a=e.initialUser;e=e.maxConcurrentLimboResolutions;const o=new Ic(n,r,s,i,a,e);return t&&(o.Fa=!0),o}}terminate(){return async function(e){const t=e;m("RemoteStore","RemoteStore shutting down."),t.F_.add(5),await Vl(t),t.x_.shutdown(),t.O_.set("Unknown")}(this.remoteStore)}}function qc(t,n=10240){let r=0;return{async read(){var e;return r<t.byteLength?(e={value:t.slice(r,r+n),done:!1},r+=n,e):{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class jc{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ba(this.observer.next,e)}error(e){this.observer.error?this.Ba(this.observer.error,e):d("Uncaught Error in snapshot listener:",e.toString())}La(){this.muted=!0}Ba(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class Gc{constructor(e,t){this.ka=e,this.serializer=t,this.metadata=new Hr,this.buffer=new Uint8Array,this.qa=new TextDecoder("utf-8"),this.Qa().then(e=>{e&&e.ea()?this.metadata.resolve(e.X_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             `+JSON.stringify(null==e?void 0:e.X_)))},e=>this.metadata.reject(e))}close(){return this.ka.cancel()}async getMetadata(){return this.metadata.promise}async Oa(){return await this.getMetadata(),this.Qa()}async Qa(){var e,t,n=await this.Ka();return null===n?null:(e=this.qa.decode(n),t=Number(e),isNaN(t)&&this.$a(`length string (${e}) is not valid number`),e=await this.Ua(t),new fc(JSON.parse(e),n.length+t))}Wa(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Ka(){for(;this.Wa()<0&&!await this.Ga(););var e,t;return 0===this.buffer.length?null:((e=this.Wa())<0&&this.$a("Reached the end of bundle when a length string is expected."),t=this.buffer.slice(0,e),this.buffer=this.buffer.slice(e),t)}async Ua(e){for(;this.buffer.length<e;)await this.Ga()&&this.$a("Reached the end of bundle when more is expected.");var t=this.qa.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}$a(e){throw this.ka.cancel(),new Error("Invalid bundle format: "+e)}async Ga(){var e=await this.ka.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Kc{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new _(w.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const o=e,n=Zo(o.serializer)+"/documents",r={documents:t.map(e=>Wo(o.serializer,e))},s=await o.Fo("BatchGetDocuments",n,r,t.length),u=new Map,i=(s.forEach(e=>{a=o.serializer;const t="found"in e?(n=a,y(!!(r=e).found),r.found.name,r.found.updateTime,n=Yo(n,r.found.name),s=F(r.found.updateTime),i=r.found.createTime?F(r.found.createTime):b.min(),r=new zi({mapValue:{fields:r.found.fields}}),k.newFoundDocument(n,s,i,r)):"missing"in e?function(e,t){y(!!t.missing),y(!!t.readTime);e=Yo(e,t.missing),t=F(t.readTime);return k.newNoDocument(e,t)}(a,e):E();var n,r,s,i,a;u.set(t.key.toString(),t)}),[]);return t.forEach(e=>{e=u.get(e.toString());y(!!e),i.push(e)}),i}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new yo(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{t=S.fromPath(t);this.mutations.push(new vo(t,this.precondition(t)))});{var e=this.datastore,n=this.mutations;const r=e,s=Zo(r.serializer)+"/documents",i={writes:n.map(e=>ru(r.serializer,e))};await r.bo("Commit",s,i)}await 0,this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw E();t=b.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new _(w.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(b.min())?L.exists(!1):L.updateTime(t):L.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return L.exists(!0);if(t.isEqual(b.min()))throw new _(w.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return L.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class zc{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.za=n.maxAttempts,this.Ho=new Nl(this.asyncQueue,"transaction_retry")}run(){--this.za,this.ja()}ja(){this.Ho.Qo(async()=>{const t=new Kc(this.datastore),e=this.Ha(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.Ja(e)}))}).catch(e=>{this.Ja(e)})})}Ha(e){try{var t=this.updateFunction(e);return!Rs(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Ja(e){0<this.za&&this.Ya(e)?(--this.za,this.asyncQueue.enqueueAndForget(()=>(this.ja(),Promise.resolve()))):this.deferred.reject(e)}Ya(e){return"FirebaseError"===e.name&&("aborted"===(e=e.code)||"failed-precondition"===e||"already-exists"===e||!Eo(e))}}class Qc{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=o.UNAUTHENTICATED,this.clientId=rs.V(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{m("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(m("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new _(w.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Hr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=rc(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function $c(e,t){e.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await el(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function Hc(e,n){e.asyncQueue.verifyOperationInProgress();var t=await Yc(e),r=(m("FirestoreClient","Initializing OnlineComponentProvider"),await e.getConfiguration());await n.initialize(t,r),e.setCredentialChangeListener(e=>Jl(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>Jl(n.remoteStore,t)),e._onlineComponents=n}function Wc(e){return"FirebaseError"===e.name?e.code===w.FAILED_PRECONDITION||e.code===w.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Yc(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){m("FirestoreClient","Using user provided OfflineComponentProvider");try{await $c(t,t._uninitializedComponentsProvider._offline)}catch(e){var n=e;if(!Wc(n))throw n;Qr("Error using user provided cache. Falling back to memory cache: "+n),await $c(t,new Pc)}}else m("FirestoreClient","Using default OfflineComponentProvider"),await $c(t,new Pc);return t._offlineComponents}async function Xc(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(m("FirestoreClient","Using user provided OnlineComponentProvider"),await Hc(e,e._uninitializedComponentsProvider._online)):(m("FirestoreClient","Using default OnlineComponentProvider"),await Hc(e,new Uc))),e._onlineComponents}function Jc(e){return Yc(e).then(e=>e.persistence)}function Zc(e){return Yc(e).then(e=>e.localStore)}function ed(e){return Xc(e).then(e=>e.remoteStore)}function td(e){return Xc(e).then(e=>e.syncEngine)}async function nd(e){const t=await Xc(e),n=t.eventManager;return n.onListen=async function(e,t){const n=Lc(e);let r,s;const i=n.ga.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Va();else{const e=await rl(n.localStore,Ca(t)),i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await Ec(n,t,r,"current"===i,e.resumeToken),n.isPrimaryClient&&Bl(n.remoteStore,e)}return s}.bind(null,t.syncEngine),n.onUnlisten=async function(e,t){const n=e,r=n.ga.get(t),s=n.pa.get(r.targetId);1<s.length?(n.pa.set(r.targetId,s.filter(e=>!Na(e,t))),n.ga.delete(t)):n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await sl(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Ul(n.remoteStore,r.targetId),Ac(n,r.targetId)}).catch(ws)):(Ac(n,r.targetId),await sl(n.localStore,r.targetId,!0))}.bind(null,t.syncEngine),n}function rd(t,u,h={}){const l=new Hr;return t.asyncQueue.enqueueAndForget(async()=>{{var n=await nd(t),r=t.asyncQueue,s=u,i=h,a=l;const e=new jc({next:e=>{r.enqueueAndForget(()=>lc(n,o));var t=e.docs.has(s);!t&&e.fromCache?a.reject(new _(w.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?a.reject(new _(w.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new dc(ba(s.path),e,{includeMetadataChanges:!0,Z_:!0});return hc(n,o)}}),l.promise}function sd(o,u,h={}){const l=new Hr;return o.asyncQueue.enqueueAndForget(async()=>{{var t=await nd(o),n=o.asyncQueue,e=u,r=h,s=l;const i=new jc({next:e=>{n.enqueueAndForget(()=>lc(t,a)),e.fromCache&&"server"===r.source?s.reject(new _(w.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),a=new dc(e,i,{includeMetadataChanges:!0,Z_:!0});return hc(t,a)}}),l.promise}function id(r,e,t,s){e=Dl(e),t=function(e){if(e instanceof Uint8Array)return qc(e,void 0);if(e instanceof ArrayBuffer)return qc(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof t?So().encode(t):t);const i=new Gc(t,e);r.asyncQueue.enqueueAndForget(async()=>{{var e=await td(r),t=i;const n=e;!async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=e,r=F(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ur.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes}),Promise.resolve(new Set);r._updateProgress(pc(s));const a=new mc(s,t.localStore,n.serializer);let e=await n.Oa();for(;e;){const t=await a.na(e);t&&r._updateProgress(t),e=await n.Oa()}var i=await a.complete();return await Rc(t,i.sa,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ur.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress),Promise.resolve(i.ia)}catch(t){return Qr("SyncEngine","Loading bundle failed with "+t),r._failWith(t),Promise.resolve(new Set)}}(n,t,s).then(e=>{n.sharedClientState.notifyBundleLoaded(e)})}})}function ad(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const od=new Map;function ud(e,t,n){if(!n)throw new _(w.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function hd(e,t,n,r){if(!0===t&&!0===r)throw new _(w.INVALID_ARGUMENT,e+` and ${n} cannot be used together.`)}function ld(e){if(!S.isDocumentKey(e))throw new _(w.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function cd(e){if(S.isDocumentKey(e))throw new _(w.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function dd(e){return void 0===e?"undefined":null===e?"null":"string"==typeof e?(20<e.length&&(e=e.substring(0,20)+"..."),JSON.stringify(e)):"number"==typeof e||"boolean"==typeof e?""+e:"object"!=typeof e?"function"==typeof e?"a function":E():e instanceof Array?"an array":(e=e.constructor?e.constructor.name:null)?`a custom ${e} object`:"an object"}function P(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new _(w.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");e=dd(e);throw new _(w.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: `+e)}function fd(e,t){if(t<=0)throw new _(w.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class gd{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new _(w.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new _(w.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}hd("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=ad(null!=(t=e.experimentalLongPollingOptions)?t:{});var t=this.experimentalLongPollingOptions;if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(30<t.timeoutSeconds)throw new _(w.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class md{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new gd({}),this._settingsFrozen=!1}get app(){if(this._app)return this._app;throw new _(w.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available")}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new _(w.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new gd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Yr;switch(e.type){case"firstParty":return new es(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new _(w.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){{var e=this;const t=od.get(e);t&&(m("ComponentProvider","Removing Datastore"),od.delete(e),t.terminate())}return Promise.resolve()}}class pd{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new pd(this.firestore,e,this._query)}}class V{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new yd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new V(this.firestore,e,this._key)}}class yd extends pd{constructor(e,t,n){super(e,t,ba(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new V(this.firestore,null,new S(e))}withConverter(e){return new yd(this.firestore,e,this._path)}}function vd(e,t,...n){var r;if(e=v(e),ud("collection","path",t),e instanceof md)return cd(r=I.fromString(t,...n)),new yd(e,null,r);if(e instanceof V||e instanceof yd)return cd(r=e._path.child(I.fromString(t,...n))),new yd(e.firestore,null,r);throw new _(w.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function wd(e,t,...n){var r;if(e=v(e),ud("doc","path",t=1===arguments.length?rs.V():t),e instanceof md)return ld(r=I.fromString(t,...n)),new V(e,null,new S(r));if(e instanceof V||e instanceof yd)return ld(r=e._path.child(I.fromString(t,...n))),new V(e.firestore,e instanceof yd?e.converter:null,new S(r));throw new _(w.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function _d(e,t){return e=v(e),t=v(t),(e instanceof V||e instanceof yd)&&(t instanceof V||t instanceof yd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function bd(e,t){return e=v(e),t=v(t),e instanceof pd&&t instanceof pd&&e.firestore===t.firestore&&Na(e._query,t._query)&&e.converter===t.converter}class Id{constructor(){this.Za=Promise.resolve(),this.Xa=[],this.eu=!1,this.tu=[],this.nu=null,this.ru=!1,this.iu=!1,this.su=[],this.Ho=new Nl(this,"async_queue_retry"),this.ou=()=>{var e=Al();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Ho.$o()};const e=Al();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.ou)}get isShuttingDown(){return this.eu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this._u(),this.au(e)}enterRestrictedMode(e){if(!this.eu){this.eu=!0,this.iu=e||!1;const t=Al();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.ou)}}enqueue(e){if(this._u(),this.eu)return new Promise(()=>{});const t=new Hr;return this.au(()=>this.eu&&this.iu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Xa.push(e),this.uu()))}async uu(){if(0!==this.Xa.length){try{await this.Xa[0](),this.Xa.shift(),this.Ho.reset()}catch(e){if(!Ts(e))throw e;m("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Xa.length&&this.Ho.Qo(()=>this.uu())}}au(e){var t=this.Za.then(()=>(this.ru=!0,e().catch(e=>{throw this.nu=e,this.ru=!1,d("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return t=e.stack?e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack:t}(e)),e}).then(e=>(this.ru=!1,e))));return this.Za=t}enqueueAfterDelay(e,t,n){this._u(),-1<this.su.indexOf(e)&&(t=0);e=nc.createAndSchedule(this,e,t,n,e=>this.cu(e));return this.tu.push(e),e}_u(){this.nu&&E()}verifyOperationInProgress(){}async lu(){for(var e;await(e=this.Za),e!==this.Za;);}hu(e){for(const t of this.tu)if(t.timerId===e)return!0;return!1}Pu(t){return this.lu().then(()=>{this.tu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.tu)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.lu()})}Iu(e){this.su.push(e)}cu(e){e=this.tu.indexOf(e);this.tu.splice(e,1)}}function Ed(e){var t=e;if("object"==typeof t&&null!==t){var n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return 1}}class Td{constructor(){this._progressObserver={},this._taskCompletionResolver=new Hr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class B extends md{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Id,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||xd(this),this._firestoreClient.terminate()}}function Sd(e){return e._firestoreClient||xd(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function xd(e){var t,n,r,s,i=e._freezeSettings(),a=(t=e._databaseId,n=(null==(a=e._app)?void 0:a.options.appId)||"",r=e._persistenceKey,s=i,new Si(t,n,r,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,ad(s.experimentalLongPollingOptions),s.useFetchStreams));e._firestoreClient=new Qc(e._authCredentials,e._appCheckCredentials,e._queue,a),null!=(a=i.localCache)&&a._offlineComponentProvider&&null!=(t=i.localCache)&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function Cd(e,t,n){const r=new Hr;return e.asyncQueue.enqueue(async()=>{try{await $c(e,n),await Hc(e,t),r.resolve()}catch(e){const t=e;if(!Wc(t))throw t;Qr("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function Ad(e){return(r=Sd(e=P(e,B))).asyncQueue.enqueue(async()=>{const e=await Jc(r),t=await ed(r);e.setNetworkEnabled(!0);{const n=t;return n.F_.delete(0),Pl(n)}});var r}function Dd(t,e){return r=Sd(t=P(t,B)),s=e,r.asyncQueue.enqueue(async()=>{{var e=await Zc(r),t=s;const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Ur.getNamedQuery(e,t))}}).then(e=>e?new pd(t,null,e.query):null);var r,s}function Nd(e){if(e._initialized||e._terminated)throw new _(w.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class kd{constructor(e){this._byteString=e}static fromBase64String(e){try{return new kd(vi.fromBase64String(e))}catch(e){throw new _(w.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new kd(vi.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Rd{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new _(w.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new f(t)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Md{constructor(e){this._methodName=e}}class Od{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new _(w.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new _(w.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return T(this._lat,e._lat)||T(this._long,e._long)}}const Ld=/^__.*__$/;class Fd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new fo(e,this.data,this.fieldMask,t,this.fieldTransforms):new co(e,this.data,t,this.fieldTransforms)}}class Pd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new fo(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Vd(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw E()}}class Bd{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.du(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Tu(){return this.settings.Tu}Eu(e){return new Bd(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Au(e){var t;const n=null==(t=this.path)?void 0:t.child(e),r=this.Eu({path:n,Ru:!1});return r.Vu(e),r}mu(e){var t;const n=null==(t=this.path)?void 0:t.child(e),r=this.Eu({path:n,Ru:!1});return r.du(),r}fu(e){return this.Eu({path:void 0,Ru:!0})}gu(e){return af(e,this.settings.methodName,this.settings.pu||!1,this.path,this.settings.yu)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}du(){if(this.path)for(let e=0;e<this.path.length;e++)this.Vu(this.path.get(e))}Vu(e){if(0===e.length)throw this.gu("Document fields must not be empty");if(Vd(this.Tu)&&Ld.test(e))throw this.gu('Document fields cannot begin and end with "__"')}}class Ud{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Dl(e)}wu(e,t,n,r=!1){return new Bd({Tu:e,methodName:t,yu:n,path:f.emptyPath(),Ru:!1,pu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function qd(e){var t=e._freezeSettings(),n=Dl(e._databaseId);return new Ud(e._databaseId,!!t.ignoreUndefinedProperties,n)}function jd(e,t,n,r,s,i={}){const a=e.wu(i.merge||i.mergeFields?2:0,t,n,s);tf("Data must be an object, but it was:",a,r);e=Zd(r,a);let o,u;if(i.merge)o=new pi(a.fieldMask),u=a.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=nf(t,r,n);if(!a.contains(s))throw new _(w.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);of(e,s)||e.push(s)}o=new pi(e),u=a.fieldTransforms.filter(e=>o.covers(e.field))}else o=null,u=a.fieldTransforms;return new Fd(new zi(e),o,u)}class Gd extends Md{_toFieldTransform(e){if(2!==e.Tu)throw 1===e.Tu?e.gu(this._methodName+"() can only appear at the top level of your update data"):e.gu(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Gd}}function Kd(e,t,n){return new Bd({Tu:3,yu:t.settings.yu,methodName:e._methodName,Ru:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class zd extends Md{_toFieldTransform(e){return new so(e.path,new Ya)}isEqual(e){return e instanceof zd}}class Qd extends Md{constructor(e,t){super(e),this.Su=t}_toFieldTransform(e){const t=Kd(this,e,!0),n=this.Su.map(e=>Jd(e,t)),r=new Xa(n);return new so(e.path,r)}isEqual(e){return this===e}}class $d extends Md{constructor(e,t){super(e),this.Su=t}_toFieldTransform(e){const t=Kd(this,e,!0),n=this.Su.map(e=>Jd(e,t)),r=new Za(n);return new so(e.path,r)}isEqual(e){return this===e}}class Hd extends Md{constructor(e,t){super(e),this.bu=t}_toFieldTransform(e){var t=new to(e.serializer,$a(e.serializer,this.bu));return new so(e.path,t)}isEqual(e){return this===e}}function Wd(e,s,i,t){const a=e.wu(1,s,i),o=(tf("Data must be an object, but it was:",a,t),[]),u=zi.empty();li(t,(e,t)=>{var n=sf(s,e,i),r=(t=v(t),a.mu(n));if(t instanceof Gd)o.push(n);else{const e=Jd(t,r);null!=e&&(o.push(n),u.set(n,e))}});e=new pi(o);return new Pd(u,e,a.fieldTransforms)}function Yd(t,n,e,r,s,i){const a=t.wu(1,n,e),o=[nf(n,r,e)],u=[s];if(i.length%2!=0)throw new _(w.INVALID_ARGUMENT,`Function ${n}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)o.push(nf(n,i[e])),u.push(i[e+1]);const h=[],l=zi.empty();for(let e=o.length-1;0<=e;--e)if(!of(h,o[e])){const n=o[e];var c=v(u[e]);const r=a.mu(n);if(c instanceof Gd)h.push(n);else{const t=Jd(c,r);null!=t&&(h.push(n),l.set(n,t))}}t=new pi(h);return new Pd(l,t,a.fieldTransforms)}function Xd(e,t,n,r=!1){return Jd(n,e.wu(r?4:3,t))}function Jd(e,n){if(ef(e=v(e)))return tf("Unsupported field value:",n,e),Zd(e,n);if(e instanceof Md){{var t=e;var r=n;if(!Vd(r.Tu))throw r.gu(t._methodName+"() can only be used with update() and set()");if(!r.path)throw r.gu(t._methodName+"() is not currently supported inside arrays");t=t._toFieldTransform(r);t&&r.fieldTransforms.push(t)}return null}if(void 0===e&&n.ignoreUndefinedProperties)return null;if(n.path&&n.fieldMask.push(n.path),e instanceof Array){if(n.settings.Ru&&4!==n.Tu)throw n.gu("Nested arrays are not supported");{var s=n;const a=[];let t=0;for(const o of e){let e=Jd(o,s.fu(t));null==e&&(e={nullValue:"NULL_VALUE"}),a.push(e),t++}return{arrayValue:{values:a}}}}var i,r=0,t=n;if(null===(r=v(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof r)return $a(t.serializer,r);if("boolean"==typeof r)return{booleanValue:r};if("string"==typeof r)return{stringValue:r};if(r instanceof Date)return i=l.fromDate(r),{timestampValue:zo(t.serializer,i)};if(r instanceof l)return i=new l(r.seconds,1e3*Math.floor(r.nanoseconds/1e3)),{timestampValue:zo(t.serializer,i)};if(r instanceof Od)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof kd)return{bytesValue:Qo(t.serializer,r._byteString)};if(r instanceof V){const u=t.databaseId,h=r.firestore._databaseId;if(h.isEqual(u))return{referenceValue:$o(r.firestore._databaseId||t.databaseId,r._key.path)};throw t.gu(`Document reference is for database ${h.projectId}/${h.database} but should be for database ${u.projectId}/`+u.database)}throw t.gu("Unsupported field value: "+dd(r))}function Zd(e,n){const r={};return ci(e)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):li(e,(e,t)=>{t=Jd(t,n.Au(e));null!=t&&(r[e]=t)}),{mapValue:{fields:r}}}function ef(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof l||e instanceof Od||e instanceof kd||e instanceof V||e instanceof Md)}function tf(e,t,n){var r;if(!ef(n)||"object"!=typeof(r=n)||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r))throw"an object"===(r=dd(n))?t.gu(e+" a custom object"):t.gu(e+" "+r)}function nf(e,t,n){if((t=v(t))instanceof Rd)return t._internalPath;if("string"==typeof t)return sf(e,t);throw af("Field path arguments must be of type string or ",e,!1,void 0,n)}const rf=new RegExp("[~\\*/\\[\\]]");function sf(t,n,r){if(0<=n.search(rf))throw af(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new Rd(...n.split("."))._internalPath}catch(e){throw af(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function af(e,t,n,r,s){var i=r&&!r.isEmpty(),a=void 0!==s;let o=`Function ${t}() called with invalid data`,u=(n&&(o+=" (via `toFirestore()`)"),o+=". ","");return(i||a)&&(u+=" (found",i&&(u+=" in field "+r),a&&(u+=" in document "+s),u+=")"),new _(w.INVALID_ARGUMENT,o+e+u)}function of(e,t){return e.some(e=>e.isEqual(t))}class uf{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new V(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){var e;if(this._document)return this._converter?(e=new hf(this._firestore,this._userDataWriter,this._key,this._document,null),this._converter.fromFirestore(e)):this._userDataWriter.convertValue(this._document.data.value)}get(e){if(this._document){e=this._document.data.field(lf("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e)}}}class hf extends uf{data(){return super.data()}}function lf(e,t){return"string"==typeof t?sf(e,t):(t instanceof Rd?t:t._delegate)._internalPath}function cf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new _(w.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class df{}class ff extends df{}function gf(e,t,...n){let r=[];t instanceof df&&r.push(t),r=r.concat(n);n=(t=r).filter(e=>!1).length,t=t.filter(e=>e instanceof mf).length;if(1<n||0<n&&0<t)throw new _(w.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.");for(const t of r)e=t._apply(e);return e}class mf extends ff{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new mf(e,t,n)}_apply(e){var t=this._parse(e);return Ef(e._query,t),new pd(e.firestore,e.converter,Aa(e._query,t))}_parse(t){var n=qd(t.firestore);{var r=t._query,s="where",i=n,a=t.firestore._databaseId,o=(n=this._field,t=this._op,this._value);let e;if(n.isKeyField()){if("array-contains"===t||"array-contains-any"===t)throw new _(w.INVALID_ARGUMENT,`Invalid Query. You can't perform '${t}' queries on documentId().`);if("in"===t||"not-in"===t){If(o,t);const s=[];for(const i of o)s.push(bf(a,r,i));e={arrayValue:{values:s}}}else e=bf(a,r,o)}else"in"!==t&&"not-in"!==t&&"array-contains-any"!==t||If(o,t),e=Xd(i,s,o,"in"===t||"not-in"===t);return R.create(n,t,e)}}}(class extends df{});class pf extends ff{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new pf(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new _(w.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new _(w.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");t=new Wi(t,n);return n=t,null===Ea(e)&&null!==(e=Ta(e))&&Tf(0,e,n.field),t}(e._query,this._field,this._direction);return new pd(e.firestore,e.converter,(t=(e=e._query).explicitOrderBy.concat([t]),new wa(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class yf extends ff{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new yf(e,t,n)}_apply(e){return new pd(e.firestore,e.converter,Da(e._query,this._limit,this._limitType))}}class vf extends ff{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new vf(e,t,n)}_apply(e){var t,n=_f(e,this.type,this._docOrFields,this._inclusive);return new pd(e.firestore,e.converter,(t=e._query,e=n,new wa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class wf extends ff{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new wf(e,t,n)}_apply(e){var t,n=_f(e,this.type,this._docOrFields,this._inclusive);return new pd(e.firestore,e.converter,(t=e._query,e=n,new wa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function _f(e,t,n,r){if(n[0]=v(n[0]),n[0]instanceof uf){var s=e._query,i=e.firestore._databaseId,a=t,o=n[0]._document,u=r;if(!o)throw new _(w.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);const g=[];for(const a of xa(s))if(a.field.isKeyField())g.push(Li(i,o.key));else{const s=o.data.field(a.field);if(Ii(s))throw new _(w.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){const s=a.field.canonicalString();throw new _(w.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${s}' (used as the orderBy) does not exist.`)}g.push(s)}return new Qi(g,u)}a=qd(e.firestore);{var h=e._query,l=e.firestore._databaseId,c=a,d=t,f=n,s=r;const m=h.explicitOrderBy;if(f.length>m.length)throw new _(w.INVALID_ARGUMENT,`Too many arguments provided to ${d}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const p=[];for(let e=0;e<f.length;e++){const y=f[e];if(m[e].field.isKeyField()){if("string"!=typeof y)throw new _(w.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${d}(), but got a `+typeof y);if(!Sa(h)&&-1!==y.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${d}() must be a plain document ID, but '${y}' contains a slash.`);const c=h.path.child(I.fromString(y));if(!S.isDocumentKey(c))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${d}() must result in a valid document path, but '${c}' is not because it contains an odd number of segments.`);const f=new S(c);p.push(Li(l,f))}else{const h=Xd(c,d,y);p.push(h)}}return new Qi(p,s)}}function bf(e,t,n){if("string"==typeof(n=v(n))){if(""===n)throw new _(w.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Sa(t)&&-1!==n.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);t=t.path.child(I.fromString(n));if(S.isDocumentKey(t))return Li(e,new S(t));throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${t}' is not because it has an odd number of segments (${t.length}).`)}if(n instanceof V)return Li(e,n._key);throw new _(w.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${dd(n)}.`)}function If(e,t){if(!Array.isArray(e)||0===e.length)throw new _(w.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Ef(e,t){if(t.isInequality()){const r=Ta(e),s=t.field;if(null!==r&&!r.isEqual(s))throw new _(w.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${s.toString()}'`);var n=Ea(e);null!==n&&Tf(0,s,n)}const r=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new _(w.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new _(w.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}function Tf(e,t,n){if(!n.isEqual(t))throw new _(w.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Sf{convertValue(e,t="none"){switch(Di(e)){case 0:return null;case 1:return e.booleanValue;case 2:return N(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(bi(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw E()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,n="none"){const r={};return li(e,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new Od(N(e.latitude),N(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=Ei(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Ti(e));default:return null}}convertTimestamp(e){e=_i(e);return new l(e.seconds,e.nanos)}convertDocumentKey(e,t){const n=I.fromString(e),r=(y(lu(n)),new xi(n.get(1),n.get(3))),s=new S(n.popFirst(5));return r.isEqual(t)||d(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function xf(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class Cf extends Sf{constructor(e){super(),this.firestore=e}convertBytes(e){return new kd(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new V(this.firestore,null,e)}}class Af{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Df extends uf{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){var t;if(this._document)return this._converter?(t=new Nf(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null),this._converter.fromFirestore(t,e)):this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}get(e,t={}){if(this._document){e=this._document.data.field(lf("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e,t.serverTimestamps)}}}class Nf extends Df{data(e={}){return super.data(e)}}class kf{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Af(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new Nf(this._firestore,this._userDataWriter,e.key,e,new Af(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){e=!!e.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new _(w.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let n=0;return i._snapshot.docChanges.map(e=>{var t=new Nf(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Af(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new Nf(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Af(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:function(){switch(e.type){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return E()}}(),doc:t,oldIndex:n,newIndex:r}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Rf(e,t){return e instanceof Df&&t instanceof Df?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof kf&&t instanceof kf&&e._firestore===t._firestore&&bd(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class Mf extends Sf{constructor(e){super(),this.firestore=e}convertBytes(e){return new kd(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new V(this.firestore,null,e)}}function Of(e,t,n){e=P(e,V);var r=P(e.firestore,B),t=xf(e.converter,t,n);return Vf(r,[jd(qd(r),"setDoc",e._key,t,null!==e.converter,n).toMutation(e._key,L.none())])}function Lf(e,t,n,...r){e=P(e,V);var s=P(e.firestore,B),i=qd(s);let a;return Vf(s,[(a="string"==typeof(t=v(t))||t instanceof Rd?Yd(i,"updateDoc",e._key,t,n,r):Wd(i,"updateDoc",e._key,t)).toMutation(e._key,L.exists(!0))])}function Ff(t,...n){t=v(t);let e={includeMetadataChanges:!1},r=0;"object"!=typeof n[r]||Ed(n[r])||(e=n[r],r++);var s={includeMetadataChanges:e.includeMetadataChanges};if(Ed(n[r])){const t=n[r];n[r]=null==(h=t.next)?void 0:h.bind(t),n[r+1]=null==(h=t.error)?void 0:h.bind(t),n[r+2]=null==(h=t.complete)?void 0:h.bind(t)}let i,a,o;if(t instanceof V)a=P(t.firestore,B),o=ba(t._key.path),i={next:e=>{n[r]&&n[r](Bf(a,t,e))},error:n[r+1],complete:n[r+2]};else{const c=P(t,pd),d=(a=P(c.firestore,B),o=c._query,new Mf(a));i={next:e=>{n[r]&&n[r](new kf(a,d,c,e))},error:n[r+1],complete:n[r+2]},cf(t._query)}{var u=Sd(a),h=o,l=i;const f=new jc(l),g=new dc(h,f,s);return u.asyncQueue.enqueueAndForget(async()=>hc(await nd(u),g)),()=>{f.La(),u.asyncQueue.enqueueAndForget(async()=>lc(await nd(u),g))}}}function Pf(e,t){{var n=Sd(e=P(e,B));e=Ed(t)?t:{next:t};const r=new jc(e);return n.asyncQueue.enqueueAndForget(async()=>{var e=await nd(n),t=r;e.K_.add(t),t.next()}),()=>{r.La(),n.asyncQueue.enqueueAndForget(async()=>{var e=await nd(n),t=r;e.K_.delete(t)})}}}function Vf(e,t){{var n=Sd(e),r=t;const s=new Hr;return n.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){const r=Fc(t);try{const t=await function(e,s){const i=e,a=l.now(),o=s.reduce((e,t)=>e.add(t.key),O());let u,h;return i.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Pa,r=O();return i._s.getEntries(n,o).next(e=>{(t=e).forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>i.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of s){const s=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=Wa(r.transform,e||null);null!=s&&(n=null===n?zi.empty():n).set(r.field,s)}return n||null}(n,u.get(n.key).overlayedDocument);null!=s&&t.push(new fo(n.key,s,function r(e){const s=[];return li(e.fields,(e,t)=>{const n=new f([e]);if(Ui(t)){const e=r(t.mapValue).fields;if(0===e.length)s.push(n);else for(const t of e)s.push(n.child(t))}else s.push(n)}),new pi(s)}(s.value.mapValue),L.exists(!0)))}return i.mutationQueue.addMutationBatch(n,a,t,s)}).next(e=>{var t=(h=e).applyToLocalDocumentSet(u,r);return i.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:h.batchId,changes:Ua(u)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId);{var s=r;var i=t.batchId;var a=n;let e=s.Da[s.currentUser.toKey()];e=(e=e||new A(T)).insert(i,a),s.Da[s.currentUser.toKey()]=e}await Rc(r,t.changes),await Wl(r.remoteStore)}catch(t){const e=rc(t,"Failed to persist write");n.reject(e)}}(await td(n),r,s)),s.promise}}function Bf(e,t,n){var r=n.docs.get(t._key),s=new Mf(e);return new Df(e,s,t._key,r,new Af(n.hasPendingWrites,n.fromCache),t.converter)}const Uf={maxAttempts:5};class qf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=qd(e)}set(e,t,n){this._verifyNotCommitted();const r=jf(e,this._firestore),s=xf(r.converter,t,n),i=jd(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,L.none())),this}update(e,t,n,...r){this._verifyNotCommitted();e=jf(e,this._firestore);let s;return s="string"==typeof(t=v(t))||t instanceof Rd?Yd(this._dataReader,"WriteBatch.update",e._key,t,n,r):Wd(this._dataReader,"WriteBatch.update",e._key,t),this._mutations.push(s.toMutation(e._key,L.exists(!0))),this}delete(e){this._verifyNotCommitted();e=jf(e,this._firestore);return this._mutations=this._mutations.concat(new yo(e._key,L.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new _(w.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function jf(e,t){if((e=v(e)).firestore!==t)throw new _(w.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Gf extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=qd(e)}get(e){const n=jf(e,this._firestore),r=new Cf(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return E();const t=e[0];if(t.isFoundDocument())return new uf(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new uf(this._firestore,r,n._key,null,n.converter);throw E()})}set(e,t,n){e=jf(e,this._firestore),t=xf(e.converter,t,n),t=jd(this._dataReader,"Transaction.set",e._key,t,null!==e.converter,n);return this._transaction.set(e._key,t),this}update(e,t,n,...r){e=jf(e,this._firestore),n="string"==typeof(t=v(t))||t instanceof Rd?Yd(this._dataReader,"Transaction.update",e._key,t,n,r):Wd(this._dataReader,"Transaction.update",e._key,t);return this._transaction.update(e._key,n),this}delete(e){e=jf(e,this._firestore);return this._transaction.delete(e._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=jf(e,this._firestore),n=new Mf(this._firestore);return super.get(e).then(e=>new Df(this._firestore,n,t._key,e._document,new Af(!1,!1),t.converter))}}function Kf(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new _("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function zf(){if("undefined"==typeof Uint8Array)throw new _("unimplemented","Uint8Arrays are not available in this environment.")}function Qf(){if("undefined"==typeof atob)throw new _("unimplemented","Blobs are unavailable in Firestore in this environment.")}Or=yg.SDK_VERSION,Gr=Or,yg._registerComponent(new H("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),s=new B(new Jr(e.getProvider("auth-internal")),new ns(e.getProvider("app-check-internal")),function(e,t){if(Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))return new xi(e.options.projectId,t);throw new _(w.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.')}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),s._setSettings(n),s},"PUBLIC").setMultipleInstances(!0)),yg.registerVersion(Ee,"4.2.0",void 0),yg.registerVersion(Ee,"4.2.0","esm2017");class $f{constructor(e){this._delegate=e}static fromBase64String(e){return Qf(),new $f(kd.fromBase64String(e))}static fromUint8Array(e){return zf(),new $f(kd.fromUint8Array(e))}toBase64(){return Qf(),this._delegate.toBase64()}toUint8Array(){return zf(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Hf(e){if("object"==typeof e&&null!==e){var t=e;for(const n of["next","error","complete"])if(n in t&&"function"==typeof t[n])return 1}}class Wf{enableIndexedDbPersistence(e,t){var e=e._delegate,t={forceOwnership:t},n=(Nd(e=P(e,B)),Sd(e));if(n._uninitializedComponentsProvider)throw new _(w.FAILED_PRECONDITION,"SDK cache is already specified.");Qr("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var e=e._freezeSettings(),r=new Uc;return Cd(n,r,new Vc(r,e.cacheSizeBytes,null==t?void 0:t.forceOwnership))}enableMultiTabIndexedDbPersistence(e){Nd(e=P(e=e._delegate,B));var t=Sd(e);if(t._uninitializedComponentsProvider)throw new _(w.FAILED_PRECONDITION,"SDK cache is already specified.");Qr("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var e=e._freezeSettings(),n=new Uc;return Cd(t,n,new Bc(n,e.cacheSizeBytes))}clearIndexedDbPersistence(e){{var t=e._delegate;if(t._initialized&&!t._terminated)throw new _(w.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const n=new Hr;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{e=Hh(t._databaseId,t._persistenceKey),await(bs.C()?(e=e+"main",void await bs.delete(e)):Promise.resolve()),n.resolve()}catch(e){n.reject(e)}var e}),n.promise}}}class Yf{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof xi||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Qr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(n,r,e={}){{var[n,r,e,s={}]=[this._delegate,n,r,e];const i=(n=P(n,md))._getSettings(),t=r+":"+e;if("firestore.googleapis.com"!==i.host&&i.host!==t&&Qr("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},i),{host:t,ssl:!1})),s.mockUserToken){let e,t;if("string"==typeof s.mockUserToken)e=s.mockUserToken,t=o.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var t=t||"demo-project",n=e.iat||0,r=e.sub||e.user_id;if(r)return r=Object.assign({iss:"https://securetoken.google.com/"+t,aud:t,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},e),[U(JSON.stringify({alg:"none",type:"JWT"})),U(JSON.stringify(r)),""].join(".");throw new Error("mockUserToken must contain 'sub' or 'user_id' field!")}(s.mockUserToken,null==(r=n._app)?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new _(w.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new o(i)}n._authCredentials=new Xr(new Wr(e,t))}}}enableNetwork(){return Ad(this._delegate)}disableNetwork(){return e=this._delegate,(n=Sd(e=P(e,B))).asyncQueue.enqueue(async()=>{const e=await Jc(n),t=await ed(n);return e.setNetworkEnabled(!1),async function(){const e=t;e.F_.add(0),await Vl(e),e.O_.set("Offline")}()});var e,n}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,hd("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){var e=this._delegate;{var t=Sd(e=P(e,B));const n=new Hr;return t.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;zl(n.remoteStore)||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();if(-1===e)t.resolve();else{const r=n.Ca.get(e)||[];r.push(t),n.Ca.set(e,r)}}catch(e){const n=rc(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await td(t),n)),n.promise}}onSnapshotsInSync(e){return Pf(this._delegate,e)}get app(){if(this._appCompat)return this._appCompat;throw new _("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available")}collection(e){try{return new lg(this,vd(this._delegate,e))}catch(e){throw ng(e,"collection()","Firestore.collection()")}}doc(e){try{return new tg(this,wd(this._delegate,e))}catch(e){throw ng(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new og(this,function(e,t){if(e=P(e,md),ud("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new _(w.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new pd(e,null,new wa(I.emptyPath(),t))}(this._delegate,e))}catch(e){throw ng(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){var n=this._delegate,r=e=>t(new Jf(this,e)),e=void 0;if(n=P(n,B),(e=Object.assign(Object.assign({},Uf),e)).maxAttempts<1)throw new _(w.INVALID_ARGUMENT,"Max attempts must be at least 1");{var s=Sd(n),i=e=>r(new Gf(n,e)),a=e;const o=new Hr;return s.asyncQueue.enqueueAndForget(async()=>{var e=await Xc(s).then(e=>e.datastore);new zc(s.asyncQueue,e,a,i,o).run()}),o.promise}}batch(){return Sd(this._delegate),new Zf(new qf(this._delegate,e=>Vf(this._delegate,e)))}loadBundle(e){return n=Sd(t=P(this._delegate,B)),r=new Td,id(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return Dd(this._delegate,e).then(e=>e?new og(this,e):null)}}class Xf extends Sf{constructor(e){super(),this.firestore=e}convertBytes(e){return new $f(new kd(e))}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return tg.forKey(e,this.firestore,null)}}class Jf{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Xf(e)}get(e){const t=cg(e);return this._delegate.get(t).then(e=>new ig(this._firestore,new Df(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){e=cg(e);return n?(Kf("Transaction.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=cg(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=cg(e);return this._delegate.delete(e),this}}class Zf{constructor(e){this._delegate=e}set(e,t,n){e=cg(e);return n?(Kf("WriteBatch.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=cg(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=cg(e);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}}class eg{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){e=new Nf(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new ag(this._firestore,e),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=eg.INSTANCES;let r=n.get(e),s=(r||(r=new WeakMap,n.set(e,r)),r.get(t));return s||(s=new eg(e,new Xf(e),t),r.set(t,s)),s}}eg.INSTANCES=new WeakMap;class tg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Xf(e)}static forPath(e,t,n){if(e.length%2!=0)throw new _("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new tg(t,new V(t._delegate,n,new S(e)))}static forKey(e,t,n){return new tg(t,new V(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new lg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new lg(this.firestore,vd(this._delegate,e))}catch(e){throw ng(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=v(e))instanceof V&&_d(this._delegate,e)}set(e,t){t=Kf("DocumentReference.set",t);try{return t?Of(this._delegate,e,t):Of(this._delegate,e)}catch(e){throw ng(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Lf(this._delegate,e):Lf(this._delegate,e,t,...n)}catch(e){throw ng(e,"updateDoc()","DocumentReference.update()")}}delete(){return Vf(P((e=this._delegate).firestore,B),[new yo(e._key,L.none())]);var e}onSnapshot(...e){var t=rg(e),e=sg(e,e=>new ig(this.firestore,new Df(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Ff(this._delegate,t,e)}get(e){let t;return(t=("cache"===(null==e?void 0:e.source)?function(t){t=P(t,V);const n=P(t.firestore,B),e=Sd(n),r=new Mf(n);return function(e,t){const n=new Hr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new _(w.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){t=rc(e,`Failed to get document '${t} from cache`);n.reject(t)}}(await Zc(e),t,n)),n.promise}(e,t._key).then(e=>new Df(n,r,t._key,e,new Af(null!==e&&e.hasLocalMutations,!0),t.converter))}:"server"===(null==e?void 0:e.source)?function(t){t=P(t,V);const n=P(t.firestore,B);return rd(Sd(n),t._key,{source:"server"}).then(e=>Bf(n,t,e))}:function(t){t=P(t,V);const n=P(t.firestore,B);return rd(Sd(n),t._key).then(e=>Bf(n,t,e))})(this._delegate)).then(e=>new ig(this.firestore,new Df(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new tg(this.firestore,e?this._delegate.withConverter(eg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function ng(e,t,n){return e.message=e.message.replace(t,n),e}function rg(e){for(const t of e)if("object"==typeof t&&!Hf(t))return t;return{}}function sg(e,t){let n;return{next:e=>{n.next&&n.next(t(e))},error:null==(e=(n=Hf(e[0])?e[0]:Hf(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]}).error)?void 0:e.bind(n),complete:null==(e=n.complete)?void 0:e.bind(n)}}class ig{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new tg(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Rf(this._delegate,e._delegate)}}class ag extends ig{data(e){e=this._delegate.data(e);return void 0===e&&E(),e}}class og{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Xf(e)}where(e,t,n){try{return new og(this.firestore,gf(this._delegate,(r=n,s=t,i=lf("where",e),mf._create(i,s,r))))}catch(e){throw ng(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(e,t){try{return new og(this.firestore,gf(this._delegate,([n,r="asc"]=[e,t],s=r,i=lf("orderBy",n),pf._create(i,s))))}catch(e){throw ng(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(e){try{return new og(this.firestore,gf(this._delegate,(fd("limit",t=e),yf._create("limit",t,"F"))))}catch(e){throw ng(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new og(this.firestore,gf(this._delegate,(fd("limitToLast",t=e),yf._create("limitToLast",t,"L"))))}catch(e){throw ng(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new og(this.firestore,gf(this._delegate,([...t]=[...e],vf._create("startAt",t,!0))))}catch(e){throw ng(e,"startAt()","Query.startAt()")}var t}startAfter(...e){try{return new og(this.firestore,gf(this._delegate,([...t]=[...e],vf._create("startAfter",t,!1))))}catch(e){throw ng(e,"startAfter()","Query.startAfter()")}var t}endBefore(...e){try{return new og(this.firestore,gf(this._delegate,([...t]=[...e],wf._create("endBefore",t,!1))))}catch(e){throw ng(e,"endBefore()","Query.endBefore()")}var t}endAt(...e){try{return new og(this.firestore,gf(this._delegate,([...t]=[...e],wf._create("endAt",t,!0))))}catch(e){throw ng(e,"endAt()","Query.endAt()")}var t}isEqual(e){return bd(this._delegate,e._delegate)}get(e){let t;return(t=("cache"===(null==e?void 0:e.source)?function(t){t=P(t,pd);const n=P(t.firestore,B),e=Sd(n),r=new Mf(n);return function(e,t){const n=new Hr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await il(e,t,!0),s=new wc(t,r.Ps),i=s.ha(r.documents),a=s.applyChanges(i,!1);n.resolve(a.snapshot)}catch(e){t=rc(e,`Failed to execute query '${t} against cache`);n.reject(t)}}(await Zc(e),t,n)),n.promise}(e,t._query).then(e=>new kf(n,r,t,e))}:"server"===(null==e?void 0:e.source)?function(t){t=P(t,pd);const n=P(t.firestore,B),e=Sd(n),r=new Mf(n);return sd(e,t._query,{source:"server"}).then(e=>new kf(n,r,t,e))}:function(t){t=P(t,pd);const n=P(t.firestore,B),e=Sd(n),r=new Mf(n);return cf(t._query),sd(e,t._query).then(e=>new kf(n,r,t,e))})(this._delegate)).then(e=>new hg(this.firestore,new kf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=rg(e),e=sg(e,e=>new hg(this.firestore,new kf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Ff(this._delegate,t,e)}withConverter(e){return new og(this.firestore,e?this._delegate.withConverter(eg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class ug{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new ag(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class hg{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new og(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new ag(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new ug(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new ag(this._firestore,e))})}isEqual(e){return Rf(this._delegate,e._delegate)}}class lg extends og{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new tg(this.firestore,e):null}doc(e){try{return void 0===e?new tg(this.firestore,wd(this._delegate)):new tg(this.firestore,wd(this._delegate,e))}catch(e){throw ng(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=P(e.firestore,B),r=wd(e),s=xf(e.converter,t);return Vf(n,[jd(qd(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,L.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new tg(this.firestore,e))}isEqual(e){return _d(this._delegate,e._delegate)}withConverter(e){return new lg(this.firestore,e?this._delegate.withConverter(eg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function cg(e){return P(e,V)}var Ie={Firestore:Yf,GeoPoint:Od,Timestamp:l,Blob:$f,Transaction:Jf,WriteBatch:Zf,DocumentReference:tg,DocumentSnapshot:ig,Query:og,QueryDocumentSnapshot:ag,QuerySnapshot:hg,CollectionReference:lg,FieldPath:class gg{constructor(...e){this._delegate=new Rd(...e)}static documentId(){return new gg(f.keyField().canonicalString())}isEqual(e){return(e=v(e))instanceof Rd&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class mg{constructor(e){this._delegate=e}static serverTimestamp(){const e=new zd("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new mg(e)}static delete(){const e=new Gd("deleteField");return e._methodName="FieldValue.delete",new mg(e)}static arrayUnion(...e){[...e]=[...e];const t=new Qd("arrayUnion",e);return t._methodName="FieldValue.arrayUnion",new mg(t)}static arrayRemove(...e){[...e]=[...e];const t=new $d("arrayRemove",e);return t._methodName="FieldValue.arrayRemove",new mg(t)}static increment(e){const t=new Hd("increment",e);return t._methodName="FieldValue.increment",new mg(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){Kr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1},dg=n.default,fg=(e,t)=>new Yf(e,t,new Wf);dg.INTERNAL.registerComponent(new H("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),e=e.getProvider("firestore").getImmediate();return fg(t,e)},"PUBLIC").setServiceProps(Object.assign({},Ie))),dg.registerVersion("@firebase/firestore-compat","0.3.18")}.apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});