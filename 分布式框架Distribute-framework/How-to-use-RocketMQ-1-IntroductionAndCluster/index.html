<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.0.0"><link rel="apple-touch-icon" sizes="180x180" href="https://myblog-1303447677.file.myqcloud.com/BlogFrame/pig_32px_1271682_easyicon.net.ico"><link rel="icon" type="image/png" sizes="32x32" href="https://myblog-1303447677.file.myqcloud.com/BlogFrame/pig_32px_1271682_easyicon.net.ico"><link rel="icon" type="image/png" sizes="16x16" href="https://myblog-1303447677.file.myqcloud.com/BlogFrame/pig_32px_1271682_easyicon.net.ico"><link rel="mask-icon" href="https://myblog-1303447677.file.myqcloud.com/BlogFrame/pig_32px_1271682_easyicon.net.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/black/pace-theme-minimal.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"zm6666.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="目录  RocketMQ简介和集群架构与原理（本篇） 理解RocketMQ的消息模型并与Spring集成 RocketMQ源码解析 RocketMQ生产环境常见问题总结  主要内容 这一部分主要是了解RocketMQ和熟悉RocketMQ的部署。从安装搭建到部署监控平台，可以快速上手这一优秀的消息组件。"><meta property="og:type" content="article"><meta property="og:title" content="RocketMQ使用指南1——简介和集群部署"><meta property="og:url" content="https://zm6666.top/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/How-to-use-RocketMQ-1-IntroductionAndCluster/index.html"><meta property="og:site_name" content="Oli的生活杂谈"><meta property="og:description" content="目录  RocketMQ简介和集群架构与原理（本篇） 理解RocketMQ的消息模型并与Spring集成 RocketMQ源码解析 RocketMQ生产环境常见问题总结  主要内容 这一部分主要是了解RocketMQ和熟悉RocketMQ的部署。从安装搭建到部署监控平台，可以快速上手这一优秀的消息组件。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2024-07-18T11:52:45.000Z"><meta property="article:modified_time" content="2024-07-23T03:07:54.450Z"><meta property="article:tag" content="Java"><meta property="article:tag" content="RocketMQ"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://zm6666.top/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/How-to-use-RocketMQ-1-IntroductionAndCluster/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zm6666.top/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/How-to-use-RocketMQ-1-IntroductionAndCluster/","path":"分布式框架Distribute-framework/How-to-use-RocketMQ-1-IntroductionAndCluster/","title":"RocketMQ使用指南1——简介和集群部署"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>RocketMQ使用指南1——简介和集群部署 | Oli的生活杂谈</title><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?a2fa2913e1140bc40e9aef85d103226c"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Oli的生活杂谈</p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9"><span class="nav-number">2.</span> <span class="nav-text">主要内容</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%A7%E5%93%81%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.</span> <span class="nav-text">产品介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%A7%E5%93%81%E7%89%B9%E7%82%B9"><span class="nav-number">4.</span> <span class="nav-text">产品特点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA"><span class="nav-number">5.</span> <span class="nav-text">快速搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BArocketmq%E6%9C%8D%E5%8A%A1"><span class="nav-number">5.1.</span> <span class="nav-text">搭建RocketMQ服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E6%94%B6%E5%8F%91"><span class="nav-number">5.2.</span> <span class="nav-text">实现消息收发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8java%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">5.3.</span> <span class="nav-text">使用Java客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="nav-number">5.4.</span> <span class="nav-text">搭建可视化管理服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4"><span class="nav-number">6.</span> <span class="nav-text">分布式集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2nameserver"><span class="nav-number">6.1.</span> <span class="nav-text">部署Nameserver</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2broker"><span class="nav-number">6.2.</span> <span class="nav-text">部署Broker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="nav-number">6.3.</span> <span class="nav-text">升级高可用集群</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93rocketmq%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9E%B6%E6%9E%84"><span class="nav-number">7.</span> <span class="nav-text">总结RocketMQ的运行架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%90%86%E8%A7%A3rocketmq%E7%9A%84%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B"><span class="nav-number">8.</span> <span class="nav-text">理解RocketMQ的消息模型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">9.</span> <span class="nav-text">小结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="" src="https://myblog-1303447677.file.myqcloud.com/BlogFrame/my-avatar.png"><p class="site-author-name" itemprop="name"></p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">25</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">19</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/zhaomin6666" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhaomin6666" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:lanmao_1029@163.com" title="E-Mail → mailto:lanmao_1029@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://zm6666.top/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/How-to-use-RocketMQ-1-IntroductionAndCluster/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://myblog-1303447677.file.myqcloud.com/BlogFrame/my-avatar.png"><meta itemprop="name" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Oli的生活杂谈"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="RocketMQ使用指南1——简介和集群部署 | Oli的生活杂谈"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> RocketMQ使用指南1——简介和集群部署</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-07-18 19:52:45" itemprop="dateCreated datePublished" datetime="2024-07-18T19:52:45+08:00">2024-07-18</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-07-23 11:07:54" itemprop="dateModified" datetime="2024-07-23T11:07:54+08:00">2024-07-23</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/" itemprop="url" rel="index"><span itemprop="name">分布式框架Distribute-framework</span></a></span></span><span id="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/How-to-use-RocketMQ-1-IntroductionAndCluster/" class="post-meta-item leancloud_visitors" data-flag-title="RocketMQ使用指南1——简介和集群部署" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><h1 id="目录">目录</h1><ol type="1"><li><p>RocketMQ简介和集群架构与原理（本篇）</p></li><li><p>理解RocketMQ的消息模型并与Spring集成</p></li><li><p>RocketMQ源码解析</p></li><li><p>RocketMQ生产环境常见问题总结</p></li></ol><h1 id="主要内容">主要内容</h1><p>这一部分主要是了解RocketMQ和熟悉RocketMQ的部署。从安装搭建到部署监控平台，可以快速上手这一优秀的消息组件。</p><span id="more"></span><h1 id="产品介绍">产品介绍</h1><p>RocketMQ是阿里开源的一个消息中间件，在阿里内部经历了双十一的考验，能够处理亿万级别的消息。早起使用的ActiveMQ在消息量逐渐增多之后性能很快达到了瓶颈，而Kafka是针对日志收集等高并发场景设计的，不适用于多Topic的场景。所以阿里在吸取Kafka的优点后，自研了一个消息中间件产品并不断优化，促成了一个Apache顶级项目的诞生。</p><h1 id="产品特点">产品特点</h1><p>当今MQ产品众多，其中影响力和使用范围最大的当属Kafka、RabbitMQ、RocketMQ和Pulsar。这几个产品在设计和实现上各有差异，造成他们适合于不用的细分场景。</p><table><colgroup><col style="width:10%"><col style="width:39%"><col style="width:28%"><col style="width:21%"></colgroup><thead><tr class="header"><th></th><th>优点</th><th>缺点</th><th>适合场景</th></tr></thead><tbody><tr class="odd"><td>Kafka</td><td>吞吐量非常大，性能好，集群高可用</td><td>有丢数据可能，不适合大量topic，功能单一</td><td>日志分析、大数据采集</td></tr><tr class="even"><td>RabbitMQ</td><td>可靠性高，支持AMQP协议，功能全面</td><td>erlang语言不好扩展，吞吐量一般</td><td>企业内部小规模服务调用</td></tr><tr class="odd"><td>Pulsar</td><td>云原生计算与存储分离，支持跨数据中心容灾，支持多租户</td><td>新事物生态较少</td><td>日志分析、大数据采集、跨地区容灾</td></tr><tr class="even"><td>RocketMQ</td><td>吞吐量高，功能全面，使用Java开发方便定制，丰富的管理工具</td><td>服务加载较慢</td><td>适合多种场景</td></tr></tbody></table><h1 id="快速搭建">快速搭建</h1><h2 id="搭建rocketmq服务">搭建RocketMQ服务</h2><p>RocketMQ官网地址为：<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/">https://rocketmq.apache.org/</a> ，下载地址为<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/download/">https://rocketmq.apache.org/download/</a>。可以看到目前最新版本为5.3.0，而4.x的最后一个版本4.9.8已经于2024年3月停止维护，本次学习的还是4.x版本的，后续再会去学习5.x的新特性。</p><p>我们下载下来运行版本之后就可以上传到我们的服务器上并解压，解压后有几个重要的目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cd /app/rocketmq-all-4.9.8-bin-release</span></span><br><span class="line">[root@localhost rocketmq-all-4.9.8-bin-release]<span class="comment"># ls -l</span></span><br><span class="line">total 44</span><br><span class="line">drwxr-xr-x. 2 root root   126 Feb 22 18:24 benchmark   <span class="comment">#压测脚本</span></span><br><span class="line">drwxr-xr-x. 3 root root  4096 Feb 22 17:26 bin         <span class="comment">#执行脚本</span></span><br><span class="line">drwxr-xr-x. 6 root root   211 Feb 22 17:26 conf        <span class="comment">#配置文件</span></span><br><span class="line">drwxr-xr-x. 2 root root  4096 Feb 22 18:24 lib         <span class="comment">#运行jar包</span></span><br><span class="line">-rw-r--r--. 1 root root 17327 Feb 22 17:26 LICENSE</span><br><span class="line">-rw-r--r--. 1 root root  1338 Feb 22 17:26 NOTICE</span><br><span class="line">-rw-r--r--. 1 root root 11219 Feb 22 17:26 README.md</span><br></pre></td></tr></table></figure><p></p><p>RocketMQ建议的运行环境为至少12G内存，但是我们这里学习阶段，虚拟机里面就给1G吧。此处需要修改<code>bin</code>目录下<code>runserver.sh</code>和<code>runbroker.sh</code>两个脚本。 使用<code>vi runserver.sh</code>命令，找到下面的配置并调整jvm的内存大小。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms512m -Xmx512m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span></span><br></pre></td></tr></table></figure><p></p><p>使用<code>vi runbroker.sh</code>命令，找到下面的配置并调整jvm的内存大小。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms1g -Xmx1g&quot;</span></span><br></pre></td></tr></table></figure><p></p><p>然后在安装完jdk之后，RocketMQ就可以启动了。</p><ol type="1"><li><p>启动nameserver服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rocketmq-all-4.9.8-bin-release]<span class="comment"># nohup bin/mqnamesrv &amp;</span></span><br><span class="line">[1] 9187</span><br><span class="line">[root@localhost rocketmq-all-4.9.8-bin-release]<span class="comment"># nohup: ignoring input and appending output to ‘nohup.out’</span></span><br><span class="line">^C</span><br><span class="line">[root@localhost rocketmq-all-4.9.8-bin-release]<span class="comment"># view nohup.out</span></span><br><span class="line"></span><br><span class="line">OpenJDK 64-Bit Server VM warning: Using the DefNew young collector with the CMS collector is deprecated and will likely be removed <span class="keyword">in</span> a future release</span><br><span class="line">OpenJDK 64-Bit Server VM warning: UseCMSCompactAtFullCollection is deprecated and will likely be removed <span class="keyword">in</span> a future release.</span><br><span class="line">The Name Server boot success. serializeType=JSON</span><br></pre></td></tr></table></figure> 在nohup.out中看到success字样说明nameserver就启动成功了。 使用jps命令可以看到一个java的应用正在运行：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">9348 Jps</span><br><span class="line">9206 NamesrvStartup</span><br></pre></td></tr></table></figure><p></p></li><li><p>启动broker服务 首先修改broker.conf中的一个配置，可以让broker自动创建topic。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rocketmq-all-4.9.8-bin-release]<span class="comment"># vi conf/broker.conf</span></span><br><span class="line"><span class="comment">#在配置文件的最后添加一行</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br></pre></td></tr></table></figure> 另外，如果你的服务器配置了多张网卡，例如阿里云，腾讯云这样的云服务器，他们通常有内网网卡和外网网卡两张网卡，那么需要增加配置brokerIP1属性，指向服务器的外网IP地址，这样才能确保从其他服务器上访问到RocketMQ服务。 和启动nameserver一样启动broker服务：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rocketmq-all-4.9.8-bin-release]<span class="comment"># nohup bin/mqbroker &amp;</span></span><br><span class="line">[2] 9252</span><br><span class="line">[root@localhost rocketmq-all-4.9.8-bin-release]<span class="comment"># nohup: ignoring input and appending output to ‘nohup.out’</span></span><br><span class="line">^C</span><br><span class="line">[root@localhost rocketmq-all-4.9.8-bin-release]<span class="comment"># view nohup.out</span></span><br><span class="line"></span><br><span class="line">The broker[localhost.localdomain, 192.168.30.3:10911] boot success. serializeType=JSON</span><br></pre></td></tr></table></figure> 在nohup.out中看到success字样说明broker就启动成功了。 使用jps命令可以看到两个java的应用正在运行：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">9348 Jps</span><br><span class="line">9206 NamesrvStartup</span><br><span class="line">9275 BrokerStartup</span><br></pre></td></tr></table></figure><p></p></li></ol><p>在实际部署时，可以和安装jdk一样把RocketMQ的bin目录添加到环境变量中，这样就可以直接使用mq的命令了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export ROCKETMQ_HOME=/app/rocketmq-all-4.9.8-bin-release&#x27;</span> | sudo <span class="built_in">tee</span> -a /etc/profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:$ROCKETMQ_HOME/bin&#x27;</span> | sudo <span class="built_in">tee</span> -a /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">nohup</span> mqnamesrv &amp;</span><br><span class="line"><span class="built_in">nohup</span> mqbroker &amp;</span><br></pre></td></tr></table></figure><p></p><h2 id="实现消息收发">实现消息收发</h2><ol type="1"><li><p>执行命令添加环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export NAMESRV_ADDR=localhost:9876&#x27;</span> | sudo <span class="built_in">tee</span> -a /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><p></p></li><li><p>启动RocketMQ生产者发送消息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure> 这个指令会默认往mq发送1000条消息，执行后从命令行可以看到发送消息的日志：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">SendResult [sendStatus=SEND_OK, msgId=7F000001085F72EA2F775F87D09E03E5, offsetMsgId=C0A81E0300002A9F000000000002EB52, messageQueue=MessageQueue [topic=TopicTest, brokerName=localhost.localdomain, queueId=1], queueOffset=249]</span><br><span class="line">SendResult [sendStatus=SEND_OK, msgId=7F000001085F72EA2F775F87D09F03E6, offsetMsgId=C0A81E0300002A9F000000000002EC12, messageQueue=MessageQueue [topic=TopicTest, brokerName=localhost.localdomain, queueId=2], queueOffset=249]</span><br><span class="line">SendResult [sendStatus=SEND_OK, msgId=7F000001085F72EA2F775F87D0A003E7, offsetMsgId=C0A81E0300002A9F000000000002ECD2, messageQueue=MessageQueue [topic=TopicTest, brokerName=localhost.localdomain, queueId=3], queueOffset=249]</span><br><span class="line">13:12:16.338 [NettyClientSelector_1] INFO RocketmqRemoting - closeChannel: close the connection to remote address[192.168.30.3:10911] result: <span class="literal">true</span></span><br><span class="line">13:12:16.342 [NettyClientSelector_1] INFO RocketmqRemoting - closeChannel: close the connection to remote address[127.0.0.1:9876] result: <span class="literal">true</span></span><br></pre></td></tr></table></figure> 可以看到最后两行表示发送完成之后服务正常关闭。<p></p></li><li><p>启动消费者接收之前发送的消息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br></pre></td></tr></table></figure> 消费者启动完成后，可以看到消费到的消息：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rocketmqlogs]<span class="comment"># tools.sh org.apache.rocketmq.example.quickstart.Consumer</span></span><br><span class="line">Consumer Started.</span><br><span class="line">ConsumeMessageThread_please_rename_unique_group_name_4_1 Receive New Messages: [MessageExt [brokerName=localhost.localdomain, queueId=0, storeSize=190, queueOffset=0, sysFlag=0, bornTimestamp=1721365933162, bornHost=/192.168.30.3:33580, storeTimestamp=1721365933235, storeHost=/192.168.30.3:10911, msgId=C0A81E0300002A9F0000000000000000, commitLogOffset=0, bodyCRC=613185359, reconsumeTimes=0, preparedTransactionOffset=0, toString()=Message&#123;topic=<span class="string">&#x27;TopicTest&#x27;</span>, flag=0, properties=&#123;MIN_OFFSET=0, MAX_OFFSET=250, CONSUME_START_TIME=1721366213429, UNIQ_KEY=7F000001085F72EA2F775F87C4650000, CLUSTER=DefaultCluster, TAGS=TagA&#125;, body=[72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 48], transactionId=<span class="string">&#x27;null&#x27;</span>&#125;]]</span><br><span class="line">...</span><br></pre></td></tr></table></figure> 每1条这样的日志信息就表示消费者接收到了1条消息。这个Consumer消费者的指令并不会主动结束，他会继续挂起，等待消费新的消息。我们可以使用CTRL+C停止该进程。 从打印的消息体中，我们可以看到很多消息、队列以及broker相关的信息。<p></p></li></ol><h2 id="使用java客户端">使用Java客户端</h2><ol type="1"><li><p>搭建一个标准的maven项目，pom.xml中引入如下依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p></li><li><p>然后创建一个生产者类，编写如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicProducer</span> &#123;  </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">		<span class="comment">// 初始化一个消息生产者  </span></span><br><span class="line">		<span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;basic_producer_group_name&quot;</span>);  </span><br><span class="line">		producer.setNamesrvAddr(<span class="string">&quot;192.168.30.3:9876&quot;</span>);  </span><br><span class="line">		<span class="keyword">try</span> &#123;  </span><br><span class="line">			<span class="comment">// 启动生产者  </span></span><br><span class="line">			producer.start();  </span><br><span class="line">			<span class="comment">// 创建消息对象  </span></span><br><span class="line">			<span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span>, <span class="string">&quot;basic_tag_A&quot;</span>, <span class="string">&quot;Hello RocketMQ&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));  </span><br><span class="line">			<span class="comment">// 发送消息  </span></span><br><span class="line">			<span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);  </span><br><span class="line">			System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);  </span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">			producer.shutdown();  </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 这边记得修改nameserver的地址，我这里使用的是虚拟机，所以需要打开虚拟机9876和10911端口，9876是nameserver的端口，10911是broker的端口，如果只打开9876会导致客户端连接到nameserver之后根据nameserver返回的broker地址去建立连接时无法连接。 执行main方法后，可以看到控制台输出发送的结果：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SendResult [sendStatus=SEND_OK, msgId=7F0000014D9C02E5C6495FBCE8900000, offsetMsgId=C0A81E0300002A9F000000000002ED92, messageQueue=MessageQueue [topic=TopicTest, brokerName=localhost.localdomain, queueId=0], queueOffset=250]</span><br></pre></td></tr></table></figure><p></p></li><li><p>创建⼀个消息消费者接收RocketMQ中的消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicConsumer</span> &#123;  </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">		<span class="comment">// 构建⼀个消息消费者  </span></span><br><span class="line">		<span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;basic_consumer_group_name&quot;</span>);  </span><br><span class="line">		<span class="comment">// 指定nameserver地址  </span></span><br><span class="line">		consumer.setNamesrvAddr(<span class="string">&quot;192.168.30.3:9876&quot;</span>);  </span><br><span class="line">		consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);  </span><br><span class="line">		<span class="keyword">try</span> &#123;  </span><br><span class="line">			<span class="comment">// 订阅⼀个消息队列  </span></span><br><span class="line">			consumer.subscribe(<span class="string">&quot;basic_topic&quot;</span>, <span class="string">&quot;*&quot;</span>);  </span><br><span class="line">			<span class="comment">// 注册消息监听器  </span></span><br><span class="line">			consumer.registerMessageListener((MessageListenerConcurrently) (messageExtList, consumeConcurrentlyContext) -&gt; &#123;  </span><br><span class="line">				messageExtList.forEach(messageExt -&gt; &#123;  </span><br><span class="line">					System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(messageExt.getBody()));  </span><br><span class="line">				&#125;);  </span><br><span class="line">				<span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;  </span><br><span class="line">			&#125;);  </span><br><span class="line">			<span class="comment">// 启动消费者  </span></span><br><span class="line">			consumer.start();  </span><br><span class="line">		&#125;  </span><br><span class="line">		<span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">			e.printStackTrace();  </span><br><span class="line">		&#125;  </span><br><span class="line">	&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 执行main方法后就可以接受到刚刚发送的消息：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello RocketMQ</span><br></pre></td></tr></table></figure> 这样我们就完成一个最简单的生产消费流程。这些代码在RocketMQ的官网以及源码的example模块中都可以看到。<p></p></li></ol><h2 id="搭建可视化管理服务">搭建可视化管理服务</h2><p>RocketMQ都是以后台服务的形式在运行，我们并不很清楚RocketMQ是如何运作的。 RocketMQ的社区就提供了一个图形化的管理控制台Dashboard，可以通过可视化的形式直接观测并管理RocketMQ的运行过程。</p><p>在RocketMQ的官网上，找到<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/deploymentOperations/04Dashboard">Dashboard</a>下载源码自己使用maven打包或者使用docker安装。 我们这里有工具就下载源码，<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-dashboard">源码地址</a>。</p><p>下载完成之后用idea打开，在maven菜单中右击package命令，点击Modify Run Configuration个性化执行命令，在package后面加上<code>-Dmaven.test.skip=true</code>并执行，打包后文件为<code>rocketmq-dashboard-1.0.1-SNAPSHOT.jar</code>。也可以直接使用maven命令行<code>mvn clean package -Dmaven.test.skip=true</code>进行打包。</p><p>将jar包上传到服务器上之后，在jar包所在目录创建一个<code>application.yml</code>文件，其中配置一下nameserver的地址：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rocketmq:</span> </span><br><span class="line">  <span class="attr">config:</span> </span><br><span class="line">    <span class="attr">namesrvAddrs:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.30</span><span class="number">.3</span><span class="string">:9876</span></span><br></pre></td></tr></table></figure> 其他配置可以直接查看源码中<code>rocketmq-dashboard\src\main\resources\application.yml</code>的配置进行参考。<p></p><p>配置完成之后执行<code>java -jar rocketmq-dashboard-1.0.1-SNAPSHOT.jar</code>运行该springboot工程，然后就可以通过8080端口进行访问了。</p><p>这个管理控制台的功能非常全面。dashboard菜单展示RocketMQ近期的运⾏情况，运维ops菜单主要是管理nameserver服务，集群cluster菜单主要管理broker服务。</p><h1 id="分布式集群">分布式集群</h1><p>前面我们使用了一台服务器搭建了nameserver+broker+dashboard的一整套RocketMQ服务，但是很明显生产系统我们需要做好高可用，防止单点故障。</p><p>RocketMQ的分布式集群基于主从架构，在多个服务器组成的集群中，指定一部分节点作为Master节点，负责相应客户端请求。另一部分节点作为Slave节点，负责备份Master节点上的数据，这样当Master节点出现故障时，在Slave节点上可以保留有数据备份，至少保证数据不会丢失。</p><p>我们目标是搭建一个由三个节点组成的Nameserver和2主2从的Broker集群，为了更方便的表示各个服务器，我把三个虚拟机的ip指定一个机器名如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">view /etc/hosts</span><br><span class="line">192.168.30.3 node1</span><br><span class="line">192.168.30.4 node2</span><br><span class="line">192.168.30.5 node3</span><br></pre></td></tr></table></figure> 对应的部署情况如下：<p></p><table><thead><tr class="header"><th>机器名</th><th>Nameserver服务</th><th>Broker部署</th></tr></thead><tbody><tr class="odd"><td>node1</td><td>Nameserver</td><td></td></tr><tr class="even"><td>node2</td><td>Nameserver</td><td>broker-a, broker-b-slave</td></tr><tr class="odd"><td>node3</td><td>Nameserver</td><td>broker-b, broker-a-slave</td></tr></tbody></table><h2 id="部署nameserver">部署Nameserver</h2><p>部署Nameserver和之前一样，在三台机器上都启动nameserver服务即可</p><h2 id="部署broker">部署Broker</h2><p>broker服务需要修改集群相关的参数。配置文件在conf目录下有示例：</p><ul><li><p>2m-noslave：2主无从的集群配置</p></li><li><p>2m-2s-async：2主2从的集群配置。其中async/sync表示主节点与从节点之间是异步同步还是同步同步。</p></li><li><p>dledger：具备主从切换功能的高可用集群。集群中的节点会基于Raft协议随机选举中一个Leader，作用类似于Master节点。其他节点都是Follower，作用类似于Slave节点。</p></li></ul><p>本次我们就采用<code>2m-2s-async</code>的方式搭建集群，需要修改node2和node3下的配置文件。</p><ol type="1"><li><p>配置第一组broker-a的主从服务 在node2机器上配置broker-a的master服务，需要修改<code>conf/2m-2s-async/broker-a.properties</code> 示例如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字，名字一样的节点就在同一个集群内</span></span><br><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="comment">#broker名字，名字一样的节点就是一组主从节点。</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-a</span></span><br><span class="line"><span class="comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">0</span></span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">node1:9876;node2:9876;node3:9876</span></span><br><span class="line"><span class="comment">#是否允许Broker自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line"><span class="attr">autoCreateTopicEnable</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="comment">#消息存储时间</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="comment">#Broker的角色</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">ASYNC_MASTER</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line"><span class="attr">storePathRootDir</span>=<span class="string">/app/rocketmq/store</span></span><br><span class="line"><span class="attr">storePathCommitLog</span>=<span class="string">/app/rocketmq/store/commitlog</span></span><br><span class="line"><span class="attr">storePathConsumeQueue</span>=<span class="string">/app/rocketmq/store/consumequeue</span></span><br><span class="line"><span class="attr">storePathIndex</span>=<span class="string">/app/rocketmq/store/index</span></span><br><span class="line"><span class="attr">storeCheckpoint</span>=<span class="string">/app/rocketmq/store/checkpoint</span></span><br><span class="line"><span class="attr">abortFile</span>=<span class="string">/app/rocketmq/store/abort</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line"><span class="attr">listenPort</span>=<span class="string">10911</span></span><br></pre></td></tr></table></figure> 在node3机器上配置broker-a的salve服务，需要修改<code>conf/2m-2s-async/broker-a-s.properties</code> 示例如下：<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字，名字一样的节点就在同一个集群内</span></span><br><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="comment">#broker名字，名字一样的节点就是一组主从节点。</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-a</span></span><br><span class="line"><span class="comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">1</span></span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">node1:9876;node2:9876;node3:9876</span></span><br><span class="line"><span class="comment">#是否允许Broker自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line"><span class="attr">autoCreateTopicEnable</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="comment">#消息存储时间</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="comment">#Broker的角色</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">SLAVE</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line"><span class="attr">storePathRootDir</span>=<span class="string">/app/rocketmq/storeSlave</span></span><br><span class="line"><span class="attr">storePathCommitLog</span>=<span class="string">/app/rocketmq/storeSlave/commitlog</span></span><br><span class="line"><span class="attr">storePathConsumeQueue</span>=<span class="string">/app/rocketmq/storeSlave/consumequeue</span></span><br><span class="line"><span class="attr">storePathIndex</span>=<span class="string">/app/rocketmq/storeSlave/index</span></span><br><span class="line"><span class="attr">storeCheckpoint</span>=<span class="string">/app/rocketmq/storeSlave/checkpoint</span></span><br><span class="line"><span class="attr">abortFile</span>=<span class="string">/app/rocketmq/storeSlave/abort</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line"><span class="attr">listenPort</span>=<span class="string">11011</span></span><br></pre></td></tr></table></figure><p></p></li><li><p>配置第二组broker-b的主从服务 在node3机器上配置broker-b的master服务，需要修改<code>conf/2m-2s-async/broker-b.properties</code> 示例如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字，名字一样的节点就在同一个集群内</span></span><br><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="comment">#broker名字，名字一样的节点就是一组主从节点。</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-b</span></span><br><span class="line"><span class="comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">0</span></span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">node1:9876;node2:9876;node3:9876</span></span><br><span class="line"><span class="comment">#是否允许Broker自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line"><span class="attr">autoCreateTopicEnable</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="comment">#消息存储时间</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="comment">#Broker的角色</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">ASYNC_MASTER</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line"><span class="attr">storePathRootDir</span>=<span class="string">/app/rocketmq/store</span></span><br><span class="line"><span class="attr">storePathCommitLog</span>=<span class="string">/app/rocketmq/store/commitlog</span></span><br><span class="line"><span class="attr">storePathConsumeQueue</span>=<span class="string">/app/rocketmq/store/consumequeue</span></span><br><span class="line"><span class="attr">storePathIndex</span>=<span class="string">/app/rocketmq/store/index</span></span><br><span class="line"><span class="attr">storeCheckpoint</span>=<span class="string">/app/rocketmq/store/checkpoint</span></span><br><span class="line"><span class="attr">abortFile</span>=<span class="string">/app/rocketmq/store/abort</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line"><span class="attr">listenPort</span>=<span class="string">10911</span></span><br></pre></td></tr></table></figure> 在node2机器上配置broker-b的slave服务，需要修改<code>conf/2m-2s-async/broker-b-s.properties</code> 示例如下：<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字，名字一样的节点就在同一个集群内</span></span><br><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="comment">#broker名字，名字一样的节点就是一组主从节点。</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-b</span></span><br><span class="line"><span class="comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">1</span></span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">node1:9876;node2:9876;node3:9876</span></span><br><span class="line"><span class="comment">#是否允许Broker自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line"><span class="attr">autoCreateTopicEnable</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="comment">#消息存储时间</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="comment">#Broker的角色</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">SLAVE</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line"><span class="attr">storePathRootDir</span>=<span class="string">/app/rocketmq/storeSlave</span></span><br><span class="line"><span class="attr">storePathCommitLog</span>=<span class="string">/app/rocketmq/storeSlave/commitlog</span></span><br><span class="line"><span class="attr">storePathConsumeQueue</span>=<span class="string">/app/rocketmq/storeSlave/consumequeue</span></span><br><span class="line"><span class="attr">storePathIndex</span>=<span class="string">/app/rocketmq/storeSlave/index</span></span><br><span class="line"><span class="attr">storeCheckpoint</span>=<span class="string">/app/rocketmq/storeSlave/checkpoint</span></span><br><span class="line"><span class="attr">abortFile</span>=<span class="string">/app/rocketmq/storeSlave/abort</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line"><span class="attr">listenPort</span>=<span class="string">11011</span></span><br></pre></td></tr></table></figure><p></p></li><li><p>启动Broker服务 在node2节点上启动broker-a和broker-b-s：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> mqbroker -c /app/rocketmq-all-4.9.8-bin-release/conf/2m-2s-async/broker-a.properties &amp;</span><br><span class="line"><span class="built_in">nohup</span> mqbroker -c /app/rocketmq-all-4.9.8-bin-release/conf/2m-2s-async/broker-b-s.properties &amp;</span><br></pre></td></tr></table></figure> 在node3节点上启动broker-a-s和broker-b：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> mqbroker -c /app/rocketmq-all-4.9.8-bin-release/conf/2m-2s-async/broker-b.properties &amp;</span><br><span class="line"><span class="built_in">nohup</span> mqbroker -c /app/rocketmq-all-4.9.8-bin-release/conf/2m-2s-async/broker-a-s.properties &amp;</span><br></pre></td></tr></table></figure><p></p></li><li><p>检查集群服务状态 再启动完成之后，可以通过mq的命令行命令查看集群状态，bin文件夹下有mqadmin指令，执⾏这个指令需要在机器上配置了NAMESRV环境变量。通过该指令查看RocketMQ集群状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost 2m-2s-async]<span class="comment"># mqadmin clusterList</span></span><br><span class="line"><span class="comment">#Cluster Name     #Broker Name            #BID  #Addr                  #Version                #InTPS(LOAD)       #OutTPS(LOAD) #PCWait(ms) #Hour #SPACE</span></span><br><span class="line">DefaultCluster    broker-a                0     192.168.30.4:10911     V4_9_8                   0.00(0,0ms)         0.00(0,0ms)          0 478233.88 0.1400</span><br><span class="line">DefaultCluster    broker-a                1     192.168.30.5:11011     V4_9_8                   0.00(0,0ms)         0.00(0,0ms)          0 478233.88 0.1400</span><br><span class="line">DefaultCluster    broker-b                0     192.168.30.5:10911     V4_9_8                   0.00(0,0ms)         0.00(0,0ms)          0 478233.88 0.1400</span><br><span class="line">DefaultCluster    broker-b                1     192.168.30.4:11011     V4_9_8                   0.00(0,0ms)         0.00(0,0ms)          0 478233.88 0.1400</span><br></pre></td></tr></table></figure> mqadmin还有很多其他功能，比如新增Topic，查询消息等等，具体可以直接执行<code>mqadmin</code>并使用<code>mqadmin help [COMMAND]</code>来查看具体功能。当然我们之前搭建的dashboard会用起来更加清晰，我们这里就启动我们的dashboard来查看集群信息。<p></p></li></ol><p>注意配置dashboard的Nameserver需要加上集群的Nameserver地址：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rocketmq:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">namesrvAddrs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node1:9876</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node2:9876</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node3:9876</span></span><br></pre></td></tr></table></figure><p></p><p>在RocketMQ的这种主从架构的集群下，客户端发送的消息会分散保存到broker-a和broker-b两个服务上，然后每个服务都配有slave服务，可以备份对应master服务上的消息，这样就可以防⽌单点故障造成的消息丢失问题。</p><h2 id="升级高可用集群">升级高可用集群</h2><p>主从架构的RocketMQ集群给master节点配置了slave节点作为备份，可以保证broker上的消息不会丢失，但是master节点宕机后，消息就不再会往该broker发送，并且也无法从该broker的slave节点中读取出消息，只有master重启后才能正常被消费者读取。也就是说slave节点只能保证数据不丢失，但是无法保证服务高可用。</p><p>这时我们就希望集群能够自动将slave节点升级为master节点继续对外提供服务，这样整个集群的消息服务不会中断。而RocketMQ的Dledger集群就具备这种角色转换的功能。</p><p>在Dledger集群中，就不再单独指定各个broker的服务，而是由这些broker服务自己进行选举，产生1个Leader节点的服务，响应客户端的各种请求。其他的broker服务就作为Follower节点，负责对Leader上的数据进行备份。当然，Follower所要负责的事情相比主从架构中的SLAVE节点会要复杂一点，因为这种节点选举是在后端不断进行的，他们需要随时做好升级成Leader的准备。</p><p>接下来我们就使用之前的3台服务器来搭建一个3个节点的Dledger集群，这个集群中只要有2台服务正常运行，这个集群就能正常工作。</p><ol type="1"><li><p>部署nameserver 这一步可以使用之前的nameserver，实际上nameserver是会自动感知broker的变化的，搭建的时候都不需要重新启动。</p></li><li><p>对Broker服务进行配置 和主从结构一样，RocketMQ给出了搭建Dledger集群的配置样例，在<code>conf/dledger</code>目录下RocketMQ给出了3个配置文件，这3个文件可以在单机上直接部署成一个具有3个服务的Dledger集群，我们按照此配置进行略微修改。 对于node1的<code>broker.conf</code>配置如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">brokerClusterName=RaftCluster</span><br><span class="line">brokerName=RaftNode00</span><br><span class="line">listenPort=30911</span><br><span class="line">namesrvAddr=node1:9876;node2:9876;node3:9876</span><br><span class="line">storePathRootDir=/app/rocketmq/storeDledger/</span><br><span class="line">storePathCommitLog=/app/rocketmq/storeDledger/commitlog storePathConsumeQueue=/app/rocketmq/storeDledger/consumequeue</span><br><span class="line">storePathIndex=/app/rocketmq/storeDledger/index</span><br><span class="line">storeCheckpoint=/app/rocketmq/storeDledger/checkpoint</span><br><span class="line">abortFile=/app/rocketmq/storeDledger/abort</span><br><span class="line">enableDLegerCommitLog=true</span><br><span class="line">dLegerGroup=RaftNode00</span><br><span class="line">dLegerPeers=n0-node1:40911;n1-node2:40911;n2-node3:40911</span><br><span class="line">## must be unique</span><br><span class="line">dLegerSelfId=n0</span><br><span class="line">sendMessageThreadPoolNums=16</span><br></pre></td></tr></table></figure> 其中和Dledger集群相关的参数：<p></p></li></ol><ul><li>dLedgerGroup: Dledger Raft Group的名字，建议跟brokerName保持⼀致。</li><li>dLedgerPeers: Dledger Group内各个服务节点的地址及端口信息。同一个Group内的各个节点配置必须要保持一致。</li><li>dLedgerSelfId: Dledger节点ID，必须属于dLedgerPeers中的一个。同一个Group内的各个节点必须不能重复。 node2和node3就只需要把对应的<code>n0</code>修改为<code>n1</code>和<code>n2</code>即可。</li></ul><ol start="3" type="1"><li>启动服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> mqbroker -c /app/rocketmq-all-4.9.8-bin-release/conf/dledger/broker.conf &amp;</span><br></pre></td></tr></table></figure> 启动完成之后我们使用<code>mqadmin</code>查看集群状态：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost dledger]<span class="comment"># mqadmin clusterList</span></span><br><span class="line"><span class="comment">#Cluster Name     #Broker Name            #BID  #Addr                  #Version                #InTPS(LOAD)       #OutTPS(LOAD) #PCWait(ms) #Hour #SPACE</span></span><br><span class="line">RaftCluster       RaftNode00              0     192.168.30.5:30911     V4_9_8                   0.00(0,0ms)         0.00(0,0ms)          0 478236.00 0.1400</span><br><span class="line">RaftCluster       RaftNode00              1     192.168.30.3:30911     V4_9_8                   0.00(0,0ms)         0.00(0,0ms)          0 478236.00 0.1400</span><br><span class="line">RaftCluster       RaftNode00              2     192.168.30.4:30911     V4_9_8                   0.00(0,0ms)         0.00(0,0ms)          0 478236.00 0.1500</span><br></pre></td></tr></table></figure> 此时node3机器上的broker被选成了master（id为0，这个id和配置的dLedgerSelfId没有关联），如果此时关闭node3机器上的broker，就会发现node1和node2中被随机出来一个节点作为了master。如果继续关闭一个服务器上的broker，那么集群会因为可用服务少于半数而无法正常工作。</li></ol><p>Dledger集群机制是RocketMQ4.5版本开始⽀持的⼀个重要特性。他其实是由OpenMessage组织带入RocketMQ的一个系列框架。他是一个为高可用、高性能、高可靠的分布式存储系统提供基础支持的组件。他做的事情主要有两个，一是在集群中选举产生master节点。RocketMQ集群需要用这个master节点响应客户端的各种请求。二是在各种复杂的分布式场景下，保证CommitLog日志文件在集群中的强一致性。</p><p>Dledger集群背后的核心就是Raft协议。这是一种强大的分布式选举算法，其核⼼是只要集群中超过半数的节点作出的共同决议，就认为是集群最终的共同决议。Kafka也在之后基于Raft协议，自行实现了Kraft集群机制。</p><p>Dledger集群由于会接管RocketMQ原生的文件写入，所以，Dledger集群的文件写入速度比RocketMQ的原生写入方式是要慢一点的。这会对RocketMQ的性能产生一些影响。所以，当前版本的Dledger集群在企业中用得并不是太多。5.0版本对Dledger集群抽出了一种Dledger Controller模式，也就是只用Dledger集群的选举功能，而不用他的Commit文件写入功能，这样性能可以得到一定的提升。</p><h1 id="总结rocketmq的运行架构">总结RocketMQ的运行架构</h1><p>通过上面简单的实验，我们已经对RocketMQ的运行机制有了一个大概的了解。接下来我们梳理一下RocketMQ中各个组件的作用：</p><ol type="1"><li>nameServer服务 nameServer不依靠任何其他服务自己就能独立启动。并且不管是broker还是客户端，都需要明确指定nameServer地址。整个RocketMQ集群都要在nameServer的协调下才能正常工作。</li><li>broker服务 broker服务是整个集群中设计最为繁琐的部分，最核心的消息存储、传递、查询等功能都由Broker来提供。</li><li>client客户端 client客户端包括生产者和消费者。从生产者产生的数据经过nameServer的调度在broker中进行分发给对应的消费者。</li></ol><h1 id="理解rocketmq的消息模型">理解RocketMQ的消息模型</h1><p>在学习消息模型之前，我们先往之前的两个节点（2m-2s）的集群发送一些消息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure> 这个脚本会执行Producer测试类往服务端发送1000条消息，消息发送后可以在控制台看到SendResult信息：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SendResult [sendStatus=SEND_OK, msgId=7F000001097A72EA2F77708EA51E03E7, offsetMsgId=C0A81E0500002A9F0000000000017608, messageQueue=MessageQueue [topic=TopicTest, brokerName=broker-b, queueId=1], queueOffset=124]</span><br></pre></td></tr></table></figure> 其中就有topic，messageQueue等概念，我们打开dashboard，在【主题】菜单中可以看到多了一个名为<code>TopicTest</code>的主题，这就是运行测试类所创建的主题。点击【状态】可以看到主题上的消息分布。<p></p><p>可以看到broker-a和broker-b上各有4个队列，每一个队列分有125条消息，其中offset可以理解和Kafka一样是消息的索引，最大offset就是当前最新接收到消息保存的位置。回头来看之前日志中打印的SendResult的信息。日志中的MessageQueue就代表这一条消息存在哪个队列上了。而queueOffset就表示这条消息记录在MessageQueue的哪个位置。</p><p>我们再启动一个消费者来消费消息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br></pre></td></tr></table></figure><p></p><p>Consumer启动完成后，我们可以在控制台看到很多类似这样的⽇志：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConsumeMessageThread_please_rename_unique_group_name_4_1 Receive New Messages: [MessageExt [brokerName=broker-a3, storeSize=192, queueOffset=47, sysFlag=0, bornTimestamp=1721651595296, bornHost=/192.168.30.3:33990, storeTi21651595170, storeHost=/192.168.30.4:10911, msgId=C0A81E0400002A9F0000000000008F0A, commitLogOffset=36618, body7070, reconsumeTimes=0, preparedTransactionOffset=0, toString()=Message&#123;topic=<span class="string">&#x27;TopicTest&#x27;</span>, flag=0, properties=&#123;=0, MAX_OFFSET=125, CONSUME_START_TIME=1721651995917, UNIQ_KEY=7F000001097A72EA2F77708EA020017D, CLUSTER=DefaulTAGS=TagA&#125;, body=[72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 51, 56, 49], transactionI]</span><br></pre></td></tr></table></figure> 这里面也打印出了一些我们刚刚熟悉的brokerName，queueId，queueOffset这些属性。其中queueOffset属性就表示这一条消息在MessageQueue上的存储位点。通过记录每⼀个消息的Offset偏移量，RocketMQ就可以快速的定位到这一条消息具体的存储位置，继续正确读取到消息的内容。<p></p><p>我们可以从dashboard的【消费者】菜单中验证一下消费情况，点击对应消费者后，可以看到从中看到消费了TopicTest主题的消息，并且启动了一个叫做<code>please_rename_unique_group_name_4</code>的消费者组，并且消费都是以组消费的，我们可以自定义一个新的消费组来消费这个主题的信息。这时RocketMQ就会单独记录新消费组的消费进度，而新的消费组也可以消费到TopicTest的全部消息。</p><p>对上面的现象进行梳理，我们可以得出模型。生产者和消费者都可以指定一个Topic发送消息或者拉去消息，而Topic是一个逻辑概念，Topic中的消息被分布在后面多个MessageQueue中，这些MessageQueue又会分布在一个或者多个broker上，这一点和Kafka非常相似。</p><p>在RocketMQ的这个消息模型当中，最为核心的就是Topic。对于客户端，Topic代表了一类有相同业务规则的消息。对于Broker，Topic则代表了系统中一系列存储消息的资源。所以，RocketMQ对于Topic是需要做严格管理的。如果任由客户端随意创建Topic，那么服务端的资源管理压力就会非常大。默认情况下，Topic都需要由管理员在RocketMQ的服务端手动进行创建，然后才能给客户端使用的。而我们之前在broker.conf中手动添加的<code>autoCreateTopic=true</code>，就是表示可以由客户端自行创建Topic。这种配置方式显然只适用于测试环境，在生产环境不建议打开这个配置项。</p><p>对于业务来说，最为重要的就是消息Message了。生产者发送到某一个Topic下的消息，最终会保存在Topic下的某一个MessageQueue中。在消费者来消费消息时，RocketMQ会在Broker端给每个消费者组记录一个消息的消费位点Offset。通过Offset控制每个消费者组的消息处理进度。这样，每一条消息，在一个消费者组当中只被处理一次。</p><h1 id="小结">小结</h1><p>这一章节，主要是快速熟悉RocketMQ产品，并通过操作，理解总结RocketMQ的运行架构以及消息模型。这些抽象的模型和架构和Kafka有很多相似之处，可以与Kafka进行对比学习。当然，RocketMQ相比Kafka拥有更多业务功能，能够满足各类业务场景。</p></div><footer class="post-footer"><div><div style="text-align:center;color:#ccc;font-size:14px">-------------　　　　本文结束　<i class="fa fa-flag"></i>　感谢阅读　　　　-------------</div></div><div class="reward-container"><div>请我一杯咖啡吧！</div> <button> 打赏</button><div class="post-reward"><div> <img src="https://myblog-1303447677.file.myqcloud.com/BlogFrame/wechatpay.png" alt=" 微信支付"> <span>微信支付</span></div><div> <img src="https://myblog-1303447677.file.myqcloud.com/BlogFrame/alipay.png" alt=" 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"></li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://zm6666.top/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/How-to-use-RocketMQ-1-IntroductionAndCluster/" title="RocketMQ使用指南1——简介和集群部署">https://zm6666.top/分布式框架Distribute-framework/How-to-use-RocketMQ-1-IntroductionAndCluster/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a><a href="/tags/RocketMQ/" rel="tag"><i class="fa fa-tag"></i> RocketMQ</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/How-to-use-Kafka-4-Log_Index/" rel="prev" title="Kafka使用指南4——Kafka日志索引分析"><i class="fa fa-angle-left"></i> Kafka使用指南4——Kafka日志索引分析</a></div><div class="post-nav-item"> <a href="/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/How-to-use-RocketMQ-2-MessageModelAndSpringIntegration/" rel="next" title="RocketMQ使用指南2——消息模型和Spring整合">RocketMQ使用指南2——消息模型和Spring整合<i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">苏ICP备2022038238号-1</a></div><div class="copyright"> &copy; 2019 – <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">zm</span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div><script>var titleTime,OriginTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="来啊快活啊~"+OriginTitle,clearTimeout(titleTime)):(document.title="咚咚咚"+OriginTitle,titleTime=setTimeout(function(){document.title=OriginTitle},2e3))})</script></div></footer><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/pace.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"WYpTHDdtwSPYrGnPn3Dd6VK8-gzGzoHsz","app_key":"167XRDBA8P2enbdqnG3050K1","server_url":"https://wypthddt.lc-cn-n1-shared.com","security":true,"betterPerformance":true}</script><script src="/js/third-party/statistics/lean-analytics.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://zm6666.top/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6Distribute-framework/How-to-use-RocketMQ-1-IntroductionAndCluster/"}</script><script src="/js/third-party/quicklink.js"></script><script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"zhaomin6666/BlogUtterances","issue_term":"title","theme":"github-light"}</script><script src="/js/third-party/comments/utterances.js"></script></body></html>